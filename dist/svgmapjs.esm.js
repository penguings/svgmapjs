let e=class{static setting="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEVrZXIAAABXsNZ8AAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAuSURBVAjXY2BsYBDyYNAKYXBRYlBgYRDsYEhyY2hRBCEgA8gFCgKlgAqAyhgbALVHB5MYHdneAAAAAElFTkSuQmCC";static xcursor="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPAgMAAABGuH3ZAAAACVBMVEVlAGsAAAC6AADU707yAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAhSURBVAjXY2BgdWBgYGDDQYSGhYYwZK1atQTCwqkOZAoANmIIUX/U/KkAAAAASUVORK5CYII=";static hamburger="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEVlAGRCQkJgmRPnAAAAAXRSTlMAQObYZgAAABJJREFUCNdjYAAD+z8gBAe4uQCvKQdj5EQSJQAAAABJRU5ErkJggg==";static hamburgerEdit="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAACVBMVEVkAFb/AABCQkIPrhq8AAAAAXRSTlMAQObYZgAAACJJREFUCNdjYIADrlWrFkAINIApEQLEjKFAsZVQAirGwAAA4sIMW9pBuDwAAAAASUVORK5CYII=";static UTpng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAARElEQVQoU2NkIAEwkqCWAaviUIaD/1cz2GPIYQiAFMJsQ9eAohhZITYNcMXYFKJrACvGpxBZAyMxCmEaKA86XGFPkskAu/sRITlJWQUAAAAASUVORK5CYII=";static DTpng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAARklEQVQoU2NkIAEwkqCWgTTFoQwH/xNrOthkYjSsZrBnhDsDnwaQQpChKG7GpgGmEEMxupOQFWJVDNOArhCnYlyhQ1I4AwDsgxEhKAdQXgAAAABJRU5ErkJggg==";static RTpng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAAQUlEQVQoU2NkQAKhDAf/r2awZ0QWQ2ajSIAUgyRxacCqGJcGnIqxacCrGF0DQcXIGggqRvYsddyMLfgoC2d8MQgAdTkhDCcGd3MAAAAASUVORK5CYII="},t=class{static EMBEDSVG=0;static BITIMAGE=1;static POI=2;static VECTOR2D=3;static GROUP=4;static TEXT=5;static NONE=-1;static PATH=0;static POLYLINE=1;static POLYGON=2;static RECT=3;static CIRCLE=4;static ELLIPSE=5;static HYPERLINK=10;static SYMBOL=11;static USEDPOI=12;static DIRECTPOI=13;static SVG2EMBED=100;static EXIST=1;static CLICKABLE=2;static ns_svg="http://www.w3.org/2000/svg"};class i{static trim(e){return e.replace(/^\s+|\s+$/g,"")}static compressSpaces(e){return e.replace(/[\s\r\t\n]+/gm," ")}static numberFormat(e,t){t||(t=7);var i=Math.pow(10,t);return Math.round(e*i)/i}static MouseWheelListenerFunc(e){e.stopPropagation()}static getHyperLink(e){for(var t=e;t.parentNode;)if("a"==(t=t.parentNode).nodeName&&t.getAttribute("xlink:href"))return{href:t.getAttribute("xlink:href"),target:t.getAttribute("target")};return null}static addCommonQueryAtQueryString(e,t){var i=e;return i.lastIndexOf("?")>0?i+="&":i+="?",i+=t}static getElementByIdUsingQuerySelector(e){return this.querySelector('[id="'+e+'"]')}static getUrlHash(e){if(e.indexOf("#")>=0){var t=e.substring(e.indexOf("#")+1);t.indexOf("?")>0&&(t=t.substring(0,t.indexOf("?"))),t=t.split("&");for(var i=0;i<t.length;i++){if(t[i].indexOf("=")>0)t[i]=t[i].split("=");else if(t[i].indexOf("(")>0){var s=t[i].substring(0,t[i].indexOf("(")),r=t[i].substring(t[i].indexOf("(")+1,t[i].length-1);t[i]=[s,r]}t[t[i][0]]=t[i][1]}return t}return null}static getFragmentView(e){if(!(e.indexOf("svgView")>=0&&e.indexOf("viewBox")>=0))return null;var t=e.substring(e.indexOf("viewBox"));t=(t=t.substring(t.indexOf("(")+1,t.indexOf(")"))).split(",");try{return 5==t.length?{global:!0,x:Number(t[1]),y:Number(t[2]),width:Number(t[3]),height:Number(t[4])}:4==t.length?{global:!1,x:Number(t[0]),y:Number(t[1]),width:Number(t[2]),height:Number(t[3])}:null}catch(e){return null}}static getImageURL(e,t){return 0==e.lastIndexOf("http://",0)||0==e.lastIndexOf("https://",0)||0==e.lastIndexOf("data:",0)||0==e.lastIndexOf("blob:",0)||0==e.indexOf("/")?e:t+e}static getSvgLocation(e){var t,i="",s="",r=e.length,a=r;return e.lastIndexOf("#")>0&&(r=e.lastIndexOf("#"),i=e.substring(e.lastIndexOf("#"))),e.indexOf("?")>0&&(a=e.indexOf("?"),s=e.substring(a,r)),t=e.substring(0,a),{protocol:location.protocol,host:location.host,hostname:location.hostname,port:location.port,pathname:t,search:s,hash:i}}static getSvgReq(e){var t=i.getSvgLocation(e);return t.pathname+t.search}static numberFormat(e,t){t||(t=7);var i=Math.pow(10,t);return Math.round(e*i)/i}static escape(e){return e=(e=(e=(e=(e=e.replace(/&/g,"&amp;")).replace(/"/g,"&quot;")).replace(/'/g,"&#039;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")}static round(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i}static getNoCacheRequest(e){var t=e;return t.lastIndexOf("?")>0?t+="&":t+="?",t+="unixTime="+(new Date).getTime()}static getDocDir(e){var t=e.replace(/#.*/g,"");return(t=t.replace(/\?.*/,"")).substring(0,t.lastIndexOf("/")+1)}static inZoomRange(e,t,i){return!e||!e.minZoom&&!e.maxZoom||!(e.minZoom&&t*i<e.minZoom)&&!(e.maxZoom&&t*i>e.maxZoom)}static isVisible(e){return!!e.visible}static isIntersect(e,t){var i,s;return i=e.nonScaling?{x:e.x,y:e.y,width:0,height:0}:e,s=t.nonScaling?{x:t.x,y:t.y,width:0,height:0}:t,!(i.x>s.x+s.width||s.x>i.x+i.width||i.y>s.y+s.height||s.y>i.y+i.height)}static getBBox(e,t,i,s){return{x:e,y:t,width:i,height:s}}static getElementsByDualTagName(e,t,i){return Array.prototype.slice.call(e.getElementsByTagName(t)).concat(Array.prototype.slice.call(e.getElementsByTagName(i)))}static getElementByIdNoNS(e,t){return this.getElementByAttr(e,t,"id")}static getElementByImgIdNoNS(e,t){return this.getElementByAttr(e,t,"iid")}static getElementByAttr(e,t,i){return e&&e.hasChildNodes()?e.querySelector("["+i+'="'+t+'"]'):null}static getControllerSrc(e,t){var i=e.match(/data-controller-src[\s\S]*?"([\s\S]*?)"/)[1];return i=(i=i.replace(/&amp;/g,"&")).replace(/&quot;/g,'"'),t.controller={src:i},e.replace(/data-controller-src[\s\S]*?"[\s\S]*?"/,"")}static getSvgScript(e,t){var i=e.match(/<script>([\s\S]*)<\/script>/)[1];return i=(i=(i=(i=i.replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&amp;/g,"&")).replace(/&quot;/g,'"'),t.svgScript=i,e.replace(/<script>[\s\S]*<\/script>/,"")}static getSymbolProps(e){return{type:"symbol",id:e.getAttribute("id"),path:e.getAttribute("xlink:href"),offsetX:Number(e.getAttribute("x")),offsetY:Number(e.getAttribute("y")),width:Number(e.getAttribute("width")),height:Number(e.getAttribute("height"))}}static getGraphicsGroupSymbol(e){return{type:"group",id:e.getAttribute("id"),node:e}}static getPathSymbolMakerProps(e){var t=e.getAttribute("d");return{type:"marker",id:e.getAttribute("id"),d:t}}static getrootViewBoxFromRootSVG(e,t,i){var s,r,a,o;return i?e:(e?t.height/t.width>e.height/e.width?(a=e.width,o=e.width*t.height/t.width,s=e.x,r=e.y+e.height/2-o/2):(o=e.height,a=e.height*t.width/t.height,r=e.y,s=e.x+e.width/2-a/2):(s=0,r=0,a=t.width,o=t.height),{x:s,y:r,width:a,height:o})}static getRefresh(e){var t=new Array;t.timeout=-1,t.url="",t.start=!1,t.loadScript=!1;for(var i=e.getElementsByTagName("meta"),s=0;s<i.length;s++)if(i[s].getAttribute("http-equiv")&&"refresh"==i[s].getAttribute("http-equiv")&&i[s].getAttribute("content")){var r=i[s].getAttribute("content").split(";");t.timeout=Number(r[0]),t.loadScript=!0,r[1]&&(t.url=refs[1]);break}return t}static getMetaSchema(e){return e.documentElement.getAttribute("property")}static parseTransformMatrix(e){var t=null;if(e){var i=e.replace("matrix(","").replace(")","").split(",");6==i.length&&(t={a:Number(i[0]),b:Number(i[1]),c:Number(i[2]),d:Number(i[3]),e:Number(i[4]),f:Number(i[5])})}return t}static getNonScalingOffset(e){try{var t=e.getAttribute("transform").replace("ref(svg,","").replace(")","").split(","),i=Number(t[0]),s=Number(t[1]);return isNaN(i)||isNaN(s)?{x:null,y:null,nonScaling:!1}:{x:Number(t[0]),y:Number(t[1]),nonScaling:!0}}catch(e){return{x:null,y:null,nonScaling:!1}}}static getDocumentId(e){return e.ownerDocument.documentElement.getAttribute("about")}static getImageProps=function(e,s,r,a,o){var n,l,h,g,d,p,c,u,m,y,v,f,b,I=!1;v=0,f=0;var P,S,M=!1,w=null,x=null;if(a||s!=t.POI||(a=t.USEDPOI),s==t.EMBEDSVG||s==t.BITIMAGE||a==t.DIRECTPOI){if(s==t.EMBEDSVG&&a==t.SVG2EMBED){(u=e.getAttribute("src")).indexOf("globe",u.lastIndexOf("#")),e.getAttribute("postpone");var C=e.getAttribute("clip").replace(/rect\(|\)/g,"").replace(/\s*,\s*|\s+/,",").split(",");C&&4==C.length?(n=Number(C[0]),l=Number(C[1]),h=Number(C[2]),g=Number(C[3])):(n=-3e4,l=-3e4,h=6e4,g=6e4)}else{(E=i.getNonScalingOffset(e)).nonScaling?(I=!0,n=E.x,l=E.y,e.getAttribute("x")&&(v=Number(e.getAttribute("x"))),e.getAttribute("y")&&(f=Number(e.getAttribute("y")))):(n=Number(e.getAttribute("x")),l=Number(e.getAttribute("y")),m=i.parseTransformMatrix(e.getAttribute("transform"))),h=Number(e.getAttribute("width")),g=Number(e.getAttribute("height")),(u=e.getAttribute("xlink:href"))||(u=e.getAttribute("href")),u||(u=""),u.indexOf("#")>0&&u.indexOf("xywh=",u.indexOf("#"))>0&&(b=u.substring(5+u.indexOf("xywh=",u.indexOf("#"))),u=u.substring(0,u.indexOf("#"))),""==(x=e.getAttribute("crossorigin"))&&(x="anonymous"),o&&(s!=t.BITIMAGE||I?a==t.DIRECTPOI&&o.setPoint(n,l):o.setCoverage(n,l,h,g,m,u)),a==t.DIRECTPOI&&(d=e.getAttribute("content"),p=e.getAttribute("xlink:title"))}if(c=e.getAttribute("class"),s==t.BITIMAGE&&(e.getAttribute("style")&&e.getAttribute("style").indexOf("image-rendering:pixelated")>=0||r&&r["image-rendering"]&&"pixelated"==r["image-rendering"])&&(M=!0),s==t.BITIMAGE&&e.getAttribute("style")&&e.getAttribute("style").indexOf("filter")>=0){var L=e.getAttribute("style")+";";w=L=(L=L.substring(L.indexOf("filter:"))).substring(7,L.indexOf(";"))}}else if(a==t.USEDPOI){(E=i.getNonScalingOffset(e)).nonScaling?(I=!0,n=E.x,l=E.y,e.getAttribute("x")&&(v=Number(e.getAttribute("x"))),e.getAttribute("y")&&(f=Number(e.getAttribute("y")))):(I=!1,n=Number(e.getAttribute("x")),l=Number(e.getAttribute("y"))),h=0,g=0,d=e.getAttribute("content"),p=e.getAttribute("xlink:title"),u=e.getAttribute("xlink:href"),o&&o.setPoint(n,l)}else if(s==t.TEXT){var E;(E=i.getNonScalingOffset(e)).nonScaling?(I=!0,n=E.x,l=E.y,e.getAttribute("x")&&(v=Number(e.getAttribute("x"))),e.getAttribute("y")&&(f=Number(e.getAttribute("y")))):(I=!1,n=Number(e.getAttribute("x")),l=Number(e.getAttribute("y"))),g=16,e.getAttribute("font-size")&&(g=Number(e.getAttribute("font-size"))),I&&(g=0),h=g,y=e.textContent}e.getAttribute("visibleMinZoom")?P=Number(e.getAttribute("visibleMinZoom"))/100:r&&r.minZoom&&(P=r.minZoom),e.getAttribute("visibleMaxZoom")?S=Number(e.getAttribute("visibleMaxZoom"))/100:r&&r.maxZoom&&(S=r.maxZoom);var A=!0;"hidden"!=e.getAttribute("visibility")&&"none"!=e.getAttribute("display")||(A=!1);var T=Number(e.getAttribute("opacity"));return(T>1||T<0)&&(T=1),{x:n,y:l,width:h,height:g,href:u,opacity:T,minZoom:P,maxZoom:S,metadata:d,title:p,visible:A,elemClass:c,transform:m,text:y,cdx:v,cdy:f,nonScaling:I,href_fragment:b,pixelated:M,imageFilter:w,crossorigin:x,commonQuery:e.getAttribute("commonQuery")}}.bind(this);static getSymbols(e){for(var t=new Array,s=e.getElementsByTagName("defs"),r=0;r<s.length;r++){var a=s[r];if(a.hasChildNodes)for(var o=a.childNodes,n=0;n<o.length;n++){if("image"==o[n].nodeName)t["#"+(h=i.getSymbolProps(o[n])).id]=h;else if("g"==o[n].nodeName){if(o[n].hasChildNodes)for(var l=0;l<o[n].childNodes.length;l++)if(1==o[n].childNodes[l].nodeType){if("image"==o[n].childNodes[l].nodeName){(h=i.getSymbolProps(o[n].childNodes[l])).id||(h.id=o[n].getAttribute("id")),t["#"+h.id]=h;break}t["#"+(h=i.getGraphicsGroupSymbol(o[n])).id]=h;break}}else if("marker"==o[n].nodeName&&o[n].hasChildNodes)for(l=0;l<o[n].childNodes.length;l++)if("path"==o[n].childNodes[l].nodeName){var h;t["#"+(h=i.getPathSymbolMakerProps(o[n].childNodes[l])).id]=h;break}}}return t}static addEvent(e,t,i){e.addEventListener(t,i,!1)}static getCanvasSize(){var e=window.innerWidth,t=window.innerHeight;return e||(e=document.documentElement.clientWidth,t=document.documentElement.clientHeight),{width:e,height:t,x:0,y:0}}}class s{#e;#t;#i;#s;#r;#a;#o;#n;#l;#h;#g="Layer List: ";#d=" layers visible";constructor(e,t){this.#r=e,e.registLayerUiSetter(function(e){this.#p(e)}.bind(this),function(){this.#c()}.bind(this)),this.#a=t,console.log("construct layerUI:")}#c(){var e=document.getElementById("layerTable"),t=this.#r.getRootLayersProps();if(e){var i=this.#t.scrollTop;this.#u(e),this.#m(e,t),this.#t.scrollTop=i}this.#a.updateLayerSpecificWebAppHandler()}#y(){var t=document.getElementById("layerListOpenButton");console.log("layerListOpenClose"),this.#t=document.getElementById("layerTableDiv"),this.#e.style.height==this.#h+"px"?(this.#c(),this.#e.style.height=this.#n,t.firstChild.src=e.UTpng,this.#t.style.display="",this.#i=!0):(this.#e.style.height=this.#h+"px",t.firstChild.src=e.DTpng,this.#t.style.display="none",this.#i=!1)}#v(e){var t;return this.#s[e]?t=this.#s[e]:(t=!1,this.#s[e]=t),t}#m(e,t){var i,s=new Object,r=0,a=[];for(var o=(i=i?t:this.#r.getRootLayersProps()).length-1;o>=0;o--){var n=this.#f(i[o].title,i[o].id,i[o].visible,!1,i[o].groupName);if(i[o].groupName){var l=this.#v(i[o].groupName);if(s[i[o].groupName]){var h=s[i[o].groupName];l||e.insertBefore(n,h.nextSibling),s[i[o].groupName]=n}else{var g=this.#b(i[o],l);e.appendChild(g),s[i[o].groupName]=n,l||e.appendChild(n)}i[o].visible&&this.#I(i[o].groupName)}else e.appendChild(n);i[o].visible&&(++r<=5?a.push(i[o].title):6==r&&a.push("..."))}document.getElementById("layerListmessage").innerHTML=this.#g+r+this.#d,document.getElementById("layerListmessage").title=a,window.setTimeout(function(){this.#P()}.bind(this),30)}#S(e,t){this.#g=e,this.#d=t}#P(){var e=document.getElementById("layerTable").offsetHeight;0!=e&&(e<this.#l-this.#h-2?(this.#e.style.height=e+this.#h+2+"px",console.log("reorder:",this.#e.style.height)):this.#e.style.height=this.#n)}#I(e){var t=document.getElementById("gc_"+e).childNodes.item(0),i=Number(t.nodeValue)+1;t.nodeValue=i}#f(t,i,s,r,a){var o=document.createElement("tr");o.id="layerList_"+i,a?(o.dataset.group=a,o.className="layerItem"):o.className="layerItem noGroup";var n="cb_"+i,l="bt_"+i,h=document.createElement("td"),g=document.createElement("input");g.className="layerCheck",g.type="checkBox",g.id=n,s&&(g.checked=!0,o.style.fontWeight="bold"),g.addEventListener("change",function(e){this.#M(e)}.bind(this)),h.appendChild(g),o.appendChild(h);var d=document.createElement("td");d.setAttribute("colspan","3"),d.style.overflow="hidden";var p=document.createElement("label");p.title=t,p.setAttribute("for",n),p.className="layerLabel",p.innerHTML=t,d.appendChild(p),o.appendChild(d);var c=document.createElement("td"),u=document.createElement("button");return u.innerHTML="<img style='pointer-events: none;' src='"+e.RTpng+"'>",u.className="layerUiButton",u.id=l,u.addEventListener("click",function(e){var t=this.#w(e),i=e.target.dataset.url;this.#a.showLayerSpecificUI(t,i)}.bind(this),!1),u.disabled=!s,r||(u.style.visibility="hidden"),c.appendChild(u),o.appendChild(c),o}#x(e,t){console.log("setLayerSpecificWebAppLaunchUiEnable:",e);var i=document.getElementById("bt_"+e);i?(i.style.visibility="visible",i.dataset.url=t):console.log("Could not find launcher button: setLayerSpecificWebAppLaunchUiEnable:",e)}#b(t,i){var s=document.createElement("tr");s.dataset.group=t.groupName,s.className="groupItem",s.style.width="100%",s.id="gtr_"+t.groupName;var r=document.createElement("td");r.style.fontWeight="bold",r.setAttribute("colspan","3"),r.className="groupLabel",r.style.overflow="hidden";var a=document.createElement("label");a.title=t.groupName;var o="gb_"+t.groupName;a.setAttribute("for",o);var n=document.createTextNode("["+t.groupName+"]");a.appendChild(n),r.appendChild(a);var l=document.createElement("td");l.className="groupLabel",l.align="right";var h=document.createElement("label");h.id="gc_"+t.groupName,h.setAttribute("for",o);var g=document.createTextNode("0");h.appendChild(g),l.appendChild(h);var d="";if("batch"==t.groupFeature){r.setAttribute("colspan","2");var p=document.createElement("td");d="ba_"+t.groupName;var c=document.createElement("input");c.type="checkBox",c.id=d,c.addEventListener("change",function(e){this.#C(e)}.bind(this),!1),p.appendChild(c),t.visible&&(c.checked="true"),s.appendChild(r),s.appendChild(l),s.appendChild(p)}else s.appendChild(r),s.appendChild(l);var u=document.createElement("td"),m=document.createElement("button");return m.id=o,m.addEventListener("click",function(e){this.#L(e)}.bind(this),!1),m.innerHTML=i?"<img style='pointer-events: none;' src='"+e.DTpng+"'>":"<img style='pointer-events: none;' src='"+e.UTpng+"'>",u.appendChild(m),s.appendChild(u),s}#u(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t]);e.appendChild(this.#E())}#w(e){return console.log(e),e.target.id.substring(3)}#M(e){var t=this.#w(e);console.log("this:",this),this.#r.setRootLayersProps(t,e.target.checked,!1),this.#r.refreshScreen()}#C(e){for(var t=this.#w(e),i=this.#r.getSwLayers("batch"),s="hidden",r=0;r<i[t].length;r++)if("hidden"==i[t][r].getAttribute("visibility")){s="visible";break}for(r=0;r<i[t].length;r++)i[t][r].setAttribute("visibility",s);this.#c(),this.#r.refreshScreen()}#p(t){var s;if(this.#s=new Object,this.#e=document.getElementById("layerList"),this.#e){this.#e.addEventListener("wheel",function(e){i.MouseWheelListenerFunc(e)}.bind(this),!1),this.#e.addEventListener("mousewheel",function(e){i.MouseWheelListenerFunc(e)}.bind(this),!1),this.#e.addEventListener("DOMMouseScroll",function(e){i.MouseWheelListenerFunc(e)}.bind(this),!1),this.#e.style.zIndex="20",this.#n=this.#e.style.height;var r=this.#r.getRootLayersProps(),a=0,o=[];const t=5;for(var n=r.length-1;n>=0;n--)r[n].visible&&(++a<=t?o.push(r[n].title):a==t+1&&o.push("..."));s=document.createElement("div");var l=document.createElement("label");l.id="layerListmessage",l.setAttribute("for","layerListOpenButton"),l.setAttribute("title",o),s.appendChild(l);var h=document.createElement("button");h.id="layerListOpenButton",h.innerHTML="<img style='pointer-events: none;' src='"+e.DTpng+"'>",h.style.position="absolute",h.style.right="0px",h.addEventListener("click",function(e){this.#y(e)}.bind(this)),s.appendChild(h);var g=this.#e.getAttribute("data-customizer");if(g){var d=document.createElement("img");d.src=e.hamburger,d.style.position="absolute",d.style.right="35px",d.style.cursor="pointer",s.appendChild(d),d.addEventListener("click",function(e){this.#o=window.open(g,"layersCustomizer","toolbar=yes,menubar=yes,scrollbars=yes")}.bind(this))}this.#e.appendChild(s);var p=document.createElement("div");this.#t=p,p.id="layerTableDiv",p.style.width="100%",p.style.height="100%",p.style.overflowY="scroll",p.style.display="none",this.#e.appendChild(p);var c=document.createElement("table");c.id="layerTable",c.setAttribute("border","0"),c.style.width="100%",c.style.tableLayout="fixed",c.style.whiteSpace="nowrap",c.appendChild(this.#E()),p.appendChild(c),l.innerHTML=this.#g+a+this.#d}window.setTimeout(function(e){this.#A(e)}.bind(this),30,s)}#A(e){e&&(this.#h=e.offsetHeight,this.#e.offsetHeight<60&&(this.#n="90%"),this.#l=this.#e.offsetHeight,this.#e.style.height=this.#h+"px")}#E(){var e=document.createElement("colgroup"),t=document.createElement("col");t.setAttribute("spanr","1"),t.style.width="25px";var i=document.createElement("col");i.setAttribute("spanr","1");var s=document.createElement("col");s.setAttribute("spanr","1"),s.style.width="25px";var r=document.createElement("col");r.setAttribute("spanr","1"),r.style.width="25px";var a=document.createElement("col");return a.setAttribute("spanr","1"),a.style.width="30px",e.appendChild(t),e.appendChild(i),e.appendChild(s),e.appendChild(r),e.appendChild(a),e}#L(e){var t=this.#w(e);this.#s[t]?this.#s[t]=!1:this.#s[t]=!0,this.#c()}setLayerListmessage(...e){return this.#S(...e)}setLayerSpecificWebAppLaunchUiEnable(...e){return this.#x(...e)}getLayersCustomizer=function(){return this.#o}.bind(this)}class r{#r;#T;#O;#R;#k;#B;constructor(e,t){this.#T=t,this.#r=e,this.#T&&(this.#O=new this.#T.io.GeoJSONReader,this.#R=new this.#T.io.GeoJSONWriter,this.#k=function(e){if("MultiLineString"==e.type)for(var t=e.coordinates.length-1;t>=0;t--)e.coordinates[t].length<2&&e.coordinates.splice(t,1);else if("Polygon"==e.type)for(t=e.coordinates.length-1;t>=0;t--)e.coordinates[t].length<3&&e.coordinates.splice(t,1);return this.#O.read(e)}.bind(this),this.#B=function(e){return this.#R.write(e)}.bind(this))}#G(e,t){for(var i=e[0],s=e[1],r=!1,a=0,o=t.length-1;a<t.length;o=a++){var n=t[a][0],l=t[a][1],h=t[o][0],g=t[o][1];l>s!=g>s&&i<(h-n)*(s-l)/(g-l)+n&&(r=!r)}return r}#V(e,t){var i=this.#G(e,t[0]);if(i&&t.length>1)for(var s=1;s<t.length;s++)if(this.#G(e,t[s])){i=!1;break}return i}#N(e,t,i,s,r,a,o,n){return((e-i)*(a-t)+(t-s)*(e-r))*((e-i)*(n-t)+(t-s)*(e-o))<0&&((r-o)*(t-a)+(a-n)*(r-e))*((r-o)*(s-a)+(a-n)*(r-i))<0}#D(e,t,i,s,r,a,o,n,l){var h={pointsDocTreeID:e,polygonsDocTreeID:t,cbFunc:i,param:s,progrssCallback:r,inverse:a,pointOnly:o,getIncludedPolygonAttr:n},g=e,d=t;console.log("called getIncludedPoints:",g,d),l?(console.log("getIncludedPoints: USE preCapturedGeometry"),this.#U(l,h)):this.#r.captureGISgeometries(this.#U,h)}#F(e,t,i,s,r,a){this.#D(e,t,i,s,r,!0,a)}#H(e){for(var t=6e4,i=6e4,s=-6e4,r=-6e4,a=0;a<e.length;a++)for(var o=0;o<e[a].length;o++)e[a][o][0]<t&&(t=e[a][o][0]),e[a][o][0]>s&&(s=e[a][o][0]),e[a][o][1]<i&&(i=e[a][o][1]),e[a][o][1]>r&&(r=e[a][o][1]);return[(t+s)/2,(i+r)/2]}#j(e,t){var i=t.pointsDocTreeID,s=t.polygonsDocTreeID,r=t.cbFunc,a=t.param;t.progrssCallback;var o=t.inverse;console.log("Searched geom:",e),o&&1==o||(o=!1);for(var n=this.#z(i,s),l=n.childrenId1,h=n.childrenId2,g=0,d=new Array,p=0;p<l.length;p++)if(e[l[p]]){var c=e[l[p]];console.log("poi:",c),g+=c.length;for(var u=0;u<c.length;u++){var m;if("Point"===c[u].type)m=c[u].coordinates;else{if("Polygon"!==c[u].type&&"MultiLineString"!==c[u].type)continue;console.log(c[u]),m=this.#H(c[u].coordinates)}e:for(var y=0;y<h.length;y++)if(e[h[y]]){var v=e[h[y]];console.log("pol:",v);for(var f=0;f<v.length;f++)if("Polygon"==v[f].type)if(polygon=v[f].coordinates,o){if(this.#V(m,polygon))break e;f==v.length-1&&d.push(c[u])}else if(this.#V(m,polygon)){d.push(c[u]);break e}}}}r(d,g,a)}#U=function(e,t){console.log("getIncludedPointsS2a called : ",e);var i=this.#z(t.pointsDocTreeID);t.pointsDocTreeIDs=i;var s=this.#z(t.polygonsDocTreeID);t.polygonsDocTreeIDs=s;var r=0;new Array;for(var a=[],o=0;o<i.length;o++)if(e[i[o]]){var n=e[i[o]];r+=n.length;for(var l=0;l<n.length;l++)for(var h=0;h<s.length;h++)if(e[s[h]])for(var g=e[s[h]],d=0;d<g.length;d++)a.push([o,l,h,d])}t.totalPoiCount=r,this.#W(e,t,a)}.bind(this);#W(e,t,i,s,r,a){for(s||(r=(new Date).getTime(),a=[],s=0);s<i.length&&0==this.#Y;){var o,n=i[s][0],l=e[t.pointsDocTreeIDs[n]],h=i[s][1];if("Point"===l[h].type)o=l[h].coordinates;else{if(t.pointOnly||"Polygon"!==l[h].type&&"MultiLineString"!==l[h].type){s=this.#X(i,s),++s;continue}o=this.#H(l[h].coordinates)}var g=i[s][2],d=e[t.polygonsDocTreeIDs[g]],p=i[s][3];if("Polygon"==d[p].type){var c=d[p].coordinates;if(t.inverse?this.#V(o,c)?s=this.#X(i,s):p==d.length-1&&(console.log("PUSH"),a.push(l[h])):this.#V(o,c)&&(t.getIncludedPolygonAttr&&(l[h].includedPolygonAttr=d[p].src.getAttribute("content")),a.push(l[h]),s=this.#X(i,s)),++s,(new Date).getTime()-r>500){console.log("call laze compu",s,i.length,Math.ceil(s/i.length)),t.progrssCallback&&t.progrssCallback(Math.ceil(1e3*s/i.length)/10),r=(new Date).getTime(),setTimeout(getIncludedPointsS3.bind(this),20,e,t,i,s,r,a);break}}else t.inverse&&p==d.length-1&&a.push(l[h]),++s}this.#Y=!1,s==i.length&&(t.progrssCallback&&t.progrssCallback(100),console.log("Completed!",a),t.cbFunc(a,t.totalPoiCount,t.param))}#X(e,t){for(var i=t,s=e[t][1],r=e[t][0],a=s,o=r;a==s&&o==r&&++i!=e.length;)a=e[i][1],o=e[i][0];return i-1}#Z(e,t,i,s,r,a,o,n,l,h,g){return g||(g={}),g.processMode="difference",this.#q(e,t,i,s,r,a,o,n,l,h,g)}#q(e,t,i,s,r,a,o,n,l,h,g){var d="intersection",p="resultGroup",c=1;this.#Y=!1,g?.processMode&&(d=g.processMode),g?.resultGroupId&&(p=g.resultGroupId),g?.opacity&&(c=g.opacity);var u=this.#r.getSvgImages()[i],m=u.getElementById(p);m||((m=u.createElement("g")).setAttribute("id",p),u.documentElement.appendChild(m)),m.setAttribute("opacity",c);var y={sourceId1:e,sourceId2:t,targetId:i,strokeColor:s,strokeWidth:r,fillColor:a,progrssCallback:o,addMetadata:n,getResultAsGeoJsonCallback:l,getResultAsGeoJsonCallbackParam:h,processMode:d,resultGroup:m,areaComp:g?.areaCompare,uniteOptions:{source1:g?.uniteSource1,source2:g?.uniteSource2}};return o&&o(0),this.#r.captureGISgeometriesOption(!1,!0),"intersection"==y.processMode?this.#r.captureGISgeometries(this.#K,y):"difference"==y.processMode&&this.#r.captureGISgeometries(this.#J,y),m}#_(e,t){for(var i=0,s=0;s<e.length;s++){var r=t[e[s]];if(r&&r.length>0)for(var a=0;a<r.length;a++){var o=r[a].coordinates;if(o[0].length)for(var n=0;n<o.length;n++)i+=o[n].length;else i+=o.length}}return console.log(i),i}#Q(e,t){var i=this.#r.getSvgImagesProps(),s=[],r=[];for(var a in i)e===i[a].rootLayer?s.push(a):t===i[a].rootLayer&&r.push(a);return{childrenId1:s,childrenId2:r}}#z(e){var t,i=this.#r.getSvgImagesProps();return t=[e],this.#$(i[e],t,i),t}#$(e,t,i){if(e)for(var s in e.childImages)t.push(s),this.#$(i[s],t,i)}#J=function(e,t,i,s,r,a,o,n,l,h){var g=(new Date).getTime(),d=0;if(o)d=s;else{i=0,s=0;var p=this.#r.getSvgImages();this.#r.getSvgImagesProps();var c=this.#z(t.sourceId1),u=this.#z(t.sourceId2);r=[];for(var m=0;m<c.length;m++)e[c[m]]&&(r=r.concat(e[c[m]]));a=[];for(m=0;m<u.length;m++)e[u[m]]&&(a=a.concat(e[u[m]]));o=[],t.metaSchema=this.#ee(p[t.sourceId1]),t.areaComp&&t.metaSchema.push("areaRatio")}var y=new this.#T.geom.PrecisionModel(1e6);e:for(m=i;m<r.length;m++){if(0==d){console.log("Seed feartureA:",r[m]);var v=this.#k(r[m]);try{v=this.#T.simplify.DouglasPeuckerSimplifier.simplify(v,1e-5),v=this.#T.precision.GeometryPrecisionReducer.reduce(v,y)}catch(e){continue}t.areaComp&&(h=v.getArea()),n=v,t.addMetadata&&(l=r[m].src.getAttribute("content"))}for(d=s;d<a.length;d++){var f=this.#k(a[d]);try{f=this.#T.simplify.DouglasPeuckerSimplifier.simplify(f,1e-5),f=this.#T.precision.GeometryPrecisionReducer.reduce(f,y);var b=n.difference(f);b&&(n=this.#T.simplify.DouglasPeuckerSimplifier.simplify(b,1e-5),n=this.#T.precision.GeometryPrecisionReducer.reduce(n,y))}catch(e){continue}if((new Date).getTime()-g>300){t.progrssCallback&&t.progrssCallback(Math.ceil((m*a.length+d)/(a.length*r.length)*1e3)/10);var I=d+1,P=m;if(I==a.length&&(n&&o.push(this.#B(n)),I=0,(P=m+1)==r.length))break e;if(1==this.#Y)break e;return void setTimeout(this.#J.bind(this),20,e,t,P,I,r,a,o,n,l,h)}}if(d=0,s=0,n)try{var S=this.#B(n);this.#te(S)&&(t.addMetadata&&(S.properties=this.#ie(l,null,t.metaSchema),t.areaComp&&(S.properties.areaRatio=n.getArea()/h)),o.push(S))}catch(e){console.warn("Could not build geoJson skip :",n)}}this.#Y=!1,this.#se(o,t)}.bind(this);#re(e){var t=[];for(var i of e)if("Polygon"==i.type){var s=this.#O.read(i);t.push(s)}else console.warn("not polygon skip this geometry");var r=(new this.#T.geom.GeometryFactory).createMultiPolygon(t);return r=r.union(),this.#R.write(r)}#ae=function(e,t){console.log("called buildIntersectionS2a:",e,t),this.#r.getSvgImages(),this.#r.getSvgImagesProps();for(var i=this.#z(t.sourceId1),s=this.#z(t.sourceId2),r=[],a=0;a<i.length;a++)e[i[a]]&&(r=r.concat(e[i[a]]));var o=[];for(a=0;a<s.length;a++)e[s[a]]&&(o=o.concat(e[s[a]]));console.log("buffered srcgem1:",r,"  srcgem2:",o);var n,l=this.#k(buildGeoJsonGeometryCollectionFromGeometryArray(r)),h=this.#k(buildGeoJsonGeometryCollectionFromGeometryArray(o)),g=this.#T.precision.GeometryPrecisionReducer;switch(l=this.#T.simplify.DouglasPeuckerSimplifier.simplify(l,1e-5),h=this.#T.simplify.DouglasPeuckerSimplifier.simplify(h,1e-5),console.log("buffered jstsFeature1:",l,"  jstsFeature2:",h),l=g.reduce(l,new this.#T.geom.PrecisionModel(1e6)),h=g.reduce(h,new this.#T.geom.PrecisionModel(1e6)),console.log("GeometryPrecisionReducer:",g),t.processMode){case"intersection":default:n=l.intersection(h);break;case"difference":n=l.difference(h);break;case"union":n=l.union(h);break;case"symDifference":n=l.symDifference(h)}var d=this.#B(n);console.log("intersection:",d),t.getResultAsGeoJsonCallback&&(t.getResultAsGeoJsonCallbackParam?t.getResultAsGeoJsonCallback(d,t.getResultAsGeoJsonCallbackParam):t.getResultAsGeoJsonCallback(d)),(t.strokeColor||t.strokeWidth||t.fillColor)&&(this.#oe(d,t.targetId,t.strokeColor,t.strokeWidth,t.fillColor,"p0","poi",null,t.resultGroup),this.#r.refreshScreen())}.bind(this);#ne(e){for(var t={type:"FeatureCollection",features:[]},i=0;i<e.length;i++){var s={type:"Feature"};s.geometry=e[i],t.features.push(s)}return t}#le(e){var t={type:"GeometryCollection"};return t.geometries=e,t}#ee(e){var t=e.documentElement.getAttribute("property");return t?t.split(","):[]}#K=function(e,t){console.log("called buildIntersectionS2:",e,t);var i=this.#r.getSvgImages();this.#r.getSvgImagesProps();var s,r,a=this.#z(t.sourceId1),o=this.#z(t.sourceId2);if(t.uniteOptions.source1){for(var n=[],l=0;l<a.length;l++)e[a[l]]&&(n=n.concat(e[a[l]]));if(a=[a[0]],n.length>0){var h=n[0].src;(n=this.#re(n)).src=h,e[a[0]]=[n]}else e[a[0]]=[];console.log("unitedSrc1:",e[a[0]])}if(t.uniteOptions.source2){var g=[];for(l=0;l<o.length;l++)e[o[l]]&&(g=g.concat(e[o[l]]));if(o=[o[0]],g.length>0){h=g[0].src;(g=this.#re(g)).src=h,e[o[0]]=[g]}else e[o[0]]=[];console.log("unitedSrc2:",e[o[0]])}console.log("source1IDs:",a,"\nsource2IDs:",o),i[t.targetId];var d=[];if(this.#_(a,e)<this.#_(o,e)){if(s=a,r=o,t.addMetadata){var p=(d=this.#ee(i[t.sourceId1])).length,c=(d=d.concat(this.#ee(i[t.sourceId2]))).length-p;t.areaComp&&(d.push(`areaRatio1(${0==p?"-":"0-"+(p-1)})`),d.push(`areaRatio2(${0==c?"-":p+"-"+(p+c-1)})`))}t.sourceAlternated=!1}else{if(s=o,r=a,t.addMetadata){p=(d=this.#ee(i[t.sourceId2])).length,c=(d=d.concat(this.#ee(i[t.sourceId1]))).length-p;t.areaComp&&(d.push(`areaRatio1(${0==c?"-":p+"-"+(p+c-1)})`),d.push(`areaRatio2(${0==p?"-":"0-"+(p-1)})`))}t.sourceAlternated=!0}t.metaSchema=d,console.log("src1IDs:",s,"src2IDs:",r);var u=[];for(l=0;l<s.length;l++){var m=s[l],y=e[m];if(y&&y.length>0)for(var v=0;v<y.length;v++){var f=y[v];if(f){var b=this.#k(f),I={feature:b=this.#T.simplify.DouglasPeuckerSimplifier.simplify(b,1e-5),docId:m,geomIndex:v};t.areaComp&&(I.area=b.getArea()),u.push(I)}}}console.log("src1Features:",u);for(var P=[],S=0;S<r.length;S++){var M=e[r[S]];if(M&&M.length>0)for(var w=0;w<M.length;w++){if(M[w])for(var x=0;x<u.length;x++)P.push([S,w,x])}}this.#he(r,u,P,e,t)}.bind(this);#Y=!1;#ge(){console.log("HALT..."),this.#Y=!0}#te(e){var t=!1;if(e.coordinates.length>0&&(t=!0,"Polygon"==e.type)){for(var i=0,s=0;s<e.coordinates.length;s++)i+=e.coordinates[s].length;0==i&&(t=!1)}return t}#he(e,t,i,s,r,a,o,n,l){for(a||(o=(new Date).getTime(),l=[],a=0);a<i.length&&0==this.#Y;){var h,g=i[a][0],d=i[a][1],p=i[a][2],c=s[e[g]];if(0==p){var u=c[d];n=this.#k(u),n=this.#T.simplify.DouglasPeuckerSimplifier.simplify(n,1e-5),r.areaComp&&(h=n.getArea())}var m=t[p].feature;try{var y=m.intersection(n);if(y){var v=this.#B(y);if(this.#te(v)){if(r.addMetadata){var f=t[p].docId,b=t[p].geomIndex,I=s[f][b].src.getAttribute("content"),P=c[d].src.getAttribute("content");v.properties=this.#ie(I,P,r.metaSchema)}if(r.areaComp){var S=y.getArea(),M=S/t[p].area,w=S/h;r.sourceAlternated?(v.properties[r.metaSchema[r.metaSchema.length-1]]=M,v.properties[r.metaSchema[r.metaSchema.length-2]]=w):(v.properties[r.metaSchema[r.metaSchema.length-2]]=M,v.properties[r.metaSchema[r.metaSchema.length-1]]=w)}l.push(v)}}}catch(e){console.error(e)}if(++a,(new Date).getTime()-o>500){r.progrssCallback&&r.progrssCallback(Math.ceil(1e3*a/i.length)/10),o=(new Date).getTime(),setTimeout(this.#he.bind(this),30,e,t,i,s,r,a,o,n,l);break}}this.#Y=!1,a==i.length&&this.#se(l,r)}#se(e,t){t.progrssCallback&&t.progrssCallback(100);var i={};if(t.addMetadata&&(this.#r.getSvgImagesProps(),i.csvMetadataSchema=t.metaSchema.join(",")),i.type="GeometryCollection",i.geometries=e,console.log("svgmapGIS:geoJsonIntersections",i),t.getResultAsGeoJsonCallback&&(t.getResultAsGeoJsonCallbackParam?t.getResultAsGeoJsonCallback(i,t.getResultAsGeoJsonCallbackParam):t.getResultAsGeoJsonCallback(i)),t.strokeColor||t.strokeWidth||t.fillColor){var s=this.#r.getSvgImages()[t.targetId];t.addMetadata&&s.documentElement.setAttribute("property",i.csvMetadataSchema),this.#oe(i,t.targetId,t.strokeColor,t.strokeWidth,t.fillColor,"p0","poi",null,t.resultGroup,i.csvMetadataSchema.split(","),{multiGeometryGrouping:!0}),this.#r.refreshScreen()}}#ie(e,t,i){var s,r;s=e?e.split(","):[],r=t?t.split(","):[];for(var a=s.concat(r),o={},n=0;n<i.length;n++)o[i[n]]=a[n];return o}#de(e,t,i,s,r,a,o,n){n||(n={}),n.targetVectorType=2,this.#pe(e,t,i,s,r,a,o,n)}#ce(e,t,i,s,r,a,o,n){n||(n={}),n.targetVectorType=1,this.#pe(e,t,i,s,r,a,o,n)}#ue(e,t,i,s,r,a,o,n){n||(n={}),n.targetVectorType=0,this.#pe(e,t,i,s,r,a,o,n)}#pe(e,t,i,s,r,a,o,n){null==n&&(n={}),null==n.targetVectorType&&(n.targetVectorType=0),n.overlappingCoverage&&"or"==n.overlappingCoverage.toLowerCase()&&(n.splitByCoverage=!0,n.overlappingCoverage="or"),this.#Y=!1;var l={coverageDocTreeID:t,cbFunc:s,param:r,progrssCallback:a,range:this.#me(i),targetType:n.targetVectorType,computingOptions:n,pixDataBuffer:[]};Array.isArray(e)?(l.points=e,console.log("called getInRangePoints: poi.len,cover:",e.length,t,"  range:",l.range)):(l.pointsDocTreeID=e,console.log("called getInRangePoints: poi,cover:",e,t,"  range:",l.range)),this.#r.captureGISgeometriesOption(!0),o?(console.log("getInRangePoints: USE preCapturedGeometry"),this.#ye(o,l)):this.#r.captureGISgeometries(this.#ye,l)}#me(e){var t={hue:[[0,360]],satulation:[[10,100]],value:[[10,100]],alpha:[[10,100]]};return e&&(e.hue?(t.hue=this.#ve(e.hue),e.satulation&&(t.satulation=this.#ve(e.satulation)),e.value&&(t.value=this.#ve(e.value)),e.alpha&&(t.alpha=this.#ve(e.alpha)),e.outOfBoundsColor&&(t.outOfBoundsColor=e.outOfBoundsColor)):e.length&&e.length>0&&(t.hue=this.#ve(e))),t}#ve(e){var t=[];return null!=e[0][0]?t=e:t[0]=e,console.log("rangeVal:",e,"  normalized nRangeVal:",t),t}#fe(e){for(var t=1e30,i=-1e30,s=1e30,r=-1e30,a=0;a<e.length;a++)if("point"==e[a].type.toLowerCase())e[a].coordinates[0]>i&&(i=e[a].coordinates[0]),e[a].coordinates[0]<t&&(t=e[a].coordinates[0]),e[a].coordinates[1]>r&&(r=e[a].coordinates[1]),e[a].coordinates[1]<s&&(s=e[a].coordinates[1]);else for(var o=0;o<e[a].coordinates.length;o++)for(var n=0;n<e[a].coordinates[o].length;n++){var l=e[a].coordinates[o][n];l[0]>i&&(i=l[0]),l[0]<t&&(t=l[0]),l[1]>r&&(r=l[1]),l[1]<s&&(s=l[1])}return{xmin:t,ymin:s,xmax:i,ymax:r,x:t,y:s,width:i-t,height:r-s}}#ye=function(e,t){var i=[],s=[];e||console.log("processing conflict?? exit");var r=this.#r.getSvgImagesProps();for(var a in t.points&&(i=t.points),e)if(t.pointsDocTreeID&&r[a].rootLayer==t.pointsDocTreeID)for(var o=0;o<e[a].length;o++)0==t.computingOptions.targetVectorType?"Point"==e[a][o].type&&i.push(e[a][o]):1==t.computingOptions.targetVectorType?"MultiLineString"==e[a][o].type&&i.push(e[a][o]):2==t.computingOptions.targetVectorType&&"Polygon"==e[a][o].type&&i.push(e[a][o]);else if(r[a].rootLayer==t.coverageDocTreeID)for(o=0;o<e[a].length;o++)"Coverage"==e[a][o].type&&s.push(e[a][o]);console.log("targetCoverages:",s,"  targetGeoms.length:",i.length),t.targetGeomsBbox=this.#fe(i),console.log("targetGeomsBbox:",t.targetGeomsBbox),t.targetGeoms=i,t.targetCoverages=s,t.coverageIndex=this.#be(t.targetCoverages,t.targetGeomsBbox,-1),t.ans=[],t.progrssCallback&&t.progrssCallback(0);var n=t.targetCoverages[t.coverageIndex];if(this.#Ie=0,this.#Pe=0,this.#Se=Date.now(),console.log("getImagePixData B:",n,"   superParam.coverageIndex:",t.coverageIndex),n&&n.href){var l=n.href;this.#Me(l,this.#we,t,n.src.getAttribute("iid"),n.src.getAttribute("style"))}else this.#Y=!1,t.cbFunc(t.ans,t.param)}.bind(this);#Ie;#Pe;#Se;#be(e,t,i){for(var s=i+1,r=!1;0==r;){var a=e[s];if(s==e.length)return s;a.geoExtent||this.#xe(a),a.geoExtent[0]<=t.ymax&&t.ymin<=a.geoExtent[1]&&a.geoExtent[2]<=t.xmax&&t.xmin<=a.geoExtent[3]?r=!0:(r=!1,++s)}return s}#xe(e){var t,i,s,r;if(e.coordinates[0].lat)t=Math.min(e.coordinates[0].lat,e.coordinates[1].lat),i=Math.max(e.coordinates[0].lat,e.coordinates[1].lat),s=Math.min(e.coordinates[0].lng,e.coordinates[1].lng),r=Math.max(e.coordinates[0].lng,e.coordinates[1].lng),e.geoExtent=[t,i,s,r];else{var a=e.transform,o=e.coordinates[0],n=e.coordinates[1],l=this.#r.transform(o.x,o.y,a),h=this.#r.transform(n.x,n.y,a);t=Math.min(l.y,h.y),i=Math.max(l.y,h.y),s=Math.min(l.x,h.x),r=Math.max(l.x,h.x),e.geoExtent=[t,i,s,r],e.geo2svg=this.#r.getInverseMatrix(a)}}#we=function(e,t,i,s){s.pixDataBuffer[s.coverageIndex]=e;var r=Date.now();this.#Ie+=r-this.#Se,this.#Se=r;for(var a=0;a<s.targetGeoms.length;a++){var o=s.targetGeoms[a].coordinates;if(1==s.computingOptions.targetVectorType)for(var n=0;n<o.length;n++)this.#Ce(e,t,i,o[n],s);else if(2==s.computingOptions.targetVectorType)for(n=0;n<o.length;n++)this.#Le(e,t,i,o[n],s);else if(0==s.computingOptions.targetVectorType){var l=this.#Ee(s.targetCoverages[s.coverageIndex]);if(l.lngMin<=o[0]&&l.lngMax>o[0]&&l.latMin<=o[1]&&l.latMax>o[1]){var h=this.#Ae(t,i,o[0],o[1],s.targetCoverages[s.coverageIndex],l),g=4*(h.x+h.y*t),d=e[g],p=e[g+1],c=e[g+2],u=e[g+3];if(this.#Te(100*u/255,s.range.alpha)){var m=this.#Oe(d,p,c);this.#Te(m.h,s.range.hue,!0)&&this.#Te(m.s,s.range.satulation)&&this.#Te(m.v,s.range.value)&&(m.a=u,m.r=d,m.g=p,m.b=c,s.targetGeoms[a].hsv=m,s.ans.push(s.targetGeoms[a]))}}}}if(s.coverageIndex=this.#be(s.targetCoverages,s.targetGeomsBbox,s.coverageIndex),s.progrssCallback&&s.progrssCallback(Math.ceil(s.coverageIndex/s.targetCoverages.length*100)),1==this.#Y||s.coverageIndex==s.targetCoverages.length)this.#Y=!1,console.log("Processing overhead[ms]: fileFetch:",this.#Ie,"  computing:",this.#Pe,"   comp.Ratio[%]:",Math.floor(1e4*this.#Pe/(this.#Pe+this.#Ie))/100),1==s.computingOptions.splitByCoverage?2==s.computingOptions.targetVectorType?this.#Re(s):1==s.computingOptions.targetVectorType?this.#ke(s):this.#Be(s):s.cbFunc(s.ans,s.param);else{var y=s.targetCoverages[s.coverageIndex];if(r=Date.now(),this.#Pe+=r-this.#Se,this.#Se=r,y&&y.href){var v=y.href;this.#Me(v,this.#we,s,y.src.getAttribute("iid"),y.src.getAttribute("style"))}else this.#Y=!1,s.cbFunc(s.ans,s.param)}}.bind(this);#Ge(e){var t=e%360;return t<0&&(t+=360),t}#Te(e,t,i){if(!t)return!0;for(var s=0;s<t.length;s++)if(i){if(t[s][0]<=0&&t[s][1]>=360)return!0;var r=this.#Ge(t[s][0]),a=this.#Ge(t[s][1]);if(r>a){if(r<=e&&e<=360||0<=e&&e<=a)return!0}else if(r<=e&&e<=a)return!0}else if(t[s][0]<=e&&e<=t[s][1])return!0;return!1}#Ve=100;#Ne=[];#De=[];#Ue=!1;#Fe(e,t){if(this.#Ne[e]=t,this.#De.push(e),this.#De.length==this.#Ve){var i=this.#De.shift();delete this.#Ne[i]}}#He(){this.#Ue=!0,this.#Ne=[],this.#De=[]}#je(){this.#Ue=!1,this.#Ne=[],this.#De=[]}#Me(e,t,i,s,r){var a,o,n=this.#ze(e,!0),l=n.url;if(this.#Ue&&this.#Ne[l])this.#We(this.#Ne[l],t,i,r);else if(0!=(o="layerCanvasImage"==s?"http":(a=document.getElementById(s)).getAttribute("src")).indexOf("http")||this.#ze(o)==o)this.#We(a,t,i,r),this.#Ue&&this.#Fe(l,a);else{var h=new Image;n.crossorigin&&(h.crossOrigin="anonymous"),h.src=l,h.onload=function(){this.#We(h,t,i,r),this.#Ue&&this.#Fe(l,h)}.bind(this)}}#We(e,t,i,s){var r=document.createElement("canvas");r.width=e.naturalWidth,r.height=e.naturalHeight;var a=r.getContext("2d");a.mozImageSmoothingEnabled=!1,a.webkitImageSmoothingEnabled=!1,a.msImageSmoothingEnabled=!1,a.imageSmoothingEnabled=!1,this.#Ye(a,s),a.drawImage(e,0,0),t(a.getImageData(0,0,r.width,r.height).data,r.width,r.height,i)}#Ye(e,t){if(t){var i=t.match(/filter:([^;]+);/);i&&(console.log("applyFilter:",i),e.filter=i[1].trim())}}#Ce(e,t,i,s,r){var a=r.targetCoverages[r.coverageIndex],o=this.#Ee(a),n=this.#Xe(s);if(this.#r.isIntersect(n,o))for(var l=this.#Ze(s,o),h=this.#qe(t,i,o),g=0;g<l.length-1;g++)if(1!=l[g+1].clippedEdge)for(var d=l[g],p=l[g+1],c=this.#Ae(t,i,d.x,d.y,a,o),u=this.#Ae(t,i,p.x,p.y,a,o),m=this.#Ke([c.x,c.y],[u.x,u.y]),y=0;y<m.length;y++){var v=this.#Je(m[y][0],m[y][1],t,i,e,r.range),f=this.#_e(t,i,m[y][0],m[y][1],a,o);v.inBounds&&(1==r.computingOptions.splitByCoverage?(r.ans[r.coverageIndex]||(r.ans[r.coverageIndex]=[],r.ans[r.coverageIndex].extent=o,r.ans[r.coverageIndex].pixSize=h),r.ans[r.coverageIndex].push({coordinates:[f.longitude,f.latitude],color:v.color,inRange:v.inRange})):r.ans.push({coordinates:[f.longitude,f.latitude],color:v.color,inRange:v.inRange}))}}#Le(e,t,i,s,r){var a=r.targetCoverages[r.coverageIndex],o=this.#Ee(a),n=this.#Xe(s);if(this.#r.isIntersect(n,o)){for(var l=this.#qe(t,i,o),h=[],g=0;g<s.length;g++){var d=this.#Qe(t,i,s[g][0],s[g][1],a,o);h.push([d.x,d.y])}var p,c=this.#$e(h),u=0;if(!r.ans[r.coverageIndex]){p=new Array(i);for(var m=0;m<i;m++)p[m]=new Array(t).fill({});r.ans[r.coverageIndex]={},a.transform&&(r.ans[r.coverageIndex].transform=a.transform,r.ans[r.coverageIndex].coordinates=a.coordinates),r.ans[r.coverageIndex].extent=o,r.ans[r.coverageIndex].width=t,r.ans[r.coverageIndex].height=i,r.ans[r.coverageIndex].pixSize=l,r.ans[r.coverageIndex].rasterData=p,r.ans[r.coverageIndex].hasIntersection=!1,r.ans[r.coverageIndex].hasInRange=!1,r.ans[r.coverageIndex].hasOutOfRange=!1,r.ans[r.coverageIndex].inRangeCounts=0,r.ans[r.coverageIndex].outOfRangeCounts=0}p=r.ans[r.coverageIndex].rasterData;var y=!1,v=!1,f=!1,b=0,I=0;for(m=i-1;m>=0;m--)for(var P=p[m];u<c.length&&c[u][1]>=m;){if(c[u][1]==m)for(var S=c[u][0],M=Math.max(0,S[0]),w=Math.min(t-1,S[1]),x=M;x<=w;x++){var C=this.#Je(x,m,t,i,e,r.range);C.inBounds&&(P[x]=C,y=!0,C.inRange?(v=!0,++b):(f=!0,++I))}++u}v&&(r.ans[r.coverageIndex].hasInRange=!0),f&&(r.ans[r.coverageIndex].hasOutOfRange=!0),y&&(r.ans[r.coverageIndex].hasIntersection=!0),r.ans[r.coverageIndex].inRangeCounts=b,r.ans[r.coverageIndex].outOfRangeCounts=I}}#Je(e,t,i,s,r,a){if(e<0||t<0||e>=i||t>=s)return{color:null,inRange:!1,inBounds:!1};var o=4*(e+t*i),n=r[o],l=r[o+1],h=r[o+2],g=r[o+3];if(a.outOfBoundsColor&&n==a.outOfBoundsColor.r&&l==a.outOfBoundsColor.g&&h==a.outOfBoundsColor.b)return{color:null,inRange:!1,inBounds:!1};var d=this.#Oe(n,l,h);return d.a=g,d.r=n,d.g=l,d.b=h,this.#Te(100*g/255,a.alpha)&&this.#Te(d.h,a.hue,!0)&&this.#Te(d.s,a.satulation)&&this.#Te(d.v,a.value)?{color:d,inRange:!0,inBounds:!0}:{color:d,inRange:!1,inBounds:!0}}#Ze(e,t){for(var i=[],s=0;s<e.length;s++){var r={x:e[s][0],y:e[s][1],clippedEdge:!1};0==s&&(r.clippedEdge=!0),i.push(r)}return this.#et(i,t)}#Xe(e){for(var t=1e30,i=1e30,s=-1e30,r=-1e30,a=0;a<e.length;a++){var o=e[a];o[0]>s&&(s=o[0]),o[0]<t&&(t=o[0]),o[1]>r&&(r=o[1]),o[1]<i&&(i=o[1])}return{x:t,y:i,width:s-t,height:r-i}}#Ee(e){var t=e.geoExtent[0],i=e.geoExtent[1],s=e.geoExtent[2],r=e.geoExtent[3];return{latMin:t,latMax:i,lngMin:s,lngMax:r,x:s,y:t,width:r-s,height:i-t}}#tt(e,t){return this.#r.isIntersect(e,t)}#qe(e,t,i){return(i.width/e+i.height/t)/2}#Ae(e,t,i,s,r,a){let o=this.#Qe(e,t,i,s,r,a);return{x:Math.floor(o.x),y:Math.floor(o.y)}}#Qe(e,t,i,s,r,a){var o,n;if(r.geo2svg){var l=r.geo2svg,h=r.coordinates[0],g=r.coordinates[1],d=this.#r.transform(i,s,l),p=g.x-h.x,c=g.y-h.y;o=e*(d.x-h.x)/p,n=t*(d.y-h.y)/c}else a||(a=this.#Ee(r)),o=e*(i-a.lngMin)/(a.lngMax-a.lngMin),n=t-t*(s-a.latMin)/(a.latMax-a.latMin);var u={x:o,y:n};return(o<0||n<0||o>=e||n>=t)&&(u.outOfRange=!0),u}#_e(e,t,i,s,r,a){var o,n;if(r.geo2svg){var l=r.transform,h=r.coordinates[0],g=r.coordinates[1],d=g.x-h.x,p=g.y-h.y,c=i*d/e+h.x,u=s*p/t+h.y,m=this.#r.transform(c,u,l);n=m.x,o=m.y}else a||(a=this.#Ee(r)),n=a.lngMin+(i+.5)*(a.lngMax-a.lngMin)/e,o=a.latMin+(t-s-.5)*(a.latMax-a.latMin)/t;return{latitude:o,longitude:n}}#et(e,t){var i,s,r,a,o;return i=n(i=e,l(t.x,t.y,t.x,t.y+t.height)),i=n(i,l(t.x,t.y+t.height,t.x+t.width,t.y+t.height)),i=n(i,l(t.x+t.width,t.y+t.height,t.x+t.width,t.y)),i=n(i,l(t.x+t.width,t.y,t.x,t.y));function n(e,t){var i;if(0==e.length)return e;s=[],r=[e[e.length-1].x,e[e.length-1].y];for(var n=0;n<e.length;n++)a=[e[n].x,e[n].y],o=e[n].clippedEdge,t.inside(a)&&t.inside(r)?s.push({x:a[0],y:a[1],clippedEdge:o}):!t.inside(a)&&t.inside(r)?(i=t.intersect(a,r),s.push({x:i[0],y:i[1],clippedEdge:o})):(t.inside(a)||t.inside(r))&&t.inside(a)&&!t.inside(r)&&(i=t.intersect(r,a),s.push({x:i[0],y:i[1],clippedEdge:!0}),s.push({x:a[0],y:a[1],clippedEdge:o})),r=a;return s}function l(e,t,i,s){var r=s-t,a=e-i,o=-r*e-a*t;return{inside:function(e){return r*e[0]+a*e[1]+o>0},intersect:function(e,t){var i=t[1]-e[1],s=e[0]-t[0],n=-i*e[0]-s*e[1],l=s*r-a*i;return[(a*n-s*o)/l,(i*o-r*n)/l]}}}}#Ke(e,t){var i=new Array,s=e[0],r=e[1],a=t[0],o=t[1],n=Math.abs(a-s),l=Math.abs(o-r),h=s<a?1:-1,g=r<o?1:-1,d=n-l;for(i.push([s,r]);s!=a||r!=o;){var p=d<<1;p>-l&&(d-=l,s+=h),p<n&&(d+=n,r+=g),i.push([s,r])}return i}#$e(e,t,i){let s=Math.floor(e[0][1]),r=Math.floor(e[0][1]),a=!0,o=!1,n=[],l=[];for(let t=1;t<e.length;t++)n.push(new g(e[t-1],e[t])),!a||Math.floor(e[0][0])==Math.floor(e[t][0])&&Math.floor(e[0][1])==Math.floor(e[t][1])||(a=!1),o||e[0][0]==e[t][0]||e[0][1]==e[t][1]||(o=!0);if(o&&a)return[[[Math.floor(e[0][0]),Math.floor(e[0][0])],Math.floor(e[0][1])]];for(let t=0;t<e.length;t++){let i=Math.floor(e[t][1]);i<s?s=i:i>r&&(r=i)}s<0&&(s=0);for(let e=s;e<=r+1;e++){let t=h(e),i=h(e+.5);for(let i=1;i<t.length;i+=2)Math.abs(t[i-1]-t[i])>1e-4&&t[i]>0&&(t[i-1]<0?(e>0&&l.unshift([[0,Math.floor(t[i])],e-1]),l.unshift([[0,Math.floor(t[i])],e])):(e>0&&l.unshift([[Math.floor(t[i-1]),Math.floor(t[i])],e-1]),l.unshift([[Math.floor(t[i-1]),Math.floor(t[i])],e])));for(let t=1;t<i.length;t+=2)Math.abs(i[t-1]-i[t])>1e-4&&i[t]>0&&(i[t-1]<0?l.unshift([[0,Math.floor(i[t])],e]):l.unshift([[Math.floor(i[t-1]),Math.floor(i[t])],e]))}return l;function h(e){let t=[];for(let i=0;i<n.length;i++){let s=n[i];s.isValidY(e)&&t.push(s.getX(e))}for(let e=0;e<t.length;e++)for(let i=e+1;i<t.length;i++)if(t[e]>t[i]){let s=t[e];t[e]=t[i],t[i]=s}return t}function g(e,t){this.x0=e[0],this.x1=t[0],this.y0=e[1],this.y1=t[1],this.m=(this.y1-this.y0)/(this.x1-this.x0),this.getX=function(e){if(!this.isValidY(e))throw new RangeError;return 1/this.m*(e-this.y0)+this.x0},this.isValidY=function(e){return e>=this.y0&&e<this.y1||e>=this.y1&&e<this.y0}}}#Re(e){var t=e.ans;dc=0,dc2=0;for(var i=0;i<t.length;i++)if(t[i]){var s=t[i];if(s.hasIntersection&&s.hasOutOfRange){for(var r=s.extent,a=[],o=0;o<t.length;o++)i!=o&&t[o]&&this.#tt(r,t[o].extent)&&a.push({index:o,tile:t[o]});for(var n=0;n<s.height;n++)for(var l=0;l<s.width;l++)if(s.rasterData[n][l].color&&0==s.rasterData[n][l].inRange)for(var h=s.extent.lngMin+l*(s.extent.width/s.width),g=s.extent.latMax-n*(s.extent.height/s.height),d=0;d<a.length;d++){var p=a[d].tile;if(iPx=Math.floor(p.width*(h-p.extent.lngMin)/p.extent.width),iPy=Math.floor(p.height*(p.extent.latMax-g)/p.extent.height),iPx>=0&&iPy>=0&&iPx<p.width&&iPy<p.height)if(p.rasterData[iPy][iPx].color){if(1==p.rasterData[iPy][iPx].inRange){s.rasterData[n][l]={},--s.outOfRangeCounts,++dc;break}}else if(1==this.#Je(iPx,iPy,p.width,p.height,e.pixDataBuffer[a[d].index],e.range).inRange){s.rasterData[n][l]={},--s.outOfRangeCounts,++dc,++dc2;break}}s.outOfRangeCounts<0&&(s.outOfRangeCounts=0),0==s.outOfRangeCounts&&(s.hasOutOfRange=!1)}}console.log("Number of points inranged by OR processing : ",dc,"   by backup Processing:",dc2),e.cbFunc(e.ans,e.param)}#Be(e){e.cbFunc(e.ans,e.param)}#ke(e){for(var t=e.ans,i=t.length-1;i>=0;i--)if(t[i]){for(var s=!1,r=0;r<t[i].length;r++)if(0==t[i][r].inRange){s=!0;break}t[i].hasOutOfRange=s}else t.splice(i,1);console.log("doPolylineOrComputing dsrc:",t);for(i=0;i<t.length;i++){var a=t[i];if(a.hasOutOfRange){var o=a.extent,n=[];for(r=0;r<t.length;r++)i!=r&&this.#tt(o,t[r].extent)&&n.push(t[r]);for(r=0;r<a.length;r++){if(0==(v=a[r]).inRange){for(var l=[],h=0;h<n.length;h++){var g=1e30,d=null;if(n[h].extent.lngMin<=v.coordinates[0]&&n[h].extent.lngMax>v.coordinates[0]&&n[h].extent.latMin<=v.coordinates[1]&&n[h].extent.latMax>v.coordinates[1])for(var p=0;p<n[h].length;p++){var c=n[h][p],u=(v.coordinates[0]-c.coordinates[0])*(v.coordinates[0]-c.coordinates[0])+(v.coordinates[1]-c.coordinates[1])*(v.coordinates[1]-c.coordinates[1]);u<g&&(g=u,d=c)}d&&g<(a.pixSize+n[h].pixSize)*(a.pixSize+n[h].pixSize)&&l.push(d)}for(h=0;h<l.length;h++){(d=l[h])&&1==d.inRange&&(v.inRange="mayTrue")}}}}}var m=[],y=0;for(i=0;i<t.length;i++)for(r=0;r<t[i].length;r++){var v;"mayTrue"==(v=t[i][r]).inRange?++y:m.push(v)}e.ans=m,console.log("Number of points deleted by OR processing : ",y),e.cbFunc(e.ans,e.param)}#it={};#st(e,t,i){if(this.#it={},e){if(this.#it.proxyUrl=e,this.#it.directURLlist=t||[],0==e.indexOf("http")){var s=e.substring(0,e.indexOf("/",8));this.#it.directURLlist.push(s)}this.#it.anonProxy=!!i}}#ze(e,t){return this.#it.proxyUrl?(this.#it.proxyUrl&&0==e.indexOf("http")&&(this.#rt(e)||(e=this.#it.proxyUrl+encodeURIComponent(e))),t?{url:e,anonymous:this.#it.anonProxy}:e):this.#r.getCORSURL(e,t)}#rt(e){for(var t=!1,i=0;i<this.#it.directURLlist.length;i++)if(e.indexOf(this.#it.directURLlist[i])>=0){t=!0;break}return t}#Oe(e,t,i){var s=Math.max(e,t,i),r=Math.min(e,t,i),a={h:0,s:0,v:s};return s!=r&&(s==e&&(a.h=60*(t-i)/(s-r)),s==t&&(a.h=60*(i-e)/(s-r)+120),s==i&&(a.h=60*(e-t)/(s-r)+240),a.s=(s-r)/s),a.h<0&&(a.h=a.h+360),a.h=Math.round(a.h),a.s=Math.round(100*a.s),a.v=Math.round(a.v/255*100),a}#at(e,t,i){var s={r:0,g:0,b:0};if(360==e&&(e=0),i/=100,0==(t/=100))return s.r=255*i,s.g=255*i,s.b=255*i,s;var r=Math.floor(e/60),a=i*(1-t),o=i*(1-t*(e/60-r)),n=i*(1-t*(1-(e/60-r)));switch(r){case 0:s.r=i,s.g=n,s.b=a;break;case 1:s.r=o,s.g=i,s.b=a;break;case 2:s.r=a,s.g=i,s.b=n;break;case 3:s.r=a,s.g=o,s.b=i;break;case 4:s.r=n,s.g=a,s.b=i;break;case 5:s.r=i,s.g=a,s.b=o}return s.r=Math.round(255*s.r),s.g=Math.round(255*s.g),s.b=Math.round(255*s.b),s}#ot(e,t,i){return"#"+this.#nt(e.toString(16),2)+this.#nt(t.toString(16),2)+this.#nt(i.toString(16),2)}#nt(e,t){return("0000000000"+e).slice(-t)}#oe(e,t,i,s,r,a,o,n,l,h,g){g||(g={});var d=this.#r.getSvgImages(),p=this.#r.getSvgImagesProps(),c=d[t],u=p[t].CRS,m={};if(n)for(var y in n)m[y]=n[y];if(e.metadata&&(m=e.metadata),e.properties)for(var y in e.properties)m[y]=e.properties[y];if(!e.type&&e.length>0)for(var v=0;v<e.length;v++)this.#oe(e[v],t,i,s,r,a,o,m,l,h,g);else if("FeatureCollection"==e.type){var f=e.features;for(v=0;v<f.length;v++)this.#oe(f[v],t,i,s,r,a,o,m,l,h,g)}else if("Feature"==e.type){var b=e.geometry;this.#oe(b,t,i,s,r,a,o,m,l,h,g)}else if("GeometryCollection"==e.type){var I=e.geometries;for(v=0;v<I.length;v++)this.#oe(I[v],t,i,s,r,a,o,m,l,h,g)}else if("MultiPolygon"==e.type){if(e.coordinates.length>0){var P=l;g.multiGeometryGrouping&&(P=this.#lt(l,c,e.type));for(v=0;v<e.coordinates.length;v++)this.#ht(e.coordinates[v],c,u,r,m,P,h,g)}}else if("Polygon"==e.type)this.#ht(e.coordinates,c,u,r,m,l,h,g);else if("MultiLineString"==e.type){if(e.coordinates.length>0){P=l;g.multiGeometryGrouping&&(P=this.#lt(l,c,e.type));for(v=0;v<e.coordinates.length;v++)this.#gt(e.coordinates[v],c,u,i,s,m,P,h,g)}}else if("LineString"==e.type)this.#gt(e.coordinates,c,u,i,s,m,l,h,g);else if("MultiPoint"==e.type){if(e.coordinates.length>0){P=l;g.multiGeometryGrouping&&(P=this.#lt(l,c,e.type));for(v=0;v<e.coordinates.length;v++)this.#dt(e.coordinates[v],c,u,a,o,m,P,h,g)}}else"Point"==e.type&&this.#dt(e.coordinates,c,u,a,o,m,l,h,g)}#lt(e,t,i,s,r){var a=t.createElement("g");if(i||(i="multiGeometry"),a.setAttribute("data-multiGeometry",i),s&&r){var o=this.#pt(s,r),n=this.#ct(o.normalized);!n&&o.styles.description&&(n=o.styles.description),n&&a.setAttribute("content",n)}return e?e.appendChild(a):t.documentElement.appendChild(a),a}#ut(e,t,i,s,r,a,o,n,l,h){console.log("kml draw method.");var g=this.#r.getSvgImages(),d=this.#r.getSvgImagesProps(),p=g[t],c=d[t].CRS,u=e.querySelectorAll("Folder");if(console.log(u),u.length>0){Array.prototype.slice.call(u,0).forEach((function(e,o){var n=this.#mt(e),g=this.#yt(e);drawKml(e,t,i,s,r,a,n,g,l,h)}))}else{var m=e.querySelectorAll("Placemark"),y=Array.prototype.slice.call(m,0);let t=[];y.forEach((function(e,r){var h=this.#mt(e),g=this.#yt(e);null===h&&null===g&&(h=o,g=n);var d=this.#vt(e),u=this.#ft(e);"point"==d?this.#dt(u,p,c,a,h,[g],l):("linestring"==d||"linearring"==d)&&(t.push(h),t.push(g),putLineString(u,p,c,i,s,t,l))}))}}#mt(e){var t=e.querySelector("name");return t?t.textContent.trim():null}#yt(e){var t=e.querySelector("description");return t?t.textContent.trim():null}#vt(e){return e.querySelector("Placemark")?"placemark":e.querySelector("Polygon")?"polygon":e.querySelector("Point")?"point":e.querySelector("LineString")?"linestring":e.querySelector("LinearRing")?"linearring":e.querySelector("MultiGeometry")?"multigeometry":void 0}#ft(e){for(var t=[],i=e.querySelector("coordinates").textContent.trim().replace(/\n/g," ").replace(/\t/g," ").split(" "),s=0;s<i.length;s++)coordinate=i[s].trim().split(","),t.push([coordinate[0],coordinate[1]]);return t}#dt(e,t,i,s,r,a,o,n){var l,h,g=this.#pt(a,n),d=this.#ct(g.normalized);!d&&g.styles.description&&(d=g.styles.description),s||(s="p0"),g.styles["marker-symbol"]&&(s=g.styles["marker-symbol"]);var p=1,c=0;g.styles.opacity&&(p=Number(g.styles.opacity)),g.styles.fill&&(l=g.styles.fill),g.styles["marker-color"]&&(l=g.styles["marker-color"]),g.styles.stroke&&(h=g.styles.stroke,c=1),g.styles["stroke-width"]&&(c=g.styles["stroke-width"]),null!=g.styles.title&&null!=g.styles.title?r=g.styles.title+"":a.title&&(r=a.title+"");var u=t.createElement("use"),m=this.#bt(e,i);return m?(u.setAttribute("x","0"),u.setAttribute("y","0"),u.setAttribute("transform","ref(svg,"+m.x+","+m.y+")"),u.setAttribute("xlink:href","#"+s),r&&u.setAttribute("xlink:title",r),d&&u.setAttribute("content",d),l&&u.setAttribute("fill",l),c>0?(u.setAttribute("stroke",h),u.setAttribute("stroke-width",c),u.setAttribute("vector-effect","non-scaling-stroke")):u.setAttribute("stroke","none"),p<1&&u.setAttribute("opacity",p),o?o.appendChild(u):t.documentElement.appendChild(u),u):null}#gt(e,t,i,s,r,a,o,n){var l=this.#pt(a,n),h=this.#ct(l.normalized);!h&&l.styles.description&&(h=l.styles.description),s||(s="blue"),r||(r=3);var g,d=1;l.styles.opacity&&(d=Number(l.styles.opacity)),l.styles.stroke&&(s=l.styles.stroke),l.styles["stroke-width"]&&(r=l.styles["stroke-width"]),l.styles.title&&(g=l.styles.title);var p=t.createElement("path"),c=this.#It(e,i);return p.setAttribute("d",c),p.setAttribute("fill","none"),p.setAttribute("stroke",s),p.setAttribute("stroke-width",r),p.setAttribute("vector-effect","non-scaling-stroke"),d<1&&p.setAttribute("opacity",d),g&&p.setAttribute("xlink:title",g),h&&p.setAttribute("content",h),o?o.appendChild(p):t.documentElement.appendChild(p),p}#ht(e,t,i,s,r,a,o){var n=this.#pt(r,o),l=this.#ct(n.normalized);if(!l&&n.styles.description&&(l=n.styles.description),0!=e.length){var h="none",g=0;s||(s="orange"),n.styles.fill&&(s=n.styles.fill),n.styles.stroke&&(g=1,h=n.styles.stroke),n.styles["stroke-width"]&&(g=n.styles["stroke-width"]);var d,p=1;n.styles.opacity&&(p=Number(n.styles.opacity)),n.styles.title&&(d=n.styles.title);for(var c=t.createElement("path"),u="",m=0;m<e.length;m++)u+=this.#It(e[m],i)+"z ";return c.setAttribute("d",u),c.setAttribute("fill",s),c.setAttribute("fill-rule","evenodd"),g>0?(c.setAttribute("stroke",h),c.setAttribute("stroke-width",g),c.setAttribute("vector-effect","non-scaling-stroke")):c.setAttribute("stroke","none"),p<1&&c.setAttribute("opacity",p),d&&c.setAttribute("xlink:title",d),l&&c.setAttribute("content",l),a?a.appendChild(c):t.documentElement.appendChild(c),c}}#It(e,t){if(0==e.length)return" ";var i="M",s=this.#bt(e[0],t);if(s){i+=s.x+","+s.y+" L";for(var r=1;r<e.length;r++)(s=this.#bt(e[r],t))&&(i+=s.x+","+s.y+" ")}else i=" ";return i}#bt(e,t){return e.length>1?{x:e[0]*t.a+e[1]*t.c+t.e,y:e[0]*t.b+e[1]*t.d+t.f}:null}static#Pt={title:0,description:1,"marker-size":2,"marker-symbol":3,"marker-color":4,stroke:5,"stroke-width":6,fill:7,opacity:8};#pt(e,t){var i={},s=[],a={};if(Array.isArray(e))s=e;else if(t)for(var o in t.hashMap||this.#St(t),s=new Array(t.length),e){var n=t.hashMap[o];null!=n?s[n]=e[o]:null!=r.#Pt[o]?a[o]=e[o]:i[o]=e[o]}else{var l=Object.keys(e);for(var o of(l.sort(),l))null!=r.#Pt[o]?a[o]=e[o]:s.push(e[o])}return{normalized:s,others:i,styles:a}}#St(e){e.hashMap={};for(var t=0;t<e.length;t++)e.hashMap[e[t]]=t}#ct(e){var t;if(0==e.length)return null;for(var i=0;i<e.length;i++){var s="";null!=e[i]&&null!=e[i]&&(s=e[i].toString()),s.indexOf(",")>=0&&(s=s.replaceAll(",","&#x2c;")),0==i?t=s:t+=","+s}return t}#Mt=function(e){console.log("called testCapture"),console.log("captured Geometry is:",e)}.bind(this);#wt(){this.#r.captureGISgeometries(testCapture)}#xt(e,t){this.#r.captureGISgeometries(e,t)}#Ct(e,t){return{type:"Point",coordinates:[t,e]}}#Lt(e,t,i,s){for(var r=0;r<e.length;r++){var a=e[r];if(a){var o=this.#Et(a,s),n=t.ownerDocument.createElement("image");if(a.transform){console.log("has transform meshdata");var l=this.#r.matMul(a.transform,i);n.setAttribute("x",a.coordinates[0].x),n.setAttribute("y",a.coordinates[0].y),n.setAttribute("width",a.coordinates[1].x-a.coordinates[0].x),n.setAttribute("height",a.coordinates[1].y-a.coordinates[0].y),n.setAttribute("transform","matrix("+l.a+","+l.b+","+l.c+","+l.d+","+l.e+","+l.f+")")}else n.setAttribute("x",Math.min(a.extent.x*i.a,(a.extent.x+a.extent.width)*i.a)),n.setAttribute("y",Math.min(a.extent.y*i.d,(a.extent.y+a.extent.height)*i.d)),n.setAttribute("width",Math.abs(a.extent.width*i.a)),n.setAttribute("height",Math.abs(a.extent.height*i.d));n.setAttribute("xlink:href",o),n.setAttribute("style","image-rendering:pixelated"),t.appendChild(n)}}}#Et(e,t){var i=e.width,s=e.height;e.extent;var r=[255,0,0,255];t?t.fillColor&&t.fillColor.length>=3&&(r=t.fillColor,3==t.fillColor.length&&r.push(255)):t={};var a=document.createElement("canvas");a.width=i,a.height=s;for(var o=a.getContext("2d"),n=o.getImageData(0,0,i,s),l=n.data,h=0;h<s;++h)for(var g=0;g<i;++g){var d=4*(h*i+g),p=e.rasterData[h][g].color,c=e.rasterData[h][g].inRange;p&&(c?t.drawOutOfRange||(t.useCoverageColor?(l[d+0]=p.r,l[d+1]=p.g,l[d+2]=p.b,l[d+3]=255):(l[d+0]=r[0],l[d+1]=r[1],l[d+2]=r[2],l[d+3]=r[3])):t.drawOutOfRange&&(t.useCoverageColor?(l[d+0]=p.r,l[d+1]=p.g,l[d+2]=p.b,l[d+3]=255):(l[d+0]=r[0],l[d+1]=r[1],l[d+2]=r[2],l[d+3]=r[3])))}return o.putImageData(n,0,0),a.toDataURL("image/png")}#At(e,t){var i=this.#Tt(e),s=Math.cos(i[1]*Math.PI/180),r=[111111.11*s,0,0,111111.11,0,0],a={type:e.type,coordinates:e.coordinates};a=this.#Ot(a,r,!0),console.log(a,this);var o=this.#k(a);o=o.buffer(t);var n=this.#B(o),l=[1/(111111.11*s),0,0,1/111111.11,0,0];return this.#Ot(n,l),e.src&&(n.src=e.src),n}#Tt(e){var t,i,s,r=(t=0,i=0,s=0,{getResult:function(){return t>0?[i/t,s/t]:null},set:function(e){i+=e[0],s+=e[1],++t}});return this.#Rt(e.coordinates,r),r.getResult()}#Ot(e,t,i){i&&(e=structuredClone(e));var s=("function"==typeof t?function(){return{set:function(e){return t(e)}}}:function(){return{set:function(e){return[e[0]*t[0]+e[1]*t[2]+t[4],e[0]*t[1]+e[1]*t[3]+t[5]]}}})();return this.#Rt(e.coordinates,s),e}#Rt(e,t){if("number"==typeof e[0]&&2==e.length){var i=t.set(e);i&&(e[0]=i[0],e[1]=i[1])}else for(var s of e)this.#Rt(s,t)}buildDifference(...e){return this.#Z(...e)}buildIntersection(...e){return this.#q(...e)}captureGeometries(...e){return this.#xt(...e)}coverageImageXY2LatLng(...e){return this.#_e(...e)}drawGeoJson(...e){return this.#oe(...e)}drawKml(...e){return this.#ut(...e)}disableImageCache(...e){return this.#je(...e)}enableImageCache(...e){return this.#He(...e)}getBufferedPolygon(...e){return this.#At(...e)}getExcludedPoints(...e){return this.#F(...e)}getColorString(...e){return this.#ot(...e)}getImage(...e){return this.#Et(...e)}getIncludedPoints(...e){return this.#D(...e)}getInRangeGeometriesOnCoverage(...e){return this.#pe(...e)}getInRangeLineParts(...e){return this.#ce(...e)}getInRangePoints(...e){return this.#ue(...e)}getInRangePolygonParts(...e){return this.#de(...e)}haltComputing(...e){return this.#ge(...e)}imageUrlEncoder(...e){return this.#ze(...e)}latLng2coverageImageXY(...e){return this.#Ae(...e)}latLng2GeoJsonPoint(...e){return this.#Ct(...e)}renderImages(...e){return this.#Lt(...e)}setImageProxy(...e){return this.#st(...e)}testCapGISgeom(...e){return this.#wt(...e)}hsv2rgb(...e){return this.#at(...e)}rgb2hsv(...e){return this.#Oe(...e)}}class a{#r;#kt;#Bt;constructor(e,t){console.log("Hello this is svgMapAuthoringTool"),this.#r=e,this.#kt=t,this.#Bt=new r(e,window.jsts),console.log("construct SvgMapAuthoringTool: svgMapObject: ",e)}#Gt={};#Vt={};#Nt={strokeWidth:3,opacity:1,fill:"skyblue",stroke:"blue"};#Dt={strokeWidth:3,opacity:1,fill:"yellow",stroke:"red"};#Ut(e,t){var i=this.#r.screen2Geo(e,t);console.log("Get EditPoint event! :",i)}#Ft(e,t,i){var s=this.#Ht[t],r=this.#jt[t].CRS,a=this.#r.getSymbols(this.#Ht[t]);if(r&&s&&a&&s.getElementsByTagName("defs")[0].getElementsByTagName("g")){var o=null;for(var n in a){o=a[n];break}var l=this.#r.Geo2SVG(e.lat,e.lng,r),h="ref(svg,"+l.x+","+l.y+")",g=s.documentElement.namespaceURI,d=s.createElementNS(g,"use");d.setAttribute("x",0),d.setAttribute("y",0),d.setAttributeNS(g,"transform",h),d.setAttribute("xlink:href","#"+o.id),d.setAttribute("xlink:title",i),d.setAttribute("content","null"),s.documentElement.appendChild(d),this.#r.refreshScreen(),setTimeout(function(){POIeditProps(d,!0,a)}.bind(this),50)}}#zt=function(e){console.log("call clear tools");var t=this.#Gt.uiDoc;this.#Wt(t,this.#Gt.toolsCbFunc,this.#Gt.toolsCbFuncParam,"Cancel"),this.#Yt(),this.#Gt.modifyTargetElement&&this.#Gt.modifyTargetElement.getAttribute("iid")&&document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid"))&&(document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid")).style.backgroundColor=""),this.#Gt.modifyTargetElement=null,this.#Gt.editingGraphicsElement=!1,console.log("get iframe close/hide event from authoring tools framework."),this.#r.setRootLayersProps(this.#Gt.editingLayerId,null,!1),this.#Xt(this.#Zt)}.bind(this);#qt=function(e){console.log("get iframe appear event from authoring tools framework."),this.#r.setRootLayersProps(this.#Gt.editingLayerId,!0,!0)}.bind(this);#Kt(e,t,i,s,r,a,o,n,l,h){var g=e.ownerDocument;0!=s.indexOf("#")&&(s="#"+s),this.#Gt&&this.#Gt.editingMode&&"POIreg"==this.#Gt.editingMode&&g===this.#Gt.uiDoc&&t==this.#Gt.editingLayerId?console.log("ADD uiMapping"):(console.log("NEW uiMapping"),this.#Jt({uiPanel:[],editingLayerId:t,editingMode:"POIreg",uiDoc:g,editingGraphicsElement:!1,modifyTargetElement:null,poiParams:[],returnSvgElement:h,selectedPointsIndex:-1}),o?(this.#Gt.toolsCbFunc=o,this.#Gt.toolsCbFuncParam=n):(this.#Gt.toolsCbFunc=null,this.#Gt.toolsCbFuncParam=null)),this.#Gt.uiPanel.push(e),this.#Gt.poiParams.push({title:r,metadata:a,href:s,id:i});var d=this.#Gt.uiPanel.length-1;this.#_t(e),console.log("called initPOIregistTool: docId:",t),this.#Ht=this.#r.getSvgImages(),this.#jt=this.#r.getSvgImagesProps(),this.#r.getSymbols(this.#Ht[t]),this.#Qt(t);var p=g.createElement("input");p.setAttribute("type","button"),p.id="cernterRegButton"+d,p.setAttribute("value","mapCenterCoord");var c=g.createElement("input");c.setAttribute("type","button"),c.id="coordInputButton"+d,c.setAttribute("value","lat/lng");var u=g.createElement("input");u.setAttribute("type","text"),u.id="coordTextBox"+d,u.setAttribute("value","---,---"),e.appendChild(p),e.appendChild(c),e.appendChild(u),this.#$t(e)}#Ht;#jt;#ei(e,t,i,s,r,a,o){var n=!1;o?.bufferOption&&(n=o.bufferOption),this.#_t(e);var l=e.ownerDocument;console.log("called initPOItools: docId:",t),this.#r.setRootLayersProps(t,!0,!0),this.#Ht=this.#r.getSvgImages(),this.#jt=this.#r.getSvgImagesProps();var h=this.#r.getSymbols(this.#Ht[t]),g=this.#Qt(t),d=0;for(var p in h)++d;var c='<table id="poiEditor">';c+=d>1?'<tr><td colspan="2" id="iconselection" >':'<tr style="display:none"><td colspan="2" id="iconselection" >';var u=!0;for(var p in h)"symbol"==h[p].type&&(c+='<img id="symbol'+p+'" src="'+h[p].path+'" width="'+h[p].width+'" height="'+h[p].height+'" property="'+p+'" ',u?(c+='border="2" style="border-color:red" ',u=!1):c+='border="2" style="border-color:white" ',c+="/>");if(c+="</td></tr>",r||(c+='<tr><td>title</td><td><input type="text" id="poiEditorTitle" value="title"/></td></tr>'),c+='<tr><td><input type="button" id="pointUI" value="lat/lng"/></td><td><input id="poiEditorPosition" type="text" value="--,--"/></td></tr></table>',c+='<table id="metaEditor">',g)for(var m=0;m<g.length;m++){"title"==g[m]||"name"==g[m]||"名称"==g[m]||"タイトル"==g[m]?c+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" data-type="titleMetaCol" disabled="disabled" value="title"/></td></tr>':"latitude"==g[m]||"lat"==g[m]||"緯度"==g[m]?c+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" data-type="latMetaCol"  disabled="disabled" value="numberFormat(latlng.lat )"/></td></tr>':"longitude"==g[m]||"lon"==g[m]||"lng"==g[m]||"経度"==g[m]?c+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" data-type="lngMetaCol" disabled="disabled" value="numberFormat(latlng.lng )"/></td></tr>':c+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" value=""/></td></tr>'}return c+="</table>",n&&(c+='<div><input type="text" id="objectBufferLength"  value=""  placeholder="バッファ半径[m]"></input></div>'),c+='<div id="editConf"><input type="button" id="pepok" value="決定"/><input type="button" id="pepng" value="キャンセル"/><input type="button" id="pepdel" disabled value="削除"/><span id="editMode">newObject</span></div>',e.innerHTML=c,this.#Jt({uiPanel:e,editingLayerId:t,editingMode:"POI",uiDoc:l,editingGraphicsElement:!1,modifyTargetElement:null,returnSvgElement:a,selectedPointsIndex:-1,editingStyle:structuredClone(this.#Dt),shapeStyle:structuredClone(this.#Nt)},!0),i?(this.#Gt.toolsCbFunc=i,this.#Gt.toolsCbFuncParam=s):(this.#Gt.toolsCbFunc=null,this.#Gt.toolsCbFuncParam=null),n&&(this.#Gt.bufferOption=!0),this.#ti(this.#Gt.editingStyle,o?.editingStyle),this.#ti(this.#Gt.shapeStyle,o?.shapeStyle),this.#ii(l,t),this.#si(l,t),this.#ri(l,t),this.#Gt}#si(e){e.getElementById("metaEditor").addEventListener("click",function(t){console.log(this.#ai(e)),t.target.id}.bind(this),!1)}#ai(e){for(var t=[],i=e.getElementById("metaEditor"),s=0;s<i.rows.length;s++)t.push(i.rows[s].cells[1].childNodes[0].value);return t}#oi(e){for(var t=e.attributes,i={},s=0;s<t.length;s++)i[t[s].name]=t[s].value;return i}#ri(e,t){this.#ni=!1,e.getElementById("editConf").addEventListener("click",function(i){var s;console.log("editConf event : id:",i.target.id," editMode:",this.#Gt),"POLYLINE"!==this.#Gt.editingMode&&"POLYGON"!==this.#Gt.editingMode||this.#Xt(this.#Zt),this.#Gt.modifyTargetElement&&(this.#Gt.prevAttrs=this.#oi(this.#Gt.modifyTargetElement));var r=null;switch(i.target.id){case"pepok":if(s="OK","POI"===this.#Gt.editingMode)r=this.#li(this.#hi(e),t),this.#Gt.modifyTargetElement&&document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid"))&&(document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid")).style.backgroundColor="",r&&(document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid")).title=r.getAttribute("xlink:title")));else if("POLYLINE"===this.#Gt.editingMode||"POLYGON"===this.#Gt.editingMode)r=this.#gi(e,t);else if("FREEHAND"===this.#Gt.editingMode){if(1!=this.#Gt.editingGraphicsElement)return;console.log("FREEHAND tools editconf"),r=this.#di(e,t),this.#Yt()}this.#Gt.modifyTargetElement=null,this.#Gt.editingGraphicsElement=!1;break;case"pepng":s="Cancel",console.log("do cancel",this.#Gt.editingMode),this.#Gt.modifyTargetElement&&document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid"))&&(document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid")).style.backgroundColor=""),this.#Gt.modifyTargetElement=null,this.#Gt.editingGraphicsElement=!1;break;case"pepdel":if(console.log("pepdel button: selP",this.#Gt.selectedPointsIndex,"  insP:",this.#Gt.insertPointsIndex),-1==this.#Gt.selectedPointsIndex)this.#r.setCustomModal("Delete Object?",["YES","Cancel"],this.#pi,{targetDoc:e,toolsCbFunc:this.#Gt.toolsCbFunc,toolsCbFuncParam:this.#Gt.toolsCbFuncParam});else{console.log("remove a point not skip edit conf"),s=null;var a=this.#ci.getPoints();a.splice(this.#Gt.selectedPointsIndex,1),this.#Gt.selectedPointsIndex=-1,this.#ci.setPoints(a),this.#ui(this.#Gt.uiDoc.getElementById("polyEditorPosition"),a)}}r&&(this.#Gt.bufferOption?this.#mi(r):r.removeAttribute("data-geometry")),this.#Gt.editedElement=r,s&&this.#Wt(e,this.#Gt.toolsCbFunc,this.#Gt.toolsCbFuncParam,s)}.bind(this),!1)}#Wt(e,t,i,s){if(this.#Gt.selectedPointsIndex=-1,this.#Gt.insertPointsIndex=-1,this.#yi(e),this.#vi.removeCursor(),this.#ci.removeCanvas(),t){var r;if(this.#Gt.returnSvgElement){var a=null;this.#Gt.editedElement&&(a=this.#oi(this.#Gt.editedElement)),r={confStat:s,element:this.#Gt.editedElement,attrs:a,prevAttrs:this.#Gt.prevAttrs},this.#Gt.prevAttrs=null,this.#Gt.editedElement=null}else r=s;this.#fi(t,r,i)}this.#r.refreshScreen()}#pi=function(e,t){if(0==e){this.#Gt.editingGraphicsElement=!1;var i=this.#Gt.modifyTargetElement;i.parentNode.removeChild(i),this.#Gt.modifyTargetElement=null,this.#Wt(t.targetDoc,t.toolsCbFunc,t.toolsCbFuncParam,"Delete")}}.bind(this);#yi(e){if(console.log("clearForms"),this.#Gt.modifyTargetElement&&this.#Gt.modifyTargetElement.getAttribute("iid")&&(document.getElementById(this.#Gt.modifyTargetElement.getAttribute("iid")).style.backgroundColor="",this.#Gt.modifyTargetElement=null),e.getElementById("pepdel")&&(e.getElementById("pepdel").disabled=!0),e.getElementById("editMode")&&(e.getElementById("editMode").innerHTML="newObject"),"POI"===this.#Gt.editingMode){for(var t=(s=e.getElementById("poiEditor")).rows[0].cells[0].childNodes,i=0;i<t.length;i++)t[i].style.borderColor=0==i?"red":"white";e.getElementById("poiEditorTitle")&&(e.getElementById("poiEditorTitle").value=""),e.getElementById("poiEditorPosition").value="--,--"}else if("POLYLINE"===this.#Gt.editingMode||"POLYGON"===this.#Gt.editingMode){var s=e.getElementById("polyEditorPosition");this.#_t(s),s.innerHTML='<tr><td><input type="button" id="pointAdd" value="ADD"/></td></tr>'}if(s=e.getElementById("metaEditor"))for(i=0;i<s.rows.length;i++)s.rows[i].cells[1].childNodes[0].value=""}#li(e,t,i){var s,r;console.log("setPoiSvg called :",e,t,i),this.#Gt.modifyTargetElement&&(s=this.#Gt.modifyTargetElement.getAttribute("iid"));var a=this.#Ht[t];if(s){if(!(r=this.#r.getElementByImageId(a,s))){if(t=this.#Gt.modifyTargetElement.ownerDocument.documentElement.getAttribute("about"),a=this.#Ht[t],!(r=this.#r.getElementByImageId(a,s)))return console.log("Can not find element.... Exit..."),!1;console.log("Tiled Doc....continue")}}else i?a.getElementById(i)?r=a.getElementById(i):((r=a.createElement("use")).setAttribute("id",i),a.documentElement.appendChild(r)):(r=a.createElement("use"),a.documentElement.appendChild(r));var o=e;if(console.log("setPoiSvg:",o),o.geoPos[0]){var n=this.#r.Geo2SVG(o.geoPos[0],o.geoPos[1],this.#jt[t].CRS);if(o.metadata){for(var l="",h=0;h<o.metadata.length&&(l+=this.#r.escape(o.metadata[h]),h!=o.metadata.length-1);h++)l+=",";r.setAttribute("content",l)}return o.title&&r.setAttribute("xlink:title",o.title),r.setAttribute("transform","ref(svg,"+n.x+","+n.y+")"),o.href&&r.setAttribute("xlink:href",o.href),r.setAttribute("data-geometry",JSON.stringify({type:"Point",coordinates:[o.geoPos[1],o.geoPos[0]],icon:o.href})),console.log("setPoiSvg:",r),r}return!1}#gi(e,t){console.log("setPolySvg:",e,t);var i=null,s=this.#ci.getPoints();if(s.length<2||"POLYGON"==this.#Gt.editingMode&&s.length<3)return!1;var r="LineString";if("POLYGON"==this.#Gt.editingMode&&(r="Polygon"),!this.#Gt.modifyTargetElement||"polygon"!=this.#Gt.modifyTargetElement.nodeName&&"polyline"!=this.#Gt.modifyTargetElement.nodeName){if(this.#Gt.modifyTargetElement)i=this.#Gt.modifyTargetElement;else{var a=this.#Ht[t];i=a.createElement("path"),"POLYGON"==this.#Gt.editingMode?i.setAttribute("fill",this.#Gt.shapeStyle.fill):i.setAttribute("fill","none"),i.setAttribute("opacity",this.#Gt.shapeStyle.opacity),i.setAttribute("stroke",this.#Gt.shapeStyle.stroke),i.setAttribute("stroke-width",this.#Gt.shapeStyle.strokeWidth),i.setAttribute("vector-effect","non-scaling-stroke"),a.documentElement.appendChild(i)}for(l="",h=0;h<s.length;h++){g=this.#r.Geo2SVG(s[h].lat,s[h].lng,this.#jt[t].CRS);0==h?l="M"+g.x+","+g.y+"L":l+=g.x+","+g.y+" "}"POLYGON"==this.#Gt.editingMode&&(l+="z"),i.setAttribute("d",l);var o=this.#ai(e),n="";for(h=0;h<o.length&&(n+=this.#r.escape(o[h]),h!=o.length-1);h++)n+=",";i.setAttribute("content",n)}else{i=this.#Gt.modifyTargetElement;for(var l="",h=0;h<s.length;h++){var g;l+=(g=this.#r.Geo2SVG(s[h].lat,s[h].lng,this.#jt[t].CRS)).x+","+g.y+" "}i.setAttribute("points",l)}var d=[];for(var p of s)d.push([p.lng,p.lat]);return"Polygon"==r&&(d[0][0]==d[d.length-1][0]&&d[0][1]==d[d.length-1][1]||d.push([d[0][0],d[0][1]]),d=[d]),i.setAttribute("data-geometry",JSON.stringify({type:r,coordinates:d})),i}#hi(e){for(var t,i=this.#ai(e),s=(n=e.getElementById("poiEditor")).rows[0].cells[0].childNodes,r=0;r<s.length;r++)if("red"===s[r].style.borderColor){t=s[r].getAttribute("property");break}console.log("readPoiUiParams:symbols:",s,"  symHref:",t);var a="";e.getElementById("poiEditorTitle")&&(a=e.getElementById("poiEditorTitle").value);var o=e.getElementById("poiEditorPosition").value.split(",");console.log(o),o[0]=Number(o[0]),o[1]=Number(o[1]);var n=e.getElementById("metaEditor");for(r=0;r<n.rows.length;r++)n.rows[r].cells[1].childNodes[0].dataset.type&&("latMetaCol"==n.rows[r].cells[1].childNodes[0].dataset.type?i[r]=o[0]+"":"lngMetaCol"==n.rows[r].cells[1].childNodes[0].dataset.type?i[r]=o[1]+"":"titleMetaCol"==n.rows[r].cells[1].childNodes[0].dataset.type&&(i[r]=a));return{title:a,geoPos:o,metadata:i,href:t}}#bi(e,t,i){var s=this.#Gt.uiDoc,r=this.#r.getMouseXY(e),a=this.#r.screen2Geo(r.x,r.y);if(console.log("XY:",r," latlng:",a," form:",s.getElementById("poiEditorPosition")),s.getElementById(t).value=this.#r.numberFormat(a.lat)+","+this.#r.numberFormat(a.lng),i?(this.#li({title:i.title,geoPos:[a.lat,a.lng],metadata:i.metadata,href:i.href},this.#Gt.editingLayerId,i.id),this.#Gt.toolsCbFunc&&this.#fi(this.#Gt.toolsCbFunc,!0,this.#Gt.toolsCbFuncParam),this.#r.refreshScreen()):this.#vi.setCursorGeo(a),console.log("setPoiRegPosition: copy lat lng to meta"),s.getElementById("metaEditor"))for(var o=s.getElementById("metaEditor"),n=0;n<o.rows.length;n++)console.log(o.rows[n].cells[1].childNodes[0]),o.rows[n].cells[1].childNodes[0].dataset.type&&("latMetaCol"==o.rows[n].cells[1].childNodes[0].dataset.type?o.rows[n].cells[1].childNodes[0].value=this.#r.numberFormat(a.lat):"lngMetaCol"==o.rows[n].cells[1].childNodes[0].dataset.type&&(o.rows[n].cells[1].childNodes[0].value=this.#r.numberFormat(a.lng)))}#Ii(e,t){this.#Pi(),this.#Si={targetTxtBoxId:e,directPutPoiParams:t},this.#Mi(this.#wi)}#Si={};#wi=function(e){this.#bi(e,this.#Si.targetTxtBoxId,this.#Si.directPutPoiParams),this.#Pi()}.bind(this);#Pi(){this.#Si={},this.#Xt(this.#wi)}#fi(e,t,i){console.log("set cbf on callAfterRefreshed :",e,t,i),"function"==typeof e&&window.addEventListener("screenRefreshed",function(e,t,i){var s=function(){console.log("catch screenRefreshed call:",e," param:",t,i),window.removeEventListener("screenRefreshed",s,!1),e(t,i)}.bind(this);return s}.bind(this)(e,t,i),!1)}#$t(e){e.addEventListener("click",function(e){if(console.log("get PoiRegUiEvents: targetId:",e.target.id),"pointUI"==e.target.parentNode.id)console.log("pointUIev"),setTimeout(function(){this.#Ii("poiEditorPosition")}.bind(this),100);else if("iconselection"==e.target.parentNode.id){for(var t=0;t<e.target.parentNode.childNodes.length;t++)e.target.parentNode.childNodes[t].setAttribute("style","border-color:white");e.target.setAttribute("style","border-color:red");var i=e.target.getAttribute("property");console.log("selPoi:",i)}else if(0==e.target.id.indexOf("coordInputButton")){var s=Number(e.target.id.substring(16));console.log("coordInputButton event numb:",s),setTimeout(function(){this.#Ii("coordTextBox"+s,this.#Gt.poiParams[s])}.bind(this),100)}else if(0==e.target.id.indexOf("cernterRegButton")){s=Number(e.target.id.substring(16));var r=this.#r.getCentralGeoCoorinates();console.log("map center coord Input Button event numb:",s,r,this.#Gt.poiParams),this.#Gt.uiDoc.getElementById("coordTextBox"+s).value=this.#r.numberFormat(r.lat)+","+this.#r.numberFormat(r.lng);var a=this.#Gt.poiParams[s];this.#li({title:a.title,geoPos:[r.lat,r.lng],metadata:a.metadata,href:a.href},this.#Gt.editingLayerId,a.id),this.#Gt.toolsCbFunc&&this.#fi(this.#Gt.toolsCbFunc,!0,this.#Gt.toolsCbFuncParam),this.#r.refreshScreen()}}.bind(this),!1)}#xi=function(e){var t=this.#Gt.uiDoc,i=this.#r.getMouseXY(e),s=this.#r.screen2Geo(i.x,i.y);this.#vi.setCursorGeo(s),console.log("XY:",i," latlng:",s," form:",t.getElementById("poiEditorPosition")),t.getElementById("poiEditorPosition").value=this.#r.numberFormat(s.lat)+","+this.#r.numberFormat(s.lng),document.removeEventListener("click",this.#xi,!1),console.log("setPoiPosition: copy lat lng to meta");for(var r=t.getElementById("metaEditor"),a=0;a<r.rows.length;a++)console.log(r.rows[a].cells[1].childNodes[0]),r.rows[a].cells[1].childNodes[0].dataset.type&&("latMetaCol"==r.rows[a].cells[1].childNodes[0].dataset.type?r.rows[a].cells[1].childNodes[0].value=this.#r.numberFormat(s.lat):"lngMetaCol"==r.rows[a].cells[1].childNodes[0].dataset.type&&(r.rows[a].cells[1].childNodes[0].value=this.#r.numberFormat(s.lng)))}.bind(this);#ii(e){e.getElementById("poiEditor").addEventListener("click",function(e){if(console.log("PoiUiEvent: targetId:",e.target.id),"pointUI"===e.target.id)console.log("pointUIev"),setTimeout(function(){document.addEventListener("click",this.#xi,!1)}.bind(this),100);if("iconselection"==e.target.parentNode.id){for(var t=0;t<e.target.parentNode.childNodes.length;t++)e.target.parentNode.childNodes[t].setAttribute("style","border-color:white");e.target.setAttribute("style","border-color:red");var i=e.target.getAttribute("property");console.log("selPoi:",i)}}.bind(this),!1)}#ci=function(){var e,t,i,s=!0,r=[],a="rgba(255,127,0,1.0)",o="rgba(255,0,0,1.0)",n=3,l=function(){a=this.#Gt.editingStyle.fill,o=this.#Gt.editingStyle.stroke,n=this.#Gt.editingStyle.strokeWidth;var s=.6;(this.#Gt.polyCanvasOpacity&&(s=this.#Gt.polyCanvasOpacity),document.getElementById("PolyEditCanvas"))?e=document.getElementById("PolyEditCanvas"):(e=document.createElement("canvas"),i=this.#r.getMapCanvasSize(),e.width=i.width,e.height=i.height,e.id="PolyEditCanvas",e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.zIndex="20",e.style.opacity=s,this.#kt.mapCanvas.appendChild(e));(t=e.getContext("2d")).globalAlpha=1,t.lineWidth=n,t.strokeStyle=o,t.fillStyle=a,t.lineCap="round",t.lineJoin="round",document.addEventListener("screenRefreshed",d),document.addEventListener("zoomPanMap",d)}.bind(this);var h=function(e){var t={lat:e.lat,lng:e.lng,style:{strokeWidth:this.#Gt.editingStyle.strokeWidth,strokeColor:this.#Gt.editingStyle.stroke,fillColor:this.#Gt.editingStyle.fill}};r.push(t)}.bind(this),g=function(e){var t={lat:e.lat,lng:e.lng,floodFill:!0,style:{color:this.#Gt.editingStyle.stroke}};r.push(t),d()}.bind(this);var d=function(){if(l(),t.clearRect(0,0,i.width,i.height),0!=r.length){var e,h=!0,g=[];r[0].style||(r[0].style={strokeWidth:n,strokeColor:o,fillColor:a});for(var d=0;d<r.length;d++){var p=this.#r.geo2Screen(r[d].lat,r[d].lng);if(p.x=Math.floor(p.x),p.y=Math.floor(p.y),r[d].floodFill){var m=y(r[d].style.color);g.push({floodFill:!0,point:p,color:m})}else r[d].style&&(0==h?s&&e.closePath():h=!1,e=new Path2D,g.push({path:e,style:r[d].style})),e.lineTo(p.x,p.y)}for(var v of g)if(v.floodFill){I(v.point.x,v.point.y,v.color,-255)}else t.fillStyle=v.style.fillColor,t.strokeStyle=v.style.strokeColor,t.lineWidth=v.style.strokeWidth,t.stroke(v.path);1==r.length&&c(0),this.#Gt.insertPointsIndex>=0?"POLYLINE"==this.#Gt.editingMode&&this.#Gt.insertPointsIndex==r.length?c(this.#Gt.insertPointsIndex-1):"POLYLINE"==this.#Gt.editingMode&&0==this.#Gt.insertPointsIndex?c(0):(0==this.#Gt.insertPointsIndex?c(r.length-1):c(this.#Gt.insertPointsIndex-1),u(this.#Gt.insertPointsIndex)):this.#Gt.selectedPointsIndex>=0&&c(this.#Gt.selectedPointsIndex)}}.bind(this);function p(){r=[]}var c=function(e){if(e>=0&&e<r.length){var i=this.#r.geo2Screen(r[e].lat,r[e].lng);console.log("hilightPoint:",e," XY:",i),t.lineWidth=2*n,t.strokeStyle="rgba(0,255,0,1.0)",t.fillStyle="rgba(0,255,0,1.0)",t.beginPath(),t.arc(i.x,i.y,2*n,0,2*Math.PI,!0),t.fill(),t.stroke(),t.lineWidth=n,t.strokeStyle=o,t.fillStyle=a}}.bind(this),u=function(e){var i,s;console.log("polyCanvas hilightLine:",e," totalPoints:",r.length),e>0&&e<r.length?(i=this.#r.geo2Screen(r[e-1].lat,r[e-1].lng),s=this.#r.geo2Screen(r[e].lat,r[e].lng)):0!=e&&e!=r.length||r.length>0&&(i=this.#r.geo2Screen(r[r.length-1].lat,r[r.length-1].lng),s=this.#r.geo2Screen(r[0].lat,r[0].lng)),i&&(t.lineWidth=2*n,t.strokeStyle="rgba(0,255,0,1.0)",t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.closePath(),t.stroke(),t.lineWidth=n,t.strokeStyle=o,t.fillStyle=a)}.bind(this);var m={blue:65535,red:4278190335};function y(e){if(m[e])return m[e];return 255+(e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,((e,t,i,s)=>"#"+t+t+i+i+s+s)).substring(1).match(/.{2}/g).reduce((function(e,t){return(e<<8)+parseInt(t,16)}),0)<<8)}function v(e,t,i){if(t<0||i<0||t>=e.width||i>=e.height)return NaN;var s=e.data,r=4*(i*e.width+t);return(255&s[r+0])<<24|(255&s[r+1])<<16|(255&s[r+2])<<8|255&s[r+3]}function f(e,t,i,s){var r=4*(i*e.width+t),a=e.data;a[r+0]=s>>>24&255,a[r+1]=s>>>16&255,a[r+2]=s>>>8&255,a[r+3]=s>>>0&255}function b(e,t,i){return i<0?!((255&e)>=-i):function(e,t){if(isNaN(e)||isNaN(t))return 1/0;var i=(e>>>24&255)-(t>>>24&255),s=(e>>>16&255)-(t>>>16&255),r=(e>>>8&255)-(t>>>8&255),a=(e>>>0&255)-(t>>>0&255);return i*i+s*s+r*r+a*a}(e,t)<=i}function I(i,s,r,a){for(var o,n,l,h,g,d,p=t,c=e,u=p.getImageData(0,0,c.width,c.height),m=[],y=0;y<c.width;y++)m[y]=[];var I=v(u,i,s);for(a>0&&(a*=a),h=[[i,s]],m[i][s]=!0;o=h.pop();)if(b(v(u,g=o[0],d=o[1]),I,a)){for(f(u,g,d,r),n=l=g;n>0&&b(v(u,n-1,d),I,a)&&!m[--n][d];)f(u,n,d,r);for(;l<u.width-1&&b(v(u,l+1,d),I,a)&&!m[++l][d];)f(u,l,d,r);for(g=n;g<=l;g++)d>0&&b(v(u,g,d-1),I,a)&&(m[g][d-1]||(h.push([g,d-1]),m[g][d-1]=!0)),d<c.height-1&&b(v(u,g,d+1),I,a)&&(m[g][d+1]||(h.push([g,d+1]),m[g][d+1]=!0))}p.putImageData(u,0,0,0,0,c.width,c.height)}return{addPoint:function(e){r.push(e),d()},clearPoints:p,floodFill:g,getImageData:function(){return t.getImageData(0,0,e.width,e.height)},getPoints:function(){return r},movePoint:h,removeCanvas:function(){if(p(),console.log("removeCanvas"),document.removeEventListener("screenRefreshed",d,!1),document.removeEventListener("zoomPanMap",d,!1),document.getElementById("PolyEditCanvas")){var e=document.getElementById("PolyEditCanvas");e.parentNode.removeChild(e)}},setPoints:function(e,t){if(e[0].lat)r=e;else{r=[];for(var i=0;i<e.length;i++)r.push({lat:e[i][0],lng:e[i][1]})}t&&(s=t),d()},setPolygonMode:function(e){s=e},undo:function(){for(var e=r.length-1;e>=0;e--)if(r[e].style){r.splice(e);break}d()},updateCanvas:d}}.bind(this)();#vi=function(){var e;var t=function(t){if(console.log("updateCursor:",e,"  ev:",t),document.getElementById("centerSight")){var i=this.#r.geo2Screen(e.lat,e.lng);if(document.getElementById("POIeditCursor"))s=document.getElementById("POIeditCursor");else{var s=document.createElement("img");s.style.position="absolute",s.style.width="10",s.style.height="10",s.id="POIeditCursor";var r=document.getElementById("centerSight");s.src=r.src,this.#kt.mapCanvas.appendChild(s)}s.style.zIndex="100",s.style.left=i.x-6+"px",s.style.top=i.y-6+"px"}}.bind(this);return{setCursorGeo:function(i){console.log("setCursorGeo :",e,i),e=i,t(),document.addEventListener("screenRefreshed",t),document.addEventListener("zoomPanMap",t)},removeCursor:function(){if(document.removeEventListener("screenRefreshed",t,!1),document.removeEventListener("zoomPanMap",t,!1),document.getElementById("POIeditCursor")){var e=document.getElementById("POIeditCursor");e.parentNode.removeChild(e)}}}}.bind(this)();#Ci(e){for(var t=e.childNodes,i=0;i<t.length;i++)"img"===t[i].nodeName?addEventListener("click",function(e){cdonsole.log("click:",e)}.bind(this)):"div"===t[i].nodeName&&this.#Ci(t[i])}#Li(e){var t=e.element,i=e.docId,s=this.#r.getPoiPos(t),r=t.getAttribute("xlink:href"),a=t.getAttribute("content");a=a&&""!=a?a.split(","):[];var o=t.getAttribute("xlink:title");return{position:this.#r.SVG2Geo(Number(s.x),Number(s.y),this.#jt[i].CRS),href:r,metaData:a,title:o}}#Ei(e){console.log("getPolyProps:",e,e.element.nodeName);var t,i,s=e.element,r=e.docId;if(s.getAttribute("content")&&(t=s.getAttribute("content").split(",")),"path"==e.element.nodeName){var a=this.#Ai(this.#Ti(e.element.getAttribute("d")));i=this.#Oi(a,this.#jt[r].CRS)}else"polygon"==e.element.nodeName||e.element.nodeName;return{position:i,metaData:t}}#Ti(e){return e=(e=(e=(e=(e=(e=(e=(e=e.replace(/,/gm," ")).replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2")).replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([0-9])([+\-])/gm,"$1 $2")).replace(/(\.[0-9]*)(\.)/gm,"$1 $2")).replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 "),e=this.#Ri(this.#ki(e)).split(" ")}#ki(e){return e.replace(/[\s\r\t\n]+/gm," ")}#Ri(e){return e.replace(/^\s+|\s+$/g,"")}#Ai(e){for(var t=[],i="M",s=!1,r=0,a=0,o=0,n=0,l=0,h=e[l];l<e.length;){switch(h){case"M":++l,r=Number(e[l]),++l,o=r,n=a=Number(e[l]);var g=[d=[r,a]];t.push(g),h="L";break;case"m":++l,r+=Number(e[l]),++l,o=r,n=a+=Number(e[l]);g=[d=[r,a]];t.push(g),h="l";break;case"L":++l,r=Number(e[l]),++l;var d=[r,a=Number(e[l])];t[t.length-1].push(d);break;case"l":++l,r+=Number(e[l]),++l;d=[r,a+=Number(e[l])];t[t.length-1].push(d);break;case"A":++l,++l,++l,++l,++l,++l,++l;break;case"Z":case"z":d=[r=o,a=n];t[t.length-1].push(d),t.type="POLYGON";break;default:s=!0}s?(h=i,s=!1,--l):(i=h,h=e[++l])}return t}#Oi(e,t){for(var i,s,r=[],a=0;a<e.length;a++)if(e[0]instanceof Array){s=[];for(var o=0;o<e[a].length;o++)i=this.#r.SVG2Geo(e[a][o][0],e[a][o][1],t),s.push([i.lat,i.lng]);r.push(s)}else i=this.#r.SVG2Geo(e[a][0],e[a][1],t),r.push([i.lat,i.lng]);return e.type&&(r.type=e.type),r}#Bi(e){if(console.log("called setTargetObject:",e),console.log(this.#Gt.editingLayerId,e.docId,e),this.#Gt.editingLayerId===e.docId||this.#Gt.editingLayerId===this.#jt[e.docId].rootLayer){var t=e.element;console.log(t.nodeName,t.getAttribute("fill"),this.#Gt.editingMode,this.#Gt.genericModePanel),this.#Gt.genericMode?.panel?this.#Gi(e):(console.log("setTargetObject:",t),"use"==t.nodeName&&"POI"==this.#Gt.editingMode?(this.#Vi(t.getAttribute("iid")),this.#Ni(e)):"path"!=t.nodeName&&"polygon"!=t.nodeName&&"polyline"!=t.nodeName||"POLYGON"!=this.#Gt.editingMode&&"POLYLINE"!=this.#Gt.editingMode||this.#Di(e))}this.#r.refreshScreen()}#Ui;#Vi(e){console.log("hilightPOI  :  targetPOI ID:",e," poiIcon:",document.getElementById(e)),document.getElementById(e)&&(document.getElementById(e).style.backgroundColor="#FFFF00",this.#Ui&&this.#Ui!=e&&document.getElementById(this.#Ui)&&(document.getElementById(this.#Ui).style.backgroundColor=""),this.#Ui=e)}#Ni(e){var t=this.#Li(e),i=this.#Gt.uiPanel.ownerDocument;i.documentElement,this.#Gt.modifyTargetElement=e.element,i.getElementById("pepdel").disabled=!1,i.getElementById("editMode").innerHTML="modifyObject",i.getElementById("metaEditor"),i.getElementById("poiEditorPosition").value=this.#r.numberFormat(t.position.lat)+","+this.#r.numberFormat(t.position.lng),i.getElementById("poiEditorTitle")&&(i.getElementById("poiEditorTitle").value=t.title);for(var s=0;s<t.metaData.length;s++)i.getElementById("meta"+s).value=t.metaData[s];var r=i.getElementById("iconselection").childNodes;for(s=0;s<r.length;s++)r[s].style.borderColor="white";i.getElementById("symbol"+t.href).style.borderColor="red",this.#r.geo2Screen(t.position.lat,t.position.lng),this.#vi.setCursorGeo(t.position)}#Di(e){var t=this.#Ei(e),i=this.#Gt.uiPanel.ownerDocument;i.documentElement,this.#Gt.modifyTargetElement=e.element,i.getElementById("pepdel").disabled=!1,i.getElementById("editMode").innerHTML="modifyObject",i.getElementById("metaEditor");var s=i.getElementById("polyEditorPosition");if(console.log(t.position,"  props:",t,"   svgTarget:",e),t.position.type&&"POLYGON"===t.position.type){this.#Gt.editingMode="POLYGON";var r=t.position[0].length-1}else{this.#Gt.editingMode="POLYLINE";r=t.position[0].length}for(var a=[],o=0;o<r;o++)a.push({lat:t.position[0][o][0],lng:t.position[0][o][1]});if(this.#ui(s,a),console.log("points:",a,"  docId:",e.docId,"  metaSchema:",this.#Qt(e.docId)),this.#ci.setPoints(a),this.#ci.updateCanvas(),t.metaData&&t.metaData.length&&this.#Qt(e.docId))for(o=0;o<t.metaData.length;o++)i.getElementById("meta"+o).value=t.metaData[o]}#ui(e,t){for(var i="",s=0;s<t.length;s++)i+='<tr><td><input type="button" id="pointIns'+s+'" value="INS"/></td><td><input id="point'+s+'" style="width:200px" type="button" value="'+this.#r.numberFormat(t[s].lat)+", "+this.#r.numberFormat(t[s].lng)+'"/></td></tr>';i+='<tr><td><input type="button" id="pointAdd" value="ADD"/></td></tr>',e.innerHTML=i}#Fi(e,t,i,s,r,a){console.log("initPolygonTools : isPolylineMode:",r),this.#_t(e);var o=e.ownerDocument;console.log("called initPolygonTools: docId:",t),this.#r.setRootLayersProps(t,!0,!0)||console.log("This ID is not layer (child document of layer).. thus you can only add new elements ( not edit existing element) ");var n=!1;1==a?.bufferOption&&(n=!0),this.#Ht=this.#r.getSvgImages(),this.#jt=this.#r.getSvgImagesProps(),this.#r.getSymbols(this.#Ht[t]);var l=this.#Qt(t),h='<div id="polyEditor" style="width:300px;height:100px;overflow:auto"><table id="polyEditorPosition"><tr><td><input type="button" id="pointAdd" value="ADD"/></td></tr></table></div>';if(console.log(" init metaEditor table... metaSchema:",l),h+='<table id="metaEditor">',l)for(var g=0;g<l.length;g++){"title"==l[g]?h+="<tr><td>"+l[g]+'</td><td><input id="meta'+g+'" type="text" disabled="disabled" value="title"/></td></tr>':"latitude"==l[g]||"lat"==l[g]||"緯度"==l[g]?h+="<tr><td>"+l[g]+'</td><td><input id="meta'+g+'" type="text" disabled="disabled" value="numberFormat(latlng.lat )"/></td></tr>':"longitude"==l[g]||"lon"==l[g]||"lng"==l[g]||"経度"==l[g]?h+="<tr><td>"+l[g]+'</td><td><input id="meta'+g+'" type="text" disabled="disabled" value="numberFormat(latlng.lng )"/></td></tr>':h+="<tr><td>"+l[g]+'</td><td><input id="meta'+g+'" type="text" value=""/></td></tr>'}h+="</table>",n&&(h+='<div><input type="text" id="objectBufferLength"  value=""  placeholder="バッファ半径[m]"></input></div>'),h+='<div id="editConf"><input type="button" id="pepok" value="決定"/><input type="button" id="pepng" value="キャンセル"/><input type="button" id="pepdel" disabled value="削除"/><span id="editMode">newObject</span></div>',e.innerHTML=h;var d="POLYGON";return r?(d="POLYLINE",this.#ci.setPolygonMode(!1),console.log("polyMode:",d)):this.#ci.setPolygonMode(!0),this.#Jt({uiPanel:e,editingLayerId:t,editingMode:d,uiDoc:o,editingGraphicsElement:!1,modifyTargetElement:null,selectedPointsIndex:-1,insertPointsIndex:-1,editingStyle:structuredClone(this.#Dt),shapeStyle:structuredClone(this.#Nt)},!0),this.#ti(this.#Gt.editingStyle,a?.editingStyle),this.#ti(this.#Gt.shapeStyle,a?.shapeStyle),i?(this.#Gt.toolsCbFunc=i,this.#Gt.toolsCbFuncParam=s):(this.#Gt.toolsCbFunc=null,this.#Gt.toolsCbFuncParam=null),n&&(this.#Gt.bufferOption=!0),this.#Hi(o,t),this.#si(o,t),this.#ri(o,t),this.#Gt}#ti(e,t){if(t){if(t.opacity&&0==isNaN(t.opacity)){var i=Number(t.opacity);i>0&&i<=1&&(e.opacity=i)}if(t.strokeWidth&&0==isNaN(t.strokeWidth)){var s=Number(t.strokeWidth);s>0&&s<=100&&(e.strokeWidth=s)}t.fill&&"string"==typeof t.fill&&(e.fill=t.fill),t.stroke&&"string"==typeof t.stroke&&(e.stroke=t.stroke)}}#Jt(e,t){this.#ji(e);var i=!1;for(var s in console.log("uiMapping:",this.#Gt),this.#Gt.genericMode&&(i=this.#Gt.genericMode),this.#Gt)delete this.#Gt[s];for(var s in e)this.#Gt[s]=e[s];t&&i&&(this.#Gt.genericMode=i),console.log(this.#Gt)}#ji(e){var t=e.editingLayerId,i=e.uiDoc;if(console.log("Authoring: initGlobalVars :",this.#Vt,"  layerId:",t," uiDoc:",i),!t||!i)return console.error("No editingLayerId or uiDoc ",t,i),!1;this.#zi(i),this.#Vt[t]?this.#Gt=this.#Vt[t]:(this.#Gt={},this.#Vt[t]=this.#Gt,i.addEventListener("appearFrame",function(){console.log("change uiMapping var : ",t,this.#Vt),this.#Gt=this.#Vt[t],this.#Wi={x:0,y:0}}.bind(this)),i.addEventListener("closeFrame",function(){console.log("delete uiMappingGloval var"),delete this.#Vt[t]}.bind(this))),this.#Wi={x:0,y:0}}#zi(e){e.removeEventListener("hideFrame",this.#zt,!1),e.removeEventListener("closeFrame",this.#zt,!1),e.removeEventListener("appearFrame",this.#qt,!1),e.addEventListener("hideFrame",this.#zt),e.addEventListener("closeFrame",this.#zt),e.addEventListener("appearFrame",this.#qt)}#Yi(e){console.log("testTouch:",e,e.changedTouches[0]),console.log(e.changedTouches[0].pageX,e.changedTouches[0].pageY)}#Wi={x:0,y:0};#ni=!1;#Zt=function(e){var t=this.#r.getMouseXY(e);console.log("editPolyPoint:",t),this.#Wi.x==t.x&&this.#Wi.y==t.y&&0==this.#ni&&this.#Xt(this.#Zt),this.#Wi=t;var i=this.#r.screen2Geo(t.x,t.y),s=this.#ci.getPoints();if(console.log("uiMapping:",this.#Gt),this.#Gt.insertPointsIndex>=0&&this.#Gt.insertPointsIndex<s.length){console.log("insert point:",this.#Gt.insertPointsIndex);for(var r=[],a=0;a<s.length;a++)a==this.#Gt.insertPointsIndex&&r.push(i),r.push(s[a]);console.log("insert points::::",r),this.#ci.setPoints(r),this.#Gt.insertPointsIndex=this.#Gt.insertPointsIndex+1}else this.#Gt.selectedPointsIndex>=0?(console.log("replace point:",this.#Gt.selectedPointsIndex),s[this.#Gt.selectedPointsIndex]=i,this.#ci.setPoints(s),removePointEvents(this.#Zt)):(console.log("add last point:",this.#Gt.insertPointsIndex),this.#ci.addPoint(i),this.#Gt.insertPointsIndex=s.length);s=this.#ci.getPoints(),this.#Gt.selectedPointsIndex=-1,this.#ci.updateCanvas(),console.log("updatePointListForm:",s),this.#ui(this.#Gt.uiDoc.getElementById("polyEditorPosition"),s)}.bind(this);#Mi(e){var t=this.#kt.mapCanvas;t.addEventListener("click",e,!1),t.addEventListener("touchend",e,!1)}#Xt(e){var t=this.#kt.mapCanvas;t.removeEventListener("click",e,!1),t.removeEventListener("touchend",e,!1)}#Hi(e){e.getElementById("polyEditor").addEventListener("click",function(t){console.log("PoiUiEvent: targetId:",t.target.id),0==t.target.id.indexOf("point")?(this.#ni=!1,this.#Xi(t.target,e),this.#Gt.editingGraphicsElement||(this.#Gt.editingGraphicsElement=!0),(this.#Gt.selectedPointsIndex>=0||this.#Gt.insertPointsIndex>=0)&&console.log("FOUCUS SELECTION"),this.#ni=!0,setTimeout(function(){this.#Mi(this.#Zt)}.bind(this),30)):(console.log("should be clear selection"),this.#ni=!1,this.#Gt.selectedPointsIndex=-1,this.#Gt.insertPointsIndex=-1,this.#ci.updateCanvas(),e.getElementById("pepdel").disabled=!1)}.bind(this),!1)}#Xi(e,t){var i,s=!1;if(t.getElementById("pepdel").disabled=!0,0==e.id.indexOf("pointAdd")){s=!0,console.log("hilightEditingPoint pointAdd:",this.#ci.getPoints().length);var r=this.#ci.getPoints().length;r>=0&&(i=r)}else 0==e.id.indexOf("pointIns")?(s=!0,i=Number(e.id.substring(8))):(t.getElementById("pepdel").disabled=!1,i=Number(e.id.substring(5)));var a=-1,o=-1;s?o=i:a=i,console.log("insertIndex:",o,"  selectedIndex:",a),this.#Gt.selectedPointsIndex=a,this.#Gt.insertPointsIndex=o,this.#ci.updateCanvas()}#Zi(e,t,i){var s=0,r=-1;if(0==t)return[0,0];0==e&&(r=0);for(var a=0;a<i.length;a++){if(t>0){if(a>0&&"\n"==i.charAt(a-1)&&t==s)return[a-1,a-1];if(a==i.length-1)return[a,a]}if("\n"==i.charAt(a)&&++s,t<0&&e>=0){if(s==e)r<0&&(r=a+1);else if(s>e)return[r,a];if(a==i.length-1&&r>=0)return[r,a+1]}}}#_t(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t])}#qi(){return!!this.#Gt&&!!this.#Gt.editingGraphicsElement}#Qt(e){var t=null;return this.#Ht[e].documentElement.getAttribute("property")&&this.#Ht[e].documentElement.getAttribute("property").length>0&&(t=this.#Ht[e].documentElement.getAttribute("property").split(",")),t}#Ki(e,t,i,s,r){console.log("initFreeHandTool :"),this.#_t(e);var a=e.ownerDocument;console.log("called initPolygonTools: docId:",t),this.#r.setRootLayersProps(t,!0,!0)||console.log("This ID is not layer (child document of layer).. thus you can only add new elements ( not edit existing element) "),this.#Ht=this.#r.getSvgImages(),this.#jt=this.#r.getSvgImagesProps();var o="",n="",l=!1;r?.outlineMode?l=r.outlineMode:(o='<input type="range" min="0" max="7" step="1" value="2" id="freeHandWidth"></input><span id="freeHandWidthMsg">4px</span>',n='<input type="checkbox" id="freeHandFloodFill"/><label for="freeHandFloodFill" id="freeHandFloodFillLable">Fill</label>');var h=`\n\t<div id="freeHandEditor" style="width:300px;height:100px;overflow:auto">\n\t\t<input type="button" id="freeHandAdd" value="ADD"/>\n\t\t<span id="editConf"><input type="button" id="pepok" value="END" style="display:none" /></span>\n\t\t<input type="button" id="freeHandUndo" value="UNDO"/>\n\t\t${o}\n\t\t<input type="color" id="freeHandColor" value="#0000ff" >\n\t\t${n}\n\t</div>`;return e.innerHTML=h,this.#Jt({uiPanel:e,editingLayerId:t,editingMode:"FREEHAND",uiDoc:a,editingGraphicsElement:!1,editingStyle:structuredClone(this.#Nt),shapeStyle:structuredClone(this.#Nt),outlineMode:l,polyCanvasOpacity:.8},!0),i?(this.#Gt.toolsCbFunc=i,this.#Gt.toolsCbFuncParam=s):(this.#Gt.toolsCbFunc=null,this.#Gt.toolsCbFuncParam=null),this.#Ji(a,t),this.#ri(a,t),this.#ci.updateCanvas(),this.#Gt}#Ji(e,t){console.log("setFreeHandEvent:",e,e.defaultView),e.defaultView;var i=document.getElementById("mapCanvasWrapper").parentElement;e.getElementById("freeHandAdd").addEventListener("click",function(e){e.target.style.display="none",this.#Gt.uiPanel.ownerDocument.getElementById("pepok").style.display="",this.#ci.clearPoints(),i.addEventListener("mousemove",this.#_i,{capture:!0}),i.addEventListener("mousedown",this.#_i,{capture:!0}),i.addEventListener("mouseup",this.#_i,{capture:!0}),i.addEventListener("touchmove",this.#_i,{capture:!0}),i.addEventListener("touchstart",this.#_i,{capture:!0}),i.addEventListener("touchend",this.#_i,{capture:!0}),this.#Gt.editingGraphicsElement=!0,this.#ci.setPolygonMode(!1),this.#Qi(.5),this.#r.refreshScreen()}.bind(this)),e.getElementById("freeHandUndo").addEventListener("click",function(e){var i;this.#Gt.editingGraphicsElement?(console.log("Delete last drawing block"),this.#ci.undo()):(console.log("Delete last image element"),(i=this.#Gt.outlineMode?this.#Ht[t].getElementsByTagName("g"):this.#Ht[t].getElementsByTagName("image")).length>0&&(i[i.length-1].parentElement.removeChild(i[i.length-1]),this.#r.refreshScreen()))}.bind(this)),e.getElementById("freeHandColor").addEventListener("input",function(e){var t=e.target.value;this.#Gt.editingStyle.stroke=t}.bind(this)),this.#Gt.outlineMode||(e.getElementById("freeHandWidth").addEventListener("input",function(t){var i=Math.pow(2,t.target.value);e.getElementById("freeHandWidthMsg").innerText=`${i}px`,this.#Gt.editingStyle.strokeWidth=i}.bind(this)),e.getElementById("freeHandFloodFill").addEventListener("change",function(e){if(!this.#Gt.editingGraphicsElement)return console.log("no editingGraphicsElement exit"),void(e.target.checked=!1);e.target.checked?this.#Gt.FloodFillMode=!0:this.#Gt.FloodFillMode=!1}.bind(this)))}#di(e,t){if("FREEHAND"==this.#Gt.editingMode){var i,s=this.#Ht[t];if(this.#Gt.outlineMode){var r=null,a=0;i=s.createElement("g");var o=this.#ci.getPoints(),n="";for(var l of o){l.style&&(r&&(r.setAttribute("d",n),i.appendChild(r),++a),(r=s.createElement("path")).setAttribute("fill","none"),r.setAttribute("stroke",l.style.strokeColor),r.setAttribute("stroke-width",l.style.strokeWidth),r.setAttribute("vector-effect","non-scaling-stroke"),n="M");var h=this.#r.Geo2SVG(l.lat,l.lng,this.#jt[t].CRS);n+=h.x+","+h.y+" "}r&&(r.setAttribute("d",n),i.appendChild(r),++a),a>0?s.documentElement.appendChild(i):i=null}else{var g=this.#$i(t),d=this.#es(g.layerImg,g.layerImgSize.width,g.layerImgSize.height);(i=s.createElement("image")).setAttribute("xlink:href",d),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("x",g.layerViewBox.x),i.setAttribute("y",g.layerViewBox.y),i.setAttribute("width",g.layerViewBox.width),i.setAttribute("height",g.layerViewBox.height),s.documentElement.appendChild(i)}return i}}#es(e,t,i){var s=document.createElement("canvas");return s.width=t,s.height=i,s.getContext("2d").putImageData(e,0,0),s.toDataURL()}#$i(e){var t=this.#ci.getImageData(),i=this.#r.getMapCanvasSize(),s=this.#r.getRootViewBox(),r=this.#jt.root.CRS,a=this.#jt[e].CRS,o=this.#r.getConversionMatrixViaGCS(r,a),n=this.#r.getConversionMatrixViaGCS(a,r),l=this.#r.getTransformedBox(s,o),h={width:i.width,height:i.height},g=new ImageData(h.width,h.height);console.log(o,n);for(var d=0;d<h.height;d++)for(var p=d/h.height*l.height+l.y,c=0;c<h.width;c++){var u=c/h.width*l.width+l.x,m=svgMap.transform(u,p,n),y=Math.round((m.x-s.x)*(i.width/s.width)),v=Math.round((m.y-s.y)*(i.height/s.height));if(y>=0&&y<i.width&&v>=0&&v<i.height){var f=4*(y+v*i.width),b=4*(c+d*h.width);g.data[b]=t.data[f],g.data[b+1]=t.data[f+1],g.data[b+2]=t.data[f+2],g.data[b+3]=t.data[f+3]}}return{layerImg:g,layerImgSize:h,layerViewBox:l}}#Yt(){if("FREEHAND"==this.#Gt.editingMode){this.#ci.removeCanvas(),this.#Qi(),this.#Gt.editingGraphicsElement=!1;var e=document.getElementById("mapCanvasWrapper").parentElement;e.removeEventListener("mousemove",this.#_i,{capture:!0}),e.removeEventListener("mousedown",this.#_i,{capture:!0}),e.removeEventListener("mouseup",this.#_i,{capture:!0}),e.removeEventListener("touchmove",this.#_i,{capture:!0}),e.removeEventListener("touchstart",this.#_i,{capture:!0}),e.removeEventListener("touchend",this.#_i,{capture:!0}),this.#Gt.uiPanel.ownerDocument.getElementById("freeHandAdd").style.display="",this.#Gt.uiPanel.ownerDocument.getElementById("pepok").style.display="none"}}#Qi(e){var t=this.#Gt.editingLayerId,i=this.#Ht[t].getElementsByTagName("image");if(e&&1!=e)for(var s of i)s.setAttribute("opacity",e);else for(var s of i)s.removeAttribute("opacity")}#_i=function(e){var t=this.#r.getMouseXY(e),i=this.#r.screen2Geo(t.x,t.y),s=e.type;e.stopImmediatePropagation(),e.preventDefault(),"mousedown"==s||"touchstart"==s?1==this.#Gt.FloodFillMode?(this.#ci.floodFill(i),this.#Gt.FloodFillMode=!1,this.#Gt.outlineMode||(this.#Gt.uiDoc.getElementById("freeHandFloodFill").checked=!1)):(this.#ci.movePoint(i),this.#Gt.drawing=!0):"mouseup"==s||"touchend"==s?this.#Gt.drawing=!1:this.#Gt.drawing&&this.#ci.addPoint(i)}.bind(this);#ts(){var e;this.#Gt.genericMode?.panel?(this.#is(uiMapping.uiDoc),e=this.#Gt.genericMode.panel,delete this.#Gt.genericMode.panel):e=this.#Gt.uiPanel,this.#ss(e)}#ss(e){this.#zt(),e&&e.nodeType&&1===e.nodeType&&this.#_t(this.#Gt.uiPanel)}#rs="genericAuthoringToolModeDiv";#as="genericAuthoringToolMainDiv";#os="pointGenericToolRadioButton";#ns="polylineGenericToolRadioButton";#ls="polygonGenericToolRadioButton";#hs="bufferedPointGenericToolRadioButton";#gs="bufferedPolylineGenericToolRadioButton";#ds="bufferedPolygonGenericToolRadioButton";#ps(e,t,i,s,r){this.#_t(e);var a=e.ownerDocument;this.#Jt({genericMode:{panel:e,editingStyle:structuredClone(this.#Dt),shapeStyle:structuredClone(this.#Nt)},editingLayerId:t,uiDoc:a,toolsCbFunc:i,toolsCbFuncParam:s}),this.#ti(this.#Gt.genericMode.editingStyle,r?.editingStyle),this.#ti(this.#Gt.genericMode.shapeStyle,r?.shapeStyle);var o=a.createElement("div");o.id=this.#rs,e.appendChild(o);var n=`\t<input type="radio" value="poi" id="${this.#os}" name="amode" checked></input><label for="${this.#os}">POINT</label>\n<input type="radio" value="polyline" id="${this.#ns}" name="amode" ></input><label for="${this.#ns}">POLYLINE</label>\n<input type="radio" value="polygon" id="${this.#ls}" name="amode" ></input><label for="${this.#ls}">POLYGON</label>`;r?.withBufferedTools&&(this.#Gt.genericMode.withBufferedTools=!0,n+=`\t<input type="radio" value="b_poi" id="${this.#hs}" name="amode" ></input><label for="${this.#hs}">CIRCLE</label>\n<input type="radio" value="b_polyline" id="${this.#gs}" name="amode" ></input><label for="${this.#gs}">Buffered POLYLINE</label>\n<input type="radio" value="b_polygon" id="${this.#ds}" name="amode" ></input><label for="${this.#ds}">Buffered POLYGON</label>`),o.insertAdjacentHTML("beforeend",n),a.getElementById(this.#os).addEventListener("change",this.#cs),a.getElementById(this.#ns).addEventListener("change",this.#cs),a.getElementById(this.#ls).addEventListener("change",this.#cs),a.getElementById(this.#hs).addEventListener("change",this.#cs),a.getElementById(this.#gs).addEventListener("change",this.#cs),a.getElementById(this.#ds).addEventListener("change",this.#cs);var l=a.createElement("div");return l.id=this.#as,e.appendChild(l),this.#cs({target:{value:"poi"}}),this.#Gt}#is(e){e.getElementById(this.#os).removeEventListener("change",this.#cs,!1),e.getElementById(this.#ns).removeEventListener("change",this.#cs,!1),e.getElementById(this.#ls).removeEventListener("change",this.#cs,!1),e.getElementById(this.#hs).removeEventListener("change",this.#cs,!1),e.getElementById(this.#gs).removeEventListener("change",this.#cs,!1),e.getElementById(this.#ds).removeEventListener("change",this.#cs,!1)}#cs=function(e){var t=e.target.value.toLowerCase(),i=this.#Gt.editingLayerId,s=this.#Gt.uiDoc,r=this.#Gt.toolsCbFunc,a=this.#Gt.toolsCbFuncParam;this.#ss(this.#Gt.uiPanel);var o={editingStyle:this.#Gt.genericMode.editingStyle,shapeStyle:this.#Gt.genericMode.shapeStyle};0==t.indexOf("b_")&&(o.bufferOption=!0);var n=s.getElementById(this.#as);switch(t){case"poi":s.getElementById(this.#os).checked=!0,this.#ei(n,i,r,a,!1,!1,o);break;case"polyline":s.getElementById(this.#ns).checked=!0,this.#Fi(n,i,r,a,!0,o);break;case"polygon":s.getElementById(this.#ls).checked=!0,this.#Fi(n,i,r,a,!1,o);break;case"b_poi":s.getElementById(this.#hs).checked=!0,this.#ei(n,i,r,a,!1,!1,o);break;case"b_polyline":s.getElementById(this.#gs).checked=!0,this.#Fi(n,i,r,a,!0,o);break;case"b_polygon":s.getElementById(this.#ds).checked=!0,this.#Fi(n,i,r,a,!1,o)}}.bind(this);#Gi(e){console.log("switchGenericTool svgTarget:",e);var t,i,s=e.element,r=this.#Gt.genericMode,a=s.nodeName,o=s.getAttribute("fill");if("use"==a?t="POI":"polygon"==a?t="POLYGON":"polyline"==a?t="POLYLINE":"path"==a&&(t="none"==o?"POLYLINE":"POLYGON"),r?.withBufferedTools&&s.getAttribute("data-buffered")){switch((i={}).length=Number(s.getAttribute("data-buffered")),i.baseGeometry=JSON.parse(s.getAttribute("data-geometry")),i.baseGeometry.type.toLowerCase()){case"point":t="B_POI";break;case"linestring":t="B_POLYLINE";break;case"polygon":t="B_POLYGON"}e.element=this.#us(s,i.baseGeometry)}var n=this.#Gt.editingMode;this.#Gt.bufferOption&&(n="B_"+n),t!=n&&(-1==t.indexOf("B_")&&n.indexOf(t)>=0||this.#cs({target:{value:t}})),"POI"==t||"B_POI"==t?(this.#Vi(s.getAttribute("iid")),this.#Ni(e)):this.#Di(e),i&&this.#Gt.uiDoc.getElementById("objectBufferLength")&&this.#Gt.uiDoc.getElementById("objectBufferLength").setAttribute("value",i.length)}#mi(e){this.#Gt.shapeStyle||(this.#Gt.shapeStyle=this.#Nt);var t=e.getAttribute("data-geometry");if(t){var i=JSON.parse(t),s=this.#Gt.uiDoc.getElementById("objectBufferLength");if(!(isNaN(s.value)||Number(s.value)<=0)){var r=Number(s.value);if(!(r<=0)){var a=this.#Bt.getBufferedPolygon(i,r),o=e.ownerDocument.createElement("path");o.setAttribute("data-geometry",t),o.setAttribute("data-buffered",r),o.setAttribute("d",this.#ms(a)),o.setAttribute("fill",this.#Gt.shapeStyle.fill),o.setAttribute("stroke",this.#Gt.shapeStyle.stroke),o.setAttribute("opacity",this.#Gt.shapeStyle.opacity),o.setAttribute("stroke-width",this.#Gt.shapeStyle.strokeWidth),o.setAttribute("vector-effect","non-scaling-stroke"),e.parentElement.insertBefore(o,e),e.remove()}}}}#us(e,t){this.#Gt.shapeStyle||(this.#Gt.shapeStyle=this.#Nt);var i,s,r=e,a=e.ownerDocument,o=this.#jt[this.#Gt.editingLayerId].CRS,n=this.#r.Geo2SVG(t.coordinates[1],t.coordinates[0],o);switch(t.type.toLowerCase()){case"point":(s=a.createElement("use")).setAttribute("transform",`ref(svg,${n.x},${n.y})`),s.setAttribute("xlink:href",t.icon);break;case"linestring":(i=a.createElement("path")).setAttribute("d",this.#It(t.coordinates,o)),i.setAttribute("fill","none");break;case"polygon":(i=a.createElement("path")).setAttribute("d",this.#ms(t)),i.setAttribute("fill",this.#Gt.shapeStyle.fill)}return i?(i.setAttribute("stroke",this.#Gt.shapeStyle.stroke),i.setAttribute("stroke-width",this.#Gt.shapeStyle.strokeWidth),i.setAttribute("vector-effect","non-scaling-stroke"),r=i):r=s,e.parentElement.insertBefore(r,e),e.remove(),r}#ms(e){for(var t=this.#jt[this.#Gt.editingLayerId].CRS,i="",s=0;s<e.coordinates.length;s++)i+=this.#It(e.coordinates[s],t)+"z ";return i}#It(e,t){if(0==e.length)return" ";var i="M",s=this.#r.Geo2SVG(e[0][1],e[0][0],t);if(s){i+=s.x+","+s.y+" L";for(var r=1;r<e.length;r++)(s=this.#r.Geo2SVG(e[r][1],e[r][0],t))&&(i+=s.x+","+s.y+" ")}else i=" ";return i}cancelPointingPoiRegister(...e){return this.#Pi(...e)}editPoint(...e){return this.#Ut(...e)}initFreeHandTool(...e){return this.#Ki(...e)}initGenericTool(...e){return this.#ps(...e)}initPOItools(...e){return this.#ei(...e)}initPOIregistTool(...e){return this.#Kt(...e)}initPolygonTools(...e){return this.#Fi(...e)}setTargetObject(...e){return this.#Bi(...e)}isEditingGraphicsElement(...e){return this.#qi(...e)}clearTools(...e){return this.#ts(...e)}}let o=class{constructor(e,t,i){if(console.log("InterWindowMessaging:functionSet, targetWindow, responseReady",e,t,i),!t)return console.warn("No targetWindow_or_itsGetter Exit."),void console.warn("targetWindow_or_itsGetter is not Window instance");this.#ys(),this.#vs=e,"object"==typeof t?this.#fs=t:this.#bs=t,1==i&&(this.#Is(),this.#Ps=!0)}#fs=null;#bs=null;#Ps=!1;#vs;#ys(){window.addEventListener("message",async function(e){if(e.origin==window.location.origin){var t=this.#Ss();if(t&&e.source.location.pathname==t.location.pathname){console.log("InterWindowMessaging get message:",e.data," srcWin:",e.source," srcPath:",e.source.location.pathname);var i=JSON.parse(e.data);if(i.command)if(this.#vs[i.command]){var s=await this.#vs[i.command](...i.parameter),r={response:i.command,content:s};console.log("========\ncmd:",i.command),console.log("parameter:",i.parameter),console.log("ans:",s);var a=JSON.stringify(r);t.postMessage(a,t.origin)}else{console.log("========\ncmd:",i.command," is not exists within commandSet");a=JSON.stringify({response:"error"});t.postMessage(a,t.origin)}else 1==i.ready&&(console.log("Get ready!"),this.#Ps=!0);this.#Ms&&(this.#Ms(e.data),this.#Ms=null)}}}.bind(this),!1)}#Ss=function(){return this.#bs?this.#bs():this.#fs}.bind(this);#Ms=null;#ws=100;#xs(e){return new Promise(async function(t,i){for(var s=0;0==this.#Ps||null!=this.#Ms;){if(console.log("waiting post message"),s>this.#ws)return void i("postMessagePromise: Now waiting message. skip.  command:"+JSON.parse(e).command);await this.#Cs(5),++s}this.#Ms=t;var r=this.#Ss();r.postMessage(e,r.origin)}.bind(this))}#Cs=e=>new Promise((t=>setTimeout(t,e)));async callRemoteFunc(e,t){console.log("callRemoteFunc:",e);var i={command:e,parameter:t},s=JSON.stringify(i),r=await this.#xs(s);return(r=JSON.parse(r)).response==e?r.content:null}#Is(){var e=this.#Ss();console.log("submitReady:",e),e.postMessage(JSON.stringify({ready:!0}),e.origin)}async getReady(){for(;0==this.#Ps;)await this.#Cs(5);console.log("Ready!")}};class n{constructor(e,t){"object"==typeof e&&(this.#Ls=!0,this.#Es=e),this.#As=t,this.#Ts()}#Os;#As;#Ts(){this.#Os=new o({getDetailedLayersPropertySet:this.#Rs.bind(this),getDetailedOriginalLayersPropertySet:this.#ks.bind(this),setCustomLayerSettingIndex:this.#Bs.bind(this),applyCustomLayers:this.#Gs.bind(this),getRootContainerXML:this.#Vs.bind(this),registCustomLayer:this.#Ns.bind(this),loadCustomLayerSettings:this.#Ds.bind(this),storeCustomLayerSettings:this.#Us.bind(this),deleteAllCustomLayerSettings:this.#Fs.bind(this),deleteAllCustomViewBoxSettings:this.#Hs.bind(this),buildCustomGeoViewboxSettingObject:this.#js.bind(this),loadCustomGeoViewboxes:this.#zs.bind(this),storeCustomGeoViewboxes:this.#Ws.bind(this),applyCustomLayersSettingsToCurrentMapView:this.#Ys.bind(this),deleteCustomLayerSetting:this.#Xs.bind(this),buildCustomLayersSetting:this.#Zs.bind(this),mergeSettings:this.#qs.bind(this),getGeoViewBox:this.#Es.getGeoViewBox.bind(this.#Es),setGeoViewPort:this.#Es.setGeoViewPort.bind(this.#Es),getResume:this.#Es.getResume.bind(this.#Es),setResume:this.#Es.setResume.bind(this.#Es),refreshScreen:this.#Es.refreshScreen.bind(this.#Es)},this.#As)}#Ls=!1;#Es=null;#Ks=null;static#Js="r2";static#_s="svgmap_";static#Qs="customLayers";static#$s="customGeoViewboxes";async#er(){if(0==this.#Ls)return console.warn("This Object don't have svgMapObject. Exit."),null;var e=new URL(this.#Es.getSvgImagesProps().root.Path,location.href).href,t=await this.#tr(e,!0);this.#ir(t)}async#ks(){return null==this.#Ks&&await this.#er(),this.#sr(this.#Ks)}#Ns(e,t,i){console.log("registCustomLayer:",e,t,i);var s=this.#Ds();if(!i||!i.key){var r=new Date;i={key:"L_"+r.getTime(),time:r.getTime(),title:r.toString(),description:""}}s.customLayersSettings[i.key]={data:e,metadata:i},s.currentSettingKey=i.key,this.#Us(s),t&&this.#Ls&&(this.#Gs(s),this.#Es.refreshScreen())}#Gs(e,t){var i,s=!0;if("object"==typeof t&&(s=!1),!this.#Ls){if("object"!=typeof t)return console.error("No svgMap Object.."),!1;s=!1}if(!s||(i=this.#rr())){if(e||(e=this.#Ds()),0==this.#ar(e))return console.warn("customLayersObject is invalid"),!1;var r=e.currentSettingKey;if(r){console.log(e,r);var a,o,n=e.customLayersSettings[r].data;console.log("applyCustomLayers:customLayersSet:",n),this.#or(n),a="object"==typeof t?t.layersProperty:this.#Rs(null,null,!0).layersProperty;for(var l=[],h={},g=!1,d={},p={},c=0;c<a.length;c++)p[this.#nr(a[c])]?(g=!0,d[this.#nr(a[c])]=!0):p[this.#nr(a[c])]=!0;g&&console.warn("duplicatedLayerTitles:",d);for(c=a.length-1;c>=0;c--){var u=this.#nr(a[c]);if(n[u]&&!n[u].add)if(n[u].href==a[c].href){if(s){var m=this.#lr(u);o=this.#hr(i,m.title,m.group,a[c].href).getAttribute("iid"),d[u]&&console.warn("edit duplicatedLayer:",u,a[c].href,this.#gr(i,o,"iid").getAttribute("xlink:href")),this.#dr(o,n[u],i)}this.#pr(c,n[u],a),h[u]=!0,l[c]=!0}else console.error("href is unmatched!!!: title:",u,"  href:",n[u].href," vs ",a[c].href,"  SKIP IT"),l[c]="href is unmatched:"+u;else l[c]=!1}var y={};for(c=a.length-1;c>=0;c--)if(0==l[c])for(var u in n)if(!h[u]&&n[u].href==a[c].href&&!n[u].add&&!y[u]){if(s){m=this.#lr(this.#nr(a[c]));o=this.#hr(i,m.title,m.group,a[c].href).getAttribute("iid"),this.#dr(o,n[u],i)}this.#pr(c,n[u],a),h[u]=!0,l[c]=!0,y[u]=!0}var v=[],f=[];for(var u in n)if(n[u].add){var b=n[u].add;if(b.afterTitle){var I=this.#cr(b.afterTitle,b.afterHref,a);I&&"all"==I.level?v.push(u):f.push(u)}else v.push(u)}!function e(t){for(var i=[],s=0;s<t.length;s++){var r=n[t[s]].add.afterTitle;v.indexOf(r)>=0?v.push(t[s]):i.push(t[s])}if(0!=i.length&&t.length!=i.length)e(i);else for(s=0;s<i.length;s++)v.push(i[s])}(f);for(c=0;c<v.length;c++){if(!h[u=v[c]]){for(var P=!1,S=0;S<a.length;S++)this.#nr(a[S])==u&&(P=!0);P?console.error("Already exists the same title layer : ",u,"  SKIP..."):(s&&this.#ur(u,n[u],i),h[u]=!0,this.#mr(u,n[u],a))}}return a}console.warn("customLayersObject's currentSettingKey is not assigned. : customLayersObject:",e)}else console.error("Can't get rootContainer")}#cr(e,t,i){for(var s=this.#lr(e),r=s.title,a=s.group,o=0;o<i.length;o++)if(i[o].title==r&&i[o].href==t){if(!a)return{index:o,level:"all"};if(i[o].detail.group==a)return{index:o,level:"all"}}for(o=0;o<i.length;o++)if(i[o].title==r){if(!a)return{index:o,level:"all"};if(i[o].detail.group==a)return{index:o,level:"title"}}for(o=0;o<i.length;o++)if(i[o].href==t)return{index:o,level:"href"};return null}#dr(e,t,i){var s=this.#gr(i,e,"iid"),r=s.getAttribute("xlink:href").trim();if(t.delete)s.parentNode.removeChild(s);else{for(var a in t)"delete"!=a&&("href"==a?r!=t.href&&s.setAttribute("xlink:href",t.href):""==t[a]?s.removeAttribute(a):s.setAttribute(a,t[a]));console.log("layer:",s,s.getAttribute("visibility"))}}#ur(e,t,i){var s,r=i.createElement("animation"),a=this.#lr(e).title;for(var o in r.setAttribute("title",a),r.setAttribute("x",-3e4),r.setAttribute("y",-3e4),r.setAttribute("width",6e4),r.setAttribute("height",6e4),t)"add"!=o&&("href"==o?r.setAttribute("xlink:href",t.href):r.setAttribute(o,t[o]));if(""==t.add||1==t.add)s=null;else{var n=this.#lr(t.add.afterTitle);(s=this.#hr(i,n.title,n.group))||(s=this.#gr(i,t.add.afterHref,"xlink:href"))&&console.error("Can't find afterLayer element titled:",n,"  but found ",s),s||console.error("Can't find afterLayer element...:",t.add,"   for ",n,"layer.")}s?s.parentElement.insertBefore(r,s):i.documentElement.appendChild(r)}#pr(e,t,i){if(i.href,t.delete)i.splice(e,1);else{for(var s in t)"delete"!=s&&("href"==s?i[e].href=t.href:"title"==s?i[e].title=t.title:"visibility"==s?"visible"==t[s]||""==t[s]?i[e].visible=!0:i[e].visible=!1:"opacity"==s?i[e].opacity=t.opacity:"class"==s&&(i[e].detail=this.#yr(t.class,{})),"href"!=s?i[e].attributes[s]=t[s]:i[e].attributes["xlink:href"]=t[s]);null==i[e].detail&&delete i[e].detail}}#mr(e,t,i){var s={href:t.href,opacity:t.opacity,title:t.title,visibile:!1,attributes:{},detail:this.#yr(t.class,{})};for(var r in t)"add"!=r&&("href"!=r?s.attributes[r]=t[r]:s.attributes["xlink:href"]=t[r]);var a=-1;if(""==t.add||1==t.add)a=-1;else{var o=this.#cr(t.add.afterTitle,t.add.afterHref,i);o?a=o.index:console.error("Can't find afterLayer ...:",t.add,"  then add top..")}-1==a?i.push(s):i.splice(a,0,s)}#nr(e){var t=e.title;return e.detail&&e.detail.group?t+"\t"+e.detail.group:t}#lr(e){var t=(e=e.split("\t"))[0],i=null;return 2==e.length&&(i=e[1]),{group:i,title:t}}#Zs(e,t){!t&&this.#Ks&&(t=this.#sr(this.#Ks).layersProperty);var i=this.#vr(e,t),s={};console.log("buildCustomLayersSetting:",e,t,this.#Ks),console.log("buildCustomLayersSetting:",i);for(var r=0;r<i.delIndex.length;r++)s[this.#nr(t[i.delIndex[r]])]={delete:!0,href:t[i.delIndex[r]].href};for(r=0;r<i.addIndex.length;r++){var a,o=i.addIndex[r];a=o==e.length-1||{afterTitle:this.#nr(e[o+1]),afterHref:e[o+1].href};var n=this.#nr(e[o]);for(var l in s[n]&&s[n].delete?s[n].originalHref=s[n].href:s[n]={},s[n].add=a,e[o].attributes)s[n][l]=e[o].attributes[l],"xlink:href"==l&&(s[n].href=e[o].attributes[l])}for(r=0;r<i.attrChangedIndex.length;r++){n=this.#nr(e[i.attrChangedIndex[r].edited]);var h=e[i.attrChangedIndex[r].edited].href,g=i.attrChangedIndex[r].attributes,d={};if(g.changedAttributes)for(var l in g.changedAttributes)d[l]=g.changedAttributes[l];if(g.removedAttributes)for(var l in g.removedAttributes)d[l]="";if(g.addedAttributes)for(var l in g.addedAttributes)d[l]=g.addedAttributes[l];s[n]=d,s[n].href=h}return s}async#tr(e,t){var i=await fetch(e),s=new URL(e,location.href).pathname,r=await i.text(),a=(new DOMParser).parseFromString(r,"text/xml");return this.#Rs(a,s,t)}#fr(){var e;return this.#Ls?(console.warn("Get root container document from this window's svgMap"),e=this.#br(),{rootContainerDoc:this.#rr(),rootContainerHref:e}):(console.warn("Can't get root container live document from this windows's svgMap "),{rootContainerDoc:null,rootContainerHref:null})}#Rs(e,t,i){if(!e||!t){var s=this.#fr();e=s.rootContainerDoc,t=s.rootContainerHref}if(!e)return console.error("No rootContainerDoc"),null;for(var r=e.getElementsByTagName("animation"),a={},o=[],n=0;n<r.length;n++){o.push({});for(var l=r[n],h={},g=0;g<l.attributes.length;g++)i&&"iid"==l.attributes[g].nodeName||(h[l.attributes[g].nodeName]=l.attributes[g].nodeValue.trim());var d={};h.class&&(d=this.#yr(h.class,a,n)),h.opacity&&(o[n].opacity=Number(h.opacity)),o[n].visibile=!0,"hidden"!=h.visibility&&"none"!=h.display||(o[n].visibile=!1);var p=h["xlink:href"],c=l.getAttribute("title");c||(c=p),o[n].title=c,o[n].href=p,o[n].attributes=h,o[n].detail=d}return{layersProperty:o,groupsProperty:a,rootContainerHref:t}}#yr(e,t,i){var s={};if(!e||""==e)return s;for(var r=e.split(" "),a=0;a<r.length;a++)"clickable"==r[a].trim().toLowerCase()?s.clickable=!0:"editable"==r[a].trim().toLowerCase()?s.editable=!0:"switch"==r[a].trim().toLowerCase()?s.switch=!0:"batch"==r[a].trim().toLowerCase()?s.batch=!0:(s.group=r[a],t[s.group]||(t[s.group]={},t[s.group].members=[]),t[s.group].members.push(i)),s.group&&(s.switch&&(t[s.group].switch=!0),s.batch&&(t[s.group].batch=!0));return s}#ir(e){this.#Ks=this.#sr(e)}#sr(e){return JSON.parse(JSON.stringify(e))}#Ir=[{title:"a",href:"A",attributes:{a:"a",b:"b",c:"c"}},{title:"b",href:"B",attributes:{a:"a",b:"b",c:"c"}},{title:"c",href:"C",attributes:{a:"a",b:"b",c:"c"}},{title:"d",href:"D",attributes:{a:"a",b:"b",c:"c"}},{title:"e",href:"E",attributes:{a:"a",b:"b",c:"c"}},{title:"f",href:"F",attributes:{a:"a",b:"b",c:"c"}},{title:"g",href:"G",attributes:{a:"a",b:"b",c:"c"}},{title:"h",href:"H",attributes:{a:"a",b:"b",c:"c"}},{title:"i",href:"I",attributes:{a:"a",b:"b",c:"c"}}];#Pr=[{title:"a",href:"A",attributes:{a:"A",b:"b",c:"c"}},{title:"c",href:"C",attributes:{a:"a",b:"b",c:"c"}},{title:"a",href:"A",attributes:{a:"a",b:"b",c:"c"}},{title:"d",href:"D",attributes:{a:"a",b:"b",c:"c"}},{title:"e",href:"E",attributes:{a:"a",b:"b",c:"c",d:"d"}},{title:"f",href:"F",attributes:{a:"a",b:"b",c:"c"}},{title:"g",href:"G",attributes:{a:"a",b:"b",c:"c"}},{title:"h",href:"H",attributes:{a:"a",c:"c",k:"K"}},{title:"w",href:"W",attributes:{a:"a",b:"b",c:"c"}}];#Sr=!0;#vr(e,t){e||(e=this.#Pr),t||(t=this.#Ks?this.#sr(this.#Ks).layersProperty:this.#Ir);for(var i=0,s=[],r=[],a=[],o=0;o<t.length;o++){var n=i,l=!1;if(n>=e.length)l=!0,s.push(o);else for(;!this.#Sr&&t[o].title!=e[n].title||t[o].href!=e[n].href;){if(n==e.length-1){l=!0,s.push(o);break}++n}if(!l){if(r.push({original:o,edited:n}),i!=n)for(var h=i;h<n;h++)console.log("added?:",h),a.push(h);i=n+1}}for(h=i;h<e.length;h++)console.log("added?:",h),a.push(h);var g=[];for(o=0;o<r.length;o++){var d=t[r[o].original],p=e[r[o].edited],c=!1,u={},m={},y={};for(var v in d.attributes)p.attributes[v]?d.attributes[v]!=p.attributes[v]&&(c=!0,u[v]=p.attributes[v]):(c=!0,m[v]="");for(var f in p.attributes)d.attributes[f]||(c=!0,y[f]=p.attributes[f]);if(c){var b={};Object.keys(m).length>0&&(b.removedAttributes=m),Object.keys(u).length>0&&(b.changedAttributes=u),Object.keys(y).length>0&&(b.addedAttributes=y),g.push({original:r[o].original,edited:r[o].edited,attributes:b})}}return{attrChangedIndex:g,existIndex:r,delIndex:s,addIndex:a}}#Mr(){if(!this.#Ls)return console.error("No svgMap Object.."),!1;for(var e=this.#Es.getRootLayersProps(),t=this.#rr(),i={},s=0;s<e.length;s++){for(var r=e[s].id,a=this.#gr(t,r,"iid"),o={},n=0;n<a.attributes.length;n++)o[a.attributes[n].nodeName]=a.attributes[n].nodeValue;var l={};if(o.class){var h=o.class.split(" ");for(n=0;n<h.length;n++)"clickable"==h[n].trim().toLowerCase()?l.clickable=!0:"editable"==h[n].trim().toLowerCase()?l.editable=!0:"switch"==h[n].trim().toLowerCase()?l.switch=!0:"batch"==h[n].trim().toLowerCase()?l.batch=!0:(l.group=h[n],i[l.group]||(i[l.group]={},i[l.group].members=[]),i[l.group].members.push(r)),l.group&&(l.switch&&(i[l.group].switch=!0),l.batch&&(i[l.group].batch=!0))}o.opacity&&(e[s].opacity=Number(o.opacity)),e[s].attributes=o,e[s].detail=l}for(s=0;s<e.length;s++){r=e[s].id;e[s].detail.group&&(i[e[s].detail.group].switch&&(e[s].detail.switch=!0),i[e[s].detail.group].batch&&(e[s].detail.batch=!0)),e[r].attributes=e[s].attributes,e[r].detail=e[s].detail}return{layersProperty:e,groupsProperty:i}}#rr(){return this.#Ls?this.#Es.getSvgImages().root:(console.warn("Can't get root container live document from this windows's svgMap "),null)}#Vs(){var e=this.#rr();return(new XMLSerializer).serializeToString(e)}#br(){return this.#Ls?new URL(this.#Es.getSvgImagesProps().root.Path,window.location.href).pathname:(console.warn("Can't get root container live document from this windows's svgMap "),null)}#wr(e){var t=this.#br();return t?n.#_s+t+"#"+e:(console.error("rootContainerHref is not defined... exit"),null)}#Us(e){window.localStorage[this.#wr(n.#Qs)]=JSON.stringify(e)}#Ds(){var e=null;window.localStorage[this.#wr(n.#Qs)]&&(e=JSON.parse(window.localStorage[this.#wr(n.#Qs)]));var t=this.#br();return e&&t==e.rootContainerHref&&e.settingRevision==n.#Js||(e&&(t!=e.rootContainerHref&&console.warn("rootContainerHref mismatch:",t," vs ",e.rootContainerHref),e.settingRevision!=n.#Js&&console.warn("settingRevision mismatch:",n.#Js," vs ",e.settingRevision)),console.warn("create new:",e,t),e={currentSettingKey:null,customLayersSettings:{},rootContainerHref:t,settingRevision:n.#Js}),e}#Ws(e){window.localStorage[this.#wr(n.#$s)]=JSON.stringify(e)}#zs(){return window.localStorage[this.#wr(n.#$s)]?JSON.parse(window.localStorage[this.#wr(n.#$s)]):{currentSettingKey:null,settings:{}}}#js(e,t,i,s,r,a){return e||(e="V_"+(new Date).getTime()),t||(t=e),{key:e,title:t,x:i,y:s,width:r,height:a}}#Fs(){delete window.localStorage[this.#wr(n.#Qs)]}#Hs(){delete window.localStorage[this.#wr(n.#$s)]}#Xs(e){if(null==e)console.error("key is requred");else{var t=this.#Ds();if(t.customLayersSettings[e])return delete t.customLayersSettings[e],t.currentSettingKey==e&&(t.currentSettingKey=null),this.#Us(t),t;console.error("layer setting key is invalid:",e)}}#Bs(e){var t=this.#Ds();return e?t.customLayersSettings[e]?(t.currentSettingKey=e,this.#Us(t),t):void console.error("key is invalid:",e):(t.currentSettingKey=null,this.#Us(t),null)}#gr(e,t,i){return i.indexOf(":")>0&&(i="*|"+i.substring(i.indexOf(":")+1)),e&&e.hasChildNodes()?e.querySelector("["+i+'="'+t+'"]'):null}#xr(e,t,i,s,r){if(i.indexOf(":")>0&&(i="*|"+i.substring(i.indexOf(":")+1)),!e||!e.hasChildNodes())return null;var a=e.querySelectorAll("["+i+'="'+t+'"]');if(0==a.length)return null;for(var o=0;o<a.length;o++){if(a[o].getAttribute(r)==s)return a[o]}return null}#hr(e,t,i,s,r){if(!e||!e.hasChildNodes())return null;for(var a=[],o=e.querySelectorAll("*"),n=0;n<o.length;n++)o[n].getAttribute("title")&&o[n].getAttribute("title")==t&&a.push(o[n]);if(0==a.length)return null;var l=[];if(i)for(n=0;n<a.length;n++){a[n].getAttribute("class").indexOf(i)>=0&&l.push(a[n])}else l=a;if(0==l.length)return null;var h=[];if(s)for(n=0;n<l.length;n++){l[n].getAttribute("xlink:href").trim()==s&&h.push(l[n])}else h=l;return 0==h.length?null:1==h.length?h[0]:r?h:h[0]}#Cr(e){}#Ys(e){var t=this.#rr(),i=this.#br(),s=this.#Rs(t,i,!0),r=this.#Zs(e.layersProperty,s.layersProperty),a={currentSettingKey:"L_0",customLayersSettings:{},settingRevision:n.#Js,rootContainerHref:i};return a.customLayersSettings[a.currentSettingKey]={data:r,metadata:{key:a.currentSettingKey,title:"temp"}},this.#Lr(a),a}#Lr(e){this.#Gs(e),this.#Es.refreshScreen(),setTimeout(this.#Es.updateLayerListUI,1e3)}#ar(e){var t=!0,i="",s=this.#br();return e.rootContainerHref!=s&&(t=!1,i="rootContainerHref is invalid "+e.rootContainerHref+" vs "+s),e.settingRevision!=n.#Js&&(t=!1,i="settingRevision is mismatch "+e.settingRevision+" vs "+n.#Js),0==t&&console.warn("customLayersObject is invalid: "+i),t}#qs(e){var t=this.#Ds(),i=this.#zs();if(e.rootContainerHref!=t.rootContainerHref||location.host!=e.host)return"異なるコンテンツ用の設定ファイルです";if(e.settingRevision!=n.#Js)return"異なるリビジョンの設定ファイルです";for(var s in e.customLayersSettings)t.customLayersSettings[s]?console.warn("カスタムレイヤー：重複しています　スキップします"):t.customLayersSettings[s]=e.customLayersSettings[s];for(var s in e.customGeoViewboxSettings)i.settings[s]?console.warn("ビューボックス：重複しています　スキップします"):i.settings[s]=e.customGeoViewboxSettings[s];return this.#Us(t),this.#Ws(i),!0}#or(e){for(var t in e){var i=e[t];i.iid&&delete i.iid}}applyCustomLayers(...e){return this.#Gs(...e)}}class l{constructor(e,t,i){if(console.log("InterWindowMessaging:functionSet, targetWindow, responseReady",e,t,i),!t)return console.warn("No targetWindow_or_itsGetter Exit."),void console.warn("targetWindow_or_itsGetter is not Window instance");this.#ys(),this.#vs=e,"object"==typeof t?this.#fs=t:this.#bs=t,1==i&&(this.#Is(),this.#Ps=!0)}#fs=null;#bs=null;#Ps=!1;#vs;#ys(){window.addEventListener("message",async function(e){if(e.origin==window.location.origin){var t=this.#Ss();if(t&&e.source.location.pathname==t.location.pathname){console.log("InterWindowMessaging get message:",e.data," srcWin:",e.source," srcPath:",e.source.location.pathname);var i=JSON.parse(e.data);if(i.command)if(this.#vs[i.command]){var s=await this.#vs[i.command](...i.parameter),r={response:i.command,content:s};console.log("========\ncmd:",i.command),console.log("parameter:",i.parameter),console.log("ans:",s);var a=JSON.stringify(r);t.postMessage(a,t.origin)}else{console.log("========\ncmd:",i.command," is not exists within commandSet");a=JSON.stringify({response:"error"});t.postMessage(a,t.origin)}else 1==i.ready&&(console.log("Get ready!"),this.#Ps=!0);this.#Ms&&(this.#Ms(e.data),this.#Ms=null)}}}.bind(this),!1)}#Ss=function(){return this.#bs?this.#bs():this.#fs}.bind(this);#Ms=null;#ws=100;#xs(e){return new Promise(async function(t,i){for(var s=0;0==this.#Ps||null!=this.#Ms;){if(console.log("waiting post message"),s>this.#ws)return void i("postMessagePromise: Now waiting message. skip.  command:"+JSON.parse(e).command);await this.#Cs(5),++s}this.#Ms=t;var r=this.#Ss();r.postMessage(e,r.origin)}.bind(this))}#Cs=e=>new Promise((t=>setTimeout(t,e)));async callRemoteFunc(e,t){console.log("callRemoteFunc:",e);var i={command:e,parameter:t},s=JSON.stringify(i),r=await this.#xs(s);return(r=JSON.parse(r)).response==e?r.content:null}#Is(){var e=this.#Ss();console.log("submitReady:",e),e.postMessage(JSON.stringify({ready:!0}),e.origin)}async getReady(){for(;0==this.#Ps;)await this.#Cs(5);console.log("Ready!")}}class h{constructor(e){this.#Es=e,this.#Er()}#Es=null;#Os;#Ar;#Tr;#Or;#Rr;#kr;#Br(e){if(this.#kr||(this.#kr="cesiumWindow2.html"),console.log("openCesium:"),this.#Rr)this.#Rr.closed&&(this.#Rr=null,this.#Br(e));else{var t=new URL(this.#Es.getSvgImagesProps().root.Path,window.location).pathname;t=t.substring(0,t.lastIndexOf("/")+1),this.#Rr=window.open(this.#kr,"sub","width=800,height=600"),this.#Os=new l({reldir2imageUrl:function(){return t},getCORSURL:function(e){var t=this.#Es.getCORSURL(e);return console.log("getCORSURL:",t),t}.bind(this)},this.#Rr)}e&&this.#Gr(e)}async#Gr(e){await this.#Os.getReady(),e()}#B(e){this.#Vr&this.#Nr&&this.#Dr(),this.#Es.captureGISgeometriesOption(!0),console.log("getGeoJson  is cesiumWindow?:",this.#Rr,"   is complex:",e),"true"==e?this.#Es.captureGISgeometries(this.#Ur):(this.#Br(),this.#Es.captureGISgeometries(this.#Fr))}#Fr=function(e){var t=this.#Es.getRootLayersProps(),i=this.#Es.getSvgImagesProps();for(var s in e){var r=i[s].rootLayer;e[s].layerProps=t[r]}this.#Hr(e)}.bind(this);#Ur=function(e){console.log("called jsonPropComp : json:",e);var t=this.#Es.getRootLayersProps(),i=this.#Es.getSvgImagesProps();console.log("svgImagesProps:",i);var s=[];for(var r in e){var a=i[r],o=a.rootLayer;e[r].layerProps=t[o],o&&e[r][0]&&"Point"==e[r][0].type&&(s[o]={title:t[o].title,metaSchema:a.metaSchema.split(",")})}console.log("jLayers:",s);var n=document.getElementById("svg2cesiumProp");this.#_t(n),n.style.display="";var l=document.createElement("span");l.innerHTML="Select property of layers which you want to visualize as bar graphs.<br>Note: If you select string property then value should be the length of string....",n.appendChild(l);var h=document.createElement("table");h.id="extentTable",h.border=1;var g=document.createElement("tr");for(var d in g.innerHTML="<th>LayerName</th><th>targetProp</th><th>min</th><th>max</th>",h.appendChild(g),s){g=document.createElement("tr"),(c=document.createElement("td")).innerHTML=s[d].title,g.appendChild(c),c=document.createElement("td");var p=document.createElement("select");p.addEventListener("change",function(t){this.#jr(t,e)}.bind(this)),p.id="sel_"+d;var c,u=document.createElement("option");u.value="-",u.innerHTML="-",u.selected=!0,p.appendChild(u);for(var m=0;m<s[d].metaSchema.length;m++)(u=document.createElement("option")).value=s[d].metaSchema[m],u.innerHTML=s[d].metaSchema[m],p.appendChild(u);c.appendChild(p),g.appendChild(c),(c=document.createElement("td")).innerHTML="<input type='text' id='min_"+d+"'  readonly>",g.appendChild(c),(c=document.createElement("td")).innerHTML="<input type='text' id='max_"+d+"'  readonly>",g.appendChild(c),h.appendChild(g)}n.appendChild(h);var y=document.createElement("input");y.type="button",y.value="view",y.addEventListener("click",function(t){this.#zr(e)}.bind(this)),n.appendChild(y);var v=document.createElement("input");v.type="button",v.value="cancel",v.addEventListener("click",function(e){document.getElementById("svg2cesiumProp").style.display="none"}.bind(this)),n.appendChild(v)}.bind(this);#zr(e){for(var t=document.getElementById("extentTable"),i=0;i<t.rows.length;i++)for(var s=0;s<t.rows[i].cells.length;s++){var r=t.rows[i].cells[s];console.log(r)}this.#Br(),console.log("jsonPropCompPh2:",e),this.#Hr(e),document.getElementById("svg2cesiumProp").style.display="none"}#jr=function(e,t){var i=e.target.id.substring(4),s=e.target.selectedIndex-1,r=9e99,a=-9e99;for(var o in t)if(t[o].layerProps&&t[o].layerProps.svgImageProps.rootLayer==i)for(var n=0;n<t[o].length;n++)if(s<0)delete t[o][n].mainValue;else if("Point"==t[o][n].type)try{var l="";l=t[o][n].usedParent&&t[o][n].usedParent.getAttribute("content")?t[o][n].usedParent.getAttribute("content").split(",")[s]:t[o][n].src.getAttribute("content").split(",")[s];var h=Number(l);isNaN(h)?(h=l.length,r=Math.min(r,h),a=Math.max(a,h)):(r=Math.min(r,h),a=Math.max(a,h)),t[o][n].mainValue=h}catch(e){}s<0?(document.getElementById("min_"+i).value="",document.getElementById("max_"+i).value="",delete t[i].mainValueMin,delete t[i].mainValueMax):(document.getElementById("min_"+i).value=r,document.getElementById("max_"+i).value=a,t[i].mainValueMin=r,t[i].mainValueMax=a,console.log("min,max,id",r,a,i))}.bind(this);#Wr(e){var t={};for(var i in e){if(t[i]={},e[i].length>0){t[i].geometry=[];for(var s=0;s<e[i].length;s++){var r={};for(var a in e[i][s])r[a]="src"==a?{title:e[i][s][a].getAttribute("xlink:title")}:e[i][s][a];t[i].geometry.push(r)}}e[i].layerProps&&(t[i].layerProps={},console.log(i,e[i],e[i].layerProps),t[i].layerProps.id=e[i].layerProps.id,t[i].layerProps.title=e[i].layerProps.title,t[i].layerProps.groupName=e[i].layerProps.groupName,t[i].layerProps.svgImageProps={rootLayer:e[i].layerProps.svgImageProps.rootLayer}),e[i].mainValueMin&&(t[i].mainValueMin=e[i].mainValueMin,t[i].mainValueMax=e[i].mainValueMax)}return console.log("fixJsonObj:",t),t}async#Hr(e){var t=this.#Es.getGeoViewBox();console.log("jsonCapture:",e),this.#Rr||console.warn("NO cesiumWindow exit."),await this.#Os.getReady(),await this.#Os.callRemoteFunc("viewGeoJson",[this.#Wr(e),t])}#_t(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t])}#Yr=function(){this.#Vr.style.display=""}.bind(this);#Dr=function(){this.#Vr.style.display="none"}.bind(this);#Vr;#Nr;#Er(){if(this.#Nr=document.getElementById("3DviewButton"),this.#Nr){this.#Nr.getAttribute("data-app")&&(this.#kr=this.#Nr.getAttribute("data-app"),console.log("set cesiumWindowHtmlLocation:",this.#kr)),this.#Nr.title||(this.#Nr.title="View 3D Map");var e=this.#Nr.style.top;this.#Nr.addEventListener("click",this.#Yr),this.#Ar="left :0px; top:0px; position: relative",this.#Tr="left :0px; top:0px; position: relative",this.#Or="left:2px;top:"+e+"; position:absolute;display:none;z-index:1000;background-color : #AAEEDD",this.#Ar||(this.#Ar="right :0px; top: 0px; position: relative"),this.#Tr||(this.#Tr="right :0px; top: 0px; position: relative"),this.#Vr=document.createElement("div"),this.#Vr.id="3dViewBtns",this.#Vr.setAttribute("style",this.#Or),console.log("buildUI : style1,2:",this.#Ar,this.#Tr);var t=document.createElement("input");t.id="svg2cesiumBtn1",t.type="button",t.value="Simple 3D view",t.addEventListener("click",function(){this.#B()}.bind(this)),t.setAttribute("style",this.#Ar);var i=document.createElement("input");i.id="svg2cesiumBtn2",i.type="button",i.value="Complex 3D view",i.addEventListener("click",function(){this.#B("true")}.bind(this)),i.setAttribute("style",this.#Tr);var s=document.createElement("input");s.addEventListener("click",this.#Dr),s.type="button",s.value="x",this.#Vr.appendChild(t),this.#Vr.appendChild(i),this.#Nr&&this.#Vr.appendChild(s);var r=document.createElement("div");r.id="svg2cesiumProp",r.setAttribute("style","left :80px; top: 80px; position: absolute; background-color: white;opacity:0.8;display:none;z-index:1000"),document.body.appendChild(this.#Vr),document.body.appendChild(r)}}}class g{static#Xr="gMsg_";static#Zr=5;static#qr="globalMessage";constructor(){}#Kr(e,t){var i=document.getElementById(g.#qr);if(!i)return console.log('NO id="'+g.#qr+'" element skip'),!1;var s=i.getElementsByTagName("table")[0];s||(console.log("init globalMesasge area"),(s=document.createElement("table")).style.border="0px",s.style.padding="0px",s.style.margin="0px",i.appendChild(s));var r=i.children,a=document.getElementById(g.#Xr+t);if(!a){if(r.length>=g.#Zr)return console.log("can not append global message due to limit"),!1;a=document.createElement("td");var o=document.createElement("tr");o.id=g.#Xr+t,o.appendChild(a),i.appendChild(o)}return console.log(a,e),a.innerText=e,!0}putGlobalMessageForLayer(e){return function(t){this.#Kr(t,e)}.bind(this)}clearGlobalMessage(e){console.log("clearGlobalMessage:",e);var t=document.getElementById(g.#qr);if(console.log("globalMessage:",t),t){var i=document.getElementById(g.#Xr+e);console.log("globalMessageCell:",i),i&&(console.log("Remove GlobalMessage for layer:",e),i.parentNode.removeChild(i))}else console.log('NO id="globalMesasge" element skip')}}class d{static#Jr=20;static#_r="openFrame";static#Qr="closeFrame";static#$r="appearFrame";static#ea="hideFrame";#ta;#r;#Bt;#ia;#sa;#ra={};#aa=0;#oa;#na;#la={};constructor(e,t,i){this.#r=e,this.#ia=t,this.#la={},this.#Bt=new r(e,window.jsts),this.#oa=i.bind(this.#r),this.#na=new g,console.log("construct layerUI: svgMapGIStool:",this.#Bt," svgMapAuthoringTool:",this.#ia),window.initSvgMapWebAppLayer=this.initSvgMapWebAppLayer}#ha(){for(var e=this.#r.getRootLayersProps(),t=e.length-1;t>=0;t--)this.#ga(e[t].id,e[t].visible)}#da(e,t){var i=this.#r.getRootLayersProps();i[e].svgImageProps?i[e].svgImageProps.controller?i[e].svgImageProps.controllerWindow?(console.warn("Already launched"),t&&t(i[e].svgImageProps.controllerWindow)):this.#pa(i[e].svgImageProps,i[e].id,!0,t):console.error("This layer has NO controller, EXIT."):console.error("This layer is not yet loaded, EXIT.")}setLayerUIobject(e){this.#sa=e}#pa(e,t,i,s){var r,a=this.#ta.ownerDocument;if(!e.controller&&e.svgScript&&(r=":#exec=hiddenOnLayerLoad"),e.controller&&(r=e.controller.src?e.controller.url?":"+e.controller.url:":":e.controller.url,"function"==typeof this.#sa.setLayerSpecificWebAppLaunchUiEnable&&this.#sa.setLayerSpecificWebAppLaunchUiEnable(t,r)),r&&!a.getElementById(this.#ca(t))){var o=this.#ua(r);if(!e.svgScript||o&&o.exec||(o?o.exec="appearOnLayerLoad":o={exec:"appearOnLayerLoad"}),i&&(o?o.exec="appearOnLayerLoad":o={exec:"appearOnLayerLoad"}),o&&o.exec&&("appearonlayerload"==o.exec.toLowerCase()||"hiddenonlayerload"==o.exec.toLowerCase())){var n=!1;"hiddenOnLayerLoad"==o.exec&&(n=!0),console.log("Find #exec=appearOnLayerLoad,hiddenOnLayerLoad Auto load LayerUI : layerId,ctrUrl,hiddenOnLaunch,cbf:",t,r,n,s),this.#ma(t,r,n,s)}}}#ya;#va;#fa(){this.#ba.element?(console.log("Found preDefinedTargetUiElement! : ",this.#ba),this.#ta=this.#ba.element,this.#ba.isInline&&(this.#ta.style.display="none")):this.#ta=document.getElementById("layerSpecificUI"),this.#ta?(this.#ta.style.zIndex="20",this.#ta.style.display="none"):(console.log("can't find id:initLayerSpecificUI elem ... create it"),this.#ta=document.createElement("div"),this.#ta.setAttribute("id","layerSpecificUI"),this.#ta.setAttribute("style","right :10px; top: 40px; width:400px;height:400px; position: absolute; background-color: white;opacity:0.8;display:none;zIndex:20;"),document.body.appendChild(this.#ta)),this.#ra.height=this.#ta.style.height,this.#ra.width=this.#ta.style.height,this.#ra.top=this.#ta.style.top,this.#ra.left=this.#ta.style.left,this.#ra.right=this.#ta.style.right,this.#ya=document.createElement("div"),this.#ya.id="layerSpecificUIbody",this.#ya.style.overflow="auto",this.#ya.style.webkitOverflowScrolling="touch",this.#ya.style.width="100%",this.#ya.style.height="100%",this.#ta.appendChild(this.#ya),this.#ba.element&&!this.#ba.isInline||(this.#va=document.createElement("input"),this.#va.type="button",this.#va.value="x",this.#va.style.webkitTransform="translateZ(10)",this.#va.style.zIndex="3",this.#va.id="layerSpecificUIclose",this.#va.style.position="absolute",this.#va.style.right="0px",this.#va.style.top="0px",this.#ta.appendChild(this.#va),this.#va.addEventListener("click",function(e){this.#Ia(e)}.bind(this),!1)),this.#Pa()}#ba={};#Sa(e,t,i){this.#ba={element:e,isInline:t,autoSizing:i}}#ca(e){return"layerSpecificUIframe_"+e}#ua(e){if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1);t.indexOf("?")>0&&(t=t.substring(0,t.indexOf("?"))),t=t.split("&");for(var i=0;i<t.length;i++)t[i]=t[i].split("="),t[t[i][0]]=t[i][1];return t}return null}#Ma(){for(var e=this.#ya,t=e.childNodes.length-1;t>=0;t--)if("none"!=e.childNodes[t].style.display)return e.childNodes[t].id;return null}#ma(e,t,i,s){var r=this.#ta.ownerDocument,a={height:-1,width:-1},o=this.#ua(t);o&&(o.requiredHeight&&(a.height=Number(o.requiredHeight)),o.requiredWidth&&(a.width=Number(o.requiredWidth))),i||(!this.#ba.element||this.#ba.isInline?this.#ta.style.display="inline":this.#ta.style.display="block");var n=this.#ca(e),l=this.#Ma();!i&&l&&n!=l&&(this.#wa(d.#ea,l),r.getElementById(l).style.display="none");var h=r.getElementById(n);h?(console.log("alreadyCreated iframe"),"IMG"==h.tagName?this.#xa(h,r.getElementById("layerSpecificUI"),a):(h.style.display="block",this.#Ca(h,a)),this.#wa(d.#$r,n)):this.#La(e,t,a,i,s)}#xa(e,t,i){-1!=i.width&&-1!=i.height?(console.log(t.style.width+"/"+t.style.height),e.style.width=i.width+"px",e.style.height=i.height+"px",t.style.width=i.width+"px",t.style.height=i.height+"px",console.log("change designation size.")):e.width&&e.height?(e.style.width=e.width,e.style.height=e.height,t.style.width=e.width+"px",t.style.height=e.height+"px"):(e.style.width="100%",e.style.height="auto",this.#ta.style.width=this.#ra.width,this.#ta.style.height=this.#ra.height),e.style.display="block"}#wa(e,t){var i=this.#ta.ownerDocument;if(i.getElementById(t)&&i.getElementById(t).contentWindow){var s=i.getElementById(t),r=s.contentWindow.document.createEvent("HTMLEvents");r.initEvent(e,!0,!1),s.contentWindow.document.dispatchEvent(r);var a=document.createEvent("HTMLEvents");a.initEvent(e,!0,!1),document.dispatchEvent(a)}}#Ea(e){var t=e.indexOf("#"),i=e.indexOf("?");i>t&&(i=-1);var s,r="disableCacheQuery="+(new Date).getTime();return s=i>0?"&":"?",t>0?e.substring(0,t)+s+r+e.substring(t):e+s+r}initSvgMapWebAppLayer=function(e){var t;for(var i in this.#la){var s=this.#la[i];if(s.iframe.contentWindow===e){t=s;break}}t&&(console.log("Do initSvgMapWebAppLayer: layerID: ",i),this.#Aa(t.iframe,t.lid,t.reqSize,t.controllerURL,t.cbf),delete this.#la[t.lid])}.bind(this);#La(e,t,i,s,r){console.log("initIframe:",t,"  hiddenOnLaunch?:",s);var a=this.#ya,o=this.#ta.ownerDocument.createElement("iframe");a.appendChild(o);var n=this.#ca(e);o.id=n,s&&(console.log("iframe:",o," display:",o.style.display),o.style.display="none"),this.#la[e]={iframe:o,lid:e,reqSize:i,controllerURL:t,cbf:r},this.#Ta(o,function(){this.#la[e]?(this.#Aa(o,e,i,t,r),delete this.#la[e]):console.log("skip")}.bind(this),!1);var l=this.#Oa(t);if(console.log("initIframe: legendImage:",l),":"!=t.charAt(0)&&0==l)if("http://"==t.substr(0,7)||"https://"==t.substr(0,8)){console.log("Get controller by XHR");var h=new XMLHttpRequest,g=this;h.onreadystatechange=function(){g.#Ra(this,o,e,i)},h.open("GET",t,!0),h.send(null)}else o.src=t,o.src=this.#Ea(t);else{var d;if(l)d=this.#ka('<img src="'+t+'">');else if(this.#r.getSvgImagesProps()[e].controller)d=this.#r.getSvgImagesProps()[e].controller.src;else{var p="<h4>svgScript only  layerUI</h4>LayerID:"+e;d=this.#ka(p)}o.srcdoc=d,o.getAttribute("srcdoc")||(console.log("patch for IE&Edge:"),d=d.replace(/&quot;/g,'"'),o.contentWindow.document.write(d),o.contentWindow.document.close())}return o.setAttribute("frameborder","0"),o.style.width="100%",o.style.height="100%",o.style.border="none",s||(o.style.display="block"),o}#Oa(e){return e.indexOf(".png")>0||e.indexOf(".jpg")>0||e.indexOf(".jpeg")>0||e.indexOf(".gif")>0}#ka(e){return"<!doctype html><html><body>"+e+"</body></html>"}#Aa(e,t,i,s,r){var a=e.id;console.log("initIframe load eventListen : controllerURL:",s,"  svgMapAuthoringTool:",this.#ia),this.#wa(d.#_r,a),0==this.#aa&&(this.#aa=this.#ta.offsetHeight),e.contentWindow.layerID=t,e.contentWindow.controllerSrc=s,e.contentWindow.svgMap=this.#r,void 0!==this.#Bt&&(e.contentWindow.svgMapGIStool=this.#Bt),void 0!==this.#ia&&(e.contentWindow.svgMapAuthoringTool=this.#ia),"undefined"!=typeof svgMapPWA&&(e.contentWindow.svgMapPWA=svgMapPWA),e.contentWindow.svgMapLayerUI=this.#sa,e.contentWindow.putGlobalMessage=this.#na.putGlobalMessageForLayer(t);var o=this.#r.getSvgImagesProps()[t];e.contentWindow.svgImageProps=o,o.controllerWindow=e.contentWindow,e.contentWindow.svgImage=this.#r.getSvgImages()[t],this.#Ba[t]?(document.removeEventListener("zoomPanMap",this.#Ba[t],!1),document.removeEventListener("screenRefreshed",this.#Ba[t],!1),document.removeEventListener("zoomPanMapCompleted",this.#Ba[t],!1)):(this.#Ba[t]=this.#Ga(t),console.log("build transferCustomEvent2iframe for ",t,this.#Ba[t])),o.svgScript&&this.#Va(o.svgScript,e.contentWindow),"function"==typeof e.contentWindow.preRenderFunction&&(console.log("Register preRenderControllerFunction for layerID:",t),this.#r.getSvgImagesProps()[t].preRenderControllerFunction=e.contentWindow.preRenderFunction),this.#Na(e.contentWindow),e.contentWindow.setLoadingFlag=function(e){var i=this.#r.getSvgImagesProps();console.log("registLoadingFlag:",i[t]),1==e?this.#Da(t,i):0==e&&this.#Ua(t,i)},document.addEventListener("zoomPanMap",this.#Ba[t],!1),document.addEventListener("screenRefreshed",this.#Ba[t],!1),document.addEventListener("zoomPanMapCompleted",this.#Ba[t],!1),setTimeout(function(e,t){this.#Ca(e,t)}.bind(this),1e3,e,i),r&&r(e.contentWindow)}#Ta(e,t,i){var s,r=!1;function a(){r||(r=!0,clearTimeout(s),t.call(this),e.contentWindow.removeEventListener("error",h))}function o(){"complete"===this.readyState&&a.call(this)}function n(e,t,i){return e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,(function(){return i.call(e,window.event)}))}i&&n(e,"load",(function(){a.call(e.contentDocument||e.contentWindow.document)}));var l=!1;function h(e){console.warn("iFrame error:",e.message),l=!0}e.contentWindow.addEventListener("error",h),function t(){var i=e.contentDocument||e.contentWindow.document;if(0!==i.URL.indexOf("about:blank"))if("complete"===i.readyState){if(console.warn("Already load completed."),a.call(i),l){console.warn("Retry load process ....");var r=new Event("load");e.contentWindow.dispatchEvent(r)}}else n(i,"DOMContentLoaded",a),n(i,"readystatechange",o);else s=setTimeout(t,1)}()}#Va(e,t){var i="";console.log("controllerWindow:",t),t.svgImageProps&&t.svgImageProps.CRS&&t.svgImageProps.CRS.unresolved&&t.svgImageProps.CRS.transformFunctionName&&(i="transformFunction: "+t.svgImageProps.CRS.transformFunctionName+",",console.log("transformRetStr set:",i)),t.svgScript=t.Function(`\n\t\t\t${e}\n\t\t\tvar document = svgImage;\n//\t\t\tvar refreshScreen = function(){svgMap.refreshScreen()};\n\t\t\tconsole.log("arrangeHtmlEmbedScript svgScript launched : location.href:",location.href);\n\t\t\tsetTimeout(function(){\n\t\t\t\tconsole.log("arrangeHtmlEmbedScript svgScript Timeout: layerID:",layerID,"  svgImage : ", svgImage);\n\t\t\t\tdocument = svgImage;\n//\t\t\t\ttransform = svgMap.transform.bind(svgMap);\n\t\t\t\tsvgMap.refreshScreen();\n\t\t\t},1);\n\t\t\t\n\t\t\tvar scale,geoViewBox,CRS,docId,actualViewBox;\n\t\t\tvar onload, onzoom, onscroll; \n\t\t\tfunction preRenderFunction(svgDocStatus){\n\t\t\t\t\n\t\t\t\tscale = svgImageProps.scale;\n\t\t\t\tsvgImageProps.script.scale = scale;\n\t\t\t\tgeoViewBox = svgImageProps.geoViewBox;\n\t\t\t\tactualViewBox = svgDocStatus.actualViewBox;\n\t\t\t\tsvgImageProps.script.geoViewBox = geoViewBox;\n\t\t\t\tCRS = svgImageProps.CRS;\n\t\t\t\tsvgImageProps.script.CRS = CRS;\n\t\t\t\tdocId = layerID;\n\t\t\t\tsvgImageProps.script.location=svgDocStatus.location;\n\t\t\t\t\n\t\t\t\t// console.log("svgScript preRenderFunction　this?:",this, geoViewBox);\n\t\t\t\tif ( svgDocStatus && svgDocStatus.viewChanged=="scroll"){\n\t\t\t\t\tif ( typeof(onscroll)=="function" && window.onscroll!=onscroll ){ \n\t\t\t\t\t\tonscroll.call(svgImageProps.script);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif ( typeof(onzoom)=="function" && window.onzoom!=onzoom ){\n\t\t\t\t\t\tonzoom.call(svgImageProps.script);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfunction refreshScreen(...params){\n\t\t\t\treturn ( svgMap.refreshScreen(...params));\n\t\t\t}\n\t\t\tfunction transform(...params){\n\t\t\t\treturn ( svgMap.transform(...params));\n\t\t\t}\n\t\t\tfunction getCanvasSize(){\n\t\t\t\treturn ( svgMap.getCanvasSize());\n\t\t\t}\n\t\t\tfunction getCORSURL(originalURL, alsoCrossoriginParam){\n\t\t\t\treturn ( svgMap.getCORSURL(originalURL, alsoCrossoriginParam));\n\t\t\t}\n\t\t\t\n\t\t\tfunction onloadFunction(svgDocStatus){\n\t\t\t\t// console.log("window.onload:",window.onload,"  this.onload:",this.onload,"  onload:",onload," window.onload==onload?:",window.onload==onload);\n\t\t\t\t\n\t\t\t\tscale = svgImageProps.scale;\n\t\t\t\tsvgImageProps.script.scale = scale;\n\t\t\t\tgeoViewBox = svgImageProps.geoViewBox;\n\t\t\t\tactualViewBox = svgDocStatus.actualViewBox;\n\t\t\t\tsvgImageProps.script.geoViewBox = geoViewBox;\n\t\t\t\tCRS = svgImageProps.CRS;\n\t\t\t\tsvgImageProps.script.CRS = CRS;\n\t\t\t\tdocId = layerID;\n\t\t\t\tsvgImageProps.script.location=svgDocStatus.location;\n\t\t\t\t\n\t\t\t\tif ( typeof(onload)=="function" && window.onload!=onload ){\n//\t\t\t\t\tsvgImageProps.script.location=svgDocStatus.location;\n\t\t\t\t\t// console.log("onloadFunctionZ　this?:",this, "  location:",location,"  svgDocStatus:",svgDocStatus);\n\t\t\t\t\tonload.call(svgImageProps.script); \n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tfunction getTransforrmFunction(fName){\n\t\t\t\t\n\t\t\t\tvar ans= new Function("return " + fName );\n\t\t\t\treturn ( ans );\n\t\t\t}\n\t\t\t\n\t\t\treturn{\n\t\t\t\tonloadFunction : onloadFunction,\n\t\t\t\tpreRenderFunction : preRenderFunction,\n\t\t\t\t${i}\n\t\t\t}\n\t\t`),t.svgImageProps.script=t.svgScript(),t.preRenderFunction||(t.preRenderFunction=t.svgImageProps.script.preRenderFunction),t.svgImageProps.script.onloadFunction(this.#oa(t.layerID))}#Na(e){var t,i,s=this.#r.getSvgImagesProps(),r=this;e.fetch=function(t){return async function(){r.#Da(e.layerID,s);const i=await t.apply(e,arguments);return r.#Ua(e.layerID,s),i}}(e.fetch),t=e.XMLHttpRequest.prototype.send,e.XMLHttpRequest.prototype.send=function(){r.#Da(e.layerID,s);var i=this.onreadystatechange;this.onreadystatechange=function(){4==this.readyState&&(this.responseURL,r.#Ua(e.layerID,s)),i&&i.apply(this,arguments)},t.apply(this,arguments)},i=e.XMLHttpRequest.prototype.open,e.XMLHttpRequest.prototype.open=function(){i.apply(this,arguments)}}#Da(e,t){t[e].xhrLoading?++t[e].xhrLoading:t[e].xhrLoading=1,this.#Fa=!1}#Ua(e,t){t[e].xhrLoading?--t[e].xhrLoading:console.error("svgImagesProps["+e+"].xhrLoading flag is inconsistent."),this.#Ha(t)}#ja(){var e=this.#r.getSvgImagesProps();this.#za=!0,this.#Ha(e)}#Ha(e){var t=0;for(var i in e)e[i].xhrLoading&&(t+=e[i].xhrLoading);0==t&&0==this.#Fa&&(this.#Fa=!0,setTimeout(function(){this.#Wa()}.bind(this),d.#Jr))}#za=!1;#Fa=!1;#Wa(){if(this.#Fa){if(this.#za){this.#za=!1;var e=document.createEvent("HTMLEvents");e.initEvent("zoomPanMapCompleted",!0,!1),document.dispatchEvent(e)}this.#Fa=!1}}#Ra(e,t,i,s){if(4==e.readyState)if(403!=e.status&&404!=e.status&&500!=e.status&&503!=e.status){console.log("initIframePh2(byXHR): httpRes: ",e,"   lid:",i);var r=e.responseText,a=`<base href='${e.responseURL}'>`;r.indexOf("<script")>0&&(r=r.indexOf("</head>")>0?r.replace("</head>",`${a}</head>`):r.replace(/<html[^>]*>/,`$&<head>${a}</head>`)),t.srcdoc=r,t.getAttribute("srcdoc")||(console.log("patch for IE&Edge"),r=r.replace(/&quot;/g,'"'),t.contentWindow.document.write(r),t.contentWindow.document.close())}else console.log("csvXHR2 : File get failed")}#Ya(e){return e&&e.indexOf("px")>0?Number(e.substring(0,e.indexOf("px"))):0}#Xa=0;#Za(e,t){this.#va&&(0==e.offsetWidth?this.#va.style.right="0px":this.#ta.clientWidth-e.offsetWidth!=this.#Xa&&(this.#Xa=this.#ta.clientWidth-e.offsetWidth,this.#Xa>0?this.#va.style.right=this.#Xa+"px":this.#va.style.right="0px"),t||this.#ta.clientWidth!=e.offsetWidth||setTimeout(function(e,t){this.#Za(e,t)}.bind(this),1e3,e,!0))}#Ca(e,t){if(console.log("testIframeSize:",e,e.style),"none"!=e.style.display){var i=window.innerHeight-this.#Ya(this.#ra.top)-50,s=window.innerWidth-this.#Ya(this.#ra.left)-this.#Ya(this.#ra.right)-50;!e.contentWindow||this.#ba.element&&!this.#ba.autoSizing||(this.#Za(e.contentWindow.document.documentElement),t.width>0?t.width<s?this.#ta.style.width=t.width+"px":this.#ta.style.width=s+"px":this.#ta.style.width=this.#ra.width,t.height>0?t.height<i?this.#ta.style.height=t.height+"px":this.#ta.style.height=i+"px":e.contentWindow.document.body.offsetHeight<this.#aa?this.#ta.style.height=50+e.contentWindow.document.body.offsetHeight+"px":this.#ta.style.height=this.#ra.height)}}#Ba=[];#Ga(e){return function(t){console.log("get event from root doc : type: ",t.type," forLayer:",e);var i=this.#ta.ownerDocument.getElementById(this.#ca(e));if(i){var s=i.contentWindow.document.createEvent("HTMLEvents");s.initEvent(t.type,!0,!1),i.contentWindow.document.dispatchEvent(s)}}.bind(this)}#Ia(){var e=this.#ta.ownerDocument,t=this.#Ma();this.#wa(d.#ea,t),e.getElementById(t).style.display="none",this.#ba.element&&!this.#ba.isInline||(this.#ta.style.display="none",this.#ta.style.height=this.#ra.height)}#ga(e,t){if(this.#ta){var i=this.#ta.ownerDocument,s=this.#Ma(),r=this.#ca(e);if(0==t&&i.getElementById(r)){s==r&&this.#Ia();var a=i.getElementById(r);console.log("close layer specific UI for:",e),document.removeEventListener("zoomPanMap",this.#Ba[e],!1),document.removeEventListener("screenRefreshed",this.#Ba[e],!1),document.removeEventListener("zoomPanMapCompleted",this.#Ba[e],!1),delete this.#Ba[e],this.#wa(d.#Qr,r),this.#na.clearGlobalMessage(e),setTimeout((function(){console.log("remove iframe:",a.id),a.parentNode.removeChild(a)}),100)}}}#qa=!1;#Ka(){var e=this.#r.getRootLayersProps();this.#qa=!1;for(var t=0;t<e.length;t++)e[t].visible&&(e[t].svgImageProps&&e[t].hasDocument?this.#pa(e[t].svgImageProps,e[t].id):this.#qa=!0)}#Ja(){this.#qa&&this.#Ka()}#Pa(){addEventListener("zoomPanMap",function(e){this.#Ja(e)}.bind(this),!1),addEventListener("zoomPanMap",function(e){this.#ja(e)}.bind(this),!1),addEventListener("screenRefreshed",function(e){this.#Ja(e)}.bind(this),!1),this.#Ka()}assignLayerSpecificUiElement(...e){return this.#Sa(...e)}initLayerSpecificUI(...e){return this.#fa(...e)}showLayerSpecificUI(...e){return this.#ma(...e)}updateLayerSpecificWebAppHandler(){this.#ha(),this.#Ka()}}class p{getTransformedBox(e,t){if(t.transform||0!=t.b||0!=t.c){if(t.transform){if(t.transform){for(i=[],s=[],r=4,a=0;a<=r;a++)for(o=0;o<=r;o++){n=t.transform({x:e.x+o*e.width/r,y:e.y+a*e.height/r});i.push(n.x),s.push(n.y)}return{x:l=Math.min.apply(null,i),y:h=Math.min.apply(null,s),width:Math.max.apply(null,i)-l,height:Math.max.apply(null,s)-h}}return null}for(var i=[],s=[],r=1,a=0;a<=r;a++)for(var o=0;o<=r;o++){var n=this.transform(e.x+o*e.width/r,e.y+a*e.height/r,t);i.push(n.x),s.push(n.y)}return{x:l=Math.min.apply(null,i),y:h=Math.min.apply(null,s),width:Math.max.apply(null,i)-l,height:Math.max.apply(null,s)-h}}var l,h,g,d;return t.a>0?(l=t.a*e.x+t.e,g=t.a*e.width):(l=t.a*(e.x+e.width)+t.e,g=-t.a*e.width),t.d>0?(h=t.d*e.y+t.f,d=t.d*e.height):(h=t.d*(e.y+e.height)+t.f,d=-t.d*e.height),{x:l,y:h,width:g,height:d}}matMul(e,t){return e.transform||t.transform?{transform:function(i){var s;return s=e.transform?e.transform(i):this.transform(i.x,i.y,e),t.transform?t.transform(s):this.transform(s.x,s.y,t)}.bind(this)}:{a:t.a*e.a+t.b*e.b,b:t.b*e.a+t.d*e.b,c:t.a*e.c+t.c*e.d,d:t.b*e.c+t.d*e.d,e:t.a*e.e+t.c*e.f+t.e,f:t.b*e.e+t.d*e.f+t.f}}transform(e,t,i,s,r){if(1==s){if(i.transform){var a=i.transform(0,0);return(o=i.transform({x:e,y:t})).x=o.x-a.x,o.y=o.y-a.y,o}return{x:i.a*e+i.c*t,y:i.b*e+i.d*t}}var o;return r?i?i.transform?((o=i.transform({x:r.x,y:r.y})).x=o.x+e,o.y=o.y+t,o):{x:i.a*r.x+i.c*r.y+i.e+e,y:i.b*r.x+i.d*r.y+i.f+t}:{x:r.x+e,y:r.y+t}:i?i.transform?o=i.transform({x:e,y:t}):{x:i.a*e+i.c*t+i.e,y:i.b*e+i.d*t+i.f}:{x:e,y:t}}SVG2Geo(e,t,i,s){var r;if(r=s||this.getInverseMatrix(i)){var a=this.transform(e,t,r);return{lng:a.x,lat:a.y}}return null}Geo2SVG(e,t,i){return this.transform(t,e,i)}getConversionMatrixViaGCS(e,t){var i=this.getInverseMatrix(e);if(t.transform||e.transform){var s=this.getInverseMatrix(t);return{transform:function(e){var s=this.transform(e.x,e.y,i);return this.transform(s.x,s.y,t)}.bind(this),inverse:function(t){var i=this.transform(t.x,t.y,s);return this.transform(i.x,i.y,e)}.bind(this),scale:(i.inverse?i.scale:Math.sqrt(Math.abs(i.a*i.d-i.b*i.c)))*(t.inverse?t.scale:Math.sqrt(Math.abs(t.a*t.d-t.b*t.c)))}}var r=t.a*i.a+t.c*i.b,a=t.b*i.a+t.d*i.b,o=t.a*i.c+t.c*i.d,n=t.b*i.c+t.d*i.d;return{a:r,b:a,c:o,d:n,e:t.a*i.e+t.c*i.f+t.e,f:t.b*i.e+t.d*i.f+t.f,scale:Math.sqrt(Math.abs(r*n-a*o))}}matMul(e,t){return e.transform||t.transform?{transform:function(i){var s;return s=e.transform?e.transform(i):this.transform(i.x,i.y,e),t.transform?t.transform(s):this.transform(s.x,s.y,t)}.bind(this)}:{a:t.a*e.a+t.c*e.b,b:t.b*e.a+t.d*e.b,c:t.a*e.c+t.c*e.d,d:t.b*e.c+t.d*e.d,e:t.a*e.e+t.c*e.f+t.e,f:t.b*e.e+t.d*e.f+t.f}}transformRect(e,t){var i;i=e.transform?this.matMul(e.transform,t):t;var s=this.getTransformedBox(e,i);return s.c2rScale=t.scale,s}getInverseMatrix(e){if(e.inverse)return{transform:e.inverse,inverse:e.transform,scale:1/e.scale};var t=e.a*e.d-e.b*e.c;return 0!=t?{a:e.d/t,b:-e.b/t,c:-e.c/t,d:e.a/t,e:(-e.d*e.e+e.c*e.f)/t,f:(e.b*e.e-e.a*e.f)/t}:null}}class c{constructor(){this.scale=1/360,this.mercator=!0}#_a(e,t){var i=Math.sin(e*Math.PI/180);return{x:(t+180)/360*1,y:1*(.5-Math.log((1+i)/(1-i))/(4*Math.PI))}}#Qa(e,t){var i=e/1-.5,s=.5-t/1;return{lat:90-360*Math.atan(Math.exp(2*-s*Math.PI))/Math.PI,lng:360*i}}transform=function(e){return this.#_a(e.y,e.x)}.bind(this);inverse=function(e){var t=this.#Qa(e.x,e.y);return{x:t.lng,y:t.lat}}.bind(this);scale;mercator}class u{#$a=!1;#eo;#to;#io;#so;#ro;#ao;#oo;#kt;#no;constructor(e,t,i,s,r,a,o){this.#io=e,this.#so=t,this.#ro=i,this.#ao=s,this.#oo=r,this.#no=o,this.#kt=a}#lo(e){e.touches.length>1&&this.#ho(e.touches.length+" : "+e.touches[0].pageX+","+e.touches[0].pageY+" : "+e.touches[1].pageX+","+e.touches[1].pageY)}#ho(e){document.getElementById("posCmt").innerHTML=e}#go=0;#do(e){var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;return Math.sqrt(t*t+i*i)}getMouseXY=function(e){var t,i;return this.#kt.uaProps.isIE?(t=event.clientX,i=event.clientY):e.type.indexOf("touch")>=0?e.touches.length>0?(t=e.touches[0].pageX,i=e.touches[0].pageY):e.changedTouches.length>0&&(t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY):(t=e.clientX,i=e.clientY),{x:t,y:i}}.bind(this);startPan=function(e){this.#po=0,this.#co=0,e&&e.button&&2==e.button?this.#uo=1:this.#uo=-1;var t=!1;e&&e.shiftKey&&-1==this.#uo&&(console.log("SHIFT-ZOOM MODE"),t=!0);var i=this.getMouseXY(e);return this.#eo=i.x,this.#to=i.y,this.#go=0,!this.#kt.uaProps.isIE&&e.type.indexOf("touch")>=0&&e.touches.length>1&&(this.#uo=1,this.#go=this.#do(e)),this.#mo=0,this.#yo=0,this.#io(),this.#$a=!0,1==t?"function"==typeof requestAnimationFrame?this.#vo=requestAnimationFrame(this.#fo):this.#vo=setTimeout(this.#fo,this.#bo):"function"==typeof requestAnimationFrame?this.#vo=requestAnimationFrame(this.#Io):this.#vo=setTimeout(this.#Io,this.#bo),!!this.#kt.uaProps.isIE}.bind(this);#vo;endPan=function(){if(clearTimeout(this.#vo),this.#$a)if(this.#$a=!1,this.#Po&&""==this.#Po.style.display){this.#Po.style.display="none";var e=Math.min(this.#eo+this.#mo,this.#eo),t=Math.max(this.#to+this.#yo,this.#to),i=this.#no.screen2Geo(e,t);e=Math.max(this.#eo+this.#mo,this.#eo),t=Math.min(this.#to+this.#yo,this.#to);var s=this.#no.screen2Geo(e,t);this.#so(!0),this.#no.setGeoViewPort(i.lat,i.lng,s.lat-i.lat,s.lng-i.lng)}else if(0!=this.#mo||0!=this.#yo)if(this.#kt.mapCanvas.style.top="0px",this.#kt.mapCanvas.style.left="0px",this.#So(this.#kt.mapCanvas,{a:1,b:0,c:0,d:1,e:0,f:0}),this.#so(!0),-1!=this.#uo)this.zoom(1/this.#uo),this.#uo=-1;else{this.#Mo(1,this.#mo,this.#yo);var r=this.#oo(),a=this.#no.getRootViewBox();a.x-=this.#mo/r.a,a.y-=this.#yo/r.d,this.#no.setRootViewBox(a),this.#no.refreshScreen()}else this.#ro(this.#eo,this.#to)}.bind(this);#mo;#yo;#po;#co;#uo=-1;wheelZooming=!1;showPanning=function(e){if(this.#$a){if(this.wheelZooming&&"wheelDummy"!=e.type)return!1;this.#kt.uaProps.isIE?0==event.buttons?this.endPan():(this.#mo=event.clientX-this.#eo,this.#yo=event.clientY-this.#to):e.type.indexOf("touch")>=0?(this.#mo=e.touches[0].pageX-this.#eo,this.#yo=e.touches[0].pageY-this.#to,-1!=this.#uo&&(this.#uo=this.#do(e)/this.#go)):0==e.buttons?this.endPan():(this.#mo=e.clientX-this.#eo,this.#yo=e.clientY-this.#to),this.#uo>0&&(0==this.#go&&(this.#uo=Math.exp(this.#yo/(this.#kt.mapCanvasSize.height/2))/Math.exp(0)),this.#uo<.1&&(this.#uo=.1)),Math.abs(this.#po-this.#mo)>200||Math.abs(this.#co-this.#yo)>200?this.endPan():(this.#po=this.#mo,this.#co=this.#yo)}return!1}.bind(this);#Po;#fo=function(){if(this.#$a){this.#Po||(this.#Po=document.createElement("span"),this.#Po.id="shiftZoomingBox",this.#Po.style.position="absolute",this.#Po.style.opacity="0.5",this.#Po.style.backgroundColor="gray",document.getElementById("centerSight").insertAdjacentElement("afterend",this.#Po)),this.#Po.style.display="";var e=Math.min(this.#eo+this.#mo,this.#eo),t=Math.min(this.#to+this.#yo,this.#to);this.#Po.style.top=t+"px",this.#Po.style.left=e+"px",this.#Po.style.width=Math.abs(this.#mo)+"px",this.#Po.style.height=Math.abs(this.#yo)+"px","function"==typeof requestAnimationFrame?this.#vo=requestAnimationFrame(this.#fo):this.#vo=setTimeout(this.#fo,this.#bo)}}.bind(this);#Io=function(){return this.#$a&&(this.#wo(this.#mo,this.#yo,this.#uo),"function"==typeof requestAnimationFrame?this.#vo=requestAnimationFrame(this.#Io):this.#vo=setTimeout(this.#Io,this.#bo)),!1}.bind(this);#So(e,t){var i;i=(this.#kt.uaProps.verIE,"matrix("+t.a+","+t.b+","+t.c+","+t.d+","+t.e+","+t.f+")"),e.style.transform=i,e.style.webkitTransform=i,e.style.MozTransform=i,e.style.msTransform=i,e.style.OTransform=i}#wo(e,t,i){var s;this.#kt.uaProps.verIE>8?(s=-1!=i?{a:i,b:0,c:0,d:i,e:0,f:0}:{a:1,b:0,c:0,d:1,e:e,f:t},this.#So(this.#kt.mapCanvas,s)):(this.#kt.mapCanvas.style.top=t+"px",this.#kt.mapCanvas.style.left=e+"px")}zoom=function(e){var t=this.#no.getRootViewBox(),i=t.x+.5*t.width,s=t.y+.5*t.height;t.width=t.width*e,t.height=t.height*e,t.x=i-t.width/2,t.y=s-t.height/2,this.#no.setRootViewBox(t),this.#Mo(1/e,0,0),this.#no.refreshScreen()}.bind(this);#xo=300;#Co=0;#bo=20;setSmoothZoomTransitionTime=function(e){Number(e)>0?this.#xo=Number(e):this.#xo=300}.bind(this);setSmoothZoomInterval=function(e){Number(e)>0?this.#bo=Number(e):this.#bo=20}.bind(this);#Lo(e,t,i,s){if(s||(s=1),!t){if(-1!=this.#uo)return void(this.#Co=e);t=new Date}var r=new Date-t,a=this;if(i)if(0!=this.#Co){var o=e*this.#Co;"function"==typeof requestAnimationFrame?requestAnimationFrame((function(){a.#Lo(o,new Date,!1,e)})):setTimeout(function(e,t,i,s){this.#Lo(e,t,i,s)}.bind(this),this.#bo,o,new Date,!1,e),this.#Co=0}else this.#kt.mapCanvas.style.top="0px",this.#kt.mapCanvas.style.left="0px",this.#So(this.#kt.mapCanvas,{a:1,b:0,c:0,d:1,e:0,f:0}),this.#uo=-1,this.#so(!0),this.zoom(e);else r<this.#xo?(this.#uo=1/s+(1/e-1/s)*(r/this.#xo),this.#wo(0,0,this.#uo),"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){a.#Lo(e,t,!1,s)}.bind(this)):setTimeout(function(e,t,i,s){this.#Lo(e,t,i,s)}.bind(this),this.#bo,e,t,!1,s)):(this.#wo(0,0,1/e),"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){a.#Lo(e,t,!0,s)}.bind(this)):setTimeout(function(e,t,i,s){this.#Lo(e,t,i,s)}.bind(this),this.#bo,e,t,!0,s))}#Mo(e,t,i){var s=this.#kt.mapCanvas.getElementsByTagName("img"),r=this.#kt.mapCanvasSize;if(this.#kt.uaProps.IE)for(var a=s.length-1;a>=0;a--)s.item(a).parentNode.removeChild(s.item(a));else{var o=[],n=[];for(a=s.length-1;a>=0;a--){var l=Number(s.item(a).style.left.replace("px","")),h=Number(s.item(a).style.top.replace("px","")),g=Number(s.item(a).width),d=Number(s.item(a).height);o[a]=this.#ao((l-.5*r.width)*e+.5*r.width+t,g*e),n[a]=this.#ao((h-.5*r.height)*e+.5*r.height+i,d*e)}for(a=s.length-1;a>=0;a--){var p=o[a],c=n[a],u=new Object;u.x=p.p0,u.y=c.p0,u.width=p.span,u.height=c.span,s.item(a).style.left=p.p0+"px",s.item(a).style.top=c.p0+"px",s.item(a).width=p.span,s.item(a).height=c.span,s.item(a).style.width=p.span+"px",s.item(a).style.height=c.span+"px"}}for(a=(s=this.#kt.mapCanvas.getElementsByTagName("canvas")).length-1;a>=0;a--){l=0,h=0,g=Number(s.item(a).width),d=Number(s.item(a).height),p=this.#ao((l-.5*r.width)*e+.5*r.width+t,g*e),c=this.#ao((h-.5*r.height)*e+.5*r.height+i,d*e);s.item(a).style.left=p.p0+"px",s.item(a).style.top=c.p0+"px",s.item(a).width=p.span,s.item(a).height=c.span}}#Eo=1.7320508;setZoomRatio(e){this.#Eo=e}zoomup=function(){this.#Lo(1/this.#Eo)}.bind(this);zoomdown=function(){this.#Lo(this.#Eo)}.bind(this)}class m{verIE=100;isIE=!1;isSP;uaProp;name;MS;IE;Edge;Blink;smartPhone;old;constructor(){this.isSP=this.#Ao(),this.uaProp=this.#To(),this.#Oo()}#Ao(){return navigator.userAgent.indexOf("iPhone")>0||navigator.userAgent.indexOf("iPad")>0||navigator.userAgent.indexOf("iPod")>0||navigator.userAgent.indexOf("Android")>0||navigator.userAgent.indexOf("Mobile")>0&&navigator.userAgent.indexOf("Gecko")>0}#To(){var e,t=!1,i=!1,s=!1,r=!1,a=!1,o=this.#Ao();return navigator.userAgent.indexOf("Trident")>=0?(e="IE",t=!0,i=!0):navigator.userAgent.indexOf("MSIE")>=0?(e="IE",t=!0,i=!0,a=!0):navigator.userAgent.indexOf("Edge")>=0?(e="Edge",t=!0,r=!0):navigator.userAgent.indexOf("Firefox")>=0?e="Firefox":navigator.userAgent.indexOf("Opera")>=0?(e="Opera",s=!0):navigator.userAgent.indexOf("Safari")>=0&&navigator.userAgent.indexOf("Chrome")<0?e="Safari":navigator.userAgent.indexOf("Chrome")>=0&&(e="Chrome",s=!0),this.name=e,this.MS=t,this.IE=i,this.Edge=r,this.Blink=s,this.smartPhone=o,this.old=a,{name:e,MS:t,IE:i,Edge:r,Blink:s,smartPhone:o,old:a}}#Oo(){if("Microsoft Internet Explorer"==navigator.appName||navigator.userAgent.indexOf("Trident")>=0){this.isIE=!0;var e=navigator.appVersion.toLowerCase();console.log("checkIE:",e),e.indexOf("msie")>-1?this.verIE=parseInt(e.replace(/.*msie[ ]/,"").match(/^[0-9]+/)):this.verIE=parseInt(e.match(/(msie\s|rv:)([\d\.]+)/)[2])}}}class y{#no;#Ro;#ze;#ko;constructor(e,t){this.#no=e,this.#Ro=new p,this.#ze=t,this.#Bo=new Object}GISgeometriesCaptureFlag=!1;GISgeometriesCaptureOptions={BitImageGeometriesCaptureFlag:!1,TreatRectAsPolygonFlag:!1,SkipVectorRendering:!1,captureAlsoAsBitImage:!1};#Bo;#Go;#Vo(){console.log("CGET:",(new Date).getTime()-this.#Go)}captureGISgeometries(e,t,i,s,r,a,o,n){if(this.GISgeometriesCaptureFlag)return console.log("Now processing another captureGISgeometries. Try later."),e(!1),!1;this.#Go=(new Date).getTime(),this.GISgeometriesCaptureFlag=!0,this.#Bo=new Object;var l=function(){document.removeEventListener("screenRefreshed",l,!1),console.log("screenRefreshed start prepare Geom"),this.#Vo(),this.#No(e,t,i,s,r,a,o,n)}.bind(this);document.addEventListener("screenRefreshed",l,!1),console.log("Start capture geom"),this.#no.refreshScreen()}#No(e,t,i,s,r,a,o,n){var l=this.#no.getSvgImagesProps();for(var h in this.#Bo){var g=this.#Bo[h];if(g.length>0)for(var d,p,c=l[h].CRS,u=this.#Ro.getInverseMatrix(c),m=0;m<g.length;m++){var y=g[m];if("Point"===y.type)d=this.#Ro.SVG2Geo(y.svgXY[0],y.svgXY[1],null,u),y.coordinates=[d.lng,d.lat];else if("Coverage"===y.type)if(y.coordinates=new Array,!y.transform||y.transform&&0==y.transform.b&&0==y.transform.c){if(y.transform){var v=this.#Ro.transform(y.svgXY[0][0],y.svgXY[0][1],y.transform),f=this.#Ro.transform(y.svgXY[1][0],y.svgXY[1][1],y.transform);d=this.#Ro.SVG2Geo(v.x,v.y,null,u),p=this.#Ro.SVG2Geo(f.x,f.y,null,u)}else d=this.#Ro.SVG2Geo(y.svgXY[0][0],y.svgXY[0][1],null,u),p=this.#Ro.SVG2Geo(y.svgXY[1][0],y.svgXY[1][1],null,u);y.coordinates.push({lat:Math.min(d.lat,p.lat),lng:Math.min(d.lng,p.lng)}),y.coordinates.push({lat:Math.max(d.lat,p.lat),lng:Math.max(d.lng,p.lng)}),delete y.transform}else y.coordinates.push({x:y.svgXY[0][0],y:y.svgXY[0][1]}),y.coordinates.push({x:y.svgXY[1][0],y:y.svgXY[1][1]}),geoTf=this.#Ro.matMul(y.transform,u),y.transform=geoTf;else if(y.coordinates=new Array,1==y.svgXY.length&&1==y.svgXY[0].length)d=this.#Ro.SVG2Geo(y.svgXY[0][0][0],y.svgXY[0][0][1],null,u),y.coordinates=[d.lng,d.lat],y.type="Point";else for(var b=0;b<y.svgXY.length;b++){var I=y.svgXY[b],P=new Array;if("Polygon"===y.type&&I.length>2||"MultiLineString"===y.type&&I.length>1){for(var S=0;S<I.length;S++){var M=I[S];if(d=this.#Ro.SVG2Geo(M[0],M[1],null,u),0==S)var w=d;P.push([d.lng,d.lat])}"Polygon"!==y.type||w.lat==d.lat&&w.lng==d.lng||P.push([w.lng,w.lat]),y.coordinates.push(P)}}delete y.svgXY}}this.GISgeometriesCaptureFlag=!1,this.GISgeometriesCaptureOptions.captureAlsoAsBitImage&&this.#Do(this.#Bo),e(this.#Bo,t,i,s,r,a,o,n)}prepareDocGeometries(e){this.#Bo[e]||(this.#Bo[e]=new Array)}removeDocGeometries(e){delete this.#Bo[e]}addGeometry(e,t,i,s){t.href?(t.href=this.#ze(t.href,s),(i&&i.naturalHeight>0||0==t.href.indexOf("data:")||0==t.href.indexOf("blob:"))&&this.#Bo[e].push(t)):this.#Bo[e].push(t)}dummy2DContextBuilder(){var e={};for(var t of["clearRect","fillRect","strokeRect","fillText","strokeText","measureText","getLineDash","setLineDash","createLinearGradient","createRadialGradient","createPattern","beginPath","closePath","moveTo","lineTo","bezierCurveTo","quadraticCurveTo","arc","arcTo","ellipse","rect","fill","stroke","drawFocusIfNeeded","scrollPathIntoView","clip","isPointInPath","isPointInStroke","rotate","scale","translate","transform","setTransform","resetTransform","drawImage","createImageData","getImageData","putImageData","save","restore","addHitRegion","removeHitRegion","clearHitRegions"])e[t]=function(){};return e}#Do(e){var t=this.getLayerCanvases(e),i=this.#no.getSvgImagesProps().root,s=svgMap.getGeoViewBox();for(var r in console.log("layerCanvases:",t," root SvgImagesProps:",i),t){var a=t[r].toDataURL("image/png");console.log("imgUri:",r," url:",a);var o=this.#Uo(a,s,i.CRS);e[r]=e[r].concat(o)}}#Uo(e,t,i){i.transform;var s=document.createElement("span");return s.setAttribute("iid","layerCanvasImage"),[{type:"Coverage",coordinates:[{lat:t.y,lng:t.x},{lat:t.y+t.height,lng:t.x+t.width}],href:e,layerCanvasImage:!0,src:s}]}splitImage=async function(e){var t=await this.getImage(e),i=Math.ceil(t.naturalWidth/4),s=Math.ceil(t.naturalHeight/4),r=document.createElement("canvas");r.width=i,r.height=s;for(var a=r.getContext("2d"),o=[],n=0;n<4;++n){for(var l=[],h=0;h<4;++h)a.clearRect(0,0,i,s),a.drawImage(t,h*i,n*s,i,s,0,0,i,s),l.push(r.toDataURL());o.push(l)}return o};getImage(e){return new Promise((function(t){var i=new Image;i.src=e,i.onload=function(){t(i)}}))}getLayerCanvases(e){var t={};for(var i in e){var s=document.getElementById(i+"_canvas");s&&(t[i]=s)}return t}}class v{type;svgXY;src;static createSVGMapGISgeometry(e,i,s,r){return e==t.EMBEDSVG?(console.log("return null for GISGeometry"),null):e!=t.BITIMAGE||r.BitImageGeometriesCaptureFlag?new v(e,i,s,r):(console.log("return null for GISGeometry"),null)}constructor(e,i,s,r){switch(e){case t.EMBEDSVG:break;case t.BITIMAGE:r.BitImageGeometriesCaptureFlag&&(this.type="Coverage");break;case t.POI:this.type="Point";break;case t.VECTOR2D:switch(i){case t.PATH:this.type="TBD";break;case t.POLYLINE:this.type="MultiLineString";break;case t.POLYGON:this.type="Polygon";break;case t.RECT:r.TreatRectAsPolygonFlag?this.type="Polygon":this.type="Point";break;case t.CIRCLE:case t.ELLIPSE:this.type="Point"}}this.type&&(this.src=s)}determineType(e){"TBD"===this.type&&(e.fill&&"none"!=e.fill?this.type="Polygon":this.type="MultiLineString"),e.usedParent&&(this.usedParent=e.usedParent,this.type="Point")}setCoverage(e,t,i,s,r,a){this.svgXY=[],this.svgXY[0]=[e,t],this.svgXY[1]=[e+i,t+s],this.transform=r,this.href=a}setPoint(e,t){this.svgXY=[e,t]}makePath(){this.svgXY=new Array}startSubPath(e,t){var i=[[e,t]];this.svgXY.push(i)}addSubPathPoint(e,t){var i=[e,t];this.svgXY[this.svgXY.length-1].push(i)}}class f{static getLinearTransformMatrix(e,t,i,s,r,a,o,n,l,h,g,d){var p=f.getTernarySimultaneousEquationsSolution(e,t,1,i,s,1,r,a,1,o,l,g),c=f.getTernarySimultaneousEquationsSolution(e,t,1,i,s,1,r,a,1,n,h,d);return p&&c?{a:p.x1,c:p.x2,e:p.x3,b:c.x1,d:c.x2,f:c.x3}:null}static getTernarySimultaneousEquationsSolution(e,t,i,s,r,a,o,n,l,h,g,d){var p=e*r*l+t*a*o+i*s*n-e*a*n-t*s*l-i*r*o;return 0==p?null:{x1:(h*r*l+t*a*d+i*g*n-h*a*n-t*g*l-i*r*d)/p,x2:(e*g*l+h*a*o+i*s*d-e*a*d-h*s*l-i*g*o)/p,x3:(e*r*d+t*g*o+h*s*n-e*g*n-t*s*d-h*r*o)/p}}}class b{#Es;#jt;#Fo;#Ro;constructor(e,t,i){this.#Es=e,this.#jt=this.#Es.getSvgImagesProps(),this.#Fo=t,this.#Ro=i}vectorDataWrapperForShowPoiProperty(e,t,i){var s=this.getVectorMetadata(e,i,t),r=this.getMetadataObject(s.metadata,s.metaSchema,s.title),a=this.#Es.screen2Geo(t.x,t.y+t.height),o=this.#Es.screen2Geo(t.x+t.width,t.y),n=e.getAttribute("content");i&&i.getAttribute("content")&&e.setAttribute("content",i.getAttribute("content")),console.log("targetElement:",e),e.setAttribute("lat",a.lat+","+o.lat),e.setAttribute("lng",a.lng+","+o.lng),e.setAttribute("data-title",r.title),this.showPoiPropertyWrapper(e),n?e.setAttribute("content",n):e.setAttribute("content",""),e.removeAttribute("data-title"),e.removeAttribute("lat"),e.removeAttribute("lng")}getVectorMetadata(e,t,i){console.log("called getVectorMetadata: ",e,t,i);var s=this.#Es.screen2Geo(i.x,i.y+i.height),r=this.#Es.screen2Geo(i.x+i.width,i.y),a="",o="";t&&t.getAttribute("content")?a=t.getAttribute("content"):e.getAttribute("content")&&(a=e.getAttribute("content")),t&&t.getAttribute("xlink:title")?o=t.getAttribute("xlink:title"):e.getAttribute("xlink:title")&&(o=e.getAttribute("xlink:title"));var n="",l=this.#Fo(this.#Es.getLayer(this.#jt[e.ownerDocument.firstChild.getAttribute("about")].rootLayer));return e.ownerDocument.firstChild.getAttribute("property")&&(n=e.ownerDocument.firstChild.getAttribute("property")),{geolocMin:s,geolocMax:r,metadata:a,metaSchema:n,layerName:l,title:o}}getMetadataObject(e,t,i){var s,r=this.parseEscapedCsvLine(e);if(t){var a=this.parseEscapedCsvLine(t);if(r.length==a.length){s=new Object;for(var o=0;o<r.length;o++)s[a[o]]=r[o];i||(s.name?i=s.name:s.title?i=s.title:s["名前"]?i=s["名前"]:s["名称"]?i=s["名称"]:s["タイトル"]&&(i=s["タイトル"]))}}return i||(i=r[0]),{object:s,title:i,array:r}}#Ho(e){var t=this.#jt[i.getDocumentId(e)].CRS,s=i.getImageProps(e,SvgMapElementType.POI),r=this.#Ro.SVG2Geo(s.x,s.y,t),a=document.getElementById(e.getAttribute("iid")).title;e.setAttribute("lat",r.lat),e.setAttribute("lng",r.lng),e.setAttribute("data-title",a),this.showPoiPropertyWrapper(e),e.removeAttribute("data-title"),e.removeAttribute("lat"),e.removeAttribute("lng")}#jo={};showPoiPropertyWrapper(e){var t=!1;if(e.nodeType===Node.ELEMENT_NODE){t=!0;var s=i.getDocumentId(e),r=this.#jt[s].rootLayer,a=this.#Fo(this.#Es.getLayer(r));e.setAttribute("data-layername",a)}var o=!0;this.#jo[s]?o=this.#jo[s](e):this.#jo[r]?o=this.#jo[r](e):t?this.#zo(e):console.warn(" Skip. The result of the hit test is not an Element, so it is necessary to setShowPoiProperty. :",e),0==o&&this.#zo(e),t&&e.removeAttribute("data-layername")}setShowPoiProperty(e,t){e?t?this.#jo[t]=e:this.#Wo=e:t?delete this.#jo[t]:this.#Wo=null}#Wo;#zo(e){this.#Wo?this.#Wo(e):this.#Yo(e)}#Yo(e){var t=null;e.ownerDocument.firstChild.getAttribute("property")&&(t=e.ownerDocument.firstChild.getAttribute("property").split(","));var s="<table border='1' style='word-break: break-all;table-layout:fixed;width:100%;border:solid orange;border-collapse: collapse'>",r="";if(e.getAttribute("data-title")&&(r=e.getAttribute("data-title")+"/"+e.getAttribute("data-layername")+"\n"),e.getAttribute("content")){var a=this.parseEscapedCsvLine(e.getAttribute("content"));if(s+="<tr><th style='width=25%'>name</th><th>value</th></tr>",""!=r&&(s+="<tr><td>title/Layer</td><td> "+r+"</td></tr>"),t&&t.length==a.length)for(var o=0;o<t.length;o++){var n="--";""!=a[o]&&(n=a[o]),s+="<tr><td>"+t[o]+" </td><td> "+n+"</td></tr>"}else for(o=0;o<a.length;o++){n="--";""!=a[o]&&(n=a[o]),s+="<tr><td>"+o+" </td><td> "+n+"</td></tr>"}}else{var l=e.attributes;for(o=0;o<l.length;o++)s+="<tr><td>"+l.item(o).nodeName+" </td><td> "+domElement.getAttribute(l.item(o).nodeName)+"</td></tr>"}i.getHyperLink(e)&&(s+="<tr><td>link</td> <td><a href='"+i.getHyperLink(e).href+"' target=`_blank'>"+i.getHyperLink(e).href+"</a></td></tr>"),e.getAttribute("lat")&&(s+="<tr><td>latitude</td> <td>"+this.#Xo(e.getAttribute("lat"))+"</td></tr>",s+="<tr><td>longitude</td> <td>"+this.#Xo(e.getAttribute("lng"))+"</td></tr>"),s+="</table>",this.showModal(s,400,600)}#Xo(e){for(var t=e.split(","),s="",r=0;r<t.length;r++)s+=i.numberFormat(Number(t[r]),6),r<t.length-1&&(s+=",");return s}showModal(e,t,s){var r;document.getElementById("modalDiv")?((r=document.getElementById("modalDiv")).parentNode.removeChild(r),r=document.createElement("div")):r=document.createElement("div"),window.innerWidth-100<t&&(t=window.innerWidth-100),window.innerHeight-140<s&&(s=window.innerHeight-100),r.style.height=s+36+"px",r.style.width=t+10+"px",r.style.backgroundColor="rgba(180, 180, 180, 0.4)",r.style.zIndex="1000",r.style.position="absolute",r.style.top="40px",r.style.left="40px",r.style.overflowY="hidden",r.style.overflowX="hidden",r.id="modalDiv";var a=document.createElement("div");a.style.height=s+"px",a.style.width=t+"px",a.style.backgroundColor="rgba(255,240,220,0.7)",a.style.position="absolute",a.style.top="5px",a.style.left="5px",a.style.overflowY="scroll",a.style.overflowX="hidden",a.id="infoDiv",r.appendChild(a),a.innerHTML=e;var o=document.createElement("button"),n=document.createTextNode("CLOSE");return o.appendChild(n),o.onclick=function(){r.parentNode.removeChild(r)},o.style.position="absolute",o.style.width="30%",o.style.bottom="5px",o.style.right="40px",r.appendChild(o),r.addEventListener("wheel",(function(e){i.MouseWheelListenerFunc(e)}),!1),r.addEventListener("mousewheel",(function(e){i.MouseWheelListenerFunc(e)}),!1),r.addEventListener("DOMMouseScroll",(function(e){i.MouseWheelListenerFunc(e)}),!1),document.getElementsByTagName("body")[0].appendChild(r),a}parseEscapedCsvLine(e){for(var t=e.split(","),s=0;s<t.length;s++)if(t[s]=i.trim(t[s]),0==t[s].indexOf("'")||0==t[s].indexOf('"')){for(var r=0;"'"!=t[s].substr(t[s].length-1,1)&&'"'!=t[s].substr(t[s].length-1,1)&&(t[s]=t[s]+","+t[s+1],t.splice(s+1,1),!(++r>5)););t[s]=t[s].replace(/['"]/g,"")}return t}}class I{constructor(e,t,i){this.#Es=e,this.#ia=t,this.#Zo=i}#ia;#Es;#Zo;enable;centralGetter;hittedElements;hittedElementsBbox;hittedElementsUsedParent;x;y;setCentralVectorObjectsGetter(){if(this.enable)return!1;this.enable=!1,this.centralGetter=!0;var e=this.#Es.getMapCanvasSize();return this.x=e.width/2,this.y=e.height/2,this.hittedElements=new Array,this.hittedElementsBbox=new Array,this.hittedElementsUsedParent=new Array,"object"!=typeof this.#ia||!this.#ia.isEditingGraphicsElement()||(console.log("now object editing.."),this.enable=!1,!1)}getHittedObjects=function(){return this.enable=!1,this.centralGetter=!1,{elements:this.hittedElements,bboxes:this.hittedElementsBbox,parents:this.hittedElementsUsedParent}}.bind(this);setHittedObjects(e,t,i){this.hittedElements.push(e),this.hittedElementsBbox.push(t),this.hittedElementsUsedParent.push(i)}getVectorObjectsAtPoint(e,t){return this.enable=!0,this.centralGetter=!1,this.x=e,this.y=t,this.hittedElements=new Array,this.hittedElementsBbox=new Array,this.hittedElementsUsedParent=new Array,"object"==typeof this.#ia&&this.#ia.isEditingGraphicsElement()?(console.log("now object editing.."),this.enable=!1,null):(this.#Es.refreshScreen(!1,null,!1,!0),this.#Zo(!0),this.getHittedObjects())}}class P{constructor(){this.visiblePOIs=new Array}visiblePOIs;getPoiObjectsAtPoint(e,t){var i=new Array;for(var s in this.visiblePOIs)e<this.visiblePOIs[s].x||e>this.visiblePOIs[s].x+this.visiblePOIs[s].width||t<this.visiblePOIs[s].y||t>this.visiblePOIs[s].y+this.visiblePOIs[s].height||(this.visiblePOIs[s].id=s,i.push(this.visiblePOIs[s]));return i}clear(){this.visiblePOIs=new Array}setPoiBBox(e,t,i,s,r){this.visiblePOIs[e]={x:t,y:i,width:s,height:r}}}class S{constructor(e,t){this.#no=e,this.#jt=e.getSvgImagesProps(),this.#Ht=e.getSvgImages(),this.#Fo=t}#no;#jt;#Ht;#Fo;getLayerHitTestAtPoint(e,t,i){var s=this.#no.screen2Geo(e,t),r={clientX:e,clientY:t,lat:s.lat,lng:s.lng};i&&(r.isMapCenterHitTest=!0);var a=[];for(var o in this.#jt){var n=this.#jt[o];if(n.controllerWindow){var l=n.controllerWindow.customHitTester;if("function"==typeof l){var h=l(r);if(h){Array.isArray(h)||(h=[h]);var g=this.#Fo(this.#no.getLayer(o)),d=0;for(var p of h){var c={};c.layerName=g,c.metaSchema=n.metaSchema,c.geoBbox={x:s.lng,y:s.lng,width:0,height:0},c.hitTestIndex=d,!0===p?(c.element=this.#Ht[o].documentElement,c.title=g,c.metadata=d):"string"==typeof p?(c.element=this.#Ht[o].documentElement,c.title=p,c.metadata=p):p.nodeType===Node.ELEMENT_NODE&&(c.element=p,c.title=p.getAttribute("xlink:title"),c.metadata=p.getAttribute("content")),a.push(c),++d}}}}}return a}}class M{#Es;#qo;#Ko;#Jo;#jt;showPoiProperty;pathHitTester;poiHitTester;#_o;#Qo;#$o;#Fo;#Ro;#ia;constructor(e,t,s,r,a,o){if(this.#Es=e,this.#Jo=document.getElementById("centerSight"),!this.#qo){var n=this.#Jo.parentNode;this.#qo=document.createElement("span"),n.insertBefore(this.#qo,this.#Jo),this.#qo.style.position="absolute",this.#qo.style.backgroundColor="yellow",this.#qo.style.color="black",this.#qo.style.display="none",this.#qo.style.opacity="0.5",this.#qo.id="ticker",this.#qo.style.cursor="pointer",this.#qo.style.overflowX="hidden",this.#qo.style.overflowY="auto",this.#qo.addEventListener("wheel",i.MouseWheelListenerFunc,!1),this.#qo.addEventListener("mousewheel",i.MouseWheelListenerFunc,!1),this.#qo.addEventListener("DOMMouseScroll",i.MouseWheelListenerFunc,!1),this.#Ko=document.createElement("table"),this.#Ko.style.borderCollapse="collapse",this.#Ko.style.border="solid 1px black",this.#Ko.setAttribute("border","1"),this.#qo.appendChild(this.#Ko),this.#jt=this.#Es.getSvgImagesProps(),this.#Ro=t,this.#$o=s,this.#Fo=r,this.#ia=o}this.updateTicker(),this.pathHitTester=new I(e,o,a),this.poiHitTester=new P,this.#_o=new S(e,r),this.showPoiProperty=new b(e,r,t)}updateTicker(){this.#en(),this.#qo.style.fontSize="110%",this.#qo.style.fontWeight="bolder"}isEnabled(){if(this.#qo)return!0}showTicker(){this.#qo&&(this.#qo.style.display="")}hideTicker=function(){this.#qo&&(this.#qo.style.display="none")}.bind(this);#en(e,t){if(this.#qo){if(!e&&!t){var i=this.#Es.getMapCanvasSize();e=i.width/2,t=i.height/2}this.#qo.style.left=e+2+"px",this.#qo.style.top=t+this.#Jo.height/2+"px"}}#tn(){var e=this.#Es.getMapCanvasSize(),t=Number(this.#qo.style.top.replace("px",""));this.#qo.style.height="";var i=this.#qo.offsetHeight;this.#qo.offsetWidth,e.height-t<i&&(this.#qo.style.height=e.height-t-8+"px")}#in;getTickerMetadata=function(){for(var e=0;e<this.#in.length;e++){var s=this.#in[e];if(s.img){var r=this.#Es.getSvgTarget(s.img).element,a=this.#jt[i.getDocumentId(r)].CRS,o=i.getImageProps(r,t.POI),n=this.#Ro.SVG2Geo(o.x,o.y,a);s.geoBbox={x:n.lng,y:n.lat,width:0,height:0},s.metadata=r.getAttribute("content"),s.element=r,s.metaSchema=r.ownerDocument.firstChild.getAttribute("property")}}return console.log("getTickerMetadata:",this.#in),this.#in}.bind(this);checkTicker(e,t){var i,s,r;if(e&&t)i=this.pathHitTester.getVectorObjectsAtPoint(e,t),s=this.poiHitTester.getPoiObjectsAtPoint(e,t),r=this.#_o.getLayerHitTestAtPoint(e,t);else{i=this.pathHitTester.getHittedObjects();var a=this.#Es.getMapCanvasSize();s=this.poiHitTester.getPoiObjectsAtPoint(a.width/2,a.height/2),r=this.#_o.getLayerHitTestAtPoint(a.width/2,a.height/2,!0)}if(!(0==s.length&&e&&t&&this.#sn(i,e,t)))if(this.#_t(this.#Ko),this.#in=new Array,i&&i.elements.length>0||s.length>0||r.length>0){var o,n=this;setTimeout(function(){n.#tn()}.bind(this),300);for(var l=0;l<s.length;l++){var h=this.#rn(s[l].id),g=h.imgElement;o=u=function(e){return function(){n.#an(e)}}(g),this.#on(g.title,u,this.#Ko,h.layerName),this.#in.push({title:g.title,layerName:h.layerName,img:g})}if(i)for(l=0;l<i.elements.length;l++){var d=this.showPoiProperty.getVectorMetadata(i.elements[l],i.parents[l],i.bboxes[l]),p=this.showPoiProperty.getMetadataObject(d.metadata,d.metaSchema,d.title);console.log(d.geolocMin,d.geolocMax,p,p.title,d.layerName);var c=function(e,t,i,s){return function(){s.vectorDataWrapperForShowPoiProperty(e,i,t)}}(i.elements[l],i.parents[l],i.bboxes[l],this.showPoiProperty);o=c,this.#on(p.title,c,this.#Ko,d.layerName),this.#in.push({title:p.title,layerName:d.layerName,element:i.elements[l],parent:i.parents[l],bbox:i.bboxes[l],metadata:d.metadata,geoBbox:{x:d.geolocMin.lng,y:d.geolocMin.lat,width:d.geolocMax.lng-d.geolocMin.lng,height:d.geolocMax.lat-d.geolocMin.lat},metaSchema:d.metaSchema})}for(l=0;l<r.length;l++){var u,m=r[l];o=u=function(e,t){return function(){e.setAttribute("data-hitTestIndex",t),this.showPoiProperty.showPoiPropertyWrapper(e),e.removeAttribute("data-hitTestIndex")}.bind(this)}.bind(this)(m.element,m.hitTestIndex),this.#on(m.title,u,this.#Ko,m.layerName),this.#in.push(m)}e&&t&&1==this.#in.length?(this.hideTicker(),o()):(this.#en(e,t),this.showTicker())}else this.hideTicker()}#an(e){var t=e.target||e.srcElement||e,i=this.#$o(),s=this.#Es.getSvgTarget(t);s.element,"object"==typeof this.#ia&&i&&i.getAttribute("iid")==this.#jt[t.parentNode.getAttribute("id")].rootLayer?this.#ia.setTargetObject(s):this.#nn(s)}#on(e,t,i,s){var r=document.createElement("tr"),a=document.createElement("td"),o=document.createElement("span");o.innerHTML=s?e+"<font size='-2'>/"+s+"</font>":e,a.appendChild(o),r.appendChild(a),i.appendChild(r),o.addEventListener("mousedown",t,!1)}getObjectAtPoint=function(e,t){this.checkTicker(e,t)}.bind(this);#sn(e,t,s){var r=this.#$o(),a=!1;if("object"==typeof this.#ia&&r)if(e&&e.elements.length>0){var o=this.#ln(e,r);o&&(this.#ia.setTargetObject({element:o,docId:i.getDocumentId(o)}),a=!0)}else this.#ia.editPoint(t,s),a=!0;return a}#ln(e,t){var s=-1;if("object"==typeof this.#ia&&t)for(var r=0;r<e.elements.length;r++)if(t.getAttribute("iid")==i.getDocumentId(e.elements[r])){s=r;break}return s>=0?e.elements[s]:null}#_t(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t])}#rn(e){var t,i=document.getElementById(e);if(i&&i.parentNode&&i.parentNode.getAttribute("class")){var s=i.parentNode.getAttribute("class").substring(10),r=this.#Es.getLayer(s);t=this.#Fo(r)}else t="/";return{layerId:s,layerName:t,imgElement:i}}#nn(e){var t=e.element;i.getHyperLink(t)&&!t.getAttribute("content")?this.showPage(i.getHyperLink(t)):i.getHyperLink(t)&&t.getAttribute("content")?this.POIviewSelection(t):this.showUseProperty(t)}showPage(e){var t=i.trim(e.href);if(0!=t.indexOf("#"))e.target?window.open(t):window.open(t,"_self","");else{var s=i.getFragmentView(t);s&&this.#Es.setGeoViewPort(s.y,s.x,s.height,s.width)}}POIviewSelection(e){var t=this.initModal("POIviewSelection"),s=function(r){switch(r.target.id){case"pvsView":this.showUseProperty(e),this.initModal(),t.removeEventListener("click",s,!1);break;case"pvsLink":this.showPage(i.getHyperLink(e)),this.initModal(),t.removeEventListener("click",s,!1)}}.bind(this);t.addEventListener("click",s,!1)}initModal(e){var t;if(document.getElementById("modalUI"))t=document.getElementById("modalUI");else{var i=document.getElementsByTagName("body")[0];(t=document.createElement("div")).style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.width="100%",t.style.height="100%",t.style.display="none",t.id="modalUI",t.style.zIndex="32767",i.appendChild(t);var s=document.createElement("div");s.style.position="absolute",s.id="modalMask",s.style.left="0px",s.style.top="0px",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="#505050",s.style.color="yellow",s.style.opacity="0.5",t.appendChild(s);var r=document.createElement("div");r.style.opacity="1",r.style.position="absolute",r.style.backgroundColor="white",r.id="POIviewSelection",r.innerHTML='<input type="button" id="pvsView" value="view Property"/><br><input type="button" id="pvsLink" value="open Link"/>',r.style.display="none",t.appendChild(r);var a=document.createElement("div");a.style.opacity="1",a.style.position="absolute",a.style.backgroundColor="white",a.id="customModal",a.style.display="none",t.appendChild(a)}var o=null;e?(t.style.display="",o=document.getElementById(e)):t.style.display="none";for(var n=t.getElementsByTagName("div"),l=0;l<n.length;l++)n[l].id==e||"modalMask"==n[l].id?n[l].style.display="":n[l].style.display="none";return o}showUseProperty(e){var s=this.#jt[i.getDocumentId(e)].CRS,r=i.getImageProps(e,t.POI),a=this.#Ro.SVG2Geo(r.x,r.y,s),o=document.getElementById(e.getAttribute("iid")).title;e.setAttribute("lat",a.lat),e.setAttribute("lng",a.lng),e.setAttribute("data-title",o),this.showPoiProperty.showPoiPropertyWrapper(e),e.removeAttribute("data-title"),e.removeAttribute("lat"),e.removeAttribute("lng")}}class w{constructor(e){this.mapTicker=e,console.log("const:CustomModal: this.mapTicker",this.mapTicker)}mapTicker;setCustomModal(e,t,i,s){console.log("setCustomModal :",t,Array.isArray(t));for(var r=this.mapTicker.initModal("customModal"),a=r.childNodes.length-1;a>=0;a--)r.removeChild(r.childNodes[a]);if(t)if(Array.isArray(t));else{var o=t;(t=new Array)[0]=o}else t=["OK"];console.log("setCustomModal :",t);var n=document.createElement("div");"object"==typeof e&&1==e.nodeType?n.appendChild(e):n.innerHTML=e,r.appendChild(n);for(a=0;a<t.length;a++){var l=document.createElement("input");l.setAttribute("type","button"),l.id="customModalBtn_"+a,l.setAttribute("value",t[a]),r.appendChild(l)}var h=function(e){return function(e){e.target.id.indexOf("customModalBtn_")>=0&&(this.mapTicker.initModal(),i&&i(Number(e.target.id.substring(15)),s),r.removeEventListener("click",h,!1))}.bind(this)}.bind(this)();r.addEventListener("click",h,!1)}}class x{constructor(e,t,i){this.#Es=e,this.#jt=e.getSvgImagesProps(),this.#Ht=e.getSvgImages(),this.#hn=t,this.#gn=i}#dn=!1;#pn=3;#cn;static localStorageSvgMapSuffix="svgmap_";#Es;#jt;#Ht;#hn;#un=null;#gn;#mn(e,t,i){var s=new URL(this.#jt.root.Path,location.href).pathname;window.localStorage[x.localStorageSvgMapSuffix+s+"#"+e]=t}#yn(){for(var e={},t=new URL(this.#jt.root.Path,location.href).pathname,i=x.localStorageSvgMapSuffix+t+"#",s=0;s<window.localStorage.length;s++)0==window.localStorage.key(s).indexOf(i)&&(e[window.localStorage.key(s).substring(i.length)]=window.localStorage[window.localStorage.key(s)]);return e}#vn(e){for(var t=new URL(this.#jt.root.Path,location.href).pathname,i=x.localStorageSvgMapSuffix+t+"#",s=window.localStorage.length-1;s>=0;s--)0==window.localStorage.key(s).indexOf(i)&&(e?window.localStorage.key(s).indexOf(e)>0&&delete window.localStorage[window.localStorage.key(s)]:delete window.localStorage[window.localStorage.key(s)])}setInitialCustomLayers(e,t){if(console.log(e),e&&"object"==typeof e){if(e.customLayersSettings){if(console.warn("setInitialCustomLayers: initialCustomLayersObj is cookie CustomLayersObj, use default setting"),!e.currentSettingKey)if(e.currentSettingKeys?.customLayer)e.currentSettingKey=e.currentSettingKeys.customLayer;else{var i=Object.keys(e.customLayersSettings);i.length>0&&(e.currentSettingKey=i[0])}this.#un=e}else if(function(e){if(!e.data||!e.metadata)return!1;var t=e.data;for(var i in t){var s=t[i];if("object"!=typeof s)return!1;if(!s.href)return!1}return console.log("setInitialCustomLayers Check OK!"),!0}(e)){var s=new URL(t,window.location.href);this.#un={currentSettingKey:"startup",customLayersSettings:{startup:e},settingRevision:"r2",rootContainerHref:s.pathname,host:s.host},e.metadata&&(e.metadata.viewBox&&(this.#un.viewBox=e.metadata.viewBox),e.metadata.settingRevision&&(this.#un.settingRevision=e.metadata.settingRevision),e.metadata.rootContainerHref&&(this.#un.rootContainerHref=e.metadata.rootContainerHref)),this.#un.customLayersSettings.startup.metadata.key="startup"}}else console.warn("setInitialCustomLayers: initialCustomLayersObj is not object exit.")}resumeFirstTime=!0;checkResume(e,t){var s,r,a=null;if(location.href.indexOf("#")>=0&&(s=location.href.substring(location.href.indexOf("#")),r=i.getUrlHash(s)),this.resumeFirstTime){var o=this.#yn();(r&&(r.visibleLayer||r.hiddenLayer)||o.resume||o.customLayers||this.#un)&&this.#gn(e,t);var n,l=this.#Es.getRootLayersProps();if(this.#cn=l,this.#un&&this.#hn)try{console.log("applyCustomLayers using initialCustomLayers information : ",this.#un),this.#hn.applyCustomLayers(this.#un),this.#gn(e,t),l=this.#Es.getRootLayersProps(),this.#un.viewBox&&(n=this.#un.viewBox)}catch(e){console.error("svgMapCustomLayersManager.applyCustomLayers by initialCustomLayers step error:",e)}else if(o.customLayers&&this.#hn)try{var h=JSON.parse(o.customLayers);this.#hn.applyCustomLayers(h),this.#gn(e,t),l=this.#Es.getRootLayersProps()}catch(e){console.error("svgMapCustomLayersManager.applyCustomLayers step by cookie error:",e)}if(n)this.#Es.setGeoViewPort(n.y,n.x,n.height,n.width,!0);else if(o.customGeoViewboxes){var g=JSON.parse(o.customGeoViewboxes);if(console.log("customGeoViewboxes:",g),g.currentSettingKey){var d=g.settings[g.currentSettingKey];d&&this.#Es.setGeoViewPort(d.y,d.x,d.height,d.width,!0)}}if(o.resume&&(a=JSON.parse(o.resume),this.#dn=a.resume),this.#vn("resume"),this.#dn&&a){if(r&&(r.hiddenLayer||r.visibleLayer))console.log("hiddenLayer or visibleLayer hash is. Skip layer visibility resume.");else{for(var p=a.layersProperties,c=[],u=0;u<l.length;u++){var m=l[u].title;if(c.push(!1),p[m])if(p[m].href==l[u].href){var y=p[m].visible;this.#Es.setRootLayersProps(l[u].id,y,!1),c[u]=!0,delete p[m]}else console.warn("href is unmatched!!!: title:",m,"  href:",p[m].href," : ",l[u].href,"  SKIP IT")}for(u=0;u<l.length;u++)if(0==c[u])for(var m in p)if(p[m].href==l[u].href){y=p[m].visible;this.#Es.setRootLayersProps(l[u].id,y,!1),c[u]=!0,console.log("layer title may be changed, but set visibility")}}var v=Number(a.vbLat),f=Number(a.vbLng),b=Number(a.vbLatSpan),I=Number(a.vbLngSpan);this.#Es.setGeoViewPort(v,f,b,I,!0)}}if(this.#dn&&this.#fn(),this.resumeFirstTime&&r){var P;if(r.svgView)P=i.getFragmentView(s);else if(r.xywh&&0==r.xywh.indexOf("global:")){var S=r.xywh.substring(7).split(",");P={x:Number(S[0]),y:Number(S[1]),width:Number(S[2]),height:Number(S[3]),global:!0},console.log(" global view by Media Fragments: ",P)}if(r.visibleLayer&&r.visibleLayer.indexOf("*")>=0){var M=this.#Es.getLayers();for(u=0;u<M.length;u++){var w=M[u].getAttribute("iid");this.#Es.setRootLayersProps(w,!0,!1)}}if(r.hiddenLayer)if(r.hiddenLayer.indexOf("*")>=0)for(M=getLayers(),u=0;u<M.length;u++){w=M[u].getAttribute("iid");this.#Es.setRootLayersProps(w,!1,!1)}else{var x=decodeURIComponent(r.hiddenLayer).split(",");for(u=0;u<x.length;u++){x[u]=this.#bn(x[u]),(w=this.#Es.getLayerId(x[u].name))&&this.#Es.setRootLayersProps(w,!1,!1,x[u].hash)}}if(r.visibleLayer){var C=decodeURIComponent(r.visibleLayer).split(",");for(u=0;u<C.length;u++){C[u]=this.#bn(C[u]),(w=this.#Es.getLayerId(C[u].name))&&this.#Es.setRootLayersProps(w,!0,!1,C[u].hash)}}P&&P.global&&this.#Es.setGeoViewPort(P.y,P.x,P.height,P.width,!0)}this.resumeFirstTime=!1}#bn(e){var t=e.indexOf("#"),i=e.indexOf("?");i>t&&(i=-1);var s="",r="",a=e;return t>0&&(s=a.substring(t),a=a.substring(0,t)),i>0&&(r=a.substring(i),a=a.substring(0,i),console.log("queryStr:",r)),{name:a,query:r,hash:s}}#fn(){var e=new Date;e.setTime(e.getTime()+864e5*this.#pn);var t={};1==this.#dn&&(t=this.#In()),t.resume=this.#dn,this.#mn("resume",JSON.stringify(t),e)}#In(){var e={},t=this.#Es.getGeoViewBox();e.vbLng=t.x,e.vbLat=t.y,e.vbLngSpan=t.width,e.vbLatSpan=t.height;var i=this.#Es.getRootLayersProps(),s=this.#Pn(i);return e.layersProperties=s,e}#Pn(e){for(var t={},i=0;i<e.length;i++){var s=e[i],r=s.title,a={visible:s.visible,editing:s.editing,groupName:s.groupName,groupFeature:s.groupFeature,href:s.href,title:s.title,href:s.href};t[r]=a}return t}getBasicPermanentLink(e){console.log("getBasicPermanentLink:",e);var t=this.#In(),i=[],s=[],r=this.#Pn(this.#cn);for(var a in r){var o=r[a],n=t.layersProperties[a];n&&o.visible!=n.visible&&(1==o.visible?i.push(a):s.push(a))}var l="";s.length>0&&(l=`&visibleLayer=${s.join(",")}`);var h="";i.length>0&&(h=`&hiddenLayer=${i.join(",")}`);var g=`xywh=global:${t.vbLng.toFixed(6)},${t.vbLat.toFixed(6)},${t.vbLngSpan.toFixed(6)},${t.vbLatSpan.toFixed(6)}`,d=new URL(location.pathname,location.origin),p=g+l+h;return d.hash=p,1==e&&navigator.clipboard.writeText(d.href),d}resumeToggle(e){e.target.checked?svgMap.setResume(!0):svgMap.setResume(!1)}setResume(e){this.#dn=e,(!this.#dn||Object.keys(this.#Ht).length>0)&&this.#fn()}getResume(){return this.#dn}}class C{#Sn={getUrlViaProxy:null,getUrlViaImageProxy:null,crossOriginAnonymous:!1,getNonlinearTransformationProxyUrl:null,crossOriginAnonymousNonlinearTF:!1};getAccessInfo(e){return"function"==typeof this.#Sn.getUrlViaProxy?this.#Sn.getUrlViaProxy(e):e}getImageAccessInfo(e,t,i){var s=!1,r=!1;return null!=i&&(s=!0),"function"==typeof this.#Sn.getUrlViaImageProxy?(e=this.#Sn.getUrlViaImageProxy(e),this.#Sn.crossOriginAnonymous&&(s=!0)):"function"==typeof this.#Sn.getNonlinearTransformationProxyUrl&&t&&(e=this.#Sn.getNonlinearTransformationProxyUrl(e),r=!0,this.#Sn.crossOriginAnonymousNonlinearTF&&(s=!0)),{href:e,crossOriginFlag:s,hasNonLinearImageTransformation:r}}setProxyURLFactory(e,t,i,s,r){"function"==typeof e?this.#Sn.getUrlViaProxy=e:null===e&&(this.#Sn.getUrlViaProxy=null),"function"==typeof t?this.#Sn.getUrlViaImageProxy=t:null===t&&(this.#Sn.getUrlViaImageProxy=null),1==i?this.#Sn.crossOriginAnonymous=!0:0==i&&(this.#Sn.crossOriginAnonymous=!1),"function"==typeof s?this.#Sn.getNonlinearTransformationProxyUrl=s:null===s&&(this.#Sn.getNonlinearTransformationProxyUrl=null),1==r?this.#Sn.crossOriginAnonymousNonlinearTF=!0:0==r&&(this.#Sn.crossOriginAnonymousNonlinearTF=!1),console.log("called setProxyURLFactory: contentProxyParams:",this.#Sn,"    input params:",e,t,i,s,r)}getCORSURL(e,t){return t?"function"==typeof this.#Sn.getNonlinearTransformationProxyUrl?{url:this.#Sn.getNonlinearTransformationProxyUrl(e),crossorigin:this.#Sn.crossOriginAnonymousNonlinearTF}:{url:e,crossorigin:!1}:"function"==typeof this.#Sn.getNonlinearTransformationProxyUrl?this.#Sn.getNonlinearTransformationProxyUrl(e):e}}class L{#Es;#jt;#Ht;constructor(e){this.#Es=e,this.#jt=e.getSvgImagesProps(),this.#Ht=e.getSvgImages()}linkedDocOp(e,i,s,r,a,o,n){var l=this.#Ht[i],h=this.#jt[i];if(l){e(l,h,s,r,a,o,n);var g=h.childImages;for(var d in g)g[d]!=t.CLICKABLE&&g[d]!=t.EXIST||this.linkedDocOp(e,d,s,r,a,o,n)}}childDocOp(e,i,s,r,a,o,n){var l=this.#Ht[i],h=this.#jt[i];if(l){var g=h.childImages;for(var d in g){if(g[d]==t.CLICKABLE||g[d]==t.EXIST)e(this.#Ht[d],this.#jt[d],s,r,a,o,n)}}}contColorSet(){var e=Number(document.getElementById("contValue").value);e&&this.contColorSetContinuous(e)}contColorSetOnce(e){var t=this.#Es.getHashByDocPath("vectorContainer.svg");this.linkedDocOp(this.contourMarker,t,e),this.#Es.refreshScreen()}contColorSetContinuous(e){var t;"contourSearch[m]"==document.getElementById("contButton").innerHTML?(document.getElementById("contButton").innerHTML="disableSearch",document.getElementById("contValue").disabled="true",t=!1):(document.getElementById("contButton").innerHTML="contourSearch[m]",document.getElementById("contValue").disabled="",t=!0),t?(document.removeEventListener("zoomPanMap",this.eDom,!1),t=!1,this.eDom=this.editDOM(e,!0),this.eDom()):(this.eDom=this.editDOM(Number(e),!1),this.eDom(),document.addEventListener("zoomPanMap",this.eDom,!1),t=!0)}eDom;editDOM(e,t){return function(){var i=this.#Es.getHashByDocPath("vectorContainer.svg");this.linkedDocOp(contourMarker,i,e,t),this.#Es.refreshScreen()}}contourMarker(e,t,i,s){for(var r=e.getElementsByTagName("path"),a=0;a<r.length;a++){var o=r[a],n=Number(o.getAttribute("lm:標高"));n&&n%i==0&&(s?(o.removeAttribute("stroke"),o.removeAttribute("stroke-width")):(o.setAttribute("stroke","red"),o.setAttribute("stroke-width","2")))}}}class E{styleCatalog=new Array("stroke","stroke-width","stroke-linejoin","stroke-linecap","fill","fill-rule","fill-opacity","opacity","vector-effect","display","font-size","stroke-dasharray","marker-end","visibility","image-rendering");constructor(e){this.getNonScalingOffset=e}getNonScalingOffset;getStyle(e,t,i,s){var r;s&&(r=s.get(e)),null==r&&(r=this.getNodeStyle(e,i),s&&s.set(e,r));var a={};for(var o of this.styleCatalog)r[o]?a[o]=r[o]:t&&t[o]&&(a[o]=t[o]);return r.minZoom?a.minZoom=r.minZoom:t&&t.minZoom&&(a.minZoom=t.minZoom),r.maxZoom?a.maxZoom=r.maxZoom:t&&t.maxZoom&&(a.maxZoom=t.maxZoom),r.nonScalingOffset?a.nonScalingOffset=r.nonScalingOffset:t&&t.nonScalingOffset&&(a.nonScalingOffset=t.nonScalingOffset),t&&t.usedParent&&(a.usedParent=t.usedParent),a}getNodeStyle(e,t){for(var i=!1,s={fill:null},r=this.getStyleAttribute(e),a=0;a<this.styleCatalog.length;a++){var o=this.getStyleOf(this.styleCatalog[a],e,r);o&&(s[this.styleCatalog[a]]=o,i=!0)}if(e.getAttribute("visibleMinZoom")&&(s.minZoom=Number(e.getAttribute("visibleMinZoom"))/100,i=!0),e.getAttribute("visibleMaxZoom")&&(s.maxZoom=Number(e.getAttribute("visibleMaxZoom"))/100,i=!0),s.hasUpdate=i,t){var n=e.getAttribute("xlink:href"),l=e.getAttribute("target");n&&(s.hyperLink=n,s.target=l)}return e.getAttribute("transform")&&(s.nonScalingOffset=this.getNonScalingOffset(e)),s}getStyleAttribute(e){var t=null;if(e.getAttribute("style")){t={};var s=e.getAttribute("style").split(";");if(s)for(var r=0;r<s.length;r++){var a=s[r].split(":");if(a&&a.length>1){var o=i.trim(a[0]),n=i.trim(a[1]);"fill"!=o&&"stroke"!=o||6==n.length&&n.match(/^[0-9A-F]/)&&(n="#"+n),t[o]=n}}}return t}getStyleOf(e,t,i){var s;return t.getAttribute(e)?s=t.getAttribute(e):i&&i[e]&&(s=i[e]),s}static setCanvasStyle(e,t){var i={fillStyle:null,strokeStyle:null};if(e){if(e.stroke?"none"==e.stroke?t.strokeStyle="rgba(0, 0, 0, 0)":(t.strokeStyle=e.stroke,i.strokeStyle=e.stroke):t.strokeStyle="rgba(0, 0, 0, 0)",e.fill&&("none"==e.fill?t.fillStyle="rgba(0, 0, 0, 0)":(t.fillStyle=e.fill,i.fillStyle=e.fill)),e["stroke-width"]?e["vector-effect"]?e["stroke-width"]?t.lineWidth=e["stroke-width"]:t.lineWidth=0:t.lineWidth=1:t.lineWidth=0,e["stroke-dasharray"]){var s=e["stroke-dasharray"].split(/\s*[\s,]\s*/);t.setLineDash(s)}e["stroke-linejoin"]&&(t.lineJoin=e["stroke-linejoin"]),e["stroke-linecap"]&&(t.lineCap=e["stroke-linecap"]),e.opacity&&(t.globalAlpha=e.opacity),e["fill-opacity"]&&(t.globalAlpha=e["fill-opacity"])}return i}}class A{#Mn;#Ro;#wn;#kt;constructor(e,t,i,s){console.log("new PathRenderer"),this.#Mn=e,this.#Ro=t,this.#wn=i,this.#kt=s}defaultHilightStyle={stroke:{color:"rgba(255,0,0,1)",widthIncrement:6},fill:{color:"rgba(255,0,0,1)",lineWidth:6}};setSVGcirclePoints(e,i,s,r,a,o,n){var l,h,g=Number(e.getAttribute("cx")),d=Number(e.getAttribute("cy"));a==t.CIRCLE?h=l=Number(e.getAttribute("r")):(l=Number(e.getAttribute("rx")),h=Number(e.getAttribute("ry"))),n&&n.setPoint(g,d);var p="M"+(g-l)+","+d+"A"+l+","+h+" 0 0 1 "+(g+l)+","+d+"A"+l+","+h+" 0 0 1 "+(g-l)+","+d+"z",c=this.setSVGpathPoints(e,i,s,r,p,o,n);if(o.nonScalingOffset)c.y-=h,c.height=2*h;else{var u=this.#Ro.transform(l,h,s,!0);c.y-=u.y,c.height=2*u.y}return c}setSVGrectPoints(e,t,i,s,r,a){var o=Number(e.getAttribute("x")),n=Number(e.getAttribute("y")),l=Number(e.getAttribute("width")),h=Number(e.getAttribute("height"));a&&!this.#Mn.GISgeometriesCaptureOptions.TreatRectAsPolygonFlag&&a.setPoint(o+l/2,n+h/2);var g="M"+o+","+n+"L"+(o+l)+","+n+" "+(o+l)+","+(n+h)+" "+o+","+(n+h)+"z";return this.setSVGpathPoints(e,t,i,s,g,r,a)}setSVGpolyPoints(e,i,s,r,a,o,n){var l=e.getAttribute("points");if(l){var h=l.replace(/,/g," ").split(" ");if(h.length>3){for(var g="M",d=0;d<h.length/2;d++)g+=h[2*d]+","+h[2*d+1],g+=0==d?"L":" ";return a==t.POLYGON&&(g+="Z"),this.setSVGpathPoints(e,i,s,r,g,o,n)}}}ssppRe0=new RegExp(/,/gm);ssppRe1=new RegExp(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm);ssppRe2=new RegExp(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm);ssppRe3=new RegExp(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm);ssppRe4=new RegExp(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm);ssppRe5=new RegExp(/([0-9])([+\-])/gm);ssppRe6=new RegExp(/(\.[0-9]*)(\.)/gm);ssppRe7=new RegExp(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm);setSVGpathPoints(e,t,s,r,a,o,n){var l=o.nonScalingOffset,h=t.context;if(n)if(l){if(n.setPoint(l.x,l.y),this.#Mn.GISgeometriesCaptureOptions.SkipVectorRendering)return{}}else n.svgXY||n.makePath();var g=E.setCanvasStyle(o,h),d=!1;g.fillStyle||(d=!0);var p=!1;g.strokeStyle||(p=!0);var c,u=6e4,m=-6e4,y=6e4,v=-6e4,f=t.altdMap.get(e);f?c=f:((c=a||e.getAttribute("d"))||(c=""),c=(c=(c=(c=(c=(c=(c=(c=c.replace(this.ssppRe0," ")).replace(this.ssppRe1,"$1 $2")).replace(this.ssppRe2,"$1 $2")).replace(this.ssppRe3,"$1 $2")).replace(this.ssppRe4,"$1 $2")).replace(this.ssppRe5,"$1 $2")).replace(this.ssppRe6,"$1 $2")).replace(this.ssppRe7,"$1 $3 $4 "),c=(c=i.trim(i.compressSpaces(c))).split(" "),t.altdMap.set(e,c));var b="M",I=!1,P=0,S=0,M=0,w=0,x=0,C=0,L=0,A=0;h.beginPath();for(var T,O=0,R=c[O],k=!1;O<c.length;){switch(T&&(L=T.x,A=T.y),R){case"M":++O,P=Number(c[O]),++O,x=P,C=S=Number(c[O]),M=(T=this.#Ro.transform(P,S,s,!1,l)).x,w=T.y,h.moveTo(T.x,T.y),n&&!l&&n.startSubPath(P,S),R="L";break;case"m":++O,P+=Number(c[O]),++O,x=P,C=S+=Number(c[O]),M=(T=this.#Ro.transform(P,S,s,!1,l)).x,w=T.y,h.moveTo(T.x,T.y),n&&!l&&n.startSubPath(P,S),R="l";break;case"L":++O,P=Number(c[O]),++O,S=Number(c[O]),T=this.#Ro.transform(P,S,s,!1,l),h.lineTo(T.x,T.y),n&&!l&&n.addSubPathPoint(P,S);break;case"l":++O,P+=Number(c[O]),++O,S+=Number(c[O]),T=this.#Ro.transform(P,S,s,!1,l),h.lineTo(T.x,T.y),n&&!l&&n.addSubPathPoint(P,S);break;case"A":var B={x:P,y:S};++O;var G=Number(c[O]);++O;var V=Number(c[O]);++O;var N=Number(c[O]);++O;var D=Number(c[O]);++O;var U,F=Number(c[O]);++O,P=Number(c[O]),++O,T={x:P,y:S=Number(c[O])},U=0==N?{x:(B.x-T.x)/2,y:(B.y-T.y)/2}:{x:Math.cos(N)*(B.x-T.x)/2+Math.sin(N)*(B.y-T.y)/2,y:-Math.sin(N)*(B.x-T.x)/2+Math.cos(N)*(B.y-T.y)/2};var H=Math.pow(U.x,2)/Math.pow(G,2)+Math.pow(U.y,2)/Math.pow(V,2);H>1&&(G*=Math.sqrt(H),V*=Math.sqrt(H));var j=(D==F?-1:1)*Math.sqrt((Math.pow(G,2)*Math.pow(V,2)-Math.pow(G,2)*Math.pow(U.y,2)-Math.pow(V,2)*Math.pow(U.x,2))/(Math.pow(G,2)*Math.pow(U.y,2)+Math.pow(V,2)*Math.pow(U.x,2)));isNaN(j)&&(j=0);var z,W={x:j*G*U.y/V,y:j*-V*U.x/G};z=0==N?{x:(B.x+T.x)/2+W.x,y:(B.y+T.y)/2+W.y}:{x:(B.x+T.x)/2+Math.cos(N)*W.x-Math.sin(N)*W.y,y:(B.y+T.y)/2+Math.sin(N)*W.x+Math.cos(N)*W.y};var Y=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2))},X=function(e,t){return(e[0]*t[0]+e[1]*t[1])/(Y(e)*Y(t))},Z=function(e,t){return(e[0]*t[1]<e[1]*t[0]?-1:1)*Math.acos(X(e,t))},q=Z([1,0],[(U.x-W.x)/G,(U.y-W.y)/V]),K=[(U.x-W.x)/G,(U.y-W.y)/V],J=[(-U.x-W.x)/G,(-U.y-W.y)/V],_=Z(K,J);X(K,J)<=-1&&(_=Math.PI),X(K,J)>=1&&(_=0);X=G>V?G:V;var Q,$=G>V?1:G/V,ee=G>V?V/G:1,te=this.#Ro.transform(z.x,z.y,s,!1,l);Q=l?{x:$,y:ee}:this.#Ro.transform($,ee,s,!0),h.translate(te.x,te.y),0==N&&1==Q.x&&1==Q.y?h.arc(0,0,X,q,q+_,1-F):(h.rotate(N),h.scale(Q.x,Q.y),h.arc(0,0,X,q,q+_,1-F),h.scale(1/Q.x,1/Q.y),h.rotate(-N)),h.translate(-te.x,-te.y),T=this.#Ro.transform(P,S,s,!1,l);break;case"Z":case"z":h.closePath(),k=!0,P=x,S=C,n&&!l&&n.addSubPathPoint(P,S);break;default:I=!0}T&&(T.x<u&&(u=T.x),T.x>m&&(m=T.x),T.y<y&&(y=T.y),T.y>v&&(v=T.y)),I?(R=b,I=!1,--O):(b=R,R=c[++O])}d||h.fill(),p||h.stroke();var ie,se=!1;if(r&&!d&&(this.#wn.pathHitTester.enable||this.#wn.pathHitTester.centralGetter)&&((h.isPointInPath(this.#wn.pathHitTester.x,this.#wn.pathHitTester.y)||h.isPointInStroke(this.#wn.pathHitTester.x,this.#wn.pathHitTester.y))&&(se=!0,r.hilightFillStyle?r.hilightFillStyle.color&&r.hilightFillStyle.lineWidth&&(ie=r.hilightFillStyle):ie=this.defaultHilightStyle.fill,ie))){var re=h.lineWidth;h.lineWidth=ie.lineWidth;var ae=h.fillStyle;h.fillStyle=ie.color,h.fill(),h.stroke(),h.fillStyle=ae,h.lineWidth=re}if(r&&d){var oe,ne=h.lineWidth,le=h.strokeStyle;if(h.lineWidth<6&&(h.lineWidth=6,h.strokeStyle="rgba(0,0,0,0)",h.stroke()),this.#wn.pathHitTester.enable||this.#wn.pathHitTester.centralGetter)if(h.isPointInStroke(this.#wn.pathHitTester.x,this.#wn.pathHitTester.y))se=!0,r.hilightStrokeStyle?r.hilightStrokeStyle.color&&r.hilightStrokeStyle.widthIncrement&&(oe=r.hilightStrokeStyle):oe=this.defaultHilightStyle.stroke,oe&&(h.lineWidth=ne+oe.widthIncrement,h.strokeStyle=oe.color,h.stroke());h.lineWidth=ne,h.strokeStyle=le}var he,ge,de=0,pe=0;k?(he=M,ge=w):(he=T.x,ge=T.y);var ce=Math.sqrt((he-L)*(he-L)+(ge-A)*(ge-A));return ce&&(de=(he-L)/ce,pe=(ge-A)/ce),{hitted:se,x:u,y:y,width:m-u,height:v-y,endX:he,endY:ge,endCos:de,endSin:pe}}}class T{constructor(e,t,i,s){this.#jt=e,this.#Ht=t,this.#xn=i,this.#Cn=s}#jt;#Ht;#xn;#Cn;getLayer(e){var t=null,s=this.#jt.root.isSVG2;if(isNaN(e)){if(!(t=i.getElementByImgIdNoNS(this.#Ht.root,e)))for(var r=this.getLayers(),a=0;a<r.length;a++){if(r[a].getAttribute("title")==e){t=r[a];break}if(s&&r[a].getAttribute("src")==e){t=r[a];break}if(r[a].getAttribute("xlink:href")==e){t=r[a];break}}}else t=s?this.#Ht.root.getElementsByTagName("iframe")[e]:this.#Ht.root.getElementsByTagName("animation")[e];return t}getLayerId(e){var t=null;if(e.getAttribute)t=e.getAttribute("iid");else{var i=this.getLayer(e);i&&(t=i.getAttribute("iid"))}return t}isEditingLayer=function(e){if(e){var t=e.getAttribute("iid");return!(!this.#jt[t]||!this.#jt[t].editing)}for(var s in this.#jt)if(1==this.#jt[s].editing)return this.#Ht.root.documentElement,i.getElementByImgIdNoNS(this.#Ht.root,s);return null}.bind(this);isEditableLayer(e){if("string"==typeof e){for(var t=this.#Ln(),i=0;i<t.length;i++)if(t[i].getAttribute("iid")==e)return!0;return!1}return!!(e.getAttribute("class")&&e.getAttribute("class").indexOf("editable")>=0)}#Ln(){for(var e=new Array,t=this.getLayers(),i=0;i<t.length;i++)this.isEditableLayer(t[i])&&e.push(t[i]);return e}#En(e,t,i,s,r,a){return t&&-1!=e.indexOf(t)&&e.splice(e.indexOf(t),1),i&&-1!=e.indexOf(i)&&e.splice(e.indexOf(i),1),s&&-1!=e.indexOf(s)&&e.splice(e.indexOf(s),1),r&&-1!=e.indexOf(r)&&e.splice(e.indexOf(r),1),a&&-1!=e.indexOf(a)&&e.splice(e.indexOf(a),1),e}getSwLayers(e){for(var t=new Array,i=new Array,s=this.getLayers(),r=0;r<s.length;r++)if(s[r].getAttribute("class")){var a,o=s[r].getAttribute("class").split(" ");a=!e||-1!=o.indexOf(e),o=this.#En(o,"switch","batch","editable","clickable");for(var n=0;n<o.length;n++)t[o[n]]||(t[o[n]]=new Array),a&&(i[o[n]]=!0),t[o[n]].push(s[r])}if(e)for(var r in t)i[r]||delete t[r];return t}#An(e){var t;if(!e.getAttribute("class"))return!0;t=e.getAttribute("class").split(" "),t=this.#En(t,"batch","editable","clickable","switch");var i=this.getSwLayers("switch"),s=!1;for(var r in i)if(-1!=t.indexOf(r)){s=!0;break}if(s){if("hidden"==e.getAttribute("visibility")||"none"==e.getAttribute("display")){i=this.getSwLayers();var a=new Array;for(r=0;r<t.length;r++)for(var o=i[t[r]],n=0;n<o.length;n++)o[n]!=e&&a.push(o[n]);return i=null,a}return!1}return!0}getLayers(e){return e||(e="root"),this.#jt[e].isSVG2?this.#Ht[e].getElementsByTagName("iframe"):this.#Ht[e].getElementsByTagName("animation")}getRootLayersProps(){for(var e=this.getSwLayers("switch"),t=this.getSwLayers("batch"),i=this.getLayers(),s=new Array,r=0;r<i.length;r++){s[r]=new Object,s[r].id=i[r].getAttribute("iid"),s[r].number=r,this.#jt[s[r].id]&&this.#Ht[s[r].id]&&!this.#xn[s[r].id]?s[r].hasDocument=!0:s[r].hasDocument=!1,s[r].href=i[r].getAttribute("xlink:href"),s[r].svgImageProps=this.#jt[s[r].id],s[r].title=this.getLayerName(i[r]);var a=!0;"hidden"!=i[r].getAttribute("visibility")&&"none"!=i[r].getAttribute("display")||(a=!1),s[r].visible=a,s[r].editable=this.isEditableLayer(i[r]),s[r].editing=!1,s[r].editable&&(s[r].editing=this.isEditingLayer(i[r]));var o="";if(i[r].getAttribute("class")){var n=this.#En(i[r].getAttribute("class").split(" "),"switch","batch","editable","clickable");n.length>0&&(o=n[0])}s[r].groupName=o,s[r].groupFeature="",o&&(e[o]?s[r].groupFeature="switch":t[o]&&(s[r].groupFeature="batch"))}for(r=0;r<s.length;r++)s[s[r].id]=s[r];return s}setRootLayersPropsPostprocessed=!1;setRootLayersProps(e,t,i,s,r){this.setRootLayersPropsPostprocessed=!1;var a=this.getLayer(e);if(!a)return!1;r&&a.parentElement.removeChild(a);var o=a.getAttribute("iid"),n=this.getRootLayersProps(),l=n[o];if(null==t&&(t=l.visible),null==i&&(i=l.editing),!s&&l.visible==t&&l.editing==i)return!1;if(!l.editable&&i)return!1;if(!t&&i)return!1;if("switch"==l.groupFeature&&t&&!l.visible){var h=this.#An(a);if(h instanceof Boolean&&0==h);else if(h instanceof Array)for(var g=0;g<h.length;g++)h[g].setAttribute("visibility","hidden")}if(i&&l.editing!=i)for(g=0;g<n.length;g++)this.#jt[n[g].id]&&1==this.#jt[n[g].id].editing&&this.#jt[n[g].id].editing;if(l.visible!=t&&(t?a.setAttribute("visibility","visible"):a.setAttribute("visibility","hidden")),s){var d=!1,p=a.getAttribute("xlink:href");p||(d=!0,p=a.getAttribute("src")),p.indexOf("#")>0?p=p.substring(0,p.indexOf("#"))+s:p+=s,console.log("add hashOption to url:",p," : ",s),d?a.setAttribute("src",p):a.setAttribute("xlink:href",p)}return l.editing!=i&&(this.#jt[o].editing=i),!0}setLayerVisibility(e,t){this.setRootLayersProps(e,t,!1),this.#Cn()}getLayerName(e){var t="";return e.getAttribute("title")?t=e.getAttribute("title"):(t=e.getAttribute("xlink:href"),optText||(t=e.getAttribute("src"))),t}getLayerHash(e){var t=null,i=this.getLayer(e);return i&&(t=i.getAttribute("iid")),t}getHashByDocPath(e){var t=null;for(var i in this.#jt)if(null==this.#jt[i].Path);else if(this.#jt[i].Path.indexOf(e)>=0){t=i;break}return t}}class O{#Tn=null;#no;constructor(e){this.#no=e;var t=this.#no.getUaProp(),i=document.getElementById("gpsButton");if(i)if(navigator.geolocation){if(t.isSP&&navigator.userAgent.indexOf("Safari")>0&&navigator.userAgent.indexOf("Chrome")<0){this.#Tn=document.createElement("iframe"),document.documentElement.appendChild(this.#Tn),console.log("contentWindow:",this.#Tn.contentWindow.document);var s=this.#Tn.contentWindow.document.documentElement,r=this.#Tn.contentWindow.document.createElement("script");this.#Tn.style.display="none",r.innerHTML='function gps(){navigator.geolocation.getCurrentPosition( gpsSuccess );}function gpsSuccess(position){console.log("gps",position);window.parent.svgMap.gpsCallback(position)}',s.appendChild(r)}}else i.style.display="none"}gps(){this.#Tn?this.#Tn.contentWindow.gps():navigator.geolocation.getCurrentPosition(this.gpsSuccess)}gpsSuccess=function(e){console.log("gpsSuccess:",e),this.#no.setGeoCenter(e.coords.latitude,e.coords.longitude,10*e.coords.accuracy/1e5)}.bind(this)}class R{#no;#xn;#On;#Rn;#jt;#Ro;#so;#kn;#kt;constructor(e,t,i,s,r,a,o,n){this.#no=e,this.#xn=t,this.#On=i,this.#Rn=s,this.#kt=r,this.#Ro=a,this.#so=o,this.#kn=n,this.#jt=this.#no.getSvgImagesProps()}getImgElement(e,s,r,a,o,n,l,h,g,d,p,c,u,m,y,v,f,b){var I=document.createElement("img");u&&(I.style.imageRendering="pixelated",I.style.imageRendering="-moz-crisp-edges",I.style.msInterpolationMode="nearest-neighbor",I.style.imageRendering="optimize-contrast",I.dataset.pixelated="true"),c&&I.setAttribute("href_fragment",c),y&&(o=i.getNoCacheRequest(o)),b&&(o=i.addCommonQueryAtQueryString(o,b));var P=this.#On.getImageAccessInfo(o,this.#Bn(this.#jt[f.docId].CRS,f.svgNode),v);return this.#Gn(I,P.href,n,!1,f,P.crossOriginFlag,P.hasNonLinearImageTransformation),l&&(I.style.opacity=l),m&&(I.style.filter+=m),I.style.left=e+"px",I.style.top=s+"px",I.style.display="none",I.style.position="absolute",I.style.maxWidth="initial",I.style.height=a+"px",I.style.width=r+"px",I.width=r,I.height=a,I.id=n,p&&(I.style.transform="matrix("+p.a+","+p.b+","+p.c+","+p.d+","+p.e+","+p.f+")",I.style.transformOrigin="0 0",I.style.webkitTransform="matrix("+p.a+","+p.b+","+p.c+","+p.d+","+p.e+","+p.f+")",I.style.webkitTransformOrigin="0 0"),h==t.POI?(I.style.zIndex="10",I.style.cursor="pointer",I.setAttribute("content",g),d?I.setAttribute("title",d):I.setAttribute("title",P.href)):I.setAttribute("title",""),I}setImgElement(e,t,i,s,r,a,o,n,l,h,g,d,p,c,u,m,y,v){if(n||(n=0),l||(l=0),e.style.left=n+t+"px",h)if(g||(e.style.fontSize=r+"px"),this.#kt.uaProps.MS){var f=parseInt(e.style.fontSize);e.style.top=i+l-f+"px"}else e.style.bottom=this.#kt.mapCanvasSize.height-(l+i)+"px";else e.style.top=l+i+"px";h||(e.width=s,e.height=r,e.style.width=s+"px",e.style.height=r+"px"),p?(e.style.imageRendering="pixelated",e.style.imageRendering="-moz-crisp-edges",e.style.msInterpolationMode="nearest-neighbor",e.style.imageRendering="optimize-contrast",e.dataset.pixelated="true"):(e.style.imageRendering="",e.style.imageRendering="",e.style.msInterpolationMode="",e.style.imageRendering="",e.dataset.pixelated="true"),e.style.opacity=m||"",e.style.filter=c||"";var b=this.#On.getImageAccessInfo(a,this.#Bn(this.#jt[v.docId].CRS,v.svgNode),y),I=e.getAttribute("data-preTransformedHref");I||(I=e.getAttribute("src")),!h&&e.src&&b.href&&this.#Vn(I,b.href)&&(e.removeAttribute("data-preTransformedHref"),this.#Gn(e,b.href,u,!0,v,b.crossOriginFlag,b.hasNonLinearImageTransformation)),o&&(e.style.transform="matrix("+o.a+","+o.b+","+o.c+","+o.d+","+o.e+","+o.f+")",e.style.transformOrigin="0 0",e.style.webkitTransform="matrix("+o.a+","+o.b+","+o.c+","+o.d+","+o.e+","+o.f+")",e.style.webkitTransformOrigin="0 0"),e.style.visibility="",d&&this.#Nn(e,d)}#Gn(e,t,i,s,r,a,o){var n=this.#Rn;1==o&&(n=3*this.#Rn),this.#kt.uaProps.verIE>8?(e.addEventListener("load",this.#Dn),e.addEventListener("error",this.#Un),e.src=t,e.crossOrigin=a?"anonymous":null):(e.attachEvent("onload",this.#Dn),e.crossOrigin=a?"anonymous":null,s?e.src=t:e.setAttribute("href",t),e.style.filter="inherit"),setTimeout(this.#Un,n,e),this.#xn[i]=r}#Dn=function(e){var t=e.target||e.srcElement;if(t.removeEventListener("load",this.#Dn),t.src,t.getAttribute("href_fragment")){var i=t.getAttribute("href_fragment");this.#Nn(t,i),t.removeAttribute("href_fragment")}t.style.display="",t.style.visibility="";var s=this.#xn[t.id];delete this.#xn[t.id],this.#Fn(t,s),this.#so()}.bind(this);#Bn(e,t){if(e.transform||this.#kt.rootCrs.transform){if("true"==t.getAttribute("data-mercator-tile")&&!e.transform&&this.#kt.rootCrs.mercator)return!1;var i=t.getAttribute("transform");return!i||0!=i.indexOf("ref")}return!1}#Un=function(e){var t,i=!1;e.id?(t=e,i=!0):(t=e.target||e.srcElement,++this.#kn.otherBitImagesCount),this.#xn[t.id]&&(console.warn("LoadImg TimeOut!!!!!"),i&&++this.#kn.timeoutBitImagesCount,delete this.#xn[t.id],this.#so())}.bind(this);#Fn(e,t){if(t){var s=t.svgNode,r=s.getAttribute("transform");if(!r||0!=r.indexOf("ref")){var a=i.parseTransformMatrix(r),o=this.#jt[t.docId].CRS;if(0!=this.#Bn(o,s)){var n=document.getElementById("imageTransformCanvas");n||((n=document.createElement("canvas")).id="imageTransformCanvas");var l=e.naturalWidth,h=e.naturalHeight,g=n.getContext("2d");n.width=l,n.height=h,g.drawImage(e,0,0);var d=g.getImageData(0,0,l,h),p=g.createImageData(l,h),c=Number(s.getAttribute("x")),u=Number(s.getAttribute("y")),m={a:Number(s.getAttribute("width"))/l,b:0,c:0,d:Number(s.getAttribute("height"))/h,e:c,f:u};a&&(m=this.#Ro.matMul(m,a));var y=this.#Ro.getInverseMatrix(m),v=this.#Ro.getConversionMatrixViaGCS(this.#kt.rootCrs,o),f=this.#Ro.getConversionMatrixViaGCS(o,this.#kt.rootCrs),b=this.#Ro.transformRect({x:0,y:0,width:l,height:h},m);if(e.getAttribute("data-preTransformedHref"))console.log("Already Transformed image");else{for(var I=this.#Ro.transformRect(b,f),P={a:I.width/l,b:0,c:0,d:I.height/h,e:I.x,f:I.y},S=[],M=4*l,w=0;w<h;w++)for(var x=!1,C=0;C<l;C++){var L,E=4*(C+w*l),A=this.#Ro.transform(C,w,P),T=this.#Ro.transform(A.x,A.y,v);if(T&&(L=this.#Ro.transform(T.x,T.y,y)),L&&L.x>=0&&L.x<l&&L.y>=0&&L.y<h){var O=4*(Math.floor(L.x)+Math.floor(L.y)*l);p.data[E]=d.data[O],p.data[E+1]=d.data[O+1],p.data[E+2]=d.data[O+2],p.data[E+3]=d.data[O+3],x=!0,S[C]=!0}else x?(p.data[E]=p.data[E-4],p.data[E+1]=p.data[E-4+1],p.data[E+2]=p.data[E-4+2],p.data[E+3]=p.data[E-4+3]):S[C]&&(p.data[E]=p.data[E-M],p.data[E+1]=p.data[E-M+1],p.data[E+2]=p.data[E-M+2],p.data[E+3]=p.data[E-M+3]),x=!1,S[C]=!1}g.putImageData(p,0,0);var R=n.toDataURL("image/png");e.setAttribute("data-preTransformedHref",e.getAttribute("src")),e.setAttribute("src",R)}}}}}#Nn(e,t){var i=t.split(/\s*,\s*|\s/),s=e.width/Number(i[2]),r=e.height/Number(i[3]),a=parseFloat(e.style.left)-s*Number(i[0]),o=parseFloat(e.style.top)-r*Number(i[1]),n=e.naturalWidth*s,l=e.naturalHeight*r;e.style.left=a+"px",e.style.top=o+"px",e.width=n,e.height=l,e.style.width=n+"px",e.style.height=l+"px",e.style.clip="rect("+Number(i[1])*r+"px,"+(Number(i[0])+Number(i[2]))*s+"px,"+(Number(i[1])+Number(i[3]))*r+"px,"+Number(i[0])*s+"px)"}#Vn(e,t){var i=!0;if(e==t)return!1;if(0==e.indexOf(t)){var s=e.substring(t.length);s.indexOf("unixTime=")>0&&s.length<24&&(i=!1)}return i}buildPixelatedImages4Edge(e){var t=e.getElementsByTagName("img");if(t.length>0)for(var i=0;i<t.length;i++)if(t[i].dataset.pixelated){var s=t[i].parentNode;console.log("should be pixelated img : ",t[i].id,"  style:",t[i].style.top,t[i].style.left),t[i].style.visibility="hidden";var r=document.createElement("canvas");r.dataset.pixelate4Edge="true",r.width=t[i].width,r.height=t[i].height,r.style.position="absolute",r.style.top=t[i].style.top,r.style.left=t[i].style.left,s.insertBefore(r,t[i]);var a=r.getContext("2d");a.imageSmoothingEnabled=!1,a.msImageSmoothingEnabled=!1;var o=new Image;o.src=t[i].src,a.drawImage(o,0,0,r.width,r.height)}}}class k{#no;#Hn;#wn;#Ro;#jn;#oo;#kt;#zn=null;initialCustomLayers=null;rootSVGpath=null;geoViewBox={x:0,y:0,width:1,height:1};ignoreMapAspect=!1;constructor(e,t,i,s,r,a,o){this.#no=e,this.#kt=t,this.#Hn=i,this.#wn=s,this.#Ro=r,this.#jn=a,this.#oo=o,this.#Wn=0}#Yn;#Xn;#Zn=50;initMapCanvas(){var e=document.getElementById("mapcanvas");if(!e)return console.warn("NO id:mapcanvas div exit.."),null;var t,s=document.createElement("div");for(var r of(e.setAttribute("id","mapCanvasWrapper"),e.attributes))"id"==r.name?s.setAttribute("id","mapcanvas"):"title"==r.name||s.setAttribute(r.name,r.value);if(e.appendChild(s),e.setAttribute("style","position: absolute; overflow: hidden; top: 0px; left: 0px; width: 100%; height: 100%;"),this.#kt.mapCanvas=s,this.#kt.mapCanvasWrapper=e,e.dataset.src)t=e.dataset.src;else{if(!e.title)return console.warn("NO id:mapcanvas data-src for root svg container exit.."),null;t=e.title}if(e.dataset.customLayersRoot){var a,o=e.dataset.customLayersRoot,n=location.href.substring(location.href.indexOf("#")),l=i.getUrlHash(n);if(l&&o)l.customLayers?a=l.customLayers:l.customlayers&&(a=l.customlayers),a&&(this.#zn=new URL(a,new URL(o,location)).href);else o&&o.endsWith(".json")&&(this.#zn=new URL(o,location).href);console.log("Found customLayersRoot Property:",o,"  customLayersPath:",this.#zn)}return t}prepareInitialCustomLayers=async function(){if(this.#zn)try{this.initialCustomLayers=await(await fetch(this.#zn)).json(),console.log("customLayersPath:",this.#zn," initialCustomLayers:",this.initialCustomLayers)}catch(e){console.warn("can't load customLayers json",e)}return this.initialCustomLayers};setLayerListSize(){var e=document.getElementById("layerList"),t=e.style.width;if((!t||t.indexOf("px")<0)&&(e.style.width=.5*this.#kt.mapCanvasSize.width-this.#Zn-5+"px",t=e.style.width),t=Number(t.substring(0,t.indexOf("px"))),e.dataset.originalSize||(e.dataset.originalSize=t),this.#Zn+5+Number(e.dataset.originalSize)>this.#kt.mapCanvasSize.width){var i=this.#kt.mapCanvasSize.width-(this.#Zn+7);e.style.width=i+"px"}else e.style.width=e.dataset.originalSize+"px"}initNavigationUIs(e){var t=document.createElement("style");t.innerHTML="::-webkit-scrollbar{-webkit-appearance:none;width:7px;}::-webkit-scrollbar-thumb{border-radius:4px;background-color:rgba(0,0,0,.5);-webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);}",document.documentElement.appendChild(t);var i=document.documentElement.style;i.position="fixed",i.width="100%",i.height="100%",i.overflow="hidden";var s=document.getElementById("zoomupButton"),r=document.getElementById("zoomdownButton"),a=document.getElementById("gpsButton"),o=document.getElementById("layerList"),n=document.getElementsByClassName("customButton");if(e){var l=0;if(s&&(s.width=this.#Zn,s.height=this.#Zn,s.style.top=l+"px",l+=this.#Zn+5),r&&(r.width=this.#Zn,r.height=this.#Zn,r.style.top=l+"px",l+=this.#Zn+5),a&&(a.width=this.#Zn,a.height=this.#Zn,a.style.top=l+"px",l+=this.#Zn+5),n)for(var h=0;h<n.length;h++)n[h].width=this.#Zn,n[h].height=this.#Zn,n[h].style.top=l+"px",l+=this.#Zn+5;l>0&&o&&(o.style.left=this.#Zn+5+"px")}if(o&&this.setLayerListSize(),s&&(s.style.cursor="pointer"),r&&(r.style.cursor="pointer"),a&&(a.style.cursor="pointer"),n)for(h=0;h<n.length;h++)n[h].style.cursor="pointer"}setPointerEvents(){this.#kt.uaProps.verIE>8&&(i.addEvent(document,"contextmenu",(function(e){e.preventDefault()})),i.addEvent(this.#kt.mapCanvas,"click",(function(e){e.preventDefault()}),!1),i.addEvent(this.#kt.mapCanvas,"mousedown",(function(e){e.preventDefault()}),!1));var e=this;if(this.#kt.uaProps.verIE>8){var t=this.#kt.mapCanvasWrapper;i.addEvent(t,"touchstart",(function(e){e.preventDefault()})),i.addEvent(t,"touchend",(function(e){e.preventDefault()})),i.addEvent(t,"touchmove",(function(e){e.preventDefault()})),i.addEvent(t,"touchstart",(function(t){e.#Hn.startPan(t)})),i.addEvent(t,"touchend",(function(t){e.#Hn.endPan(t)})),i.addEvent(t,"touchmove",(function(t){e.#Hn.showPanning(t)})),i.addEvent(window,"resize",(function(t){e.#qn(t)})),i.addEvent(t,"mousedown",(function(t){e.#Hn.startPan(t)})),i.addEvent(t,"mouseup",(function(t){e.#Hn.endPan(t)})),i.addEvent(t,"mousemove",(function(t){e.#Hn.showPanning(t)})),i.addEvent(window,"resize",(function(t){e.#qn(t)}))}e=this;window.addEventListener("wheel",(function(t){e.#Kn(t)}),{passive:!1})}#qn(){var e=i.getCanvasSize();if(!e||e.width<1||e.height<1)setTimeout(function(){this.#qn()}.bind(this),50);else{var t=this.#oo(this.#kt.rootViewBox,this.#kt.mapCanvasSize),s=this.#kt.rootViewBox.x+.5*this.#kt.rootViewBox.width,r=this.#kt.rootViewBox.y+.5*this.#kt.rootViewBox.height;this.#kt.setMapCanvasSize(e),this.#kt.rootViewBox.width=this.#kt.mapCanvasSize.width/t.a,this.#kt.rootViewBox.height=this.#kt.mapCanvasSize.height/t.d,this.#kt.rootViewBox.x=s-.5*this.#kt.rootViewBox.width,this.#kt.rootViewBox.y=r-.5*this.#kt.rootViewBox.height,this.setMapCanvasCSS(this.#kt.mapCanvas),this.#no.refreshScreen(),this.setLayerListSize(),this.setCenterUI()}}#Jn;#Wn;#Kn(e){0==this.#Wn&&(this.#Hn.startPan({type:"wheelDummy",button:2,clientX:0,clientY:0}),this.#Hn.wheelZooming=!0);var t=1;e.ctrlKey&&(t=3),this.#Wn-=(e.deltaX+e.deltaY+e.deltaZ)*t,this.#Hn.showPanning({type:"wheelDummy",buttons:1,clientX:0,clientY:this.#Wn}),clearTimeout(this.#Jn),this.#Jn=setTimeout(function(){this.#Hn.endPan(),this.#Hn.wheelZooming=!1,this.#Wn=0}.bind(this),200),e.preventDefault()}setCenterUI(){var e;document.getElementById("centerSight")?e=document.getElementById("centerSight"):((e=document.createElement("img")).setAttribute("id","centerSight"),e.setAttribute("src",BuiltinIcons.xcursor),e.setAttribute("width",15),e.setAttribute("height",15),e.style.opacity="0.5",document.documentElement.appendChild(e)),e.style.position="absolute",e.style.top=this.#kt.mapCanvasSize.height/2-document.getElementById("centerSight").height/2+"px",e.style.left=this.#kt.mapCanvasSize.width/2-document.getElementById("centerSight").width/2+"px",this.#wn.updateTicker(),document.getElementById("centerPos")?this.#Yn=document.getElementById("centerPos"):this.#Yn=null,document.getElementById("vScale")?this.#Xn=document.getElementById("vScale"):this.#Xn=null}updateCenterPos(){if(this.#Yn){var e=this.getCentralGeoCoorinates();this.#Yn.innerHTML=i.round(e.lat,6)+" , "+i.round(e.lng,6)}this.#Xn&&(this.#Xn.innerHTML=i.round(this.getVerticalScreenScale(50),3)+"Km")}setUpdateCenterPos(e){e&&(this.updateCenterPos=e)}getVerticalScreenScale(e){var t=this.screen2Geo(1,1),i=this.screen2Geo(1,1+e);return 111.111111*(t.lat-i.lat)}getCentralGeoCoorinates(){var e=this.#kt.rootViewBox.x+this.#kt.rootViewBox.width/2,t=this.#kt.rootViewBox.y+this.#kt.rootViewBox.height/2;return this.#Ro.SVG2Geo(e,t,this.#kt.rootCrs)}screen2Geo(e,t){var i,s;t?(i=e,s=t):(i=e.x,s=e.y);var r=this.#kt.rootViewBox.width*i/this.#kt.mapCanvasSize.width,a=this.#kt.rootViewBox.height*s/this.#kt.mapCanvasSize.height,o=this.#kt.rootViewBox.x+r,n=this.#kt.rootViewBox.y+a;return this.#Ro.SVG2Geo(o,n,this.#kt.rootCrs)}geo2Screen(e,t){var i,s;t?(i=e,s=t):(i=e.lat,s=e.lng);var r=this.#Ro.Geo2SVG(i,s,this.#kt.rootCrs);return{x:(r.x-this.#kt.rootViewBox.x)*this.#kt.mapCanvasSize.width/this.#kt.rootViewBox.width,y:(r.y-this.#kt.rootViewBox.y)*this.#kt.mapCanvasSize.height/this.#kt.rootViewBox.height}}setGeoCenter(e,t,i){if(console.log("setGeoCenter:",e,t,i),e&&t){var s,r;if(this.#jn(),i){if(this.#kt.rootCrs.d)r=Math.abs(this.#kt.rootCrs.d*i);else{var a=this.#Ro.transform(t,e-i/2,this.#kt.rootCrs),o=this.#Ro.transform(t,e+i/2,this.#kt.rootCrs);r=Math.abs(a.y-o.y)}s=r*this.#kt.rootViewBox.width/this.#kt.rootViewBox.height}else r=this.#kt.rootViewBox.height,s=this.#kt.rootViewBox.width;var n=this.#Ro.Geo2SVG(e,t,this.#kt.rootCrs),l=n.x-s/2,h=n.y-r/2;this.#kt.rootViewBox.x=l,this.#kt.rootViewBox.y=h,this.#kt.rootViewBox.width=s,this.#kt.rootViewBox.height=r,this.#no.refreshScreen()}}setGeoViewPort(e,t,i,s,r){return!(!i||!s)&&(this.#jn(),this.#kt.setRootViewBox(this.#_n(e,t,i,s,this.ignoreMapAspect)),r?this.setGeoViewBox(this.#Ro.getTransformedBox(this.#kt.rootViewBox,this.#kt.root2Geo)):this.#no.refreshScreen(),!0)}#_n(e,t,s,r,a){var o=this.#Ro.Geo2SVG(e,t,this.#kt.rootCrs),n=this.#Ro.Geo2SVG(e+s,t+r,this.#kt.rootCrs),l=new Object;return l.x=o.x,l.y=n.y,l.width=Math.abs(n.x-o.x),l.height=Math.abs(o.y-n.y),a?l:i.getrootViewBoxFromRootSVG(l,this.#kt.mapCanvasSize)}setGeoViewBox(e){this.geoViewBox.x=e.x,this.geoViewBox.y=e.y,this.geoViewBox.width=e.width,this.geoViewBox.height=e.height}getGeoViewBox(){var e=this.getCentralGeoCoorinates();return{x:this.geoViewBox.x,y:this.geoViewBox.y,width:this.geoViewBox.width,height:this.geoViewBox.height,cx:e.lng,cy:e.lat}}setMapCanvasCSS(e){e.style.position="absolute",e.style.overflow="hidden",e.style.top="0px",e.style.left="0px",e.style.width=this.#kt.mapCanvasSize.width+"px",e.style.height=this.#kt.mapCanvasSize.height+"px"}}class B{root2Geo;mapCanvas;rootCrs;uaProps;mapCanvas;mapCanvasWrapper;constructor(){Object.defineProperty(this,"rootViewBox",{value:{}}),Object.defineProperty(this,"mapCanvasSize",{value:{}})}hasUaProps(){var e=!1;return this.uaProps&&this.uaProps.verIE&&(e=!0),e}hasMapCanvasSize(){return!!this.mapCanvasSize.width}setRootViewBox(e){this.rootViewBox.x=e.x,this.rootViewBox.y=e.y,this.rootViewBox.width=e.width,this.rootViewBox.height=e.height}setMapCanvasSize(e){this.mapCanvasSize.x=e.x,this.mapCanvasSize.y=e.y,this.mapCanvasSize.width=e.width,this.mapCanvasSize.height=e.height}}class G{#kt;#Qn;#wn;#Mn;#jt;#Ht;#Cn;#$n;usedImages={};constructor(e,t,i,s,r){Object.defineProperty(this,"loadingImgs",{value:{}}),this.#kt=e,this.#jt=t,this.#Ht=i,this.#Cn=s,this.#$n=r}init(e,t,i){this.#Qn=e,this.#wn=t,this.#Mn=i}#el=!0;setLoadCompleted=function(e){this.#el=e}.bind(this);getLoadCompleted=function(){return this.#el}.bind(this);checkLoadCompleted=function(e){var t=this.#tl(this.loadingImgs);if(0==t||e){for(var i=0;i<this.#il;i++){var s=document.getElementById("toBeDel"+i);s&&s.parentNode.removeChild(s)}if(this.#il=0,this.#sl(this.#kt.mapCanvas),this.#kt.uaProps.Edge&&this.#Qn.buildPixelatedImages4Edge(this.#kt.mapCanvas),!this.#el&&!this.#wn.pathHitTester.enable)if(this.#rl(),this.#$n()){var r=document.createEvent("HTMLEvents");r.initEvent("zoomPanMap",!0,!1),document.dispatchEvent(r)}else{var a=document.createEvent("HTMLEvents");a.initEvent("screenRefreshed",!0,!1),document.dispatchEvent(a)}return this.#el=!0,this.#al(),!0}return this.#el=0==t,!1}.bind(this);#il=0;requestRemoveTransition(e,t){var i=e.parentNode,s=null;if(i.childNodes)for(var r=0;r<i.childNodes.length;r++)if(1==i.childNodes[r].nodeType&&0==i.childNodes[r].id.indexOf("toBeDel")){s=i.childNodes[r];break}s||((s=document.createElement("div")).id="toBeDel"+this.#il,i.insertBefore(s,i.firstChild),++this.#il),i.removeChild(e),s.appendChild(e)}#sl(e){for(var t=e.getElementsByTagName("canvas"),i=t.length-1;i>=0;i--)"true"!=t[i].getAttribute("hasdrawing")&&t[i].parentNode.removeChild(t[i]);this.#ol(e)}#ol(e){for(var t=!0,i=e.childNodes.length-1;i>=0;i--){var s=e.childNodes.item(i);if(1==s.nodeType)if("DIV"!=s.nodeName)t=!1;else if(s.hasChildNodes()){this.#ol(s)&&!s.getAttribute("data-layerNode")?s.parentNode.removeChild(s):t=!1}else s.getAttribute("data-layerNode")||s.parentNode.removeChild(s)}return t}#rl(){var e=[];for(var t in this.#Ht)this.usedImages[t]||(this.#jt[t].domMutationObserver&&this.#jt[t].domMutationObserver.disconnect(),delete this.#Ht[t],delete this.#jt[t],this.#Mn.removeDocGeometries(t),e.push(t));e.length>0&&console.log("removeUnusedDocs : docId:",e," are no longer used. Delete it.")}#al(){for(var e in this.#jt)this.#jt[e].refresh&&this.#jt[e].refresh.timeout>0&&0==this.#jt[e].refresh.start&&(this.#jt[e].refresh.start=!0,this.#jt[e].refresh.loadScript=!0,setTimeout(function(e){this.#nl(e)}.bind(this),1e3*this.#jt[e].refresh.timeout,e))}#nl(e){this.#jt[e]&&(this.#jt[e].refresh.start=!1,this.#Cn())}#tl(e){return Object.keys(e).length}}class V{#ll=1;#hl=[];#gl=!0;#Rn=7e3;#dl=138;#pl=37;#kt;#Ht={};#jt={};#qo;#Ko;#sa;#a;#ia;#hn;#cl;#Ro;#Hn;#Mn;#wn;#ul;#ml;#On;#yl;#vl;#fl;#bl;#Il;#Qn;#Pl;#Sl;constructor(){this.#kt=new B;var e=this;console.log("init"),this.#Ro=new p,this.#On=new C,this.#ia=new a(this,this.#kt),this.#a=new d(this,this.#ia,this.#oa),this.#sa=new s(this,this.#a),this.#a.setLayerUIobject(this.#sa),this.#hn=new n(this,this.#sa.getLayersCustomizer),this.#Sl=new G(this.#kt,this.#jt,this.#Ht,this.#Cn,this.#$n),this.#bl=new T(this.#jt,this.#Ht,this.#Sl.loadingImgs,this.#Cn),this.#wn=new M(this,this.#Ro,this.#bl.isEditingLayer,this.#bl.getLayerName,this.#Sl.setLoadCompleted,this.#ia),this.#ul=new w(this.#wn),this.#cl=new h(this),this.#Mn=new y(this,i.getImageURL),this.#vl=new A(this.#Mn,this.#Ro,this.#wn,this.#kt),this.#Qn=new R(this,this.#Sl.loadingImgs,this.#On,this.#Rn,this.#kt,this.#Ro,this.#Sl.checkLoadCompleted,this.#kn),this.#Sl.init(this.#Qn,this.#wn,this.#Mn),this.#ml=new x(this,this.#hn,function(e,t){this.#Ml(e,"root",this.#kt.mapCanvas,!1,t,null,null,!0)}.bind(this)),this.#yl=new L(this),this.#fl=new E(i.getNonScalingOffset),"complete"===document.readyState?e.#wl():i.addEvent(window,"load",function(){e.#wl()}.bind(this)),i.addEvent(window,"hashchange",function(){e.#Cn(),"function"==typeof this.#xl&&setTimeout(function(){this.#xl()}.bind(this),300)}.bind(this))}async#wl(){this.#kt.hasUaProps()&&console.log("Already initialized. Exit..."),this.#Hn=new u(this.#wn.hideTicker,this.#Sl.checkLoadCompleted,this.#wn.getObjectAtPoint,this.#ao,this.#oo,this.#kt,this),this.#Pl=new k(this,this.#kt,this.#Hn,this.#wn,this.#Ro,this.#jn,this.#oo);var e=this.#Pl.initMapCanvas();if(e){if(this.#kt.uaProps=new m,this.#kt.setMapCanvasSize(i.getCanvasSize()),!this.#kt.hasMapCanvasSize())return console.log("retry init....",this.#kt.mapCanvasSize),this.#kt.uaProps=null,void setTimeout(function(){this.#wl()}.bind(this),50);this.#Il=new O(this),this.#kt.setRootViewBox(i.getBBox(0,0,this.#kt.mapCanvasSize.width,this.#kt.mapCanvasSize.height)),this.#Pl.setMapCanvasCSS(this.#kt.mapCanvas),this.#Pl.setPointerEvents(),this.#Pl.setCenterUI(),this.#Pl.initNavigationUIs(this.#kt.uaProps.isSP),this.#ml.setInitialCustomLayers(await this.#Pl.prepareInitialCustomLayers(),e),this.#Cl(e,"root",this.#kt.mapCanvas)}}#Ll(e,t,i){i&&("root"==i?(this.#jt[e].rootLayer=e,t.setAttribute("class","rootLayer:"+e),t.getAttribute("data-nocache")&&(this.#jt[e].noCache=!0)):(this.#jt[e].rootLayer=this.#jt[i].rootLayer,t.setAttribute("class","rootLayer:"+this.#jt[i].rootLayer)))}#Cl(e,t,s,r){if(this.#Ht[t])delete this.#Sl.loadingImgs[t],this.#Ll(t,s,r),this.#El(t,s);else{this.#jt[t]=new function(){},this.#Ll(t,s,r);var a=this,o=this.#Al((function(){a.#Tl(t,e,s,this,r)}),(function(){a.#Ol(t,e,this,!0)}));if(o){this.#Sl.loadingImgs[t]=!0;var n=e;this.#jt[t].rootLayer&&this.#jt[this.#jt[t].rootLayer].noCache&&(n=i.getNoCacheRequest(n));const s=this.#jt[t].commonQuery||this.#jt[this.#jt[t].rootLayer]?.commonQuery;null!=s&&(n=i.addCommonQueryAtQueryString(n,s),this.#jt[t].commonQuery=s),n=this.#On.getAccessInfo(n),o.open("GET",i.getSvgReq(n),!0),this.#kt.uaProps.MS&&o.ontimeout&&(o.timeout=this.#Rn),o.send(null)}}}#Ol(e,t,i,s){delete this.#Sl.loadingImgs[e],console.log("File get failed: Err:",i.status," Path:",t," id:",e),this.#jt[e]&&(this.#jt[e].loadError=!0),s?++this.#kn.timeoutSvgDocCount:++this.#kn.otherSvgDocCount,this.#Sl.checkLoadCompleted()}#Tl(e,s,r,a,o){if(4==a.readyState){if(!this.#jt[e])return console.log("NO svgImagesProps[docId] : docId:",e,"  skip processing"),delete this.#Sl.loadingImgs[e],void this.#Sl.checkLoadCompleted();if(403==a.status||404==a.status||500==a.status||503==a.status)return void this.#Ol(e,s,a);if(a.responseText.indexOf("http://www.w3.org/2000/svg")>=0){var n=a.responseText.replace('xmlns="http://www.w3.org/2000/svg"','xmlns="http://www.w3.org/"');n.match(/data-controller-src([\s\S]*)"/)&&(n=i.getControllerSrc(n,this.#jt[e])),n.match(/<script>([\s\S]*)<\/script>/)&&(n=i.getSvgScript(n,this.#jt[e])),this.#Ht[e]=(new DOMParser).parseFromString(n,"application/xml")}else this.#Ht[e]=(new DOMParser).parseFromString(a.responseText,"application/xml");if(this.#Ht[e].getElementsByTagName("svg").length<1)return console.warn("DOCUMENT ERROR.. skip"),delete this.#Ht[e],void this.#Ol(e,s,a);this.#Ht[e].getElementById=i.getElementByIdUsingQuerySelector,this.#jt[e].Path=s,this.#jt[e].CRS=this.#Rl(this.#Ht[e],e),this.#jt[e].refresh=i.getRefresh(this.#Ht[e]),this.#jt[e].styleMap=new WeakMap,this.#jt[e].altdMap=new WeakMap;var l=new MutationObserver(function(t){t.forEach(function(t){"attributes"==t.type&&(this.#jt[e].styleMap.delete(t.target),this.#jt[e].altdMap.delete(t.target))}.bind(this))}.bind(this));if(l.observe(this.#Ht[e].documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),this.#jt[e].domMutationObserver=l,this.#kl(e),this.#jt[e].isSVG2=this.#jt[e].CRS.isSVG2,this.#jt[e].parentDocId=o,this.#jt[o]&&this.#jt[o].childImages[e]==t.CLICKABLE&&(this.#jt[e].isClickable={value:!0}),this.#Bl(this.#Ht[e],s,this.#jt[e]),"root"==e){this.#kt.rootCrs=this.#jt[e].CRS,this.#kt.root2Geo=this.#Ro.getInverseMatrix(this.#kt.rootCrs);var h=this.#Gl(this.#Ht.root);this.#kt.setRootViewBox(i.getrootViewBoxFromRootSVG(h,this.#kt.mapCanvasSize,this.#Pl.ignoreMapAspect))}else this.#bl.isEditableLayer(e)&&(this.#jt[e].editable=!0);this.#El(e,r)}}#Vl=new Object;#El(e,t){e||t||(e="root",t=this.#kt.mapCanvas);var s=this.#Ht[e];s.documentElement.setAttribute("about",e),t.setAttribute("property",this.#jt[e].metaSchema);var r=i.getSymbols(s);"root"==e&&(this.#Sl.usedImages={},this.#wn.pathHitTester.setCentralVectorObjectsGetter(),this.#bl.setRootLayersPropsPostprocessed||("function"==typeof this.#xl&&this.#xl(),this.#bl.setRootLayersPropsPostprocessed=!0),this.#gl&&this.#Nl(),this.#wn.hideTicker(),this.#Pl.updateCenterPos(),this.#Pl.setGeoViewBox(this.#Ro.getTransformedBox(this.#kt.rootViewBox,this.#kt.root2Geo)),this.#wn.pathHitTester.enable||(this.#Vl=new Object,this.#wn.poiHitTester.clear()),this.#ml.checkResume(s.documentElement,r),this.#Dl()),this.#Ml(s.documentElement,e,t,!1,r,null,null),delete this.#Sl.loadingImgs[e],"root"==e&&("function"==typeof this.#Ul&&(this.#Ul({}),this.#a.initLayerSpecificUI(),this.#Ul=null),this.#Fl(this.#kt.mapCanvas),!this.#wn.isEnabled()||this.#wn.pathHitTester.enable||this.#Mn.GISgeometriesCaptureFlag||this.#wn.checkTicker()),this.#wn.pathHitTester.enable||this.#Sl.checkLoadCompleted()}#Hl(e,t,s){this.#jt[e].script.location=i.getSvgLocation(this.#jt[e].Path),this.#jt[e].script.scale=t*s.scale,this.#jt[e].script.actualViewBox=this.#Ro.getTransformedBox(this.#kt.rootViewBox,this.#Ro.getInverseMatrix(s)),this.#jt[e].script.geoViewBox=this.#Pl.geoViewBox,this.#jt[e].script.viewport=this.#jt[e].script.actualViewBox,this.#jt[e].script.geoViewport=this.#Pl.geoViewBox;var r=this.#$n(e);this.#jt[e].script.handleScriptCf(),"zoom"==r||this.#jt[e].script.initialLoad?(this.#jt[e].script.initialLoad=!1,this.#jt[e].script.onzoom&&this.#jt[e].script.onzoom()):"scroll"==r&&this.#jt[e].script.onscroll&&this.#jt[e].script.onscroll(),this.#jt[e].refresh.timeout>0&&1==this.#jt[e].refresh.loadScript&&(this.#jt[e].refresh.loadScript=!1,this.#jt[e].script.onload())}#jl=null;#zl(e,t,i,s){var r=this.#oa(e,t,i);if(s)this.#jl(r);else try{this.#jt[e].preRenderControllerFunction(r)}catch(t){console.error("Error in handlePreRenderControllerScript: docId:",e,"  Exception:",t)}}#oa(e,t,s){if(!t||!s){var r=this.#jt[e].CRS;s=this.#Ro.getConversionMatrixViaGCS(r,this.#kt.rootCrs);var a=this.#oo(this.#kt.rootViewBox,this.#kt.mapCanvasSize);t=this.#Wl(a,e)}var o=this.#$n("prc_"+e);return{docId:e,location:i.getSvgLocation(this.#jt[e].Path),scale:t*s.scale,rootScale:t,c2rScale:s.scale,actualViewBox:this.#Ro.getTransformedBox(this.#kt.rootViewBox,this.#Ro.getInverseMatrix(s)),geoViewBox:this.#Pl.geoViewBox,viewChanged:o}}#Yl={};#$n=function(e){var t;return e||(e="allMaps"),t=this.#Yl[e]&&this.#Yl[e].width==this.#kt.rootViewBox.width&&this.#Yl[e].height==this.#kt.rootViewBox.height?(this.#Yl[e].x!=this.#kt.rootViewBox.x||this.#Yl[e].y!=this.#kt.rootViewBox.y)&&"scroll":"zoom",this.#Yl[e],this.#Yl[e]={x:this.#kt.rootViewBox.x,y:this.#kt.rootViewBox.y,width:this.#kt.rootViewBox.width,height:this.#kt.rootViewBox.height},t}.bind(this);#kl(e){var t=i.getMetaSchema(this.#Ht[e]);this.#jt[e].metaSchema=t||""}#Ml(e,s,r,a,o,n,l,h){var g=this.#jt[s].Path,d=this.#jt[s].isClickable;"svg"==e.nodeName&&(this.#kl(s),this.#Sl.usedImages[s]=!0,n={});var p=null,c=this.#oo(this.#kt.rootViewBox,this.#kt.mapCanvasSize),u=this.#Wl(c,s),m=e.childNodes,y=this.#jt[s].CRS;if(!this.#jt[s].CRS.unresolved||(this.#jt[s].CRS=this.#Rl(this.#Ht[s],s),!this.#jt[s].CRS.unresolved)){this.#jt[s].isSVG2=this.#jt[s].CRS.isSVG2;var b=this.#jt[s].isSVG2,I=this.#Ro.getConversionMatrixViaGCS(y,this.#kt.rootCrs);this.#jt[s].scale=u*I.scale,this.#jt[s].geoViewBox=this.#Pl.geoViewBox;var P=this.#Ro.matMul(I,c);"svg"==e.nodeName&&("function"==typeof this.#jt[s].preRenderControllerFunction&&this.#zl(s,u,I),"function"==typeof this.#jl&&this.#zl(s,u,I,!0)),this.#Mn.GISgeometriesCaptureFlag&&this.#Mn.prepareDocGeometries(s);for(var S=i.getDocDir(g),M=0;M<m.length;M++){var w=m[M],x=!1;if(1==w.nodeType){var C="",L=t.NONE,E=t.NONE;switch(w.nodeName){case"animation":b||(L=t.EMBEDSVG);break;case"iframe":b&&(L=t.EMBEDSVG,E=t.SVG2EMBED);break;case"image":i.getNonScalingOffset(w).nonScaling?(L=t.POI,E=t.DIRECTPOI):L=t.BITIMAGE;break;case"use":(C=w.getAttribute("xlink:href"))||(C=w.getAttribute("href")),o[C]&&("group"==o[C].type?(L=t.GROUP,E=t.SYMBOL):(L=t.POI,E=t.USEDPOI));break;case"path":E=t.PATH,L=t.VECTOR2D;break;case"polyline":E=t.POLYLINE,L=t.VECTOR2D;break;case"polygon":E=t.POLYGON,L=t.VECTOR2D;break;case"rect":E=t.RECT,L=t.VECTOR2D;break;case"circle":E=t.CIRCLE,L=t.VECTOR2D;break;case"ellipse":E=t.ELLIPSE,L=t.VECTOR2D;break;case"g":L=t.GROUP;break;case"a":L=t.GROUP,E=t.HYPERLINK;break;case"text":L=t.TEXT}var A=null;if(!this.#wn.pathHitTester.enable&&this.#Mn.GISgeometriesCaptureFlag&&(A=v.createSVGMapGISgeometry(L,E,w,this.#Mn.GISgeometriesCaptureOptions)),!this.#wn.pathHitTester.enable&&(L==t.POI||L==t.BITIMAGE||L==t.EMBEDSVG||L==t.TEXT)||this.#wn.pathHitTester.enable&&L==t.EMBEDSVG){var T,O=w.getAttribute("iid");O&&0==O.indexOf("i")||(O="i"+this.#Xl,w.setAttribute("iid",O),++this.#Xl),this.#Vl[O]=!0,T=this.#Zl(O);var R=i.getImageProps(w,L,l,E,A),k=this.#Ro.transformRect(R,I);if(R.nonScaling&&(k.nonScaling=!0),0!=k.width||0!=k.height||L!=t.EMBEDSVG&&L!=t.BITIMAGE||console.warn("This embedding element don't have width/height property. Never renders... imageId:",O,w),R.commonQuery&&"root"!=s&&(this.#jt[this.#jt[s].rootLayer].commonQuery=R.commonQuery),h)continue;if(!a&&i.isIntersect(k,this.#kt.rootViewBox)&&i.inZoomRange(R,u,k.c2rScale)&&i.isVisible(R)){var B,G,V=null;if(R.transform){var N=this.#Ro.matMul(R.transform,P),D=this.#Ro.transform(R.x,R.y,N);if(!N.a){var U=this.#Ro.transform(R.x+R.width,R.y,N),F=this.#Ro.transform(R.x+R.width,R.y+R.height,N);N=f.getLinearTransformMatrix(R.x,R.y,R.x+R.width,R.y,R.x+R.width,R.y+R.height,D.x,D.y,U.x,U.y,F.x,F.y)}var H=Math.sqrt(Math.abs(N.a*N.d-N.b*N.c));B={p0:0,span:R.width*H},G={p0:0,span:R.height*H},B.p0=D.x,G.p0=D.y,V={a:N.a/H,b:N.b/H,c:N.c/H,d:N.d/H,e:0,f:0}}else{var j=this.#Ro.getTransformedBox(k,c);if(L==t.POI&&E==t.USEDPOI){var z=o[R.href];z.d||(R.href=z.path,j.x+=z.offsetX,j.y+=z.offsetY,j.width=z.width,j.height=z.height)}else R.nonScaling&&(j.width=R.width,j.height=R.height,(R.cdx||R.cdy)&&(j.x+=R.cdx,j.y+=R.cdy));B=this.#ao(j.x,j.width),G=this.#ao(j.y,j.height)}if(T){if(L==t.POI||L==t.BITIMAGE)this.#Qn.setImgElement(T,B.p0,G.p0,B.span,G.span,i.getImageURL(R.href,S),V,0,0,!1,R.nonScaling,R.href_fragment,R.pixelated,R.imageFilter,O,R.opacity,R.crossorigin,{docId:s,svgNode:w});else if(L==t.TEXT)this.#Qn.setImgElement(T,B.p0,G.p0,0,G.span,"",V,R.cdx,R.cdy,!0,R.nonScaling,null,R.pixelated,R.imageFilter,O,R.opacity,null,{docId:s,svgNode:w});else{K=i.getImageURL(R.href,S);this.#jt[O]&&this.#jt[O].Path&&this.#jt[O].Path!=K&&(console.log("change SVG's path. this has issues...."),this.#jt[O].Path=K),this.#ql(this.#Ht,O,T,0)}p=T}else{var W;if(L==t.POI||L==t.BITIMAGE){var Y=i.getImageURL(R.href,S),X=L==t.BITIMAGE&&this.#jt[s].rootLayer&&this.#jt[this.#jt[s].rootLayer].noCache;W=this.#Qn.getImgElement(B.p0,G.p0,B.span,G.span,Y,O,R.opacity,L,R.metadata,R.title,V,R.href_fragment,R.pixelated,R.imageFilter,X,R.crossorigin,{docId:s,svgNode:w},R.commonQuery||this.#jt[this.#jt[s].rootLayer]?.commonQuery)}else if(L==t.TEXT){var Z=this.#fl.getStyle(w,l,null,this.#jt[s].styleMap);W=this.#Kl(B.p0,G.p0,R.cdx,R.cdy,R.text,O,R.opacity,V,Z,G.span,R.nonScaling)}else W=document.createElement("div"),"root"==s&&(w.getAttribute("data-nocache")&&W.setAttribute("data-nocache","true"),W.setAttribute("data-layerNode","true")),W.id=O,R.opacity&&(this.#kt.uaProps.MS?(this.#kt.uaProps.verIE>8&&W.setAttribute("style","Filter: Alpha(Opacity="+100*R.opacity+");opacity:"+R.opacity+";"),W.style.filter="alpha(opacity="+100*R.opacity+")",W.style.position="absolute",W.style.top=0,W.style.left=0):W.style.opacity=R.opacity),this.#jt[s].childImages||(this.#jt[s].childImages=new Array),this.#jt[s].isClickable||R.elemClass&&R.elemClass.indexOf("clickable")>=0?this.#jt[s].childImages[O]=t.CLICKABLE:this.#jt[s].childImages[O]=t.EXIST;if(L==t.POI&&this.#Mn.GISgeometriesCaptureOptions.SkipVectorRendering);else{if(p)r.insertBefore(W,p.nextSibling);else if(r.hasChildNodes()){var q=r.getElementsByTagName("div");q?r.insertBefore(W,q.item(0)):r.insertBefore(W,r.lastChild)}else r.appendChild(W);p=W}if(L!=t.POI&&L!=t.BITIMAGE&&L!=t.TEXT){var K=i.getImageURL(R.href,S);this.#Cl(K,O,W,s)}this.#kt.uaProps.isIE&&(this.#kt.uaProps.verIE<9&&(L==t.POI||L==t.BITIMAGE)&&(W.src=W.getAttribute("href")),W.width=B.span,W.height=G.span,W.style.width=B.span+"px",W.style.height=G.span+"px")}L==t.POI&&this.#wn.poiHitTester.setPoiBBox(O,B.p0,G.p0,B.span,G.span),x=!0}else T&&(this.#Sl.requestRemoveTransition(T,r),L==t.EMBEDSVG&&this.#Jl(O))}else if(L==t.GROUP){if(w.hasChildNodes()||E==t.SYMBOL){var J=!1;E==t.HYPERLINK&&(J=!0);Z=this.#fl.getStyle(w,l,J,this.#jt[s].styleMap);E==t.SYMBOL&&(Z.usedParent=w,w=o[C].node),p=this.#Ml(w,s,r,!1,o,n,Z,h)}}else if(L==t.VECTOR2D){if(h)continue;if(!n.context)if(this.#gl){var _=document.getElementById(this.#jt[s].rootLayer+"_canvas");_||((_=document.createElement("canvas")).style.position="absolute",_.style.left="0px",_.style.top="0px",_.width=this.#kt.mapCanvasSize.width,_.height=this.#kt.mapCanvasSize.height,_.id=this.#jt[s].rootLayer+"_canvas",document.getElementById(this.#jt[s].rootLayer).appendChild(_),_.setAttribute("hasdrawing","false")),n.element=_,n.context2d=_.getContext("2d")}else;Z=this.#fl.getStyle(w,l,null,this.#jt[s].styleMap);if(A&&A.determineType(Z),this.#Mn.GISgeometriesCaptureOptions.SkipVectorRendering?n.context=this.#Mn.dummy2DContextBuilder():n.context=n.context2d,n.altdMap=this.#jt[s].altdMap,i.inZoomRange(Z,u,I.scale)&&(!Z.display||"none"!=Z.display)&&(!Z.visibility||"hidden"!=Z.visibility)){var Q=null;if(E==t.PATH?Q=this.#vl.setSVGpathPoints(w,n,P,d,null,Z,A):E==t.RECT?Q=this.#vl.setSVGrectPoints(w,n,P,d,Z,A):E==t.CIRCLE||E==t.ELLIPSE?Q=this.#vl.setSVGcirclePoints(w,n,P,d,E,Z,A):E!=t.POLYLINE&&E!=t.POLYGON||(Q=this.#vl.setSVGpolyPoints(w,n,P,d,E,Z,A)),Q){if(Z["marker-end"]){var $="M-20,-5 L0,0 L-20,5",ee=/\s*url\((#.*)\)/.exec(Z["marker-end"]);ee&&o[ee[1]]&&o[ee[1]].d&&($=o[ee[1]].d);var te={a:Q.endCos,b:Q.endSin,c:-Q.endSin,d:Q.endCos,e:Q.endX,f:Q.endY};n.context.setLineDash([]),this.#vl.setSVGpathPoints(w,n,te,d,$,Z)}(this.#wn.pathHitTester.enable||this.#wn.pathHitTester.centralGetter)&&Q.hitted&&this.#wn.pathHitTester.setHittedObjects(w,Q,Z.usedParent),i.isIntersect(Q,this.#kt.mapCanvasSize)&&(n.element.setAttribute("hasdrawing","true"),x=!0)}}}A&&x&&this.#Mn.addGeometry(s,A,T,S)}}return p}console.warn("docId:",s,"'s CRS is not resolved skip.")}#ql(e,t,s,r){if(!this.#jt[t]||!this.#jt[t].loadError)if(this.#Ht[t]&&this.#jt[t]){this.#Sl.loadingImgs[t]=!0;var a=i.getSymbols(this.#Ht[t]);this.#Ml(this.#Ht[t].documentElement,t,s,!1,a,null,null),delete this.#Sl.loadingImgs[t]}else r<20?(++r,setTimeout(function(e,t,i,s){this.#ql(e,t,i,s)}.bind(this),50,e,t,s,r)):console.log("FAIL: document load : imageId:",t)}#Fl(e){for(var t=new Array,i=e.childNodes.length-1;i>=0;i--){var s=e.childNodes.item(i);1==s.nodeType&&("IMG"!=s.nodeName&&"SPAN"!=s.nodeName||!s.id||-1!=s.id.indexOf("toBeDel")||this.#Vl[s.id]||t.push(s),s.id&&-1==s.id.indexOf("toBeDel")&&s.hasChildNodes()&&this.#Fl(s))}for(i=0;i<t.length;i++)this.#Sl.requestRemoveTransition(t[i],e)}#Nl(){for(var e=this.#kt.mapCanvas.getElementsByTagName("canvas"),t=e.length-1;t>=0;t--){var i=e.item(t);i.dataset.pixelate4Edge||(i.setAttribute("hasdrawing","false"),i.style.left="0px",i.style.top="0px",i.width=this.#kt.mapCanvasSize.width,i.height=this.#kt.mapCanvasSize.height,i.getContext("2d").clearRect(0,0,i.width,i.height))}}#oo=function(e,t){var i,s;return e||(e=this.#kt.rootViewBox,t=this.#kt.mapCanvasSize),{a:i=t.width/e.width,b:0,c:0,d:s=t.height/e.height,e:-i*e.x,f:-s*e.y}}.bind(this);#Xl=0;#Zl(e){var t=document.getElementById(e);return t||!1}#ao(e,t){var i=Math.floor(e);return{p0:i,span:Math.floor(e+t)-i+.02}}#Kl(e,t,i,s,r,a,o,n,l,h,g){var d=document.createElement("span");o&&(d.style.opacity=o),l.fill&&(d.style.color=l.fill);var p=0;return p=l["font-size"]&&g?Number(l["font-size"]):g?16:h,d.style.fontSize=p+"px",d.innerHTML=r,d.style.left=e+i+"px",this.#kt.uaProps.MS?d.style.top=t+s-p+"px":d.style.bottom=this.#kt.mapCanvasSize.height-(t+s)+"px",d.style.position="absolute",d.id=a,d.setAttribute("title",""),d}#jn=function(){for(var e=this.#kt.mapCanvas.getElementsByTagName("img"),t=e.length-1;t>=0;t--)e[t].style.visibility="hidden"}.bind(this);#Rl(e,t){var s=!1,r=null,a=i.getElementByIdNoNS(e,"globe");try{var o={unresolved:!0,isSVG2:!1};if(a&&"view"==a.nodeName){var n=a.getAttribute("viewBox").split(/\s*,\s*|\s/);(r=new Array(6))[0]=n[2]/360,r[1]=0,r[2]=0,r[3]=-n[3]/180,r[4]=Number(n[0])+180*r[0],r[5]=Number(n[1])-90*r[3],s=!0,o={a:r[0],b:r[1],c:r[2],d:r[3],e:r[4],f:r[5],isSVG2:s}}else{var l=e.getElementsByTagName("globalCoordinateSystem")[0];if(l){var h=l.getAttribute("transform");if(h)if(o.transformFunctionName=h,h.indexOf("matrix")>=0)(o=i.parseTransformMatrix(h))&&(o.isSVG2=s);else if("mercator"==h.toLowerCase())console.log("isMercator"),(o=new c).isSVG2=!1;else if(0==h.indexOf("controller.")){var g=this.#jt[this.#jt[t].rootLayer].controllerWindow;if(g){var d=h.substring(11);g[d]&&((o=g[d]).isSVG2||(o.isSVG2=!1))}}else if(this.#jt[t].script&&this.#jt[t].script.transformFunction){var p=this.#jt[t].script.transformFunction;console.log("set transformFunction:",p),p&&((o=p()).isSVG2||(o.isSVG2=!1))}}}return o.unresolved&&console.warn("This document don't have CRS. Never renders. docId:",t),o}catch(e){return{a:1,b:0,c:0,d:1,e:0,f:0,isSVG2:!1}}}#Bl(e,t,s){var r=e.documentElement.getAttribute("data-controller");if(s.controller&&s.controller.src){if(r){var a=s.controller.src;s.controller=new String(r),s.controller.url=r,vgImageProps.controller.src=a}}else if(r){var o=i.getImageURL(r,i.getDocDir(t));s.controller=new String(o),s.controller.url=o}else if("root"==s.parentDocId&&null!=(r=this.#bl.getLayer(s.rootLayer).getAttribute("data-controller"))&&""!==r){o=i.getImageURL(r,i.getDocDir(t));s.controller=new String(o),s.controller.url=o}}#Gl(e){var t=e.documentElement.getAttribute("viewBox");if(t){if(0==t.indexOf("#"))return t.substring(1);if(0==t.trim().indexOf("global")){var s=i.trim(t).split(/[\s,]+/),r={x:Number(s[1]),y:Number(s[2]),width:Number(s[3]),height:Number(s[4])},a=this.#Ro.getTransformedBox(r,this.#kt.rootCrs);return console.log("getViewBox:global,root:",r,a,s),a}s=i.trim(t).split(/[\s,]+/);return{x:Number(s[0]),y:Number(s[1]),width:Number(s[2]),height:Number(s[3])}}return null}#Wl(e,t){var i=this.#jt[t].rootLayer;return null!=this.#hl[i]?(Math.abs(e.a)+Math.abs(e.d))/(2*this.#hl[i]):(Math.abs(e.a)+Math.abs(e.d))/(2*this.#ll)}#_l(e,t){t?e>0?this.#hl[t]=e:e||delete this.#hl[t]:e>0?this.#ll=e:e||(this.#ll=1,this.#hl=[])}#Ql(e){if(e){var t=this.#jt[e].rootLayer;return null!=this.#hl[t]?this.#hl[t]:this.#ll}return{commonDevicePixelRatio:this.#ll,layerDevicePixelRatio:this.#hl}}#Al(e,t){var i=null;try{i=new XMLHttpRequest}catch(e){alert("Too old browsers: not supported")}return i&&(i.onreadystatechange=e),t&&(this.#kt.uaProps.MS||(i.timeout=this.#Rn),i.ontimeout=t),i}#Jl(e){if(this.#Ht[e]){for(var t=this.#bl.getLayers(e),i=0;i<t.length;i++)this.#Jl(t[i].getAttribute("iid"));this.#jt[e].domMutationObserver&&this.#jt[e].domMutationObserver.disconnect(),delete this.#Ht[e],delete this.#jt[e]}else this.#jt[e]&&this.#jt[e].loadError&&(this.#jt[e].domMutationObserver&&this.#jt[e].domMutationObserver.disconnect(),delete this.#jt[e])}#kn={};#Dl(){this.#kn={timeoutBitImagesCount:0,timeoutSvgDocCount:0,otherBitImagesCount:0,otherSvgDocCount:0}}#$l(){return this.#kn}#eh(e){var t=e.parentNode.getAttribute("id");return"mapcanvas"==t&&(t="root"),{element:i.getElementByImgIdNoNS(this.#Ht[t],e.getAttribute("id")),docId:t}}#th=!1;#Cn=function(e,t,i,s){if(s)return this.#ih(e,t,i,s);queueMicrotask(function(){this.#ih(e,t,i)}.bind(this))}.bind(this);#ih=function(e,t,i){if(console.log("rootViewBox:",this.#kt.rootViewBox),!this.#th||i){if(console.log("called refreshScreen",this.#Sl.getLoadCompleted()?"":" : now loading"),0!=this.#Sl.getLoadCompleted())this.#th=!1,this.#Sl.setLoadCompleted(!1),this.#El("root",this.#kt.mapCanvas);else if(!e){var s=this;setTimeout(function(){s.#Cn(e,undefined,!0)}.bind(this),10),this.#th=!0}}else console.log("Is refreshScreen retry queue:: SKIP this Call")}.bind(this);#Ul;#xl;#sh(e){console.log("called reLoadLayer : ",e),this.#bl.setRootLayersProps(e,!1,!1),this.#Cn(),this.#bl.setRootLayersProps(e,!0,!1),this.#Cn()}Geo2SVG(...e){return this.#Ro.Geo2SVG(...e)}POIviewSelection(...e){return this.#wn.POIviewSelection(...e)}SVG2Geo(...e){return this.#Ro.SVG2Geo(...e)}addEvent(){return i.addEvent}captureGISgeometries(...e){return this.#Mn.captureGISgeometries(...e)}captureGISgeometriesOption=function(e,t,i,s){if("object"==typeof e)for(var r in e)"boolean"==typeof e[r]&&"boolean"==typeof this.#Mn.GISgeometriesCaptureOptions[r]&&(this.#Mn.GISgeometriesCaptureOptions[r]=e[r]);else!0!==e&&!1!==e||(this.#Mn.GISgeometriesCaptureOptions.BitImageGeometriesCaptureFlag=e),!0!==t&&!1!==t||(this.#Mn.GISgeometriesCaptureOptions.TreatRectAsPolygonFlag=t),!0!==i&&!1!==i||(this.#Mn.GISgeometriesCaptureOptions.SkipVectorRendering=i),"boolean"==typeof s&&(this.#Mn.GISgeometriesCaptureOptions.captureAlsoAsBitImage=s)}.bind(this);checkSmartphone(...e){return this.#kt.uaProps.isSP}childDocOp(...e){return this.#yl.childDocOp(...e)}dynamicLoad(...e){return this.#El(...e)}escape(...e){return i.escape(...e)}geo2Screen(...e){return this.#Pl.geo2Screen(...e)}getBasicPermanentLink(...e){return this.#ml.getBasicPermanentLink(...e)}getBBox(...e){return i.getBBox(...e)}getCanvasSize(...e){return i.getCanvasSize(...e)}getCentralGeoCoorinates(...e){return this.#Pl.getCentralGeoCoorinates(...e)}getConversionMatrixViaGCS(...e){return this.#Ro.getConversionMatrixViaGCS(...e)}getCORSURL(...e){return this.#On.getCORSURL(...e)}getElementByImageId(...e){return i.getElementByImgIdNoNS(...e)}getGeoViewBox(){return this.#Pl.getGeoViewBox()}getHashByDocPath(...e){return this.#bl.getHashByDocPath(...e)}getHyperLink(...e){return i.getHyperLink(...e)}getInverseMatrix(...e){return this.#Ro.getInverseMatrix(...e)}getLayer(...e){return this.#bl.getLayer(...e)}getLayerId(...e){return this.#bl.getLayerId(...e)}getLayers(...e){return this.#bl.getLayers(...e)}getLinearTransformMatrix(...e){return f.getLinearTransformMatrix(...e)}getLoadErrorStatistics(...e){return this.#$l(...e)}getMapCanvas(){return this.#kt.mapCanvas}getMapCanvasSize(){return this.#kt.mapCanvasSize}getMouseXY(...e){return this.#Hn.getMouseXY(...e)}getNonScalingOffset(...e){return i.getNonScalingOffset(...e)}getPoiPos(...e){return i.getNonScalingOffset(...e)}getResume(){return this.#ml.getResume()}getRoot2Geo(){return this.#kt.root2Geo}getRootCrs(){return this.#kt.rootCrs}getRootLayersProps(...e){return this.#bl.getRootLayersProps(...e)}getRootViewBox(){return this.#kt.rootViewBox}getSvgImages(){return this.#Ht}getSvgImagesProps(){return this.#jt}getSvgMapLayerUI(){return this.#sa}getSvgTarget(...e){return this.#eh(...e)}getSwLayers(...e){return this.#bl.getSwLayers(...e)}getSymbols(...e){return i.getSymbols(...e)}getTickerMetadata(...e){return this.#wn.getTickerMetadata(...e)}getTransformedBox(...e){return this.#Ro.getTransformedBox(...e)}getUaProp(){return{isIE:this.#kt.uaProps.isIE,isSP:this.#kt.uaProps.isSP,uaProp:this.#kt.uaProps}}getVerticalScreenScale(...e){return this.#Pl.getVerticalScreenScale(...e)}getViewBox(...e){return this.#Gl(...e)}gps(...e){return this.#Il.gps(...e)}gpsCallback(...e){return this.#Il.gpsSuccess(...e)}handleResult(...e){return this.#Tl(...e)}ignoreMapAspect(){this.#Pl.ignoreMapAspect=!0}initLoad(...e){return this.#wl(...e)}isIntersect(...e){return i.isIntersect(...e)}linkedDocOp(...e){return this.#yl.linkedDocOp(...e)}loadSVG(...e){return this.#Cl(...e)}matMul(...e){return this.#Ro.matMul(...e)}numberFormat(...e){return i.numberFormat(...e)}parseEscapedCsvLine(...e){return this.#wn.showPoiProperty.parseEscapedCsvLine(...e)}refreshScreen(...e){return this.#Cn(...e)}registLayerUiSetter(e,t){console.log("registLayerUiSetter:",e,t),this.#Ul=e,this.#xl=t}reLoadLayer(...e){return this.#sh(...e)}resumeToggle(...e){return this.#ml.resumeToggle(...e)}screen2Geo(...e){return this.#Pl.screen2Geo(...e)}setCustomModal(...e){return this.#ul.setCustomModal(...e)}setDevicePixelRatio(...e){return this.#_l(...e)}getDevicePixelRatio(...e){return this.#Ql(...e)}setGeoCenter(...e){return this.#Pl.setGeoCenter(...e)}setGeoViewPort(...e){return this.#Pl.setGeoViewPort(...e)}setLayerVisibility(...e){return this.#bl.setLayerVisibility(...e)}setMapCanvas(e){this.#kt.mapCanvas=e}setMapCanvasCSS(...e){return this.#Pl.setMapCanvasCSS(...e)}setMapCanvasSize(e){this.#kt.setMapCanvasSize(e)}setPreRenderController(e,t){"function"==typeof t?e?this.#jt[e].preRenderControllerFunction=t:this.#jl=t:e?delete this.#jt[e].preRenderControllerFunction:this.#jl=null}setProxyURLFactory(...e){return this.#On.setProxyURLFactory(...e)}setResume(e){this.#ml.setResume(e)}setRootLayersProps(...e){return this.#bl.setRootLayersProps(...e)}setRootViewBox(e){this.#kt.setRootViewBox(e)}setShowPoiProperty(...e){return this.#wn.showPoiProperty.setShowPoiProperty(...e)}setSmoothZoomInterval(...e){return this.#Hn.setSmoothZoomInterval(...e)}setSmoothZoomTransitionTime(...e){return this.#Hn.setSmoothZoomTransitionTime(...e)}setSummarizeCanvas(e){this.#gl=e}setUpdateCenterPos(...e){return this.#Pl.setUpdateCenterPos(...e)}setZoomRatio(e){this.#Hn.setZoomRatio(e)}showModal(...e){return this.#wn.showPoiProperty.showModal(...e)}showPage(...e){return this.#wn.showPage(...e)}showUseProperty(...e){return this.#wn.showUseProperty(...e)}transform(...e){return this.#Ro.transform(...e)}updateLayerListUI=function(){console.log("updateLayerListUI called  this:",this),"function"==typeof this.#xl&&this.#xl()}.bind(this);zoomdown(...e){return this.#Hn.zoomdown(...e)}zoomup(...e){return this.#Hn.zoomup(...e)}}export{V as SvgMap};
