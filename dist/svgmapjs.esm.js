let e=class{static setting="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEVrZXIAAABXsNZ8AAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAuSURBVAjXY2BsYBDyYNAKYXBRYlBgYRDsYEhyY2hRBCEgA8gFCgKlgAqAyhgbALVHB5MYHdneAAAAAElFTkSuQmCC";static xcursor="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPAgMAAABGuH3ZAAAACVBMVEVlAGsAAAC6AADU707yAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAhSURBVAjXY2BgdWBgYGDDQYSGhYYwZK1atQTCwqkOZAoANmIIUX/U/KkAAAAASUVORK5CYII=";static hamburger="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEVlAGRCQkJgmRPnAAAAAXRSTlMAQObYZgAAABJJREFUCNdjYAAD+z8gBAe4uQCvKQdj5EQSJQAAAABJRU5ErkJggg==";static slenderHamburger="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAALCAYAAABYpyyrAAAABmJLR0QAAAAAAAD5Q7t/AAAAH0lEQVQI12NgYGBgcHJy+u/k5PSfgYGBgYmBPEB/MwCR6QqlzLBxYAAAAABJRU5ErkJggg==";static hamburgerEdit="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAACVBMVEVkAFb/AABCQkIPrhq8AAAAAXRSTlMAQObYZgAAACJJREFUCNdjYIADrlWrFkAINIApEQLEjKFAsZVQAirGwAAA4sIMW9pBuDwAAAAASUVORK5CYII=";static UTpng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAARElEQVQoU2NkIAEwkqCWAaviUIaD/1cz2GPIYQiAFMJsQ9eAohhZITYNcMXYFKJrACvGpxBZAyMxCmEaKA86XGFPkskAu/sRITlJWQUAAAAASUVORK5CYII=";static DTpng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAARklEQVQoU2NkIAEwkqCWgTTFoQwH/xNrOthkYjSsZrBnhDsDnwaQQpChKG7GpgGmEEMxupOQFWJVDNOArhCnYlyhQ1I4AwDsgxEhKAdQXgAAAABJRU5ErkJggg==";static RTpng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAAQUlEQVQoU2NkQAKhDAf/r2awZ0QWQ2ajSIAUgyRxacCqGJcGnIqxacCrGF0DQcXIGggqRvYsddyMLfgoC2d8MQgAdTkhDCcGd3MAAAAASUVORK5CYII=";static hiddenIcon="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAASZJREFUWEfFl1EOhCAMROUq3v9MJBzErGETNl1sO1ME9RftPIa21LS9/KRV+vu+f1rsnLOpswRAileIVwE88Qo33QHW+nY8UwEi1i8HQNYPA/S71KqIFadzgBGVINMAosKy5NhkVJPQEm47Q+sVhE3IC4AWXFrqudJbj2JdcqD/4DiOrZTyg2TE6zsIWK6bwZndaL2+QaLv2/oXgDkvdvfeBaTpJEZcg+yFRuPcAvDO2uoFPeitI/DKUgNQj6BZiSy01kd6gmxYf33Aq1urs6FaR+tUI+ovHMZ6xhn3MmICaK4w38kNuQOJlxeRi2p4Jowm3siVTDuA+juafq3x3wRAZTnrf4KaByITThQMAqwUV8vwKevVqfhpcXciWm398H9BNMnQ+yeIGgX6F5mSfAAAAABJRU5ErkJggg==";static visibleIcon="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAORJREFUWEftlkkOwyAMRWHLCVhz/zOx5gRsU1GJijgePokqWoku6+E/bGzi3eKfX6zvNsCuwP9VIKV0aJOTc546FORsiUpACIwKcFeYAmkgLIAk3BNpdiuWwl0AuATjCayqWL60GicAmrzW6kopHx9LvJ9uBkJMTklRcQ6i/Ufje/43gGQc+/UUQNLxiDgXbL2i0s2neusBlregl9JqxZM7oI22OoYNzhop7i5YMaP9a4sI3YjiWzC7bpE1zVXrNx8jShpjPEII1uif7MhT3AKg7wGqjPYXIb4FgCRGfTbArsCuwAsNAKXrcdSFWgAAAABJRU5ErkJggg=="},t=class{static EMBEDSVG=0;static BITIMAGE=1;static POI=2;static VECTOR2D=3;static GROUP=4;static TEXT=5;static NONE=-1;static PATH=0;static POLYLINE=1;static POLYGON=2;static RECT=3;static CIRCLE=4;static ELLIPSE=5;static HYPERLINK=10;static SYMBOL=11;static USEDPOI=12;static DIRECTPOI=13;static SVG2EMBED=100;static EXIST=1;static CLICKABLE=2;static ns_svg="http://www.w3.org/2000/svg"};class i{static trim(e){return e.replace(/^\s+|\s+$/g,"")}static compressSpaces(e){return e.replace(/[\s\r\t\n]+/gm," ")}static numberFormat(e,t){t||(t=7);var i=Math.pow(10,t);return Math.round(e*i)/i}static MouseWheelListenerFunc(e){e.stopPropagation()}static getHyperLink(e){for(var t=e;t.parentNode;)if("a"==(t=t.parentNode).nodeName&&t.getAttribute("xlink:href"))return{href:t.getAttribute("xlink:href"),target:t.getAttribute("target")};return null}static addCommonQueryAtQueryString(e,t){var i=e;return i.lastIndexOf("?")>0?i+="&":i+="?",i+=t}static getElementByIdUsingQuerySelector(e){return this.querySelector('[id="'+e+'"]')}static getUrlHash(e){if(e.indexOf("#")>=0){var t=e.substring(e.indexOf("#")+1);t=t.split("&");for(var i=0;i<t.length;i++){if(t[i].indexOf("=")>0)t[i]=[t[i].substring(0,t[i].indexOf("=")),t[i].substring(t[i].indexOf("=")+1)];else if(t[i].indexOf("(")>0){var s=t[i].substring(0,t[i].indexOf("(")),r=t[i].substring(t[i].indexOf("(")+1,t[i].length-1);t[i]=[s,r]}t[t[i][0]]=t[i][1]}return t}return null}static getFragmentView(e){if(!(e.indexOf("svgView")>=0&&e.indexOf("viewBox")>=0))return null;var t=e.substring(e.indexOf("viewBox"));t=(t=t.substring(t.indexOf("(")+1,t.indexOf(")"))).split(",");try{return 5==t.length?{global:!0,x:Number(t[1]),y:Number(t[2]),width:Number(t[3]),height:Number(t[4])}:4==t.length?{global:!1,x:Number(t[0]),y:Number(t[1]),width:Number(t[2]),height:Number(t[3])}:null}catch(e){return null}}static getImageURL(e,t){return 0==e.lastIndexOf("http://",0)||0==e.lastIndexOf("https://",0)||0==e.lastIndexOf("data:",0)||0==e.lastIndexOf("blob:",0)||0==e.indexOf("/")?e:t+e}static getSvgLocation(e){var t="",i="",s=e;if(s.indexOf("#")>0){const e=s.indexOf("#");t=s.substring(e),s=s.substring(0,e)}if(s.indexOf("?")>0){const e=s.indexOf("?");i=s.substring(e),s=s.substring(0,e)}return{protocol:location.protocol,host:location.host,hostname:location.hostname,port:location.port,pathname:s,search:i,hash:t}}static getSvgReq(e){var t=i.getSvgLocation(e);return t.pathname+t.search}static numberFormat(e,t){t||(t=7);var i=Math.pow(10,t);return Math.round(e*i)/i}static escape(e){return e=(e=(e=(e=(e=e.replace(/&/g,"&amp;")).replace(/"/g,"&quot;")).replace(/'/g,"&#039;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")}static round(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i}static getNoCacheRequest(e){var t=e;return t.lastIndexOf("?")>0?t+="&":t+="?",t+="unixTime="+(new Date).getTime()}static getDocDir(e){var t=e.replace(/#.*/g,"");return(t=t.replace(/\?.*/,"")).substring(0,t.lastIndexOf("/")+1)}static inZoomRange(e,t,i){return!e||!e.minZoom&&!e.maxZoom||!(e.minZoom&&t*i<e.minZoom)&&!(e.maxZoom&&t*i>e.maxZoom)}static isVisible(e){return!!e.visible}static isIntersect(e,t){var i,s;return i=e.nonScaling?{x:e.x,y:e.y,width:0,height:0}:e,s=t.nonScaling?{x:t.x,y:t.y,width:0,height:0}:t,!(i.x>s.x+s.width||s.x>i.x+i.width||i.y>s.y+s.height||s.y>i.y+i.height)}static getBBox(e,t,i,s){return{x:e,y:t,width:i,height:s}}static getElementsByDualTagName(e,t,i){return Array.prototype.slice.call(e.getElementsByTagName(t)).concat(Array.prototype.slice.call(e.getElementsByTagName(i)))}static getElementByIdNoNS(e,t){return this.getElementByAttr(e,t,"id")}static getElementByImgIdNoNS(e,t){return this.getElementByAttr(e,t,"iid")}static getElementByAttr(e,t,i){return e&&e.hasChildNodes()?e.querySelector("["+i+'="'+t+'"]'):null}static getControllerSrc(e,t){var i=e.match(/data-controller-src[\s\S]*?"([\s\S]*?)"/)[1];return i=(i=i.replace(/&amp;/g,"&")).replace(/&quot;/g,'"'),t.controller={src:i},e.replace(/data-controller-src[\s\S]*?"[\s\S]*?"/,"")}static getSvgScript(e,t){var i=e.match(/<script>([\s\S]*)<\/script>/)[1];return i=(i=(i=(i=i.replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&amp;/g,"&")).replace(/&quot;/g,'"'),t.svgScript=i,e.replace(/<script>[\s\S]*<\/script>/,"")}static getSymbolProps(e){return{type:"symbol",id:e.getAttribute("id"),path:e.getAttribute("xlink:href"),offsetX:Number(e.getAttribute("x")),offsetY:Number(e.getAttribute("y")),width:Number(e.getAttribute("width")),height:Number(e.getAttribute("height"))}}static getGraphicsGroupSymbol(e){return{type:"group",id:e.getAttribute("id"),node:e}}static getPathSymbolMakerProps(e){var t=e.getAttribute("d");return{type:"marker",id:e.getAttribute("id"),d:t}}static getrootViewBoxFromRootSVG(e,t,i){var s,r,a,o;return i?e:(e?t.height/t.width>e.height/e.width?(a=e.width,o=e.width*t.height/t.width,s=e.x,r=e.y+e.height/2-o/2):(o=e.height,a=e.height*t.width/t.height,r=e.y,s=e.x+e.width/2-a/2):(s=0,r=0,a=t.width,o=t.height),{x:s,y:r,width:a,height:o})}static getRefresh(e){var t=new Array;t.timeout=-1,t.url="",t.start=!1,t.loadScript=!1;for(var i=e.getElementsByTagName("meta"),s=0;s<i.length;s++)if(i[s].getAttribute("http-equiv")&&"refresh"==i[s].getAttribute("http-equiv")&&i[s].getAttribute("content")){var r=i[s].getAttribute("content").split(";");t.timeout=Number(r[0]),t.loadScript=!0,r[1]&&(t.url=refs[1]);break}return t}static getMetaSchema(e){return e.documentElement.getAttribute("property")}static parseTransformMatrix(e){var t=null;if(e){var i=e.replace("matrix(","").replace(")","").split(",");6==i.length&&(t={a:Number(i[0]),b:Number(i[1]),c:Number(i[2]),d:Number(i[3]),e:Number(i[4]),f:Number(i[5])})}return t}static getNonScalingOffset(e){return this.parseNonScalingOffset(e.getAttribute("transform"))}static parseNonScalingOffset(e){try{var t=e.replace("ref(svg,","").replace(")","").split(","),i=Number(t[0]),s=Number(t[1]);return isNaN(i)||isNaN(s)?{x:null,y:null,nonScaling:!1}:{x:Number(t[0]),y:Number(t[1]),nonScaling:!0}}catch(e){return{x:null,y:null,nonScaling:!1}}}static getDocumentId(e){return e.ownerDocument.documentElement.getAttribute("about")}static getImageProps=function(e,s,r,a,o){var n,l,h,g,d,c,p,u,m,y,v,f,b,I=!1;v=0,f=0;var P,S,x=!1,M=null,w=null;if(a||s!=t.POI||(a=t.USEDPOI),s==t.EMBEDSVG||s==t.BITIMAGE||a==t.DIRECTPOI){if(s==t.EMBEDSVG&&a==t.SVG2EMBED){(u=e.getAttribute("src")).indexOf("globe",u.lastIndexOf("#")),e.getAttribute("postpone");var C=e.getAttribute("clip").replace(/rect\(|\)/g,"").replace(/\s*,\s*|\s+/,",").split(",");C&&4==C.length?(n=Number(C[0]),l=Number(C[1]),h=Number(C[2]),g=Number(C[3])):(n=-3e4,l=-3e4,h=6e4,g=6e4)}else{(A=i.getNonScalingOffset(e)).nonScaling?(I=!0,n=A.x,l=A.y,e.getAttribute("x")&&(v=Number(e.getAttribute("x"))),e.getAttribute("y")&&(f=Number(e.getAttribute("y")))):(n=Number(e.getAttribute("x")),l=Number(e.getAttribute("y")),m=i.parseTransformMatrix(e.getAttribute("transform"))),h=Number(e.getAttribute("width")),g=Number(e.getAttribute("height")),(u=e.getAttribute("xlink:href"))||(u=e.getAttribute("href")),u||(u=""),u.indexOf("#")>0&&u.indexOf("xywh=",u.indexOf("#"))>0&&(b=u.substring(5+u.indexOf("xywh=",u.indexOf("#"))),u=u.substring(0,u.indexOf("#"))),""==(w=e.getAttribute("crossorigin"))&&(w="anonymous"),o&&(s!=t.BITIMAGE||I?a==t.DIRECTPOI&&o.setPoint(n,l):o.setCoverage(n,l,h,g,m,u)),a==t.DIRECTPOI&&(d=e.getAttribute("content"),c=e.getAttribute("xlink:title"))}if(p=e.getAttribute("class"),s==t.BITIMAGE&&(e.getAttribute("style")&&e.getAttribute("style").indexOf("image-rendering:pixelated")>=0||r&&r["image-rendering"]&&"pixelated"==r["image-rendering"])&&(x=!0),(s==t.BITIMAGE||s==t.EMBEDSVG)&&e.getAttribute("style")&&e.getAttribute("style").indexOf("filter")>=0){var L=e.getAttribute("style")+";";M=L=(L=L.substring(L.indexOf("filter:"))).substring(7,L.indexOf(";"))}}else if(a==t.USEDPOI){(A=i.getNonScalingOffset(e)).nonScaling?(I=!0,n=A.x,l=A.y,e.getAttribute("x")&&(v=Number(e.getAttribute("x"))),e.getAttribute("y")&&(f=Number(e.getAttribute("y")))):(I=!1,n=Number(e.getAttribute("x")),l=Number(e.getAttribute("y"))),h=0,g=0,d=e.getAttribute("content"),c=e.getAttribute("xlink:title"),u=e.getAttribute("xlink:href"),o&&o.setPoint(n,l)}else if(s==t.TEXT){var A;(A=i.getNonScalingOffset(e)).nonScaling?(I=!0,n=A.x,l=A.y,e.getAttribute("x")&&(v=Number(e.getAttribute("x"))),e.getAttribute("y")&&(f=Number(e.getAttribute("y")))):(I=!1,n=Number(e.getAttribute("x")),l=Number(e.getAttribute("y"))),g=16,e.getAttribute("font-size")&&(g=Number(e.getAttribute("font-size"))),I&&(g=0),h=g,y=e.textContent}e.getAttribute("visibleMinZoom")?P=Number(e.getAttribute("visibleMinZoom"))/100:r&&r.minZoom&&(P=r.minZoom),e.getAttribute("visibleMaxZoom")?S=Number(e.getAttribute("visibleMaxZoom"))/100:r&&r.maxZoom&&(S=r.maxZoom);var E=!0;"hidden"!=e.getAttribute("visibility")&&"none"!=e.getAttribute("display")||(E=!1);var T=Number(e.getAttribute("opacity"));return(T>1||T<0)&&(T=1),{x:n,y:l,width:h,height:g,href:u,opacity:T,minZoom:P,maxZoom:S,metadata:d,title:c,visible:E,elemClass:p,transform:m,text:y,cdx:v,cdy:f,nonScaling:I,href_fragment:b,pixelated:x,imageFilter:M,crossorigin:w,commonQuery:e.getAttribute("commonQuery")}}.bind(this);static getSymbols(e){for(var t=new Array,s=e.getElementsByTagName("defs"),r=0;r<s.length;r++){var a=s[r];if(a.hasChildNodes)for(var o=a.childNodes,n=0;n<o.length;n++){if("image"==o[n].nodeName)t["#"+(h=i.getSymbolProps(o[n])).id]=h;else if("g"==o[n].nodeName){if(o[n].hasChildNodes)for(var l=0;l<o[n].childNodes.length;l++)if(1==o[n].childNodes[l].nodeType){if("image"==o[n].childNodes[l].nodeName){(h=i.getSymbolProps(o[n].childNodes[l])).id||(h.id=o[n].getAttribute("id")),t["#"+h.id]=h;break}t["#"+(h=i.getGraphicsGroupSymbol(o[n])).id]=h;break}}else if("marker"==o[n].nodeName&&o[n].hasChildNodes)for(l=0;l<o[n].childNodes.length;l++)if("path"==o[n].childNodes[l].nodeName){var h;t["#"+(h=i.getPathSymbolMakerProps(o[n].childNodes[l])).id]=h;break}}}return t}static addEvent(e,t,i){e.addEventListener(t,i,!1)}static getCanvasSize(){var e=window.innerWidth,t=window.innerHeight;return e||(e=document.documentElement.clientWidth,t=document.documentElement.clientHeight),{width:e,height:t,x:0,y:0}}static urlChanged(e,t){var i=new URL(e,location),s=new URL(t,location),r=!1;i.pathanme==s.pathname&&(r=!0);var a=void 0,o=void 0;return r||(a=i.hash!=s.hash,o=i.search!=s.search),{path:r,hash:a,search:o}}static getPathWithoutHash(e){const t=e.indexOf("#");return-1==t?e:e.substring(0,t)}}class s{#e;constructor(e){this.#e=e}openCustomizerUI(e){var t=this.getLayerStyles(e);console.log(t);let i=document.createElement("div");i.innerHTML=this.uiSrc.replaceAll("layerStyleCustom_saturateValue",this.saturateTransform(t.saturate,!0)).replaceAll("layerStyleCustom_invertValue",t.invert).replaceAll("layerStyleCustom_hueRotateValue",t["hue-rotate"]).replaceAll("layerStyleCustom_opacityValue",100*t.opacity).replaceAll("layerStyleCustom_colorizeValue",t.colorize?"checked":""),svgMap.showModal(i);const s=this.getUiElements(i);console.log(s);const r=this.getStyleParamsFromUi(s);this.setStyle(e,s,r.gv,r.iv,r.hv,r.ov,r.cv),this.setUiEventHandlers(e,s,i)}getUiElements(e){console.log(e);var t=e.querySelector("#layerStyleCustom_saturateInput");console.log(t);return{gi:e.querySelector("#layerStyleCustom_saturateInput"),gt:e.querySelector("#layerStyleCustom_saturateText"),ii:e.querySelector("#layerStyleCustom_invertInput"),it:e.querySelector("#layerStyleCustom_invertText"),hi:e.querySelector("#layerStyleCustom_hueRotateInput"),ht:e.querySelector("#layerStyleCustom_hueRotateText"),oi:e.querySelector("#layerStyleCustom_opacityInput"),ot:e.querySelector("#layerStyleCustom_opacityText"),ci:e.querySelector("#layerStyleCustom_colorizeInput"),ct:e.querySelector("#layerStyleCustom_colorizeText"),nb:e.querySelector("#layerStyleCustom_normal"),mb:e.querySelector("#layerStyleCustom_mono"),ib:e.querySelector("#layerStyleCustom_monoInv"),db:e.querySelector("#layerStyleCustom_dark")}}saturateTransform(e,t){return e<=100?e:t?Math.round(50*Math.log10(e)):Math.round(Math.pow(10,e/50))}getStyleParamsFromUi(e){return{gv:this.saturateTransform(e.gi.value),iv:e.ii.value,hv:e.hi.value,ov:e.oi.value,cv:e.ci.checked}}setStyle(e,t,i,s,r,a,o){let n;console.log("g:",i," i:",s," h:",r," o:",a," c:",o),t.gt.innerText=`${i}%`,t.it.innerText=`${s}%`,t.ht.innerText=`${r}deg.`,t.gi.value=this.saturateTransform(i,!0),t.ii.value=s,t.hi.value=r,t.ci.checked=!!o,null!=a&&(t.ot.innerText=`${a}%`,t.oi.value=a,n=""+a/100);let l=document.querySelector(`#mapcanvas #${e}`),h="";s>0&&(h+=`invert(${s}%) `),o&&(h+="sepia(100%) "),r>0&&(h+=`hue-rotate(${r}deg) `),100!=i&&(h+=`saturate(${i}%) `),l&&(l.style.filter=h,null!=n&&(l.style.opacity=n));let g=this.#e.getSvgImages().root.querySelector(`animation[iid="${e}"]`);g&&(g.setAttribute("style",`filter:${h}`),null!=n&&g.setAttribute("opacity",n))}setUiEventHandlers(e,t,i){t.gi.addEventListener("input",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);this.setStyle(e,t,s.gv,s.iv,s.hv,s.ov,s.cv)},!1),t.ii.addEventListener("input",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);this.setStyle(e,t,s.gv,s.iv,s.hv,s.ov,s.cv)},!1),t.hi.addEventListener("input",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);this.setStyle(e,t,s.gv,s.iv,s.hv,s.ov,s.cv)},!1),t.oi.addEventListener("input",()=>{const i=this.getStyleParamsFromUi(t);this.setStyle(e,t,i.gv,i.iv,i.hv,i.ov,i.cv)},!1),t.ci.addEventListener("change",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);s.cv?this.setStyle(e,t,2e3,35,s.hv,s.ov,s.cv):this.setStyle(e,t,100,0,s.hv,s.ov,s.cv)},!1),t.nb.addEventListener("click",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);this.setStyle(e,t,100,0,0,s.ov)},!1),t.mb.addEventListener("click",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);this.setStyle(e,t,0,0,0,s.ov,s.cv)},!1),t.ib.addEventListener("click",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);this.setStyle(e,t,0,100,0,s.ov,s.cv)},!1),t.db.addEventListener("click",()=>{this.checkFirstTime(i);const s=this.getStyleParamsFromUi(t);this.setStyle(e,t,100,100,180,s.ov,s.cv)},!1)}CustomizerUiCallBack(e,t){let i=document.querySelector(`#mapcanvas #${t}`);console.log("Layer Style Customizer UI CallBack : ",t,i.style.filter)}getLayerStyles(e){let t=document.querySelector(`#mapcanvas #${e}`),i=1;t.style.opacity&&(i=Number(t.style.opacity));const s=window.getComputedStyle(t);console.log(e,t,s);const r=s.filter;console.log("filterValue:",r);const a={opacity:i};if("none"!==r){r.match(/(\w+-?\w*)\(([^)]+)\)/g).forEach(e=>{const[t,i]=e.split("(");a[t.trim()]=parseFloat(i)})}return null==a.invert?a.invert=0:a.invert=100*a.invert,null==a.saturate?a.saturate=100:a.saturate=100*a.saturate,null==a["hue-rotate"]&&(a["hue-rotate"]=0),null==a.sepia?a.colorize=!1:a.colorize=!0,a}firstTimeFilterApplied=!0;checkFirstTime(e){if(0==this.firstTimeFilterApplied)return;this.firstTimeFilterApplied=!1;const t=e.querySelector("#svgMapLayerStyleCustomizerUiTable"),i=document.createElement("tr");i.innerHTML='<td colspan="3" style="font-size:12px;background-color:#eee;">Note:レイヤの色を変更した場合、凡例やラスタGISの色と表示色が一致しなくなります。これらを利用する場合は解除してください</td>',t.appendChild(i),setTimeout(()=>{i.remove()},1e4)}uiSrc='\n\t<table style="width:250px;border:none;border-collapse: collapse;font-size:12px;" id="svgMapLayerStyleCustomizerUiTable">\n\t<tr style="background-color:#ccf"><td>不透明度</td><td style="width:120px"><input id="layerStyleCustom_opacityInput" type="range" min="0" max="100" value="layerStyleCustom_opacityValue" step="1" style="width:120px"/></td><td style="width:60px" id="layerStyleCustom_opacityText"></td></tr>\n\t<tr style="background-color:#eee"><td>彩度</td><td><input id="layerStyleCustom_saturateInput" type="range" min="0" max="200" value="layerStyleCustom_saturateValue" step="1" style="width:120px"/></td><td id="layerStyleCustom_saturateText"></td></tr>\n\t<tr style="background-color:#eee"><td>色相反転</td><td><input id="layerStyleCustom_invertInput" type="range" min="0" max="100" value="layerStyleCustom_invertValue" step="1" style="width:120px"/></td><td id="layerStyleCustom_invertText"></td></tr>\n\t<tr style="background-color:#eee"><td>色相回転</td><td><input id="layerStyleCustom_hueRotateInput" type="range" min="0" max="360" value="layerStyleCustom_hueRotateValue" step="1" style="width:120px"/></td><td id="layerStyleCustom_hueRotateText"></td></tr>\n<tr style="background-color:#eee"><td><label for="layerStyleCustom_colorizeInput">着色</label></td><td><input id="layerStyleCustom_colorizeInput" type="checkbox" layerStyleCustom_colorizeValue /></td><td id="layerStyleCustom_colorizeText"></td></tr>\n\t<tr style="background-color:#eee"><td></td><td colspan=2><input type="button" id="layerStyleCustom_normal" value="解除"/></td></tr>\n\t<tr style="background-color:#eee"><td></td><td colspan=2><input type="button" id="layerStyleCustom_mono" value="モノクロ化" /></td></tr>\n\t<tr style="background-color:#eee"><td></td><td colspan=2><input type="button" id="layerStyleCustom_monoInv" value="モノクロ反転"/></td></tr>\n\t<tr style="background-color:#eee"><td></td><td colspan=2><input type="button" id="layerStyleCustom_dark" value="ダーク"/></td></tr>\n\t</table>'}class r{#t="layerList";#i;#s;#r;#a;#o;#n;#l;#h;#g;#d;#c="Layer List: ";#p=" layers visible";#u;constructor(e,t){this.#o=e,e.registLayerUiSetter(function(e){this.#m(e)}.bind(this),function(){this.#y()}.bind(this)),this.#n=t,this.#u=new s(e)}#y(){var e=document.getElementById("layerTable"),t=this.#o.getRootLayersProps();if(e){var i=this.#s.scrollTop;this.#v(e),this.#f(e,t),this.#s.scrollTop=i}this.#n.updateLayerSpecificWebAppHandler()}#b(){this.#i.style.height==this.#d+"px"?this.#I(!0):this.#I(!1)}#I(t){var i=document.getElementById("layerListOpenButton");const s=document.getElementById("svgMapHiddenFilterButton");this.#s=document.getElementById("layerTableDiv"),t&&this.#i.style.height==this.#d+"px"?(this.#y(),this.#i.style.height=this.#h,i.firstChild.src=e.UTpng,this.#s.style.display="",this.#r=!0,s&&(s.style.visibility="visible")):t||this.#i.style.height==this.#d+"px"||(this.#i.style.height=this.#d+"px",i.firstChild.src=e.DTpng,this.#s.style.display="none",this.#r=!1,s&&(s.style.visibility="hidden"))}#P(e){var t;return this.#a[e]?t=this.#a[e]:(t=!1,this.#a[e]=t),t}#f(e,t){var i,s=new Object,r=0,a=[];for(var o=(i=i?t:this.#o.getRootLayersProps()).length-1;o>=0;o--)if(!this.#S.hiddenFilter||i[o].visible){var n=this.#x(i[o].title,i[o].id,i[o].visible,!1,i[o].groupName);if(i[o].groupName){var l=this.#P(i[o].groupName);if(s[i[o].groupName]){var h=s[i[o].groupName];l||e.insertBefore(n,h.nextSibling),s[i[o].groupName]=n}else{var g=this.#M(i[o],l);e.appendChild(g),s[i[o].groupName]=n,l||e.appendChild(n)}i[o].visible&&this.#w(i[o].groupName)}else e.appendChild(n);i[o].visible&&(++r<=5?a.push(i[o].title):6==r&&a.push("..."))}document.getElementById("layerListmessage").innerHTML=this.#c+r+this.#p,document.getElementById("layerListmessage").title=a,window.setTimeout(function(){this.#C()}.bind(this),30)}#L(e,t){this.#c=e,this.#p=t}#C(){var e=document.getElementById("layerTable").offsetHeight;0!=e&&(e<this.#g-this.#d-2?this.#i.style.height=e+this.#d+2+"px":this.#i.style.height=this.#h)}#w(e){var t=document.getElementById("gc_"+e).childNodes.item(0),i=Number(t.nodeValue)+1;t.nodeValue=i}#x(e,t,i,s,r){var a=document.createElement("tr");a.id="layerList_"+t,r?(a.dataset.group=r,a.className="layerItem"):a.className="layerItem noGroup";var o="cb_"+t,n=document.createElement("td"),l=document.createElement("input");l.className="layerCheck",l.type="checkBox",l.id=o,i&&(l.checked=!0,a.style.fontWeight="bold"),l.addEventListener("change",function(e){this.#A(e)}.bind(this)),n.appendChild(l),a.appendChild(n);var h=document.createElement("td");h.setAttribute("colspan","3"),h.style.overflow="hidden";var g=document.createElement("label");g.title=e,g.setAttribute("for",o),g.className="layerLabel",g.innerHTML=e,h.appendChild(g),a.appendChild(h);var d=document.createElement("td");return this.#S.styleController&&this.#E(d,i,t),this.#T(d,i,s,t),a.appendChild(d),a}#T(t,i,s,r){var a="bt_"+r,o=document.createElement("button");o.innerHTML="<img style='pointer-events: none;' src='"+e.RTpng+"'>",o.className="layerUiButton",o.id=a,o.addEventListener("click",function(e){var t=this.#O(e);this.#n.showLayerSpecificUI(t)}.bind(this),!1),o.disabled=!i,s||(o.style.visibility="hidden"),t.appendChild(o)}#E(t,i,s){var r="lscBt_"+s,a=document.createElement("img");a.src=e.slenderHamburger,a.className="layerStyleCustomizerUiButton",a.id=r,a.style.verticalAlign="middle",a.style.padding="3px 5px",a.style.cursor="pointer",a.addEventListener("click",function(e){console.log("レイヤスタイルカスタマイザを起動するイベントが出ました : id:",s),this.#u.openCustomizerUI(s)}.bind(this),!1),a.addEventListener("mouseover",()=>{a.style.backgroundColor="#ddd"}),a.addEventListener("mouseout",()=>{a.style.backgroundColor=""}),i?a.disabled=!1:(a.disabled=!0,a.style.visibility="hidden"),t.appendChild(a)}#k(e){var t=document.getElementById("bt_"+e);t?t.style.visibility="visible":console.log("Could not find launcher button: setLayerSpecificWebAppLaunchUiEnable:",e)}#M(t,i){var s=document.createElement("tr");s.dataset.group=t.groupName,s.className="groupItem",s.style.width="100%",s.id="gtr_"+t.groupName;var r=document.createElement("td");r.style.fontWeight="bold",r.setAttribute("colspan","3"),r.className="groupLabel",r.style.overflow="hidden";var a=document.createElement("label");a.title=t.groupName;var o="gb_"+t.groupName;a.setAttribute("for",o);var n=document.createTextNode("["+t.groupName+"]");a.appendChild(n),r.appendChild(a);var l=document.createElement("td");l.className="groupLabel",l.align="right";var h=document.createElement("label");h.id="gc_"+t.groupName,h.setAttribute("for",o);var g=document.createTextNode("0");h.appendChild(g),l.appendChild(h);var d="";if("batch"==t.groupFeature){r.setAttribute("colspan","2");var c=document.createElement("td");d="ba_"+t.groupName;var p=document.createElement("input");p.type="checkBox",p.id=d,p.addEventListener("change",function(e){this.#R(e)}.bind(this),!1),c.appendChild(p),t.visible&&(p.checked="true"),s.appendChild(r),s.appendChild(l),s.appendChild(c)}else s.appendChild(r),s.appendChild(l);var u=document.createElement("td"),m=document.createElement("button");return m.id=o,m.addEventListener("click",function(e){this.#B(e)}.bind(this),!1),m.innerHTML=i?"<img style='pointer-events: none;' src='"+e.DTpng+"'>":"<img style='pointer-events: none;' src='"+e.UTpng+"'>",u.appendChild(m),s.appendChild(u),s}#v(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t]);e.appendChild(this.#V())}#O(e){return e.target.id.substring(3)}#A(e){var t=this.#O(e);this.#o.setRootLayersProps(t,e.target.checked,!1),this.#o.refreshScreen()}#R(e){for(var t=this.#O(e),i=this.#o.getSwLayers("batch"),s="hidden",r=0;r<i[t].length;r++)if("hidden"==i[t][r].getAttribute("visibility")){s="visible";break}for(r=0;r<i[t].length;r++)i[t][r].setAttribute("visibility",s);this.#y(),this.#o.refreshScreen()}#S={};#m(e){var t;this.#a=new Object,this.#i=document.getElementById(this.#t),this.#i&&(null!=this.#i.getAttribute("data-fixed")&&(this.#S.fixed=!0),null!=this.#i.getAttribute("data-opened")&&(this.#S.initOpen=!0),null!=this.#i.getAttribute("data-layerstylecontroller")&&(this.#S.styleController=!0),null!=this.#i.getAttribute("data-hiddenfilter")&&(this.#S.hiddenFilterUI=!0),null!=this.#i.getAttribute("data-customizer")&&(this.#S.layersCustomizerPath=this.#i.getAttribute("data-customizer")),this.#G(),(t=document.createElement("div")).id="layerListUiTopDiv",this.#S.hiddenFilterUI&&this.#N(t),this.#D(t),this.#U(t),this.#S.layersCustomizerPath&&this.#F(t),this.#i.appendChild(t),this.#H()),window.setTimeout(function(e){this.#z(e),this.#S.fixed?this.#j():this.#S.initOpen&&this.#I(!0)}.bind(this),30,t)}#j(){this.#I(!0);var e=document.getElementById("layerListOpenButton");e.disabled=!0,e.style.display="none",document.getElementById("layersCustomizerImageButton").style.right="5px"}#G(){this.#i.addEventListener("wheel",function(e){i.MouseWheelListenerFunc(e)}.bind(this),!1),this.#i.addEventListener("mousewheel",function(e){i.MouseWheelListenerFunc(e)}.bind(this),!1),this.#i.addEventListener("DOMMouseScroll",function(e){i.MouseWheelListenerFunc(e)}.bind(this),!1),this.#i.style.zIndex="20",this.#h=this.#i.style.height}#D(e){var t=this.#o.getRootLayersProps(),i=0,s=[];for(var r=t.length-1;r>=0;r--)t[r].visible&&(++i<=5?s.push(t[r].title):6==i&&s.push("..."));var a=document.createElement("label");a.id="layerListmessage",a.setAttribute("for","layerListOpenButton"),a.setAttribute("title",s),a.innerHTML=this.#c+i+this.#p,e.appendChild(a)}#U(t){var i=document.createElement("button");i.id="layerListOpenButton",i.innerHTML="<img style='pointer-events: none;' src='"+e.DTpng+"'>",i.style.position="absolute",i.style.right="0px",i.addEventListener("click",function(e){this.#b(e)}.bind(this)),t.appendChild(i)}#F(t){var i=this.#S.layersCustomizerPath;if(i){var s=document.createElement("img");s.src=e.hamburger,s.style.position="absolute",s.id="layersCustomizerImageButton",s.style.right="35px",s.style.cursor="pointer",t.appendChild(s),s.addEventListener("click",function(e){this.#l=window.open(i,"layersCustomizer","toolbar=yes,menubar=yes,scrollbars=yes")}.bind(this)),s.addEventListener("mouseover",()=>{s.style.backgroundColor="#ddd"}),s.addEventListener("mouseout",()=>{s.style.backgroundColor=""})}}#H(){var e=document.createElement("div");this.#s=e,e.id="layerTableDiv",e.style.width="100%",e.style.height="100%",e.style.overflowY="scroll",e.style.display="none",this.#i.appendChild(e);var t=document.createElement("table");t.id="layerTable",t.setAttribute("border","0"),t.style.width="100%",t.style.tableLayout="fixed",t.style.whiteSpace="nowrap",t.appendChild(this.#V()),e.appendChild(t)}#z(e){e&&(this.#d=e.offsetHeight,this.#i.offsetHeight<60&&(this.#h="90%"),this.#g=this.#i.offsetHeight,this.#i.style.height=this.#d+"px")}#V(){var e=document.createElement("colgroup"),t=document.createElement("col");t.setAttribute("spanr","1"),t.style.width="22px";var i=document.createElement("col");i.setAttribute("spanr","1");var s=document.createElement("col");s.setAttribute("spanr","1"),s.style.width="22px";var r=document.createElement("col");r.setAttribute("spanr","1"),r.style.width="22px";var a=document.createElement("col");return a.setAttribute("spanr","1"),this.#S.styleController?a.style.width="38px":a.style.width="28px",e.appendChild(t),e.appendChild(i),e.appendChild(s),e.appendChild(r),e.appendChild(a),e}#B(e){var t=this.#O(e);this.#a[t]?this.#a[t]=!1:this.#a[t]=!0,this.#y()}#N(t){const i=document.createElement("img");i.src=e.visibleIcon,i.id="svgMapHiddenFilterButton",i.title="Toggle between showing only the layer currently displayed or all layers",i.style.verticalAlign="middle",i.width=16,i.height=16,i.style.visibility="hidden",i.style.cursor="pointer",i.style.marginRight="4px",i.addEventListener("click",()=>{i.src==e.visibleIcon?(i.src=e.hiddenIcon,this.#W({hidden:!0})):(i.src=e.visibleIcon,this.#W({}))}),i.addEventListener("mouseover",()=>{i.style.backgroundColor="#ddd"}),i.addEventListener("mouseout",()=>{i.style.backgroundColor=""}),t.appendChild(i)}#W(e){e.hidden?this.#S.hiddenFilter=!0:delete this.#S.hiddenFilter,this.#y()}setLayerListmessage(...e){return this.#L(...e)}setLayerSpecificWebAppLaunchUiEnable(...e){return this.#k(...e)}getLayersCustomizer=function(){return this.#l}.bind(this)}class a{#o;#Y;#X;#Z;#q;#_;constructor(e,t){this.#Y=t,this.#o=e,this.#Y&&(this.#X=new this.#Y.io.GeoJSONReader,this.#Z=new this.#Y.io.GeoJSONWriter,this.#q=function(e){if("MultiLineString"==e.type)for(var t=e.coordinates.length-1;t>=0;t--)e.coordinates[t].length<2&&e.coordinates.splice(t,1);else if("Polygon"==e.type)for(t=e.coordinates.length-1;t>=0;t--)e.coordinates[t].length<3&&e.coordinates.splice(t,1);return this.#X.read(e)}.bind(this),this.#_=function(e){return this.#Z.write(e)}.bind(this))}#K(e,t){for(var i=e[0],s=e[1],r=!1,a=0,o=t.length-1;a<t.length;o=a++){var n=t[a][0],l=t[a][1],h=t[o][0],g=t[o][1];l>s!=g>s&&i<(h-n)*(s-l)/(g-l)+n&&(r=!r)}return r}#J(e,t){var i=this.#K(e,t[0]);if(i&&t.length>1)for(var s=1;s<t.length;s++)if(this.#K(e,t[s])){i=!1;break}return i}#Q(e,t,i,s,r,a,o,n){return((e-i)*(a-t)+(t-s)*(e-r))*((e-i)*(n-t)+(t-s)*(e-o))<0&&((r-o)*(t-a)+(a-n)*(r-e))*((r-o)*(s-a)+(a-n)*(r-i))<0}#$(e,t,i,s,r,a,o,n,l){var h={pointsDocTreeID:e,polygonsDocTreeID:t,cbFunc:i,param:s,progrssCallback:r,inverse:a,pointOnly:o,getIncludedPolygonAttr:n},g=e,d=t;console.log("called getIncludedPoints:",g,d),l?(console.log("getIncludedPoints: USE preCapturedGeometry"),this.#ee(l,h)):this.#o.captureGISgeometries(this.#ee,h)}#te(e,t,i,s,r,a){this.#$(e,t,i,s,r,!0,a)}#ie(e){for(var t=6e4,i=6e4,s=-6e4,r=-6e4,a=0;a<e.length;a++)for(var o=0;o<e[a].length;o++)e[a][o][0]<t&&(t=e[a][o][0]),e[a][o][0]>s&&(s=e[a][o][0]),e[a][o][1]<i&&(i=e[a][o][1]),e[a][o][1]>r&&(r=e[a][o][1]);return[(t+s)/2,(i+r)/2]}#se(e,t){var i=t.pointsDocTreeID,s=t.polygonsDocTreeID,r=t.cbFunc,a=t.param;t.progrssCallback;var o=t.inverse;console.log("Searched geom:",e),o&&1==o||(o=!1);for(var n=this.#re(i,s),l=n.childrenId1,h=n.childrenId2,g=0,d=new Array,c=0;c<l.length;c++)if(e[l[c]]){var p=e[l[c]];console.log("poi:",p),g+=p.length;for(var u=0;u<p.length;u++){var m;if("Point"===p[u].type)m=p[u].coordinates;else{if("Polygon"!==p[u].type&&"MultiLineString"!==p[u].type)continue;console.log(p[u]),m=this.#ie(p[u].coordinates)}e:for(var y=0;y<h.length;y++)if(e[h[y]]){var v=e[h[y]];console.log("pol:",v);for(var f=0;f<v.length;f++)if("Polygon"==v[f].type)if(polygon=v[f].coordinates,o){if(this.#J(m,polygon))break e;f==v.length-1&&d.push(p[u])}else if(this.#J(m,polygon)){d.push(p[u]);break e}}}}r(d,g,a)}#ee=function(e,t){console.log("getIncludedPointsS2a called : ",e);var i=this.#re(t.pointsDocTreeID);t.pointsDocTreeIDs=i;var s=this.#re(t.polygonsDocTreeID);t.polygonsDocTreeIDs=s;var r=0;new Array;for(var a=[],o=0;o<i.length;o++)if(e[i[o]]){var n=e[i[o]];r+=n.length;for(var l=0;l<n.length;l++)for(var h=0;h<s.length;h++)if(e[s[h]])for(var g=e[s[h]],d=0;d<g.length;d++)a.push([o,l,h,d])}t.totalPoiCount=r,this.#ae(e,t,a)}.bind(this);#ae(e,t,i,s,r,a){for(s||(r=(new Date).getTime(),a=[],s=0);s<i.length&&0==this.#oe;){var o,n=i[s][0],l=e[t.pointsDocTreeIDs[n]],h=i[s][1];if("Point"===l[h].type)o=l[h].coordinates;else{if(t.pointOnly||"Polygon"!==l[h].type&&"MultiLineString"!==l[h].type){s=this.#ne(i,s),++s;continue}o=this.#ie(l[h].coordinates)}var g=i[s][2],d=e[t.polygonsDocTreeIDs[g]],c=i[s][3];if("Polygon"==d[c].type){var p=d[c].coordinates;if(t.inverse?this.#J(o,p)?s=this.#ne(i,s):c==d.length-1&&(console.log("PUSH"),a.push(l[h])):this.#J(o,p)&&(t.getIncludedPolygonAttr&&(l[h].includedPolygonAttr=d[c].src.getAttribute("content")),a.push(l[h]),s=this.#ne(i,s)),++s,(new Date).getTime()-r>500){console.log("call laze compu",s,i.length,Math.ceil(s/i.length)),t.progrssCallback&&t.progrssCallback(Math.ceil(1e3*s/i.length)/10),r=(new Date).getTime(),setTimeout(getIncludedPointsS3.bind(this),20,e,t,i,s,r,a);break}}else t.inverse&&c==d.length-1&&a.push(l[h]),++s}this.#oe=!1,s==i.length&&(t.progrssCallback&&t.progrssCallback(100),console.log("Completed!",a),t.cbFunc(a,t.totalPoiCount,t.param))}#ne(e,t){for(var i=t,s=e[t][1],r=e[t][0],a=s,o=r;a==s&&o==r&&++i!=e.length;)a=e[i][1],o=e[i][0];return i-1}#le(e,t,i,s,r,a,o,n,l,h,g){return g||(g={}),g.processMode="difference",this.#he(e,t,i,s,r,a,o,n,l,h,g)}#he(e,t,i,s,r,a,o,n,l,h,g){var d="intersection",c="resultGroup",p=1;this.#oe=!1,g?.processMode&&(d=g.processMode),g?.resultGroupId&&(c=g.resultGroupId),g?.opacity&&(p=g.opacity);var u=this.#o.getSvgImages()[i],m=u.getElementById(c);m||((m=u.createElement("g")).setAttribute("id",c),u.documentElement.appendChild(m)),m.setAttribute("opacity",p);var y={sourceId1:e,sourceId2:t,targetId:i,strokeColor:s,strokeWidth:r,fillColor:a,progrssCallback:o,addMetadata:n,getResultAsGeoJsonCallback:l,getResultAsGeoJsonCallbackParam:h,processMode:d,resultGroup:m,areaComp:g?.areaCompare,uniteOptions:{source1:g?.uniteSource1,source2:g?.uniteSource2}};return o&&o(0),this.#o.captureGISgeometriesOption(!1,!0),"intersection"==y.processMode?this.#o.captureGISgeometries(this.#ge,y):"difference"==y.processMode&&this.#o.captureGISgeometries(this.#de,y),m}#ce(e,t){for(var i=0,s=0;s<e.length;s++){var r=t[e[s]];if(r&&r.length>0)for(var a=0;a<r.length;a++){var o=r[a].coordinates;if(o[0].length)for(var n=0;n<o.length;n++)i+=o[n].length;else i+=o.length}}return console.log(i),i}#pe(e,t){var i=this.#o.getSvgImagesProps(),s=[],r=[];for(var a in i)e===i[a].rootLayer?s.push(a):t===i[a].rootLayer&&r.push(a);return{childrenId1:s,childrenId2:r}}#re(e){var t,i=this.#o.getSvgImagesProps();return t=[e],this.#ue(i[e],t,i),t}#ue(e,t,i){if(e)for(var s in e.childImages)t.push(s),this.#ue(i[s],t,i)}#de=function(e,t,i,s,r,a,o,n,l,h){var g=(new Date).getTime(),d=0;if(o)d=s;else{i=0,s=0;var c=this.#o.getSvgImages();this.#o.getSvgImagesProps();var p=this.#re(t.sourceId1),u=this.#re(t.sourceId2);r=[];for(var m=0;m<p.length;m++)e[p[m]]&&(r=r.concat(e[p[m]]));a=[];for(m=0;m<u.length;m++)e[u[m]]&&(a=a.concat(e[u[m]]));o=[],t.metaSchema=this.#me(c[t.sourceId1]),t.areaComp&&t.metaSchema.push("areaRatio")}var y=new this.#Y.geom.PrecisionModel(1e6);e:for(m=i;m<r.length;m++){if(0==d){console.log("Seed feartureA:",r[m]);var v=this.#q(r[m]);try{v=this.#Y.simplify.DouglasPeuckerSimplifier.simplify(v,1e-5),v=this.#Y.precision.GeometryPrecisionReducer.reduce(v,y)}catch(e){continue}t.areaComp&&(h=v.getArea()),n=v,t.addMetadata&&(l=r[m].src.getAttribute("content"))}for(d=s;d<a.length;d++){var f=this.#q(a[d]);try{f=this.#Y.simplify.DouglasPeuckerSimplifier.simplify(f,1e-5),f=this.#Y.precision.GeometryPrecisionReducer.reduce(f,y);var b=n.difference(f);b&&(n=this.#Y.simplify.DouglasPeuckerSimplifier.simplify(b,1e-5),n=this.#Y.precision.GeometryPrecisionReducer.reduce(n,y))}catch(e){continue}if((new Date).getTime()-g>300){t.progrssCallback&&t.progrssCallback(Math.ceil((m*a.length+d)/(a.length*r.length)*1e3)/10);var I=d+1,P=m;if(I==a.length&&(n&&o.push(this.#_(n)),I=0,(P=m+1)==r.length))break e;if(1==this.#oe)break e;return void setTimeout(this.#de.bind(this),20,e,t,P,I,r,a,o,n,l,h)}}if(d=0,s=0,n)try{var S=this.#_(n);this.#ye(S)&&(t.addMetadata&&(S.properties=this.#ve(l,null,t.metaSchema),t.areaComp&&(S.properties.areaRatio=n.getArea()/h)),o.push(S))}catch(e){console.warn("Could not build geoJson skip :",n)}}this.#oe=!1,this.#fe(o,t)}.bind(this);#be(e){var t=[];for(var i of e)if("Polygon"==i.type){var s=this.#X.read(i);t.push(s)}else console.warn("not polygon skip this geometry");var r=(new this.#Y.geom.GeometryFactory).createMultiPolygon(t);return r=r.union(),this.#Z.write(r)}#Ie=function(e,t){console.log("called buildIntersectionS2a:",e,t),this.#o.getSvgImages(),this.#o.getSvgImagesProps();for(var i=this.#re(t.sourceId1),s=this.#re(t.sourceId2),r=[],a=0;a<i.length;a++)e[i[a]]&&(r=r.concat(e[i[a]]));var o=[];for(a=0;a<s.length;a++)e[s[a]]&&(o=o.concat(e[s[a]]));console.log("buffered srcgem1:",r,"  srcgem2:",o);var n,l=this.#q(buildGeoJsonGeometryCollectionFromGeometryArray(r)),h=this.#q(buildGeoJsonGeometryCollectionFromGeometryArray(o)),g=this.#Y.precision.GeometryPrecisionReducer;switch(l=this.#Y.simplify.DouglasPeuckerSimplifier.simplify(l,1e-5),h=this.#Y.simplify.DouglasPeuckerSimplifier.simplify(h,1e-5),console.log("buffered jstsFeature1:",l,"  jstsFeature2:",h),l=g.reduce(l,new this.#Y.geom.PrecisionModel(1e6)),h=g.reduce(h,new this.#Y.geom.PrecisionModel(1e6)),console.log("GeometryPrecisionReducer:",g),t.processMode){case"intersection":default:n=l.intersection(h);break;case"difference":n=l.difference(h);break;case"union":n=l.union(h);break;case"symDifference":n=l.symDifference(h)}var d=this.#_(n);console.log("intersection:",d),t.getResultAsGeoJsonCallback&&(t.getResultAsGeoJsonCallbackParam?t.getResultAsGeoJsonCallback(d,t.getResultAsGeoJsonCallbackParam):t.getResultAsGeoJsonCallback(d)),(t.strokeColor||t.strokeWidth||t.fillColor)&&(this.#Pe(d,t.targetId,t.strokeColor,t.strokeWidth,t.fillColor,"p0","poi",null,t.resultGroup),this.#o.refreshScreen())}.bind(this);#Se(e){for(var t={type:"FeatureCollection",features:[]},i=0;i<e.length;i++){var s={type:"Feature"};s.geometry=e[i],t.features.push(s)}return t}#xe(e){var t={type:"GeometryCollection"};return t.geometries=e,t}#me(e){var t=e.documentElement.getAttribute("property");return t?t.split(","):[]}#ge=function(e,t){console.log("called buildIntersectionS2:",e,t);var i=this.#o.getSvgImages();this.#o.getSvgImagesProps();var s,r,a=this.#re(t.sourceId1),o=this.#re(t.sourceId2);if(t.uniteOptions.source1){for(var n=[],l=0;l<a.length;l++)e[a[l]]&&(n=n.concat(e[a[l]]));if(a=[a[0]],n.length>0){var h=n[0].src;(n=this.#be(n)).src=h,e[a[0]]=[n]}else e[a[0]]=[];console.log("unitedSrc1:",e[a[0]])}if(t.uniteOptions.source2){var g=[];for(l=0;l<o.length;l++)e[o[l]]&&(g=g.concat(e[o[l]]));if(o=[o[0]],g.length>0){h=g[0].src;(g=this.#be(g)).src=h,e[o[0]]=[g]}else e[o[0]]=[];console.log("unitedSrc2:",e[o[0]])}console.log("source1IDs:",a,"\nsource2IDs:",o),i[t.targetId];var d=[];if(this.#ce(a,e)<this.#ce(o,e)){if(s=a,r=o,t.addMetadata){var c=(d=this.#me(i[t.sourceId1])).length,p=(d=d.concat(this.#me(i[t.sourceId2]))).length-c;t.areaComp&&(d.push(`areaRatio1(${0==c?"-":"0-"+(c-1)})`),d.push(`areaRatio2(${0==p?"-":c+"-"+(c+p-1)})`))}t.sourceAlternated=!1}else{if(s=o,r=a,t.addMetadata){c=(d=this.#me(i[t.sourceId2])).length,p=(d=d.concat(this.#me(i[t.sourceId1]))).length-c;t.areaComp&&(d.push(`areaRatio1(${0==p?"-":c+"-"+(c+p-1)})`),d.push(`areaRatio2(${0==c?"-":"0-"+(c-1)})`))}t.sourceAlternated=!0}t.metaSchema=d,console.log("src1IDs:",s,"src2IDs:",r);var u=[];for(l=0;l<s.length;l++){var m=s[l],y=e[m];if(y&&y.length>0)for(var v=0;v<y.length;v++){var f=y[v];if(f){var b=this.#q(f),I={feature:b=this.#Y.simplify.DouglasPeuckerSimplifier.simplify(b,1e-5),docId:m,geomIndex:v};t.areaComp&&(I.area=b.getArea()),u.push(I)}}}console.log("src1Features:",u);for(var P=[],S=0;S<r.length;S++){var x=e[r[S]];if(x&&x.length>0)for(var M=0;M<x.length;M++){if(x[M])for(var w=0;w<u.length;w++)P.push([S,M,w])}}this.#Me(r,u,P,e,t)}.bind(this);#oe=!1;#we(){console.log("HALT..."),this.#oe=!0}#ye(e){var t=!1;if(e.coordinates.length>0&&(t=!0,"Polygon"==e.type)){for(var i=0,s=0;s<e.coordinates.length;s++)i+=e.coordinates[s].length;0==i&&(t=!1)}return t}#Me(e,t,i,s,r,a,o,n,l){for(a||(o=(new Date).getTime(),l=[],a=0);a<i.length&&0==this.#oe;){var h,g=i[a][0],d=i[a][1],c=i[a][2],p=s[e[g]];if(0==c){var u=p[d];n=this.#q(u),n=this.#Y.simplify.DouglasPeuckerSimplifier.simplify(n,1e-5),r.areaComp&&(h=n.getArea())}var m=t[c].feature;try{var y=m.intersection(n);if(y){var v=this.#_(y);if(this.#ye(v)){if(r.addMetadata){var f=t[c].docId,b=t[c].geomIndex,I=s[f][b].src.getAttribute("content"),P=p[d].src.getAttribute("content");v.properties=this.#ve(I,P,r.metaSchema)}if(r.areaComp){var S=y.getArea(),x=S/t[c].area,M=S/h;r.sourceAlternated?(v.properties[r.metaSchema[r.metaSchema.length-1]]=x,v.properties[r.metaSchema[r.metaSchema.length-2]]=M):(v.properties[r.metaSchema[r.metaSchema.length-2]]=x,v.properties[r.metaSchema[r.metaSchema.length-1]]=M)}l.push(v)}}}catch(e){console.error(e)}if(++a,(new Date).getTime()-o>500){r.progrssCallback&&r.progrssCallback(Math.ceil(1e3*a/i.length)/10),o=(new Date).getTime(),setTimeout(this.#Me.bind(this),30,e,t,i,s,r,a,o,n,l);break}}this.#oe=!1,a==i.length&&this.#fe(l,r)}#fe(e,t){t.progrssCallback&&t.progrssCallback(100);var i={};if(t.addMetadata&&(this.#o.getSvgImagesProps(),i.csvMetadataSchema=t.metaSchema.join(",")),i.type="GeometryCollection",i.geometries=e,console.log("svgmapGIS:geoJsonIntersections",i),t.getResultAsGeoJsonCallback&&(t.getResultAsGeoJsonCallbackParam?t.getResultAsGeoJsonCallback(i,t.getResultAsGeoJsonCallbackParam):t.getResultAsGeoJsonCallback(i)),t.strokeColor||t.strokeWidth||t.fillColor){var s=this.#o.getSvgImages()[t.targetId];t.addMetadata&&s.documentElement.setAttribute("property",i.csvMetadataSchema),this.#Pe(i,t.targetId,t.strokeColor,t.strokeWidth,t.fillColor,"p0","poi",null,t.resultGroup,i.csvMetadataSchema.split(","),{multiGeometryGrouping:!0}),this.#o.refreshScreen()}}#ve(e,t,i){var s,r;s=e?e.split(","):[],r=t?t.split(","):[];for(var a=s.concat(r),o={},n=0;n<i.length;n++)o[i[n]]=a[n];return o}#Ce(e,t,i,s,r,a,o,n){n||(n={}),n.targetVectorType=2,this.#Le(e,t,i,s,r,a,o,n)}#Ae(e,t,i,s,r,a,o,n){n||(n={}),n.targetVectorType=1,this.#Le(e,t,i,s,r,a,o,n)}#Ee(e,t,i,s,r,a,o,n){n||(n={}),n.targetVectorType=0,this.#Le(e,t,i,s,r,a,o,n)}#Le(e,t,i,s,r,a,o,n){null==n&&(n={}),null==n.targetVectorType&&(n.targetVectorType=0),n.overlappingCoverage&&"or"==n.overlappingCoverage.toLowerCase()&&(n.splitByCoverage=!0,n.overlappingCoverage="or"),this.#oe=!1;var l={coverageDocTreeID:t,cbFunc:s,param:r,progrssCallback:a,range:this.#Te(i),targetType:n.targetVectorType,computingOptions:n,pixDataBuffer:[]};Array.isArray(e)?(l.points=e,console.log("called getInRangePoints: poi.len,cover:",e.length,t,"  range:",l.range)):(l.pointsDocTreeID=e,console.log("called getInRangePoints: poi,cover:",e,t,"  range:",l.range)),this.#o.captureGISgeometriesOption(!0),o?(console.log("getInRangePoints: USE preCapturedGeometry"),this.#Oe(o,l)):this.#o.captureGISgeometries(this.#Oe,l)}#Te(e){var t={hue:[[0,360]],satulation:[[10,100]],value:[[10,100]],alpha:[[10,100]]};return e&&(e.hue?(t.hue=this.#ke(e.hue),e.satulation&&(t.satulation=this.#ke(e.satulation)),e.value&&(t.value=this.#ke(e.value)),e.alpha&&(t.alpha=this.#ke(e.alpha)),e.outOfBoundsColor&&(t.outOfBoundsColor=e.outOfBoundsColor)):e.length&&e.length>0&&(t.hue=this.#ke(e))),t}#ke(e){var t=[];return null!=e[0][0]?t=e:t[0]=e,console.log("rangeVal:",e,"  normalized nRangeVal:",t),t}#Re(e){for(var t=1e30,i=-1e30,s=1e30,r=-1e30,a=0;a<e.length;a++)if("point"==e[a].type.toLowerCase())e[a].coordinates[0]>i&&(i=e[a].coordinates[0]),e[a].coordinates[0]<t&&(t=e[a].coordinates[0]),e[a].coordinates[1]>r&&(r=e[a].coordinates[1]),e[a].coordinates[1]<s&&(s=e[a].coordinates[1]);else for(var o=0;o<e[a].coordinates.length;o++)for(var n=0;n<e[a].coordinates[o].length;n++){var l=e[a].coordinates[o][n];l[0]>i&&(i=l[0]),l[0]<t&&(t=l[0]),l[1]>r&&(r=l[1]),l[1]<s&&(s=l[1])}return{xmin:t,ymin:s,xmax:i,ymax:r,x:t,y:s,width:i-t,height:r-s}}#Oe=function(e,t){var i=[],s=[];e||console.log("processing conflict?? exit");var r=this.#o.getSvgImagesProps();for(var a in t.points&&(i=t.points),e)if(t.pointsDocTreeID&&r[a].rootLayer==t.pointsDocTreeID)for(var o=0;o<e[a].length;o++)0==t.computingOptions.targetVectorType?"Point"==e[a][o].type&&i.push(e[a][o]):1==t.computingOptions.targetVectorType?"MultiLineString"==e[a][o].type&&i.push(e[a][o]):2==t.computingOptions.targetVectorType&&"Polygon"==e[a][o].type&&i.push(e[a][o]);else if(r[a].rootLayer==t.coverageDocTreeID)for(o=0;o<e[a].length;o++)"Coverage"==e[a][o].type&&s.push(e[a][o]);console.log("targetCoverages:",s,"  targetGeoms.length:",i.length),t.targetGeomsBbox=this.#Re(i),console.log("targetGeomsBbox:",t.targetGeomsBbox),t.targetGeoms=i,t.targetCoverages=s,t.coverageIndex=this.#Be(t.targetCoverages,t.targetGeomsBbox,-1),t.ans=[],t.progrssCallback&&t.progrssCallback(0);var n=t.targetCoverages[t.coverageIndex];if(this.#Ve=0,this.#Ge=0,this.#Ne=Date.now(),console.log("getImagePixData B:",n,"   superParam.coverageIndex:",t.coverageIndex),n&&n.href){var l=n.href;this.#De(l,this.#Ue,t,n.src.getAttribute("iid"),n.src.getAttribute("style"))}else this.#oe=!1,t.cbFunc(t.ans,t.param)}.bind(this);#Ve;#Ge;#Ne;#Be(e,t,i){for(var s=i+1,r=!1;0==r;){var a=e[s];if(s==e.length)return s;a.geoExtent||this.#Fe(a),a.geoExtent[0]<=t.ymax&&t.ymin<=a.geoExtent[1]&&a.geoExtent[2]<=t.xmax&&t.xmin<=a.geoExtent[3]?r=!0:(r=!1,++s)}return s}#Fe(e){var t,i,s,r;if(e.coordinates[0].lat)t=Math.min(e.coordinates[0].lat,e.coordinates[1].lat),i=Math.max(e.coordinates[0].lat,e.coordinates[1].lat),s=Math.min(e.coordinates[0].lng,e.coordinates[1].lng),r=Math.max(e.coordinates[0].lng,e.coordinates[1].lng),e.geoExtent=[t,i,s,r];else{var a=e.transform,o=e.coordinates[0],n=e.coordinates[1],l=this.#o.transform(o.x,o.y,a),h=this.#o.transform(n.x,n.y,a);t=Math.min(l.y,h.y),i=Math.max(l.y,h.y),s=Math.min(l.x,h.x),r=Math.max(l.x,h.x),e.geoExtent=[t,i,s,r],e.geo2svg=this.#o.getInverseMatrix(a)}}#Ue=function(e,t,i,s){s.pixDataBuffer[s.coverageIndex]=e;var r=Date.now();this.#Ve+=r-this.#Ne,this.#Ne=r;for(var a=0;a<s.targetGeoms.length;a++){var o=s.targetGeoms[a].coordinates;if(1==s.computingOptions.targetVectorType)for(var n=0;n<o.length;n++)this.#He(e,t,i,o[n],s);else if(2==s.computingOptions.targetVectorType)for(n=0;n<o.length;n++)this.#ze(e,t,i,o[n],s);else if(0==s.computingOptions.targetVectorType){var l=this.#je(s.targetCoverages[s.coverageIndex]);if(l.lngMin<=o[0]&&l.lngMax>o[0]&&l.latMin<=o[1]&&l.latMax>o[1]){var h=this.#We(t,i,o[0],o[1],s.targetCoverages[s.coverageIndex],l),g=4*(h.x+h.y*t),d=e[g],c=e[g+1],p=e[g+2],u=e[g+3];if(this.#Ye(100*u/255,s.range.alpha)){var m=this.#Xe(d,c,p);this.#Ye(m.h,s.range.hue,!0)&&this.#Ye(m.s,s.range.satulation)&&this.#Ye(m.v,s.range.value)&&(m.a=u,m.r=d,m.g=c,m.b=p,s.targetGeoms[a].hsv=m,s.ans.push(s.targetGeoms[a]))}}}}if(s.coverageIndex=this.#Be(s.targetCoverages,s.targetGeomsBbox,s.coverageIndex),s.progrssCallback&&s.progrssCallback(Math.ceil(s.coverageIndex/s.targetCoverages.length*100)),1==this.#oe||s.coverageIndex==s.targetCoverages.length)this.#oe=!1,console.log("Processing overhead[ms]: fileFetch:",this.#Ve,"  computing:",this.#Ge,"   comp.Ratio[%]:",Math.floor(1e4*this.#Ge/(this.#Ge+this.#Ve))/100),1==s.computingOptions.splitByCoverage?2==s.computingOptions.targetVectorType?this.#Ze(s):1==s.computingOptions.targetVectorType?this.#qe(s):this.#_e(s):s.cbFunc(s.ans,s.param);else{var y=s.targetCoverages[s.coverageIndex];if(r=Date.now(),this.#Ge+=r-this.#Ne,this.#Ne=r,y&&y.href){var v=y.href;this.#De(v,this.#Ue,s,y.src.getAttribute("iid"),y.src.getAttribute("style"))}else this.#oe=!1,s.cbFunc(s.ans,s.param)}}.bind(this);#Ke(e){var t=e%360;return t<0&&(t+=360),t}#Ye(e,t,i){if(!t)return!0;for(var s=0;s<t.length;s++)if(i){if(t[s][0]<=0&&t[s][1]>=360)return!0;var r=this.#Ke(t[s][0]),a=this.#Ke(t[s][1]);if(r>a){if(r<=e&&e<=360||0<=e&&e<=a)return!0}else if(r<=e&&e<=a)return!0}else if(t[s][0]<=e&&e<=t[s][1])return!0;return!1}#Je=100;#Qe=[];#$e=[];#et=!1;#tt(e,t){if(this.#Qe[e]=t,this.#$e.push(e),this.#$e.length==this.#Je){var i=this.#$e.shift();delete this.#Qe[i]}}#it(){this.#et=!0,this.#Qe=[],this.#$e=[]}#st(){this.#et=!1,this.#Qe=[],this.#$e=[]}#De(e,t,i,s,r){var a,o,n=this.#rt(e,!0),l=n.url;if(this.#et&&this.#Qe[l])this.#at(this.#Qe[l],t,i,r);else if(0!=(o="layerCanvasImage"==s?"http":(a=document.getElementById(s)).getAttribute("src")).indexOf("http")||this.#rt(o)==o)this.#at(a,t,i,r),this.#et&&this.#tt(l,a);else{var h=new Image;n.crossorigin&&(h.crossOrigin="anonymous"),h.src=l,h.onload=function(){this.#at(h,t,i,r),this.#et&&this.#tt(l,h)}.bind(this)}}#at(e,t,i,s){var r=document.createElement("canvas");r.width=e.naturalWidth,r.height=e.naturalHeight;var a=r.getContext("2d");a.mozImageSmoothingEnabled=!1,a.webkitImageSmoothingEnabled=!1,a.msImageSmoothingEnabled=!1,a.imageSmoothingEnabled=!1,this.#ot(a,s),a.drawImage(e,0,0),t(a.getImageData(0,0,r.width,r.height).data,r.width,r.height,i)}#ot(e,t){if(t){var i=t.match(/filter:([^;]+);/);i&&(console.log("applyFilter:",i),e.filter=i[1].trim())}}#He(e,t,i,s,r){var a=r.targetCoverages[r.coverageIndex],o=this.#je(a),n=this.#nt(s);if(this.#o.isIntersect(n,o))for(var l=this.#lt(s,o),h=this.#ht(t,i,o),g=0;g<l.length-1;g++)if(1!=l[g+1].clippedEdge)for(var d=l[g],c=l[g+1],p=this.#We(t,i,d.x,d.y,a,o),u=this.#We(t,i,c.x,c.y,a,o),m=this.#gt([p.x,p.y],[u.x,u.y]),y=0;y<m.length;y++){var v=this.#dt(m[y][0],m[y][1],t,i,e,r.range),f=this.#ct(t,i,m[y][0],m[y][1],a,o);v.inBounds&&(1==r.computingOptions.splitByCoverage?(r.ans[r.coverageIndex]||(r.ans[r.coverageIndex]=[],r.ans[r.coverageIndex].extent=o,r.ans[r.coverageIndex].pixSize=h),r.ans[r.coverageIndex].push({coordinates:[f.longitude,f.latitude],color:v.color,inRange:v.inRange})):r.ans.push({coordinates:[f.longitude,f.latitude],color:v.color,inRange:v.inRange}))}}#ze(e,t,i,s,r){var a=r.targetCoverages[r.coverageIndex],o=this.#je(a),n=this.#nt(s);if(this.#o.isIntersect(n,o)){for(var l=this.#ht(t,i,o),h=[],g=0;g<s.length;g++){var d=this.#pt(t,i,s[g][0],s[g][1],a,o);h.push([d.x,d.y])}var c,p=this.#ut(h),u=0;if(!r.ans[r.coverageIndex]){c=new Array(i);for(var m=0;m<i;m++)c[m]=new Array(t).fill({});r.ans[r.coverageIndex]={},a.transform&&(r.ans[r.coverageIndex].transform=a.transform,r.ans[r.coverageIndex].coordinates=a.coordinates),r.ans[r.coverageIndex].extent=o,r.ans[r.coverageIndex].width=t,r.ans[r.coverageIndex].height=i,r.ans[r.coverageIndex].pixSize=l,r.ans[r.coverageIndex].rasterData=c,r.ans[r.coverageIndex].hasIntersection=!1,r.ans[r.coverageIndex].hasInRange=!1,r.ans[r.coverageIndex].hasOutOfRange=!1,r.ans[r.coverageIndex].inRangeCounts=0,r.ans[r.coverageIndex].outOfRangeCounts=0}c=r.ans[r.coverageIndex].rasterData;var y=!1,v=!1,f=!1,b=0,I=0;for(m=i-1;m>=0;m--)for(var P=c[m];u<p.length&&p[u][1]>=m;){if(p[u][1]==m)for(var S=p[u][0],x=Math.max(0,S[0]),M=Math.min(t-1,S[1]),w=x;w<=M;w++){var C=this.#dt(w,m,t,i,e,r.range);C.inBounds&&(P[w]=C,y=!0,C.inRange?(v=!0,++b):(f=!0,++I))}++u}v&&(r.ans[r.coverageIndex].hasInRange=!0),f&&(r.ans[r.coverageIndex].hasOutOfRange=!0),y&&(r.ans[r.coverageIndex].hasIntersection=!0),r.ans[r.coverageIndex].inRangeCounts=b,r.ans[r.coverageIndex].outOfRangeCounts=I}}#dt(e,t,i,s,r,a){if(e<0||t<0||e>=i||t>=s)return{color:null,inRange:!1,inBounds:!1};var o=4*(e+t*i),n=r[o],l=r[o+1],h=r[o+2],g=r[o+3];if(a.outOfBoundsColor&&n==a.outOfBoundsColor.r&&l==a.outOfBoundsColor.g&&h==a.outOfBoundsColor.b)return{color:null,inRange:!1,inBounds:!1};var d=this.#Xe(n,l,h);return d.a=g,d.r=n,d.g=l,d.b=h,this.#Ye(100*g/255,a.alpha)&&this.#Ye(d.h,a.hue,!0)&&this.#Ye(d.s,a.satulation)&&this.#Ye(d.v,a.value)?{color:d,inRange:!0,inBounds:!0}:{color:d,inRange:!1,inBounds:!0}}#lt(e,t){for(var i=[],s=0;s<e.length;s++){var r={x:e[s][0],y:e[s][1],clippedEdge:!1};0==s&&(r.clippedEdge=!0),i.push(r)}return this.#mt(i,t)}#nt(e){for(var t=1e30,i=1e30,s=-1e30,r=-1e30,a=0;a<e.length;a++){var o=e[a];o[0]>s&&(s=o[0]),o[0]<t&&(t=o[0]),o[1]>r&&(r=o[1]),o[1]<i&&(i=o[1])}return{x:t,y:i,width:s-t,height:r-i}}#je(e){var t=e.geoExtent[0],i=e.geoExtent[1],s=e.geoExtent[2],r=e.geoExtent[3];return{latMin:t,latMax:i,lngMin:s,lngMax:r,x:s,y:t,width:r-s,height:i-t}}#yt(e,t){return this.#o.isIntersect(e,t)}#ht(e,t,i){return(i.width/e+i.height/t)/2}#We(e,t,i,s,r,a){let o=this.#pt(e,t,i,s,r,a);return{x:Math.floor(o.x),y:Math.floor(o.y)}}#pt(e,t,i,s,r,a){var o,n;if(r.geo2svg){var l=r.geo2svg,h=r.coordinates[0],g=r.coordinates[1],d=this.#o.transform(i,s,l),c=g.x-h.x,p=g.y-h.y;o=e*(d.x-h.x)/c,n=t*(d.y-h.y)/p}else a||(a=this.#je(r)),o=e*(i-a.lngMin)/(a.lngMax-a.lngMin),n=t-t*(s-a.latMin)/(a.latMax-a.latMin);var u={x:o,y:n};return(o<0||n<0||o>=e||n>=t)&&(u.outOfRange=!0),u}#ct(e,t,i,s,r,a){var o,n;if(r.geo2svg){var l=r.transform,h=r.coordinates[0],g=r.coordinates[1],d=g.x-h.x,c=g.y-h.y,p=i*d/e+h.x,u=s*c/t+h.y,m=this.#o.transform(p,u,l);n=m.x,o=m.y}else a||(a=this.#je(r)),n=a.lngMin+(i+.5)*(a.lngMax-a.lngMin)/e,o=a.latMin+(t-s-.5)*(a.latMax-a.latMin)/t;return{latitude:o,longitude:n}}#mt(e,t){var i,s,r,a,o;return i=n(i=e,l(t.x,t.y,t.x,t.y+t.height)),i=n(i,l(t.x,t.y+t.height,t.x+t.width,t.y+t.height)),i=n(i,l(t.x+t.width,t.y+t.height,t.x+t.width,t.y)),i=n(i,l(t.x+t.width,t.y,t.x,t.y));function n(e,t){var i;if(0==e.length)return e;s=[],r=[e[e.length-1].x,e[e.length-1].y];for(var n=0;n<e.length;n++)a=[e[n].x,e[n].y],o=e[n].clippedEdge,t.inside(a)&&t.inside(r)?s.push({x:a[0],y:a[1],clippedEdge:o}):!t.inside(a)&&t.inside(r)?(i=t.intersect(a,r),s.push({x:i[0],y:i[1],clippedEdge:o})):(t.inside(a)||t.inside(r))&&t.inside(a)&&!t.inside(r)&&(i=t.intersect(r,a),s.push({x:i[0],y:i[1],clippedEdge:!0}),s.push({x:a[0],y:a[1],clippedEdge:o})),r=a;return s}function l(e,t,i,s){var r=s-t,a=e-i,o=-r*e-a*t;return{inside:function(e){return r*e[0]+a*e[1]+o>0},intersect:function(e,t){var i=t[1]-e[1],s=e[0]-t[0],n=-i*e[0]-s*e[1],l=s*r-a*i;return[(a*n-s*o)/l,(i*o-r*n)/l]}}}}#gt(e,t){var i=new Array,s=e[0],r=e[1],a=t[0],o=t[1],n=Math.abs(a-s),l=Math.abs(o-r),h=s<a?1:-1,g=r<o?1:-1,d=n-l;for(i.push([s,r]);s!=a||r!=o;){var c=d<<1;c>-l&&(d-=l,s+=h),c<n&&(d+=n,r+=g),i.push([s,r])}return i}#ut(e,t,i){let s=Math.floor(e[0][1]),r=Math.floor(e[0][1]),a=!0,o=!1,n=[],l=[];for(let t=1;t<e.length;t++)n.push(new g(e[t-1],e[t])),!a||Math.floor(e[0][0])==Math.floor(e[t][0])&&Math.floor(e[0][1])==Math.floor(e[t][1])||(a=!1),o||e[0][0]==e[t][0]||e[0][1]==e[t][1]||(o=!0);if(o&&a)return[[[Math.floor(e[0][0]),Math.floor(e[0][0])],Math.floor(e[0][1])]];for(let t=0;t<e.length;t++){let i=Math.floor(e[t][1]);i<s?s=i:i>r&&(r=i)}s<0&&(s=0);for(let e=s;e<=r+1;e++){let t=h(e),i=h(e+.5);for(let i=1;i<t.length;i+=2)Math.abs(t[i-1]-t[i])>1e-4&&t[i]>0&&(t[i-1]<0?(e>0&&l.unshift([[0,Math.floor(t[i])],e-1]),l.unshift([[0,Math.floor(t[i])],e])):(e>0&&l.unshift([[Math.floor(t[i-1]),Math.floor(t[i])],e-1]),l.unshift([[Math.floor(t[i-1]),Math.floor(t[i])],e])));for(let t=1;t<i.length;t+=2)Math.abs(i[t-1]-i[t])>1e-4&&i[t]>0&&(i[t-1]<0?l.unshift([[0,Math.floor(i[t])],e]):l.unshift([[Math.floor(i[t-1]),Math.floor(i[t])],e]))}return l;function h(e){let t=[];for(let i=0;i<n.length;i++){let s=n[i];s.isValidY(e)&&t.push(s.getX(e))}for(let e=0;e<t.length;e++)for(let i=e+1;i<t.length;i++)if(t[e]>t[i]){let s=t[e];t[e]=t[i],t[i]=s}return t}function g(e,t){this.x0=e[0],this.x1=t[0],this.y0=e[1],this.y1=t[1],this.m=(this.y1-this.y0)/(this.x1-this.x0),this.getX=function(e){if(!this.isValidY(e))throw new RangeError;return 1/this.m*(e-this.y0)+this.x0},this.isValidY=function(e){return e>=this.y0&&e<this.y1||e>=this.y1&&e<this.y0}}}#Ze(e){var t=e.ans;dc=0,dc2=0;for(var i=0;i<t.length;i++)if(t[i]){var s=t[i];if(s.hasIntersection&&s.hasOutOfRange){for(var r=s.extent,a=[],o=0;o<t.length;o++)i!=o&&t[o]&&this.#yt(r,t[o].extent)&&a.push({index:o,tile:t[o]});for(var n=0;n<s.height;n++)for(var l=0;l<s.width;l++)if(s.rasterData[n][l].color&&0==s.rasterData[n][l].inRange)for(var h=s.extent.lngMin+l*(s.extent.width/s.width),g=s.extent.latMax-n*(s.extent.height/s.height),d=0;d<a.length;d++){var c=a[d].tile;if(iPx=Math.floor(c.width*(h-c.extent.lngMin)/c.extent.width),iPy=Math.floor(c.height*(c.extent.latMax-g)/c.extent.height),iPx>=0&&iPy>=0&&iPx<c.width&&iPy<c.height)if(c.rasterData[iPy][iPx].color){if(1==c.rasterData[iPy][iPx].inRange){s.rasterData[n][l]={},--s.outOfRangeCounts,++dc;break}}else if(1==this.#dt(iPx,iPy,c.width,c.height,e.pixDataBuffer[a[d].index],e.range).inRange){s.rasterData[n][l]={},--s.outOfRangeCounts,++dc,++dc2;break}}s.outOfRangeCounts<0&&(s.outOfRangeCounts=0),0==s.outOfRangeCounts&&(s.hasOutOfRange=!1)}}console.log("Number of points inranged by OR processing : ",dc,"   by backup Processing:",dc2),e.cbFunc(e.ans,e.param)}#_e(e){e.cbFunc(e.ans,e.param)}#qe(e){for(var t=e.ans,i=t.length-1;i>=0;i--)if(t[i]){for(var s=!1,r=0;r<t[i].length;r++)if(0==t[i][r].inRange){s=!0;break}t[i].hasOutOfRange=s}else t.splice(i,1);console.log("doPolylineOrComputing dsrc:",t);for(i=0;i<t.length;i++){var a=t[i];if(a.hasOutOfRange){var o=a.extent,n=[];for(r=0;r<t.length;r++)i!=r&&this.#yt(o,t[r].extent)&&n.push(t[r]);for(r=0;r<a.length;r++){if(0==(v=a[r]).inRange){for(var l=[],h=0;h<n.length;h++){var g=1e30,d=null;if(n[h].extent.lngMin<=v.coordinates[0]&&n[h].extent.lngMax>v.coordinates[0]&&n[h].extent.latMin<=v.coordinates[1]&&n[h].extent.latMax>v.coordinates[1])for(var c=0;c<n[h].length;c++){var p=n[h][c],u=(v.coordinates[0]-p.coordinates[0])*(v.coordinates[0]-p.coordinates[0])+(v.coordinates[1]-p.coordinates[1])*(v.coordinates[1]-p.coordinates[1]);u<g&&(g=u,d=p)}d&&g<(a.pixSize+n[h].pixSize)*(a.pixSize+n[h].pixSize)&&l.push(d)}for(h=0;h<l.length;h++){(d=l[h])&&1==d.inRange&&(v.inRange="mayTrue")}}}}}var m=[],y=0;for(i=0;i<t.length;i++)for(r=0;r<t[i].length;r++){var v;"mayTrue"==(v=t[i][r]).inRange?++y:m.push(v)}e.ans=m,console.log("Number of points deleted by OR processing : ",y),e.cbFunc(e.ans,e.param)}#vt={};#ft(e,t,i){if(this.#vt={},e){if(this.#vt.proxyUrl=e,this.#vt.directURLlist=t||[],0==e.indexOf("http")){var s=e.substring(0,e.indexOf("/",8));this.#vt.directURLlist.push(s)}this.#vt.anonProxy=!!i}}#rt(e,t){return this.#vt.proxyUrl?(this.#vt.proxyUrl&&0==e.indexOf("http")&&(this.#bt(e)||(e=this.#vt.proxyUrl+encodeURIComponent(e))),t?{url:e,anonymous:this.#vt.anonProxy}:e):this.#o.getCORSURL(e,t)}#bt(e){for(var t=!1,i=0;i<this.#vt.directURLlist.length;i++)if(e.indexOf(this.#vt.directURLlist[i])>=0){t=!0;break}return t}#Xe(e,t,i){var s=Math.max(e,t,i),r=Math.min(e,t,i),a={h:0,s:0,v:s};return s!=r&&(s==e&&(a.h=60*(t-i)/(s-r)),s==t&&(a.h=60*(i-e)/(s-r)+120),s==i&&(a.h=60*(e-t)/(s-r)+240),a.s=(s-r)/s),a.h<0&&(a.h=a.h+360),a.h=Math.round(a.h),a.s=Math.round(100*a.s),a.v=Math.round(a.v/255*100),a}#It(e,t,i){var s={r:0,g:0,b:0};if(360==e&&(e=0),i/=100,0==(t/=100))return s.r=255*i,s.g=255*i,s.b=255*i,s;var r=Math.floor(e/60),a=i*(1-t),o=i*(1-t*(e/60-r)),n=i*(1-t*(1-(e/60-r)));switch(r){case 0:s.r=i,s.g=n,s.b=a;break;case 1:s.r=o,s.g=i,s.b=a;break;case 2:s.r=a,s.g=i,s.b=n;break;case 3:s.r=a,s.g=o,s.b=i;break;case 4:s.r=n,s.g=a,s.b=i;break;case 5:s.r=i,s.g=a,s.b=o}return s.r=Math.round(255*s.r),s.g=Math.round(255*s.g),s.b=Math.round(255*s.b),s}#Pt(e,t,i){return"#"+this.#St(e.toString(16),2)+this.#St(t.toString(16),2)+this.#St(i.toString(16),2)}#St(e,t){return("0000000000"+e).slice(-t)}#Pe(e,t,i,s,r,a,o,n,l,h,g){g||(g={});var d=this.#o.getSvgImages(),c=this.#o.getSvgImagesProps(),p=d[t],u=c[t].CRS,m={};if(n)for(var y in n)m[y]=n[y];if(e.metadata&&(m=e.metadata),e.properties)for(var y in e.properties)m[y]=e.properties[y];if(!e.type&&e.length>0)for(var v=0;v<e.length;v++)this.#Pe(e[v],t,i,s,r,a,o,m,l,h,g);else if("FeatureCollection"==e.type){var f=e.features;for(v=0;v<f.length;v++)this.#Pe(f[v],t,i,s,r,a,o,m,l,h,g)}else if("Feature"==e.type){var b=e.geometry;this.#Pe(b,t,i,s,r,a,o,m,l,h,g)}else if("GeometryCollection"==e.type){var I=e.geometries;for(v=0;v<I.length;v++)this.#Pe(I[v],t,i,s,r,a,o,m,l,h,g)}else if("MultiPolygon"==e.type){if(e.coordinates.length>0){var P=l;g.multiGeometryGrouping&&(P=this.#xt(l,p,e.type));for(v=0;v<e.coordinates.length;v++)this.#Mt(e.coordinates[v],p,u,r,m,P,h,g)}}else if("Polygon"==e.type)this.#Mt(e.coordinates,p,u,r,m,l,h,g);else if("MultiLineString"==e.type){if(e.coordinates.length>0){P=l;g.multiGeometryGrouping&&(P=this.#xt(l,p,e.type));for(v=0;v<e.coordinates.length;v++)this.#wt(e.coordinates[v],p,u,i,s,m,P,h,g)}}else if("LineString"==e.type)this.#wt(e.coordinates,p,u,i,s,m,l,h,g);else if("MultiPoint"==e.type){if(e.coordinates.length>0){P=l;g.multiGeometryGrouping&&(P=this.#xt(l,p,e.type));for(v=0;v<e.coordinates.length;v++)this.#Ct(e.coordinates[v],p,u,a,o,m,P,h,g)}}else"Point"==e.type&&this.#Ct(e.coordinates,p,u,a,o,m,l,h,g)}#xt(e,t,i,s,r){var a=t.createElement("g");if(i||(i="multiGeometry"),a.setAttribute("data-multiGeometry",i),s&&r){var o=this.#Lt(s,r),n=this.#At(o.normalized);!n&&o.styles.description&&(n=o.styles.description),n&&a.setAttribute("content",n)}return e?e.appendChild(a):t.documentElement.appendChild(a),a}#Et(e,t,i,s,r,a,o,n,l,h){console.log("kml draw method.");var g=this.#o.getSvgImages(),d=this.#o.getSvgImagesProps(),c=g[t],p=d[t].CRS,u=e.querySelectorAll("Folder");if(console.log(u),u.length>0){Array.prototype.slice.call(u,0).forEach((e,o)=>{var n=this.#Tt(e),g=this.#Ot(e);this.drawKml(e,t,i,s,r,a,n,g,l,h)})}else{var m=e.querySelectorAll("Placemark"),y=Array.prototype.slice.call(m,0);let t=[];y.forEach((e,r)=>{var h=this.#Tt(e),g=this.#Ot(e);null===h&&null===g&&(h=o,g=n);var d=this.#kt(e),u=this.#Rt(e);"point"==d?this.#Ct(u,c,p,a,h,[g],l):("linestring"==d||"linearring"==d)&&(t.push(h),t.push(g),this.#wt(u,c,p,i,s,t,l))})}}#Tt(e){var t=e.querySelector("name");return t?t.textContent.trim():null}#Ot(e){var t=e.querySelector("description");return t?t.textContent.trim():null}#kt(e){return e.querySelector("Placemark")?"placemark":e.querySelector("Polygon")?"polygon":e.querySelector("Point")?"point":e.querySelector("LineString")?"linestring":e.querySelector("LinearRing")?"linearring":e.querySelector("MultiGeometry")?"multigeometry":void 0}#Rt(e){for(var t=[],i=e.querySelector("coordinates").textContent.trim().replace(/\n/g," ").replace(/\t/g," ").split(" "),s=0;s<i.length;s++){let e=i[s].trim().split(",");t.push([e[0],e[1]])}return t}#Ct(e,t,i,s,r,a,o,n){var l,h,g=this.#Lt(a,n),d=this.#At(g.normalized);!d&&g.styles.description&&(d=g.styles.description),s||(s="p0"),g.styles["marker-symbol"]&&(s=g.styles["marker-symbol"]);var c=1,p=0;g.styles.opacity&&(c=Number(g.styles.opacity)),g.styles.fill&&(l=g.styles.fill),g.styles["marker-color"]&&(l=g.styles["marker-color"]),g.styles.stroke&&(h=g.styles.stroke,p=1),g.styles["stroke-width"]&&(p=g.styles["stroke-width"]),null!=g.styles.title&&null!=g.styles.title?r=g.styles.title+"":a.title&&(r=a.title+"");var u=t.createElement("use"),m=this.#Bt(e,i);return m?(u.setAttribute("x","0"),u.setAttribute("y","0"),u.setAttribute("transform","ref(svg,"+m.x+","+m.y+")"),u.setAttribute("xlink:href","#"+s),r&&u.setAttribute("xlink:title",r),d&&u.setAttribute("content",d),l&&u.setAttribute("fill",l),p>0?(u.setAttribute("stroke",h),u.setAttribute("stroke-width",p),u.setAttribute("vector-effect","non-scaling-stroke")):u.setAttribute("stroke","none"),c<1&&u.setAttribute("opacity",c),o?o.appendChild(u):t.documentElement.appendChild(u),u):null}#wt(e,t,i,s,r,a,o,n){var l=this.#Lt(a,n),h=this.#At(l.normalized);!h&&l.styles.description&&(h=l.styles.description),s||(s="blue"),r||(r=3);var g,d=1;l.styles.opacity&&(d=Number(l.styles.opacity)),l.styles.stroke&&(s=l.styles.stroke),l.styles["stroke-width"]&&(r=l.styles["stroke-width"]),l.styles.title&&(g=l.styles.title);var c=t.createElement("path"),p=this.#Vt(e,i);return c.setAttribute("d",p),c.setAttribute("fill","none"),c.setAttribute("stroke",s),c.setAttribute("stroke-width",r),c.setAttribute("vector-effect","non-scaling-stroke"),d<1&&c.setAttribute("opacity",d),g&&c.setAttribute("xlink:title",g),h&&c.setAttribute("content",h),o?o.appendChild(c):t.documentElement.appendChild(c),c}#Mt(e,t,i,s,r,a,o){var n=this.#Lt(r,o),l=this.#At(n.normalized);if(!l&&n.styles.description&&(l=n.styles.description),0!=e.length){var h="none",g=0;s||(s="orange"),n.styles.fill&&(s=n.styles.fill),n.styles.stroke&&(g=1,h=n.styles.stroke),n.styles["stroke-width"]&&(g=n.styles["stroke-width"]);var d,c=1;n.styles.opacity&&(c=Number(n.styles.opacity)),n.styles.title&&(d=n.styles.title);for(var p=t.createElement("path"),u="",m=0;m<e.length;m++)u+=this.#Vt(e[m],i)+"z ";return p.setAttribute("d",u),p.setAttribute("fill",s),p.setAttribute("fill-rule","evenodd"),g>0?(p.setAttribute("stroke",h),p.setAttribute("stroke-width",g),p.setAttribute("vector-effect","non-scaling-stroke")):p.setAttribute("stroke","none"),c<1&&p.setAttribute("opacity",c),d&&p.setAttribute("xlink:title",d),l&&p.setAttribute("content",l),a?a.appendChild(p):t.documentElement.appendChild(p),p}}#Vt(e,t){if(0==e.length)return" ";var i="M",s=this.#Bt(e[0],t);if(s){i+=s.x+","+s.y+" L";for(var r=1;r<e.length;r++)(s=this.#Bt(e[r],t))&&(i+=s.x+","+s.y+" ")}else i=" ";return i}#Bt(e,t){return e.length>1?{x:e[0]*t.a+e[1]*t.c+t.e,y:e[0]*t.b+e[1]*t.d+t.f}:null}static#Gt={title:0,description:1,"marker-size":2,"marker-symbol":3,"marker-color":4,stroke:5,"stroke-width":6,fill:7,opacity:8};#Lt(e,t){var i={},s=[],r={};if(Array.isArray(e))s=e;else if(t)for(var o in t.hashMap||this.#Nt(t),s=new Array(t.length),e){var n=t.hashMap[o];null!=n?s[n]=e[o]:null!=a.#Gt[o]?r[o]=e[o]:i[o]=e[o]}else{var l=Object.keys(e);for(var o of(l.sort(),l))null!=a.#Gt[o]?r[o]=e[o]:s.push(e[o])}return{normalized:s,others:i,styles:r}}#Nt(e){e.hashMap={};for(var t=0;t<e.length;t++)e.hashMap[e[t]]=t}#At(e){var t;if(0==e.length)return null;for(var i=0;i<e.length;i++){var s="";null!=e[i]&&null!=e[i]&&(s=e[i].toString()),s.indexOf(",")>=0&&(s=s.replaceAll(",","&#x2c;")),0==i?t=s:t+=","+s}return t}#Dt=function(e){console.log("called testCapture"),console.log("captured Geometry is:",e)}.bind(this);#Ut(){this.#o.captureGISgeometries(testCapture)}#Ft(e,t){this.#o.captureGISgeometries(e,t)}#Ht(e,t){return{type:"Point",coordinates:[t,e]}}#zt(e,t,i,s){for(var r=0;r<e.length;r++){var a=e[r];if(a){var o=this.#jt(a,s),n=t.ownerDocument.createElement("image");if(a.transform){console.log("has transform meshdata");var l=this.#o.matMul(a.transform,i);n.setAttribute("x",a.coordinates[0].x),n.setAttribute("y",a.coordinates[0].y),n.setAttribute("width",a.coordinates[1].x-a.coordinates[0].x),n.setAttribute("height",a.coordinates[1].y-a.coordinates[0].y),n.setAttribute("transform","matrix("+l.a+","+l.b+","+l.c+","+l.d+","+l.e+","+l.f+")")}else n.setAttribute("x",Math.min(a.extent.x*i.a,(a.extent.x+a.extent.width)*i.a)),n.setAttribute("y",Math.min(a.extent.y*i.d,(a.extent.y+a.extent.height)*i.d)),n.setAttribute("width",Math.abs(a.extent.width*i.a)),n.setAttribute("height",Math.abs(a.extent.height*i.d));n.setAttribute("xlink:href",o),n.setAttribute("style","image-rendering:pixelated"),t.appendChild(n)}}}#jt(e,t){var i=e.width,s=e.height;e.extent;var r=[255,0,0,255];t?t.fillColor&&t.fillColor.length>=3&&(r=t.fillColor,3==t.fillColor.length&&r.push(255)):t={};var a=document.createElement("canvas");a.width=i,a.height=s;for(var o=a.getContext("2d"),n=o.getImageData(0,0,i,s),l=n.data,h=0;h<s;++h)for(var g=0;g<i;++g){var d=4*(h*i+g),c=e.rasterData[h][g].color,p=e.rasterData[h][g].inRange;c&&(p?t.drawOutOfRange||(t.useCoverageColor?(l[d+0]=c.r,l[d+1]=c.g,l[d+2]=c.b,l[d+3]=255):(l[d+0]=r[0],l[d+1]=r[1],l[d+2]=r[2],l[d+3]=r[3])):t.drawOutOfRange&&(t.useCoverageColor?(l[d+0]=c.r,l[d+1]=c.g,l[d+2]=c.b,l[d+3]=255):(l[d+0]=r[0],l[d+1]=r[1],l[d+2]=r[2],l[d+3]=r[3])))}return o.putImageData(n,0,0),a.toDataURL("image/png")}#Wt(e,t){var i=this.#Yt(e),s=Math.cos(i[1]*Math.PI/180),r=[111111.11*s,0,0,111111.11,0,0],a={type:e.type,coordinates:e.coordinates};a=this.#Xt(a,r,!0),console.log(a,this);var o=this.#q(a);o=o.buffer(t);var n=this.#_(o),l=[1/(111111.11*s),0,0,1/111111.11,0,0];return this.#Xt(n,l),e.src&&(n.src=e.src),n}#Yt(e){var t,i,s,r=(t=0,i=0,s=0,{getResult:function(){return t>0?[i/t,s/t]:null},set:function(e){i+=e[0],s+=e[1],++t}});return this.#Zt(e.coordinates,r),r.getResult()}#Xt(e,t,i){i&&(e=structuredClone(e));var s=("function"==typeof t?function(){return{set:function(e){return t(e)}}}:function(){return{set:function(e){return[e[0]*t[0]+e[1]*t[2]+t[4],e[0]*t[1]+e[1]*t[3]+t[5]]}}})();return this.#Zt(e.coordinates,s),e}#Zt(e,t){if("number"==typeof e[0]&&2==e.length){var i=t.set(e);i&&(e[0]=i[0],e[1]=i[1])}else for(var s of e)this.#Zt(s,t)}getImagePixelData(e,t,i){return this.#De(e.href,t,i,e.src.getAttribute("iid"),e.src.getAttribute("style"))}buildDifference(...e){return this.#le(...e)}buildIntersection(...e){return this.#he(...e)}captureGeometries(...e){return this.#Ft(...e)}coverageImageXY2LatLng(...e){return this.#ct(...e)}drawGeoJson(...e){return this.#Pe(...e)}drawKml(...e){return this.#Et(...e)}disableImageCache(...e){return this.#st(...e)}enableImageCache(...e){return this.#it(...e)}getBufferedPolygon(...e){return this.#Wt(...e)}getExcludedPoints(...e){return this.#te(...e)}getColorString(...e){return this.#Pt(...e)}getImage(...e){return this.#jt(...e)}getIncludedPoints(...e){return this.#$(...e)}getInRangeGeometriesOnCoverage(...e){return this.#Le(...e)}getInRangeLineParts(...e){return this.#Ae(...e)}getInRangePoints(...e){return this.#Ee(...e)}getInRangePolygonParts(...e){return this.#Ce(...e)}haltComputing(...e){return this.#we(...e)}imageUrlEncoder(...e){return this.#rt(...e)}latLng2coverageImageXY(...e){return this.#We(...e)}latLng2GeoJsonPoint(...e){return this.#Ht(...e)}renderImages(...e){return this.#zt(...e)}setImageProxy(...e){return this.#ft(...e)}testCapGISgeom(...e){return this.#Ut(...e)}hsv2rgb(...e){return this.#It(...e)}rgb2hsv(...e){return this.#Xe(...e)}}class o{#o;#qt;#_t;constructor(e,t){console.log("Hello this is svgMapAuthoringTool"),this.#o=e,this.#qt=t,this.#_t=new a(e,window.jsts)}#Kt={};#Jt={};#Qt={strokeWidth:3,opacity:1,fill:"skyblue",stroke:"blue"};#$t={strokeWidth:3,opacity:1,fill:"yellow",stroke:"red"};#ei(e,t){var i=this.#o.screen2Geo(e,t);console.log("Get EditPoint event! :",i)}#ti(e,t,i){var s=this.#ii[t],r=this.#si[t].CRS,a=this.#o.getSymbols(this.#ii[t]);if(r&&s&&a&&s.getElementsByTagName("defs")[0].getElementsByTagName("g")){var o=null;for(var n in a){o=a[n];break}var l=this.#o.Geo2SVG(e.lat,e.lng,r),h="ref(svg,"+l.x+","+l.y+")",g=s.documentElement.namespaceURI,d=s.createElementNS(g,"use");d.setAttribute("x",0),d.setAttribute("y",0),d.setAttributeNS(g,"transform",h),d.setAttribute("xlink:href","#"+o.id),d.setAttribute("xlink:title",i),d.setAttribute("content","null"),s.documentElement.appendChild(d),this.#o.refreshScreen(),setTimeout(function(){POIeditProps(d,!0,a)}.bind(this),50)}}#ri=function(e){console.log("call clear tools");var t=this.#Kt.uiDoc;this.#ai(t,this.#Kt.toolsCbFunc,this.#Kt.toolsCbFuncParam,"Cancel"),this.#oi(),this.#Kt.modifyTargetElement&&this.#Kt.modifyTargetElement.getAttribute("iid")&&document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid"))&&(document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid")).style.backgroundColor=""),this.#Kt.modifyTargetElement=null,this.#Kt.editingGraphicsElement=!1,console.log("get iframe close/hide event from authoring tools framework."),this.#o.setRootLayersProps(this.#Kt.editingLayerId,null,!1),this.#ni(this.#li)}.bind(this);#hi=function(e){console.log("get iframe appear event from authoring tools framework."),this.#o.setRootLayersProps(this.#Kt.editingLayerId,!0,!0)}.bind(this);#gi(e,t,i,s,r,a,o,n,l,h){var g=e.ownerDocument;0!=s.indexOf("#")&&(s="#"+s),this.#Kt&&this.#Kt.editingMode&&"POIreg"==this.#Kt.editingMode&&g===this.#Kt.uiDoc&&t==this.#Kt.editingLayerId?console.log("ADD uiMapping"):(console.log("NEW uiMapping"),this.#di({uiPanel:[],editingLayerId:t,editingMode:"POIreg",uiDoc:g,editingGraphicsElement:!1,modifyTargetElement:null,poiParams:[],returnSvgElement:h,selectedPointsIndex:-1}),o?(this.#Kt.toolsCbFunc=o,this.#Kt.toolsCbFuncParam=n):(this.#Kt.toolsCbFunc=null,this.#Kt.toolsCbFuncParam=null)),this.#Kt.uiPanel.push(e),this.#Kt.poiParams.push({title:r,metadata:a,href:s,id:i});var d=this.#Kt.uiPanel.length-1;this.#ci(e),console.log("called initPOIregistTool: docId:",t),this.#ii=this.#o.getSvgImages(),this.#si=this.#o.getSvgImagesProps(),this.#o.getSymbols(this.#ii[t]),this.#pi(t);var c=g.createElement("input");c.setAttribute("type","button"),c.id="cernterRegButton"+d,c.setAttribute("value","mapCenterCoord");var p=g.createElement("input");p.setAttribute("type","button"),p.id="coordInputButton"+d,p.setAttribute("value","lat/lng");var u=g.createElement("input");u.setAttribute("type","text"),u.id="coordTextBox"+d,u.setAttribute("value","---,---"),e.appendChild(c),e.appendChild(p),e.appendChild(u),this.#ui(e)}#ii;#si;#mi(e,t,i,s,r,a,o){var n=!1;o?.bufferOption&&(n=o.bufferOption),this.#ci(e);var l=e.ownerDocument;console.log("called initPOItools: docId:",t),this.#o.setRootLayersProps(t,!0,!0),this.#ii=this.#o.getSvgImages(),this.#si=this.#o.getSvgImagesProps();var h=this.#o.getSymbols(this.#ii[t]),g=this.#pi(t),d=0;for(var c in h)++d;var p='<table id="poiEditor">';p+=d>1?'<tr><td colspan="2" id="iconselection" >':'<tr style="display:none"><td colspan="2" id="iconselection" >';var u=!0;for(var c in h)"symbol"==h[c].type&&(p+='<img id="symbol'+c+'" src="'+h[c].path+'" width="'+h[c].width+'" height="'+h[c].height+'" property="'+c+'" ',u?(p+='border="2" style="border-color:red" ',u=!1):p+='border="2" style="border-color:white" ',p+="/>");if(p+="</td></tr>",r||(p+='<tr><td>title</td><td><input type="text" id="poiEditorTitle" value="title"/></td></tr>'),p+='<tr><td><input type="button" id="pointUI" value="lat/lng"/></td><td><input id="poiEditorPosition" type="text" value="--,--"/></td></tr></table>',p+='<table id="metaEditor">',g)for(var m=0;m<g.length;m++){"title"==g[m]||"name"==g[m]||"名称"==g[m]||"タイトル"==g[m]?p+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" data-type="titleMetaCol" disabled="disabled" value="title"/></td></tr>':"latitude"==g[m]||"lat"==g[m]||"緯度"==g[m]?p+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" data-type="latMetaCol"  disabled="disabled" value="numberFormat(latlng.lat )"/></td></tr>':"longitude"==g[m]||"lon"==g[m]||"lng"==g[m]||"経度"==g[m]?p+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" data-type="lngMetaCol" disabled="disabled" value="numberFormat(latlng.lng )"/></td></tr>':p+="<tr><td>"+g[m]+'</td><td><input id="meta'+m+'" type="text" value=""/></td></tr>'}return p+="</table>",n&&(p+='<div><input type="text" id="objectBufferLength"  value=""  placeholder="バッファ半径[m]"></input></div>'),p+='<div id="editConf"><input type="button" id="pepok" value="決定"/><input type="button" id="pepng" value="キャンセル"/><input type="button" id="pepdel" disabled value="削除"/><span id="editMode">newObject</span></div>',e.innerHTML=p,this.#di({uiPanel:e,editingLayerId:t,editingMode:"POI",uiDoc:l,editingGraphicsElement:!1,modifyTargetElement:null,returnSvgElement:a,selectedPointsIndex:-1,editingStyle:structuredClone(this.#$t),shapeStyle:structuredClone(this.#Qt)},!0),i?(this.#Kt.toolsCbFunc=i,this.#Kt.toolsCbFuncParam=s):(this.#Kt.toolsCbFunc=null,this.#Kt.toolsCbFuncParam=null),n&&(this.#Kt.bufferOption=!0),this.#yi(this.#Kt.editingStyle,o?.editingStyle),this.#yi(this.#Kt.shapeStyle,o?.shapeStyle),this.#vi(l,t),this.#fi(l,t),this.#bi(l,t),this.#Kt}#fi(e){e.getElementById("metaEditor").addEventListener("click",function(t){console.log(this.#Ii(e)),t.target.id}.bind(this),!1)}#Ii(e){for(var t=[],i=e.getElementById("metaEditor"),s=0;s<i.rows.length;s++)t.push(i.rows[s].cells[1].childNodes[0].value);return t}#Pi(e){for(var t=e.attributes,i={},s=0;s<t.length;s++)i[t[s].name]=t[s].value;return i}#bi(e,t){this.#Si=!1,e.getElementById("editConf").addEventListener("click",function(i){var s;console.log("editConf event : id:",i.target.id," editMode:",this.#Kt),"POLYLINE"!==this.#Kt.editingMode&&"POLYGON"!==this.#Kt.editingMode||this.#ni(this.#li),this.#Kt.modifyTargetElement&&(this.#Kt.prevAttrs=this.#Pi(this.#Kt.modifyTargetElement));var r=null;switch(i.target.id){case"pepok":if(s="OK","POI"===this.#Kt.editingMode)r=this.#xi(this.#Mi(e),t),this.#Kt.modifyTargetElement&&document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid"))&&(document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid")).style.backgroundColor="",r&&(document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid")).title=r.getAttribute("xlink:title")));else if("POLYLINE"===this.#Kt.editingMode||"POLYGON"===this.#Kt.editingMode)r=this.#wi(e,t);else if("FREEHAND"===this.#Kt.editingMode){if(1!=this.#Kt.editingGraphicsElement)return;console.log("FREEHAND tools editconf"),r=this.#Ci(e,t),this.#oi()}this.#Kt.modifyTargetElement=null,this.#Kt.editingGraphicsElement=!1;break;case"pepng":s="Cancel",console.log("do cancel",this.#Kt.editingMode),this.#Kt.modifyTargetElement&&document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid"))&&(document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid")).style.backgroundColor=""),this.#Kt.modifyTargetElement=null,this.#Kt.editingGraphicsElement=!1;break;case"pepdel":if(console.log("pepdel button: selP",this.#Kt.selectedPointsIndex,"  insP:",this.#Kt.insertPointsIndex),-1==this.#Kt.selectedPointsIndex)this.#o.setCustomModal("Delete Object?",["YES","Cancel"],this.#Li,{targetDoc:e,toolsCbFunc:this.#Kt.toolsCbFunc,toolsCbFuncParam:this.#Kt.toolsCbFuncParam},{position:i.target});else{console.log("remove a point not skip edit conf"),s=null;var a=this.#Ai.getPoints();a.splice(this.#Kt.selectedPointsIndex,1),this.#Kt.selectedPointsIndex=-1,this.#Ai.setPoints(a),this.#Ei(this.#Kt.uiDoc.getElementById("polyEditorPosition"),a)}}r&&(this.#Kt.bufferOption?this.#Ti(r):r.removeAttribute("data-geometry")),this.#Kt.editedElement=r,s&&this.#ai(e,this.#Kt.toolsCbFunc,this.#Kt.toolsCbFuncParam,s)}.bind(this),!1)}#ai(e,t,i,s){if(this.#Kt.selectedPointsIndex=-1,this.#Kt.insertPointsIndex=-1,this.#Oi(e),this.#ki.removeCursor(),this.#Ai.removeCanvas(),t){var r;if(this.#Kt.returnSvgElement){var a=null;this.#Kt.editedElement&&(a=this.#Pi(this.#Kt.editedElement)),r={confStat:s,element:this.#Kt.editedElement,attrs:a,prevAttrs:this.#Kt.prevAttrs},this.#Kt.prevAttrs=null,this.#Kt.editedElement=null}else r=s;this.#Ri(t,r,i)}this.#o.refreshScreen()}#Li=function(e,t){if(0==e){this.#Kt.editingGraphicsElement=!1;var i=this.#Kt.modifyTargetElement;i.parentNode.removeChild(i),this.#Kt.modifyTargetElement=null,this.#ai(t.targetDoc,t.toolsCbFunc,t.toolsCbFuncParam,"Delete")}}.bind(this);#Oi(e){if(console.log("clearForms"),this.#Kt.modifyTargetElement&&this.#Kt.modifyTargetElement.getAttribute("iid")&&(document.getElementById(this.#Kt.modifyTargetElement.getAttribute("iid")).style.backgroundColor="",this.#Kt.modifyTargetElement=null),e.getElementById("pepdel")&&(e.getElementById("pepdel").disabled=!0),e.getElementById("editMode")&&(e.getElementById("editMode").innerHTML="newObject"),"POI"===this.#Kt.editingMode){for(var t=(s=e.getElementById("poiEditor")).rows[0].cells[0].childNodes,i=0;i<t.length;i++)t[i].style.borderColor=0==i?"red":"white";e.getElementById("poiEditorPosition").value="--,--"}else if("POLYLINE"===this.#Kt.editingMode||"POLYGON"===this.#Kt.editingMode){var s=e.getElementById("polyEditorPosition");this.#ci(s),s.innerHTML='<tr><td><input type="button" id="pointAdd" value="ADD"/></td></tr>'}if(e.getElementById("poiEditorTitle")&&(e.getElementById("poiEditorTitle").value=""),s=e.getElementById("metaEditor"))for(i=0;i<s.rows.length;i++)s.rows[i].cells[1].childNodes[0].value=""}#xi(e,t,i){var s,r;console.log("setPoiSvg called :",e,t,i),this.#Kt.modifyTargetElement&&(s=this.#Kt.modifyTargetElement.getAttribute("iid"));var a=this.#ii[t];if(s){if(!(r=this.#o.getElementByImageId(a,s))){if(t=this.#Kt.modifyTargetElement.ownerDocument.documentElement.getAttribute("about"),a=this.#ii[t],!(r=this.#o.getElementByImageId(a,s)))return console.log("Can not find element.... Exit..."),!1;console.log("Tiled Doc....continue")}}else i?a.getElementById(i)?r=a.getElementById(i):((r=a.createElement("use")).setAttribute("id",i),a.documentElement.appendChild(r)):(r=a.createElement("use"),a.documentElement.appendChild(r));var o=e;if(console.log("setPoiSvg:",o),o.geoPos[0]){var n=this.#o.Geo2SVG(o.geoPos[0],o.geoPos[1],this.#si[t].CRS);if(o.metadata){for(var l="",h=0;h<o.metadata.length&&(l+=this.#o.escape(o.metadata[h]),h!=o.metadata.length-1);h++)l+=",";r.setAttribute("content",l)}return o.title&&r.setAttribute("xlink:title",o.title),r.setAttribute("transform","ref(svg,"+n.x+","+n.y+")"),o.href&&r.setAttribute("xlink:href",o.href),r.setAttribute("data-geometry",JSON.stringify({type:"Point",coordinates:[o.geoPos[1],o.geoPos[0]],icon:o.href})),console.log("setPoiSvg:",r),r}return!1}#wi(e,t){console.log("setPolySvg:",e,t);var i=null,s=this.#Ai.getPoints();if(s.length<2||"POLYGON"==this.#Kt.editingMode&&s.length<3)return!1;var r="LineString";if("POLYGON"==this.#Kt.editingMode&&(r="Polygon"),!this.#Kt.modifyTargetElement||"polygon"!=this.#Kt.modifyTargetElement.nodeName&&"polyline"!=this.#Kt.modifyTargetElement.nodeName){if(this.#Kt.modifyTargetElement)i=this.#Kt.modifyTargetElement;else{var a=this.#ii[t];i=a.createElement("path"),"POLYGON"==this.#Kt.editingMode?i.setAttribute("fill",this.#Kt.shapeStyle.fill):i.setAttribute("fill","none"),i.setAttribute("opacity",this.#Kt.shapeStyle.opacity),i.setAttribute("stroke",this.#Kt.shapeStyle.stroke),i.setAttribute("stroke-width",this.#Kt.shapeStyle.strokeWidth),i.setAttribute("vector-effect","non-scaling-stroke"),a.documentElement.appendChild(i)}for(g="",d=0;d<s.length;d++){c=this.#o.Geo2SVG(s[d].lat,s[d].lng,this.#si[t].CRS);0==d?g="M"+c.x+","+c.y+"L":g+=c.x+","+c.y+" "}"POLYGON"==this.#Kt.editingMode&&(g+="z"),i.setAttribute("d",g);var o=this.#Ii(e);if(e.getElementById("poiEditorTitle")){var n=e.getElementById("poiEditorTitle").value;i.setAttribute("xlink:title",n);var l=e.getElementById("metaEditor");for(d=0;d<l.rows.length;d++)"titleMetaCol"==l.rows[d].cells[1].childNodes[0].dataset.type&&(o[d]=n)}var h="";for(d=0;d<o.length&&(h+=this.#o.escape(o[d]),d!=o.length-1);d++)h+=",";i.setAttribute("content",h)}else{i=this.#Kt.modifyTargetElement;for(var g="",d=0;d<s.length;d++){var c;g+=(c=this.#o.Geo2SVG(s[d].lat,s[d].lng,this.#si[t].CRS)).x+","+c.y+" "}i.setAttribute("points",g)}var p=[];for(var u of s)p.push([u.lng,u.lat]);return"Polygon"==r&&(p[0][0]==p[p.length-1][0]&&p[0][1]==p[p.length-1][1]||p.push([p[0][0],p[0][1]]),p=[p]),i.setAttribute("data-geometry",JSON.stringify({type:r,coordinates:p})),i}#Mi(e){for(var t,i=this.#Ii(e),s=(n=e.getElementById("poiEditor")).rows[0].cells[0].childNodes,r=0;r<s.length;r++)if("red"===s[r].style.borderColor){t=s[r].getAttribute("property");break}console.log("readPoiUiParams:symbols:",s,"  symHref:",t);var a="";e.getElementById("poiEditorTitle")&&(a=e.getElementById("poiEditorTitle").value);var o=e.getElementById("poiEditorPosition").value.split(",");console.log(o),o[0]=Number(o[0]),o[1]=Number(o[1]);var n=e.getElementById("metaEditor");for(r=0;r<n.rows.length;r++)n.rows[r].cells[1].childNodes[0].dataset.type&&("latMetaCol"==n.rows[r].cells[1].childNodes[0].dataset.type?i[r]=o[0]+"":"lngMetaCol"==n.rows[r].cells[1].childNodes[0].dataset.type?i[r]=o[1]+"":"titleMetaCol"==n.rows[r].cells[1].childNodes[0].dataset.type&&(i[r]=a));return{title:a,geoPos:o,metadata:i,href:t}}#Bi(e,t,i){var s=this.#Kt.uiDoc,r=this.#o.getMouseXY(e),a=this.#o.screen2Geo(r.x,r.y);if(console.log("XY:",r," latlng:",a," form:",s.getElementById("poiEditorPosition")),s.getElementById(t).value=this.#o.numberFormat(a.lat)+","+this.#o.numberFormat(a.lng),i?(this.#xi({title:i.title,geoPos:[a.lat,a.lng],metadata:i.metadata,href:i.href},this.#Kt.editingLayerId,i.id),this.#Kt.toolsCbFunc&&this.#Ri(this.#Kt.toolsCbFunc,!0,this.#Kt.toolsCbFuncParam),this.#o.refreshScreen()):this.#ki.setCursorGeo(a),console.log("setPoiRegPosition: copy lat lng to meta"),s.getElementById("metaEditor"))for(var o=s.getElementById("metaEditor"),n=0;n<o.rows.length;n++)console.log(o.rows[n].cells[1].childNodes[0]),o.rows[n].cells[1].childNodes[0].dataset.type&&("latMetaCol"==o.rows[n].cells[1].childNodes[0].dataset.type?o.rows[n].cells[1].childNodes[0].value=this.#o.numberFormat(a.lat):"lngMetaCol"==o.rows[n].cells[1].childNodes[0].dataset.type&&(o.rows[n].cells[1].childNodes[0].value=this.#o.numberFormat(a.lng)))}#Vi(e,t){this.#Gi(),this.#Ni={targetTxtBoxId:e,directPutPoiParams:t},this.#Di(this.#Ui)}#Ni={};#Ui=function(e){this.#Bi(e,this.#Ni.targetTxtBoxId,this.#Ni.directPutPoiParams),this.#Gi()}.bind(this);#Gi(){this.#Ni={},this.#ni(this.#Ui)}#Ri(e,t,i){console.log("set cbf on callAfterRefreshed :",e,t,i),"function"==typeof e&&window.addEventListener("screenRefreshed",function(e,t,i){var s=function(){console.log("catch screenRefreshed call:",e," param:",t,i),window.removeEventListener("screenRefreshed",s,!1),e(t,i)}.bind(this);return s}.bind(this)(e,t,i),!1)}#ui(e){e.addEventListener("click",function(e){if(console.log("get PoiRegUiEvents: targetId:",e.target.id),"pointUI"==e.target.parentNode.id)console.log("pointUIev"),setTimeout(function(){this.#Vi("poiEditorPosition")}.bind(this),100);else if("iconselection"==e.target.parentNode.id){for(var t=0;t<e.target.parentNode.childNodes.length;t++)e.target.parentNode.childNodes[t].setAttribute("style","border-color:white");e.target.setAttribute("style","border-color:red");var i=e.target.getAttribute("property");console.log("selPoi:",i)}else if(0==e.target.id.indexOf("coordInputButton")){var s=Number(e.target.id.substring(16));console.log("coordInputButton event numb:",s),setTimeout(function(){this.#Vi("coordTextBox"+s,this.#Kt.poiParams[s])}.bind(this),100)}else if(0==e.target.id.indexOf("cernterRegButton")){s=Number(e.target.id.substring(16));var r=this.#o.getCentralGeoCoorinates();console.log("map center coord Input Button event numb:",s,r,this.#Kt.poiParams),this.#Kt.uiDoc.getElementById("coordTextBox"+s).value=this.#o.numberFormat(r.lat)+","+this.#o.numberFormat(r.lng);var a=this.#Kt.poiParams[s];this.#xi({title:a.title,geoPos:[r.lat,r.lng],metadata:a.metadata,href:a.href},this.#Kt.editingLayerId,a.id),this.#Kt.toolsCbFunc&&this.#Ri(this.#Kt.toolsCbFunc,!0,this.#Kt.toolsCbFuncParam),this.#o.refreshScreen()}}.bind(this),!1)}#Fi=function(e){var t=this.#Kt.uiDoc,i=this.#o.getMouseXY(e),s=this.#o.screen2Geo(i.x,i.y);this.#ki.setCursorGeo(s),console.log("XY:",i," latlng:",s," form:",t.getElementById("poiEditorPosition")),t.getElementById("poiEditorPosition").value=this.#o.numberFormat(s.lat)+","+this.#o.numberFormat(s.lng),document.removeEventListener("click",this.#Fi,!1),console.log("setPoiPosition: copy lat lng to meta");for(var r=t.getElementById("metaEditor"),a=0;a<r.rows.length;a++)console.log(r.rows[a].cells[1].childNodes[0]),r.rows[a].cells[1].childNodes[0].dataset.type&&("latMetaCol"==r.rows[a].cells[1].childNodes[0].dataset.type?r.rows[a].cells[1].childNodes[0].value=this.#o.numberFormat(s.lat):"lngMetaCol"==r.rows[a].cells[1].childNodes[0].dataset.type&&(r.rows[a].cells[1].childNodes[0].value=this.#o.numberFormat(s.lng)))}.bind(this);#vi(e){e.getElementById("poiEditor").addEventListener("click",function(e){if(console.log("PoiUiEvent: targetId:",e.target.id),"pointUI"===e.target.id)console.log("pointUIev"),setTimeout(function(){document.addEventListener("click",this.#Fi,!1)}.bind(this),100);if("iconselection"==e.target.parentNode.id){for(var t=0;t<e.target.parentNode.childNodes.length;t++)e.target.parentNode.childNodes[t].setAttribute("style","border-color:white");e.target.setAttribute("style","border-color:red");var i=e.target.getAttribute("property");console.log("selPoi:",i)}}.bind(this),!1)}#Ai=function(){var e,t,i,s=!0,r=[],a="rgba(255,127,0,1.0)",o="rgba(255,0,0,1.0)",n=3,l=function(){a=this.#Kt.editingStyle.fill,o=this.#Kt.editingStyle.stroke,n=this.#Kt.editingStyle.strokeWidth;var s=.6;(this.#Kt.polyCanvasOpacity&&(s=this.#Kt.polyCanvasOpacity),document.getElementById("PolyEditCanvas"))?e=document.getElementById("PolyEditCanvas"):(e=document.createElement("canvas"),i=this.#o.getMapCanvasSize(),e.width=i.width,e.height=i.height,e.id="PolyEditCanvas",e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.zIndex="20",e.style.opacity=s,this.#qt.mapCanvas.appendChild(e));(t=e.getContext("2d")).globalAlpha=1,t.lineWidth=n,t.strokeStyle=o,t.fillStyle=a,t.lineCap="round",t.lineJoin="round",document.addEventListener("screenRefreshed",d),document.addEventListener("zoomPanMap",d)}.bind(this);var h=function(e){var t={lat:e.lat,lng:e.lng,style:{strokeWidth:this.#Kt.editingStyle.strokeWidth,strokeColor:this.#Kt.editingStyle.stroke,fillColor:this.#Kt.editingStyle.fill}};r.push(t)}.bind(this),g=function(e){var t={lat:e.lat,lng:e.lng,floodFill:!0,style:{color:this.#Kt.editingStyle.stroke}};r.push(t),d()}.bind(this);var d=function(){if(l(),t.clearRect(0,0,i.width,i.height),0!=r.length){var e,h=!0,g=[];r[0].style||(r[0].style={strokeWidth:n,strokeColor:o,fillColor:a});for(var d=0;d<r.length;d++){var c=this.#o.geo2Screen(r[d].lat,r[d].lng);if(c.x=Math.floor(c.x),c.y=Math.floor(c.y),r[d].floodFill){var m=y(r[d].style.color);g.push({floodFill:!0,point:c,color:m})}else r[d].style&&(0==h?s&&e.closePath():h=!1,e=new Path2D,g.push({path:e,style:r[d].style})),e.lineTo(c.x,c.y)}for(var v of g)if(v.floodFill){I(v.point.x,v.point.y,v.color,-255)}else t.fillStyle=v.style.fillColor,t.strokeStyle=v.style.strokeColor,t.lineWidth=v.style.strokeWidth,t.stroke(v.path);1==r.length&&p(0),this.#Kt.insertPointsIndex>=0?"POLYLINE"==this.#Kt.editingMode&&this.#Kt.insertPointsIndex==r.length?p(this.#Kt.insertPointsIndex-1):"POLYLINE"==this.#Kt.editingMode&&0==this.#Kt.insertPointsIndex?p(0):(0==this.#Kt.insertPointsIndex?p(r.length-1):p(this.#Kt.insertPointsIndex-1),u(this.#Kt.insertPointsIndex)):this.#Kt.selectedPointsIndex>=0&&p(this.#Kt.selectedPointsIndex)}}.bind(this);function c(){r=[]}var p=function(e){if(e>=0&&e<r.length){var i=this.#o.geo2Screen(r[e].lat,r[e].lng);console.log("hilightPoint:",e," XY:",i),t.lineWidth=2*n,t.strokeStyle="rgba(0,255,0,1.0)",t.fillStyle="rgba(0,255,0,1.0)",t.beginPath(),t.arc(i.x,i.y,2*n,0,2*Math.PI,!0),t.fill(),t.stroke(),t.lineWidth=n,t.strokeStyle=o,t.fillStyle=a}}.bind(this),u=function(e){var i,s;console.log("polyCanvas hilightLine:",e," totalPoints:",r.length),e>0&&e<r.length?(i=this.#o.geo2Screen(r[e-1].lat,r[e-1].lng),s=this.#o.geo2Screen(r[e].lat,r[e].lng)):0!=e&&e!=r.length||r.length>0&&(i=this.#o.geo2Screen(r[r.length-1].lat,r[r.length-1].lng),s=this.#o.geo2Screen(r[0].lat,r[0].lng)),i&&(t.lineWidth=2*n,t.strokeStyle="rgba(0,255,0,1.0)",t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.closePath(),t.stroke(),t.lineWidth=n,t.strokeStyle=o,t.fillStyle=a)}.bind(this);var m={blue:65535,red:4278190335};function y(e){if(m[e])return m[e];return 255+(e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,t,i,s)=>"#"+t+t+i+i+s+s).substring(1).match(/.{2}/g).reduce(function(e,t){return(e<<8)+parseInt(t,16)},0)<<8)}function v(e,t,i){if(t<0||i<0||t>=e.width||i>=e.height)return NaN;var s=e.data,r=4*(i*e.width+t);return(255&s[r+0])<<24|(255&s[r+1])<<16|(255&s[r+2])<<8|255&s[r+3]}function f(e,t,i,s){var r=4*(i*e.width+t),a=e.data;a[r+0]=s>>>24&255,a[r+1]=s>>>16&255,a[r+2]=s>>>8&255,a[r+3]=s>>>0&255}function b(e,t,i){return i<0?!((255&e)>=-i):function(e,t){if(isNaN(e)||isNaN(t))return 1/0;var i=(e>>>24&255)-(t>>>24&255),s=(e>>>16&255)-(t>>>16&255),r=(e>>>8&255)-(t>>>8&255),a=(e>>>0&255)-(t>>>0&255);return i*i+s*s+r*r+a*a}(e,t)<=i}function I(i,s,r,a){for(var o,n,l,h,g,d,c=t,p=e,u=c.getImageData(0,0,p.width,p.height),m=[],y=0;y<p.width;y++)m[y]=[];var I=v(u,i,s);for(a>0&&(a*=a),h=[[i,s]],m[i][s]=!0;o=h.pop();)if(b(v(u,g=o[0],d=o[1]),I,a)){for(f(u,g,d,r),n=l=g;n>0&&b(v(u,n-1,d),I,a)&&!m[--n][d];)f(u,n,d,r);for(;l<u.width-1&&b(v(u,l+1,d),I,a)&&!m[++l][d];)f(u,l,d,r);for(g=n;g<=l;g++)d>0&&b(v(u,g,d-1),I,a)&&(m[g][d-1]||(h.push([g,d-1]),m[g][d-1]=!0)),d<p.height-1&&b(v(u,g,d+1),I,a)&&(m[g][d+1]||(h.push([g,d+1]),m[g][d+1]=!0))}c.putImageData(u,0,0,0,0,p.width,p.height)}return{addPoint:function(e){r.push(e),d()},clearPoints:c,floodFill:g,getImageData:function(){return t.getImageData(0,0,e.width,e.height)},getPoints:function(){return r},movePoint:h,removeCanvas:function(){if(c(),console.log("removeCanvas"),document.removeEventListener("screenRefreshed",d,!1),document.removeEventListener("zoomPanMap",d,!1),document.getElementById("PolyEditCanvas")){var e=document.getElementById("PolyEditCanvas");e.parentNode.removeChild(e)}},setPoints:function(e,t){if(e[0].lat)r=e;else{r=[];for(var i=0;i<e.length;i++)r.push({lat:e[i][0],lng:e[i][1]})}t&&(s=t),d()},setPolygonMode:function(e){s=e},undo:function(){for(var e=r.length-1;e>=0;e--)if(r[e].style){r.splice(e);break}d()},updateCanvas:d}}.bind(this)();#ki=function(){var e;var t=function(t){if(console.log("updateCursor:",e,"  ev:",t),document.getElementById("centerSight")){var i=this.#o.geo2Screen(e.lat,e.lng);if(document.getElementById("POIeditCursor"))s=document.getElementById("POIeditCursor");else{var s=document.createElement("img");s.style.position="absolute",s.style.width="10",s.style.height="10",s.id="POIeditCursor";var r=document.getElementById("centerSight");s.src=r.src,this.#qt.mapCanvas.appendChild(s)}s.style.zIndex="100",s.style.left=i.x-6+"px",s.style.top=i.y-6+"px"}}.bind(this);return{setCursorGeo:function(i){console.log("setCursorGeo :",e,i),e=i,t(),document.addEventListener("screenRefreshed",t),document.addEventListener("zoomPanMap",t)},removeCursor:function(){if(document.removeEventListener("screenRefreshed",t,!1),document.removeEventListener("zoomPanMap",t,!1),document.getElementById("POIeditCursor")){var e=document.getElementById("POIeditCursor");e.parentNode.removeChild(e)}}}}.bind(this)();#Hi(e){for(var t=e.childNodes,i=0;i<t.length;i++)"img"===t[i].nodeName?addEventListener("click",function(e){cdonsole.log("click:",e)}.bind(this)):"div"===t[i].nodeName&&this.#Hi(t[i])}#zi(e){var t=e.element,i=e.docId,s=this.#o.getPoiPos(t),r=t.getAttribute("xlink:href"),a=t.getAttribute("content");a=a&&""!=a?a.split(","):[];var o=t.getAttribute("xlink:title");return{position:this.#o.SVG2Geo(Number(s.x),Number(s.y),this.#si[i].CRS),href:r,metaData:a,title:o}}#ji(e){console.log("getPolyProps:",e,e.element.nodeName);var t,i=e.element,s=e.docId;i.getAttribute("content")&&(t=i.getAttribute("content").split(","));var r,a=i.getAttribute("xlink:title");if("path"==e.element.nodeName){var o=this.#Wi(this.#Yi(e.element.getAttribute("d")));r=this.#Xi(o,this.#si[s].CRS)}else"polygon"==e.element.nodeName||e.element.nodeName;return{position:r,metaData:t,title:a}}#Yi(e){return e=(e=(e=(e=(e=(e=(e=(e=e.replace(/,/gm," ")).replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2")).replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([0-9])([+\-])/gm,"$1 $2")).replace(/(\.[0-9]*)(\.)/gm,"$1 $2")).replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 "),e=this.#Zi(this.#qi(e)).split(" ")}#qi(e){return e.replace(/[\s\r\t\n]+/gm," ")}#Zi(e){return e.replace(/^\s+|\s+$/g,"")}#Wi(e){for(var t=[],i="M",s=!1,r=0,a=0,o=0,n=0,l=0,h=e[l];l<e.length;){switch(h){case"M":++l,r=Number(e[l]),++l,o=r,n=a=Number(e[l]);var g=[d=[r,a]];t.push(g),h="L";break;case"m":++l,r+=Number(e[l]),++l,o=r,n=a+=Number(e[l]);g=[d=[r,a]];t.push(g),h="l";break;case"L":++l,r=Number(e[l]),++l;var d=[r,a=Number(e[l])];t[t.length-1].push(d);break;case"l":++l,r+=Number(e[l]),++l;d=[r,a+=Number(e[l])];t[t.length-1].push(d);break;case"A":++l,++l,++l,++l,++l,++l,++l;break;case"Z":case"z":d=[r=o,a=n];t[t.length-1].push(d),t.type="POLYGON";break;default:s=!0}s?(h=i,s=!1,--l):(i=h,h=e[++l])}return t}#Xi(e,t){for(var i,s,r=[],a=0;a<e.length;a++)if(e[0]instanceof Array){s=[];for(var o=0;o<e[a].length;o++)i=this.#o.SVG2Geo(e[a][o][0],e[a][o][1],t),s.push([i.lat,i.lng]);r.push(s)}else i=this.#o.SVG2Geo(e[a][0],e[a][1],t),r.push([i.lat,i.lng]);return e.type&&(r.type=e.type),r}#_i(e){if(console.log("called setTargetObject:",e),console.log(this.#Kt.editingLayerId,e.docId,e),this.#Kt.editingLayerId===e.docId||this.#Kt.editingLayerId===this.#si[e.docId].rootLayer){var t=e.element;console.log(t.nodeName,t.getAttribute("fill"),this.#Kt.editingMode,this.#Kt.genericModePanel),this.#Kt.genericMode?.panel?this.#Ki(e):(console.log("setTargetObject:",t),"use"==t.nodeName&&"POI"==this.#Kt.editingMode?(this.#Ji(t.getAttribute("iid")),this.#Qi(e)):"path"!=t.nodeName&&"polygon"!=t.nodeName&&"polyline"!=t.nodeName||"POLYGON"!=this.#Kt.editingMode&&"POLYLINE"!=this.#Kt.editingMode||this.#$i(e))}this.#o.refreshScreen()}#es;#Ji(e){console.log("hilightPOI  :  targetPOI ID:",e," poiIcon:",document.getElementById(e)),document.getElementById(e)&&(document.getElementById(e).style.backgroundColor="#FFFF00",this.#es&&this.#es!=e&&document.getElementById(this.#es)&&(document.getElementById(this.#es).style.backgroundColor=""),this.#es=e)}#Qi(e){var t=this.#zi(e),i=this.#Kt.uiPanel.ownerDocument;i.documentElement,this.#Kt.modifyTargetElement=e.element,i.getElementById("pepdel").disabled=!1,i.getElementById("editMode").innerHTML="modifyObject",i.getElementById("metaEditor"),i.getElementById("poiEditorPosition").value=this.#o.numberFormat(t.position.lat)+","+this.#o.numberFormat(t.position.lng),i.getElementById("poiEditorTitle")&&(i.getElementById("poiEditorTitle").value=t.title);for(var s=0;s<t.metaData.length;s++)i.getElementById("meta"+s).value=t.metaData[s];var r=i.getElementById("iconselection").childNodes;for(s=0;s<r.length;s++)r[s].style.borderColor="white";i.getElementById("symbol"+t.href).style.borderColor="red",this.#o.geo2Screen(t.position.lat,t.position.lng),this.#ki.setCursorGeo(t.position)}#$i(e){var t=this.#ji(e),i=this.#Kt.uiPanel.ownerDocument;i.documentElement,this.#Kt.modifyTargetElement=e.element,i.getElementById("pepdel").disabled=!1,i.getElementById("editMode").innerHTML="modifyObject",i.getElementById("metaEditor");var s=i.getElementById("polyEditorPosition");if(console.log(t.position,"  props:",t,"   svgTarget:",e),t.position.type&&"POLYGON"===t.position.type){this.#Kt.editingMode="POLYGON";var r=t.position[0].length-1}else{this.#Kt.editingMode="POLYLINE";r=t.position[0].length}for(var a=[],o=0;o<r;o++)a.push({lat:t.position[0][o][0],lng:t.position[0][o][1]});if(this.#Ei(s,a),console.log("points:",a,"  docId:",e.docId,"  metaSchema:",this.#pi(e.docId)),this.#Ai.setPoints(a),this.#Ai.updateCanvas(),i.getElementById("poiEditorTitle")&&t.title&&(i.getElementById("poiEditorTitle").value=t.title),t.metaData&&t.metaData.length&&this.#pi(e.docId))for(o=0;o<t.metaData.length;o++)i.getElementById("meta"+o).value=t.metaData[o]}#Ei(e,t){for(var i="",s=0;s<t.length;s++)i+='<tr><td><input type="button" id="pointIns'+s+'" value="INS"/></td><td><input id="point'+s+'" style="width:200px" type="button" value="'+this.#o.numberFormat(t[s].lat)+", "+this.#o.numberFormat(t[s].lng)+'"/></td></tr>';i+='<tr><td><input type="button" id="pointAdd" value="ADD"/></td></tr>',e.innerHTML=i}#ts(e,t,i,s,r,a){console.log("initPolygonTools : isPolylineMode:",r),this.#ci(e);var o=e.ownerDocument;console.log("called initPolygonTools: docId:",t),this.#o.setRootLayersProps(t,!0,!0)||console.log("This ID is not layer (child document of layer).. thus you can only add new elements ( not edit existing element) ");var n=!1;1==a?.bufferOption&&(n=!0);var l=!1;1==a?.returnSvgElement&&(l=!0);var h=!1;1==a?.useXlinkTitle&&(h=!0),this.#ii=this.#o.getSvgImages(),this.#si=this.#o.getSvgImagesProps(),this.#o.getSymbols(this.#ii[t]);var g=this.#pi(t),d='<div id="polyEditor" style="width:300px;height:100px;overflow:auto"><table id="polyEditorPosition"><tr><td><input type="button" id="pointAdd" value="ADD"/></td></tr></table></div>';if(h&&(d+='<table><tr><td>title</td><td><input type="text" id="poiEditorTitle" value="title"/></td></tr></table>'),console.log(" init metaEditor table... metaSchema:",g),d+='<table id="metaEditor">',g)for(var c=0;c<g.length;c++){h&&"title"==g[c]?d+="<tr><td>"+g[c]+'</td><td><input id="meta'+c+'" type="text" data-type="titleMetaCol" disabled="disabled" value="title"/></td></tr>':"latitude"==g[c]||"lat"==g[c]||"緯度"==g[c]?d+="<tr><td>"+g[c]+'</td><td><input id="meta'+c+'" type="text" disabled="disabled" value="numberFormat(latlng.lat )"/></td></tr>':"longitude"==g[c]||"lon"==g[c]||"lng"==g[c]||"経度"==g[c]?d+="<tr><td>"+g[c]+'</td><td><input id="meta'+c+'" type="text" disabled="disabled" value="numberFormat(latlng.lng )"/></td></tr>':d+="<tr><td>"+g[c]+'</td><td><input id="meta'+c+'" type="text" value=""/></td></tr>'}d+="</table>",n&&(d+='<div><input type="text" id="objectBufferLength"  value=""  placeholder="バッファ半径[m]"></input></div>'),d+='<div id="editConf"><input type="button" id="pepok" value="決定"/><input type="button" id="pepng" value="キャンセル"/><input type="button" id="pepdel" disabled value="削除"/><span id="editMode">newObject</span></div>',e.innerHTML=d;var p="POLYGON";return r?(p="POLYLINE",this.#Ai.setPolygonMode(!1),console.log("polyMode:",p)):this.#Ai.setPolygonMode(!0),this.#di({uiPanel:e,editingLayerId:t,editingMode:p,uiDoc:o,editingGraphicsElement:!1,modifyTargetElement:null,selectedPointsIndex:-1,insertPointsIndex:-1,editingStyle:structuredClone(this.#$t),shapeStyle:structuredClone(this.#Qt),returnSvgElement:l},!0),this.#yi(this.#Kt.editingStyle,a?.editingStyle),this.#yi(this.#Kt.shapeStyle,a?.shapeStyle),i?(this.#Kt.toolsCbFunc=i,this.#Kt.toolsCbFuncParam=s):(this.#Kt.toolsCbFunc=null,this.#Kt.toolsCbFuncParam=null),n&&(this.#Kt.bufferOption=!0),this.#is(o,t),this.#fi(o,t),this.#bi(o,t),this.#Kt}#yi(e,t){if(t){if(t.opacity&&0==isNaN(t.opacity)){var i=Number(t.opacity);i>0&&i<=1&&(e.opacity=i)}if(t.strokeWidth&&0==isNaN(t.strokeWidth)){var s=Number(t.strokeWidth);s>0&&s<=100&&(e.strokeWidth=s)}t.fill&&"string"==typeof t.fill&&(e.fill=t.fill),t.stroke&&"string"==typeof t.stroke&&(e.stroke=t.stroke)}}#di(e,t){this.#ss(e);var i=!1;for(var s in console.log("uiMapping:",this.#Kt),this.#Kt.genericMode&&(i=this.#Kt.genericMode),this.#Kt)delete this.#Kt[s];for(var s in e)this.#Kt[s]=e[s];t&&i&&(this.#Kt.genericMode=i),console.log(this.#Kt)}#ss(e){var t=e.editingLayerId,i=e.uiDoc;if(console.log("Authoring: initGlobalVars :",this.#Jt,"  layerId:",t," uiDoc:",i),!t||!i)return console.error("No editingLayerId or uiDoc ",t,i),!1;this.#rs(i),this.#Jt[t]?this.#Kt=this.#Jt[t]:(this.#Kt={},this.#Jt[t]=this.#Kt,i.addEventListener("appearFrame",function(){console.log("change uiMapping var : ",t,this.#Jt),this.#Kt=this.#Jt[t],this.#as={x:0,y:0}}.bind(this)),i.addEventListener("closeFrame",function(){console.log("delete uiMappingGloval var"),delete this.#Jt[t]}.bind(this))),this.#as={x:0,y:0}}#rs(e){e.removeEventListener("hideFrame",this.#ri,!1),e.removeEventListener("closeFrame",this.#ri,!1),e.removeEventListener("appearFrame",this.#hi,!1),e.addEventListener("hideFrame",this.#ri),e.addEventListener("closeFrame",this.#ri),e.addEventListener("appearFrame",this.#hi)}#os(e){console.log("testTouch:",e,e.changedTouches[0]),console.log(e.changedTouches[0].pageX,e.changedTouches[0].pageY)}#as={x:0,y:0};#Si=!1;#li=function(e){var t=this.#o.getMouseXY(e);console.log("editPolyPoint:",t),this.#as.x==t.x&&this.#as.y==t.y&&0==this.#Si&&this.#ni(this.#li),this.#as=t;var i=this.#o.screen2Geo(t.x,t.y),s=this.#Ai.getPoints();if(console.log("uiMapping:",this.#Kt),this.#Kt.insertPointsIndex>=0&&this.#Kt.insertPointsIndex<s.length){console.log("insert point:",this.#Kt.insertPointsIndex);for(var r=[],a=0;a<s.length;a++)a==this.#Kt.insertPointsIndex&&r.push(i),r.push(s[a]);console.log("insert points::::",r),this.#Ai.setPoints(r),this.#Kt.insertPointsIndex=this.#Kt.insertPointsIndex+1}else this.#Kt.selectedPointsIndex>=0?(console.log("replace point:",this.#Kt.selectedPointsIndex),s[this.#Kt.selectedPointsIndex]=i,this.#Ai.setPoints(s),removePointEvents(this.#li)):(console.log("add last point:",this.#Kt.insertPointsIndex),this.#Ai.addPoint(i),this.#Kt.insertPointsIndex=s.length);s=this.#Ai.getPoints(),this.#Kt.selectedPointsIndex=-1,this.#Ai.updateCanvas(),console.log("updatePointListForm:",s),this.#Ei(this.#Kt.uiDoc.getElementById("polyEditorPosition"),s)}.bind(this);#Di(e){var t=this.#qt.mapCanvas;t.addEventListener("click",e,!1),t.addEventListener("touchend",e,!1)}#ni(e){var t=this.#qt.mapCanvas;t.removeEventListener("click",e,!1),t.removeEventListener("touchend",e,!1)}#is(e){e.getElementById("polyEditor").addEventListener("click",function(t){console.log("PoiUiEvent: targetId:",t.target.id),0==t.target.id.indexOf("point")?(this.#Si=!1,this.#ns(t.target,e),this.#Kt.editingGraphicsElement||(this.#Kt.editingGraphicsElement=!0),(this.#Kt.selectedPointsIndex>=0||this.#Kt.insertPointsIndex>=0)&&console.log("FOUCUS SELECTION"),this.#Si=!0,setTimeout(function(){this.#Di(this.#li)}.bind(this),30)):(console.log("should be clear selection"),this.#Si=!1,this.#Kt.selectedPointsIndex=-1,this.#Kt.insertPointsIndex=-1,this.#Ai.updateCanvas(),e.getElementById("pepdel").disabled=!1)}.bind(this),!1)}#ns(e,t){var i,s=!1;if(t.getElementById("pepdel").disabled=!0,0==e.id.indexOf("pointAdd")){s=!0,console.log("hilightEditingPoint pointAdd:",this.#Ai.getPoints().length);var r=this.#Ai.getPoints().length;r>=0&&(i=r)}else 0==e.id.indexOf("pointIns")?(s=!0,i=Number(e.id.substring(8))):(t.getElementById("pepdel").disabled=!1,i=Number(e.id.substring(5)));var a=-1,o=-1;s?o=i:a=i,console.log("insertIndex:",o,"  selectedIndex:",a),this.#Kt.selectedPointsIndex=a,this.#Kt.insertPointsIndex=o,this.#Ai.updateCanvas()}#ls(e,t,i){var s=0,r=-1;if(0==t)return[0,0];0==e&&(r=0);for(var a=0;a<i.length;a++){if(t>0){if(a>0&&"\n"==i.charAt(a-1)&&t==s)return[a-1,a-1];if(a==i.length-1)return[a,a]}if("\n"==i.charAt(a)&&++s,t<0&&e>=0){if(s==e)r<0&&(r=a+1);else if(s>e)return[r,a];if(a==i.length-1&&r>=0)return[r,a+1]}}}#ci(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t])}#hs(){return!!this.#Kt&&!!this.#Kt.editingGraphicsElement}#pi(e){var t=null;return this.#ii[e].documentElement.getAttribute("property")&&this.#ii[e].documentElement.getAttribute("property").length>0&&(t=this.#ii[e].documentElement.getAttribute("property").split(",")),t}#gs(e,t,i,s,r){console.log("initFreeHandTool :"),this.#ci(e);var a=e.ownerDocument;console.log("called initFreeHandTool: docId:",t),this.#o.setRootLayersProps(t,!0,!0)||console.log("This ID is not layer (child document of layer).. thus you can only add new elements ( not edit existing element) "),this.#ii=this.#o.getSvgImages(),this.#si=this.#o.getSvgImagesProps();var o="",n="",l=!1;r?.outlineMode?l=r.outlineMode:(o='<input type="range" min="0" max="7" step="1" value="2" id="freeHandWidth"></input><span id="freeHandWidthMsg">4px</span>',n='<input type="checkbox" id="freeHandFloodFill"/><label for="freeHandFloodFill" id="freeHandFloodFillLable">Fill</label>');var h=`\n\t<div id="freeHandEditor" style="width:300px;height:100px;overflow:auto">\n\t\t<input type="button" id="freeHandAdd" value="ADD"/>\n\t\t<span id="editConf"><input type="button" id="pepok" value="END" style="display:none" /></span>\n\t\t<input type="button" id="freeHandUndo" value="UNDO"/>\n\t\t${o}\n\t\t<input type="color" id="freeHandColor" value="#0000ff" >\n\t\t${n}\n\t</div>`;return e.innerHTML=h,this.#di({uiPanel:e,editingLayerId:t,editingMode:"FREEHAND",uiDoc:a,editingGraphicsElement:!1,editingStyle:structuredClone(this.#Qt),shapeStyle:structuredClone(this.#Qt),outlineMode:l,polyCanvasOpacity:.8},!0),i?(this.#Kt.toolsCbFunc=i,this.#Kt.toolsCbFuncParam=s):(this.#Kt.toolsCbFunc=null,this.#Kt.toolsCbFuncParam=null),this.#ds(a,t),this.#bi(a,t),this.#Ai.updateCanvas(),this.#Kt}#ds(e,t){console.log("setFreeHandEvent:",e,e.defaultView),e.defaultView;var i=document.getElementById("mapCanvasWrapper").parentElement;e.getElementById("freeHandAdd").addEventListener("click",function(e){e.target.style.display="none",this.#Kt.uiPanel.ownerDocument.getElementById("pepok").style.display="",this.#Ai.clearPoints(),i.addEventListener("mousemove",this.#cs,{capture:!0}),i.addEventListener("mousedown",this.#cs,{capture:!0}),i.addEventListener("mouseup",this.#cs,{capture:!0}),i.addEventListener("touchmove",this.#cs,{capture:!0}),i.addEventListener("touchstart",this.#cs,{capture:!0}),i.addEventListener("touchend",this.#cs,{capture:!0}),this.#Kt.editingGraphicsElement=!0,this.#Ai.setPolygonMode(!1),this.#ps(.5),this.#o.refreshScreen()}.bind(this)),e.getElementById("freeHandUndo").addEventListener("click",function(e){var i;this.#Kt.editingGraphicsElement?(console.log("Delete last drawing block"),this.#Ai.undo()):(console.log("Delete last image element"),(i=this.#Kt.outlineMode?this.#ii[t].getElementsByTagName("g"):this.#ii[t].getElementsByTagName("image")).length>0&&(i[i.length-1].parentElement.removeChild(i[i.length-1]),this.#o.refreshScreen()))}.bind(this)),e.getElementById("freeHandColor").addEventListener("input",function(e){var t=e.target.value;this.#Kt.editingStyle.stroke=t}.bind(this)),this.#Kt.outlineMode||(e.getElementById("freeHandWidth").addEventListener("input",function(t){var i=Math.pow(2,t.target.value);e.getElementById("freeHandWidthMsg").innerText=`${i}px`,this.#Kt.editingStyle.strokeWidth=i}.bind(this)),e.getElementById("freeHandFloodFill").addEventListener("change",function(e){if(!this.#Kt.editingGraphicsElement)return console.log("no editingGraphicsElement exit"),void(e.target.checked=!1);e.target.checked?this.#Kt.FloodFillMode=!0:this.#Kt.FloodFillMode=!1}.bind(this)))}#Ci(e,t){if("FREEHAND"==this.#Kt.editingMode){var i,s=this.#ii[t];if(this.#Kt.outlineMode){var r=null,a=0;i=s.createElement("g");var o=this.#Ai.getPoints(),n="";for(var l of o){l.style&&(r&&(r.setAttribute("d",n),i.appendChild(r),++a),(r=s.createElement("path")).setAttribute("fill","none"),r.setAttribute("stroke",l.style.strokeColor),r.setAttribute("stroke-width",l.style.strokeWidth),r.setAttribute("vector-effect","non-scaling-stroke"),n="M");var h=this.#o.Geo2SVG(l.lat,l.lng,this.#si[t].CRS);n+=h.x+","+h.y+" "}r&&(r.setAttribute("d",n),i.appendChild(r),++a),a>0?s.documentElement.appendChild(i):i=null}else{var g=this.#us(t),d=this.#ms(g.layerImg,g.layerImgSize.width,g.layerImgSize.height);(i=s.createElement("image")).setAttribute("xlink:href",d),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("x",g.layerViewBox.x),i.setAttribute("y",g.layerViewBox.y),i.setAttribute("width",g.layerViewBox.width),i.setAttribute("height",g.layerViewBox.height),s.documentElement.appendChild(i)}return i}}#ms(e,t,i){var s=document.createElement("canvas");return s.width=t,s.height=i,s.getContext("2d").putImageData(e,0,0),s.toDataURL()}#us(e){var t=this.#Ai.getImageData(),i=this.#o.getMapCanvasSize(),s=this.#o.getRootViewBox(),r=this.#si.root.CRS,a=this.#si[e].CRS,o=this.#o.getConversionMatrixViaGCS(r,a),n=this.#o.getConversionMatrixViaGCS(a,r),l=this.#o.getTransformedBox(s,o),h={width:i.width,height:i.height},g=new ImageData(h.width,h.height);console.log(o,n);for(var d=0;d<h.height;d++)for(var c=d/h.height*l.height+l.y,p=0;p<h.width;p++){var u=p/h.width*l.width+l.x,m=svgMap.transform(u,c,n),y=Math.round((m.x-s.x)*(i.width/s.width)),v=Math.round((m.y-s.y)*(i.height/s.height));if(y>=0&&y<i.width&&v>=0&&v<i.height){var f=4*(y+v*i.width),b=4*(p+d*h.width);g.data[b]=t.data[f],g.data[b+1]=t.data[f+1],g.data[b+2]=t.data[f+2],g.data[b+3]=t.data[f+3]}}return{layerImg:g,layerImgSize:h,layerViewBox:l}}#oi(){if("FREEHAND"==this.#Kt.editingMode){this.#Ai.removeCanvas(),this.#ps(),this.#Kt.editingGraphicsElement=!1;var e=document.getElementById("mapCanvasWrapper").parentElement;e.removeEventListener("mousemove",this.#cs,{capture:!0}),e.removeEventListener("mousedown",this.#cs,{capture:!0}),e.removeEventListener("mouseup",this.#cs,{capture:!0}),e.removeEventListener("touchmove",this.#cs,{capture:!0}),e.removeEventListener("touchstart",this.#cs,{capture:!0}),e.removeEventListener("touchend",this.#cs,{capture:!0}),this.#Kt.uiPanel.ownerDocument.getElementById("freeHandAdd").style.display="",this.#Kt.uiPanel.ownerDocument.getElementById("pepok").style.display="none"}}#ps(e){var t=this.#Kt.editingLayerId,i=this.#ii[t].getElementsByTagName("image");if(e&&1!=e)for(var s of i)s.setAttribute("opacity",e);else for(var s of i)s.removeAttribute("opacity")}#cs=function(e){var t=this.#o.getMouseXY(e),i=this.#o.screen2Geo(t.x,t.y),s=e.type;e.stopImmediatePropagation(),e.preventDefault(),"mousedown"==s||"touchstart"==s?1==this.#Kt.FloodFillMode?(this.#Ai.floodFill(i),this.#Kt.FloodFillMode=!1,this.#Kt.outlineMode||(this.#Kt.uiDoc.getElementById("freeHandFloodFill").checked=!1)):(this.#Ai.movePoint(i),this.#Kt.drawing=!0):"mouseup"==s||"touchend"==s?this.#Kt.drawing=!1:this.#Kt.drawing&&this.#Ai.addPoint(i)}.bind(this);#ys(){var e;this.#Kt.genericMode?.panel?(this.#vs(uiMapping.uiDoc),e=this.#Kt.genericMode.panel,delete this.#Kt.genericMode.panel):e=this.#Kt.uiPanel,this.#fs(e)}#fs(e){this.#ri(),e&&e.nodeType&&1===e.nodeType&&this.#ci(this.#Kt.uiPanel)}#bs="genericAuthoringToolModeDiv";#Is="genericAuthoringToolMainDiv";#Ps="pointGenericToolRadioButton";#Ss="polylineGenericToolRadioButton";#xs="polygonGenericToolRadioButton";#Ms="bufferedPointGenericToolRadioButton";#ws="bufferedPolylineGenericToolRadioButton";#Cs="bufferedPolygonGenericToolRadioButton";#Ls(e,t,i,s,r){this.#ci(e);var a=e.ownerDocument;this.#di({genericMode:{panel:e,editingStyle:structuredClone(this.#$t),shapeStyle:structuredClone(this.#Qt)},editingLayerId:t,uiDoc:a,toolsCbFunc:i,toolsCbFuncParam:s}),this.#yi(this.#Kt.genericMode.editingStyle,r?.editingStyle),this.#yi(this.#Kt.genericMode.shapeStyle,r?.shapeStyle);var o=a.createElement("div");o.id=this.#bs,r?.useXlinkTitle&&(this.#Kt.genericMode.useXlinkTitle=!0),e.appendChild(o);var n=`\t<input type="radio" value="poi" id="${this.#Ps}" name="amode" checked></input><label for="${this.#Ps}">POINT</label>\n<input type="radio" value="polyline" id="${this.#Ss}" name="amode" ></input><label for="${this.#Ss}">POLYLINE</label>\n<input type="radio" value="polygon" id="${this.#xs}" name="amode" ></input><label for="${this.#xs}">POLYGON</label>`;r?.withBufferedTools&&(this.#Kt.genericMode.withBufferedTools=!0,n+=`\t<input type="radio" value="b_poi" id="${this.#Ms}" name="amode" ></input><label for="${this.#Ms}">CIRCLE</label>\n<input type="radio" value="b_polyline" id="${this.#ws}" name="amode" ></input><label for="${this.#ws}">Buffered POLYLINE</label>\n<input type="radio" value="b_polygon" id="${this.#Cs}" name="amode" ></input><label for="${this.#Cs}">Buffered POLYGON</label>`),o.insertAdjacentHTML("beforeend",n),a.getElementById(this.#Ps).addEventListener("change",this.#As),a.getElementById(this.#Ss).addEventListener("change",this.#As),a.getElementById(this.#xs).addEventListener("change",this.#As),a.getElementById(this.#Ms).addEventListener("change",this.#As),a.getElementById(this.#ws).addEventListener("change",this.#As),a.getElementById(this.#Cs).addEventListener("change",this.#As);var l=a.createElement("div");return l.id=this.#Is,e.appendChild(l),this.#As({target:{value:"poi"}}),this.#Kt}#vs(e){e.getElementById(this.#Ps).removeEventListener("change",this.#As,!1),e.getElementById(this.#Ss).removeEventListener("change",this.#As,!1),e.getElementById(this.#xs).removeEventListener("change",this.#As,!1),e.getElementById(this.#Ms).removeEventListener("change",this.#As,!1),e.getElementById(this.#ws).removeEventListener("change",this.#As,!1),e.getElementById(this.#Cs).removeEventListener("change",this.#As,!1)}#As=function(e){var t=e.target.value.toLowerCase(),i=this.#Kt.editingLayerId,s=this.#Kt.uiDoc,r=this.#Kt.toolsCbFunc,a=this.#Kt.toolsCbFuncParam;this.#fs(this.#Kt.uiPanel);var o={editingStyle:this.#Kt.genericMode.editingStyle,shapeStyle:this.#Kt.genericMode.shapeStyle};1==this.#Kt.genericMode.useXlinkTitle&&(o.useXlinkTitle=!0),0==t.indexOf("b_")&&(o.bufferOption=!0);var n=s.getElementById(this.#Is);switch(t){case"poi":s.getElementById(this.#Ps).checked=!0,this.#mi(n,i,r,a,!1,!1,o);break;case"polyline":s.getElementById(this.#Ss).checked=!0,this.#ts(n,i,r,a,!0,o);break;case"polygon":s.getElementById(this.#xs).checked=!0,this.#ts(n,i,r,a,!1,o);break;case"b_poi":s.getElementById(this.#Ms).checked=!0,this.#mi(n,i,r,a,!1,!1,o);break;case"b_polyline":s.getElementById(this.#ws).checked=!0,this.#ts(n,i,r,a,!0,o);break;case"b_polygon":s.getElementById(this.#Cs).checked=!0,this.#ts(n,i,r,a,!1,o)}}.bind(this);#Ki(e){console.log("switchGenericTool svgTarget:",e);var t,i,s=e.element,r=this.#Kt.genericMode,a=s.nodeName,o=s.getAttribute("fill");if("use"==a?t="POI":"polygon"==a?t="POLYGON":"polyline"==a?t="POLYLINE":"path"==a&&(t="none"==o?"POLYLINE":"POLYGON"),r?.withBufferedTools&&s.getAttribute("data-buffered")){switch((i={}).length=Number(s.getAttribute("data-buffered")),i.baseGeometry=JSON.parse(s.getAttribute("data-geometry")),i.baseGeometry.type.toLowerCase()){case"point":t="B_POI";break;case"linestring":t="B_POLYLINE";break;case"polygon":t="B_POLYGON"}e.element=this.#Es(s,i.baseGeometry)}var n=this.#Kt.editingMode;this.#Kt.bufferOption&&(n="B_"+n),t!=n&&(-1==t.indexOf("B_")&&n.indexOf(t)>=0||this.#As({target:{value:t}})),"POI"==t||"B_POI"==t?(this.#Ji(s.getAttribute("iid")),this.#Qi(e)):this.#$i(e),i&&this.#Kt.uiDoc.getElementById("objectBufferLength")&&this.#Kt.uiDoc.getElementById("objectBufferLength").setAttribute("value",i.length)}#Ti(e){this.#Kt.shapeStyle||(this.#Kt.shapeStyle=this.#Qt);var t=e.getAttribute("data-geometry");if(t){var i=JSON.parse(t),s=this.#Kt.uiDoc.getElementById("objectBufferLength");if(!(isNaN(s.value)||Number(s.value)<=0)){var r=Number(s.value);if(!(r<=0)){var a=e.getAttribute("xlink:title"),o=e.getAttribute("content"),n=this.#_t.getBufferedPolygon(i,r),l=e.ownerDocument.createElement("path");l.setAttribute("data-geometry",t),l.setAttribute("data-buffered",r),l.setAttribute("d",this.#Ts(n)),l.setAttribute("fill",this.#Kt.shapeStyle.fill),l.setAttribute("stroke",this.#Kt.shapeStyle.stroke),l.setAttribute("opacity",this.#Kt.shapeStyle.opacity),l.setAttribute("stroke-width",this.#Kt.shapeStyle.strokeWidth),l.setAttribute("vector-effect","non-scaling-stroke"),a&&l.setAttribute("xlink:title",a),o&&l.setAttribute("content",o),e.parentElement.insertBefore(l,e),e.remove()}}}}#Es(e,t){this.#Kt.shapeStyle||(this.#Kt.shapeStyle=this.#Qt);var i,s,r=e,a=e.ownerDocument,o=this.#si[this.#Kt.editingLayerId].CRS,n=this.#o.Geo2SVG(t.coordinates[1],t.coordinates[0],o),l=e.getAttribute("xlink:title"),h=e.getAttribute("content");switch(t.type.toLowerCase()){case"point":(s=a.createElement("use")).setAttribute("transform",`ref(svg,${n.x},${n.y})`),s.setAttribute("xlink:href",t.icon),l&&s.setAttribute("xlink:title",l),h&&s.setAttribute("content",h);break;case"linestring":(i=a.createElement("path")).setAttribute("d",this.#Vt(t.coordinates,o)),i.setAttribute("fill","none");break;case"polygon":(i=a.createElement("path")).setAttribute("d",this.#Ts(t)),i.setAttribute("fill",this.#Kt.shapeStyle.fill)}return i?(i.setAttribute("stroke",this.#Kt.shapeStyle.stroke),i.setAttribute("stroke-width",this.#Kt.shapeStyle.strokeWidth),i.setAttribute("vector-effect","non-scaling-stroke"),l&&i.setAttribute("xlink:title",l),h&&i.setAttribute("content",h),r=i):r=s,e.parentElement.insertBefore(r,e),e.remove(),r}#Ts(e){for(var t=this.#si[this.#Kt.editingLayerId].CRS,i="",s=0;s<e.coordinates.length;s++)i+=this.#Vt(e.coordinates[s],t)+"z ";return i}#Vt(e,t){if(0==e.length)return" ";var i="M",s=this.#o.Geo2SVG(e[0][1],e[0][0],t);if(s){i+=s.x+","+s.y+" L";for(var r=1;r<e.length;r++)(s=this.#o.Geo2SVG(e[r][1],e[r][0],t))&&(i+=s.x+","+s.y+" ")}else i=" ";return i}cancelPointingPoiRegister(...e){return this.#Gi(...e)}editPoint(...e){return this.#ei(...e)}initFreeHandTool(...e){return this.#gs(...e)}initGenericTool(...e){return this.#Ls(...e)}initPOItools(...e){return this.#mi(...e)}initPOIregistTool(...e){return this.#gi(...e)}initPolygonTools(...e){return this.#ts(...e)}setTargetObject(...e){return this.#_i(...e)}isEditingGraphicsElement(...e){return this.#hs(...e)}clearTools(...e){return this.#ys(...e)}}class n{constructor(e,t,i,s=[]){if(!t)return console.warn("No targetWindow_or_itsGetter Exit."),void console.warn("targetWindow_or_itsGetter is not Window instance");this.#Os(),this.#ks=e,"object"==typeof t?this.#Rs=t:this.#Bs=t,1==i&&(this.#Vs(),this.#Gs=!0),Array.isArray(s)?this.#Ns=s:console.warn("InterWindowMessaging: allowedOrigins must be an array.")}#Rs=null;#Bs=null;#Gs=!1;#Ns;#ks;#Os(){window.addEventListener("message",async function(e){if(this.#Ns.includes(e.origin)||e.origin===window.location.origin){var t=this.#Ds();if(t&&e.source.location.pathname==t.location.pathname){console.log("InterWindowMessaging get message:",e.data," srcWin:",e.source," srcPath:",e.source.location.pathname);var i=JSON.parse(e.data);if(i.command)if(this.#ks[i.command]){var s=await this.#ks[i.command](...i.parameter),r={response:i.command,content:s};console.log("========\ncmd:",i.command),console.log("parameter:",i.parameter),console.log("ans:",s);var a=JSON.stringify(r);t.postMessage(a,t.origin)}else{console.log("========\ncmd:",i.command," is not exists within commandSet");a=JSON.stringify({response:"error"});t.postMessage(a,t.origin)}else 1==i.ready&&(console.log("Get ready!"),this.#Gs=!0);this.#Us&&(this.#Us(e.data),this.#Us=null)}}else console.warn(`InterWindowMessaging: Message blocked from untrusted origin: ${e.origin}`)}.bind(this),!1)}#Ds=function(){return this.#Bs?this.#Bs():this.#Rs}.bind(this);#Us=null;#Fs=100;#Hs(e){return new Promise(async function(t,i){for(var s=0;0==this.#Gs||null!=this.#Us;){if(console.log("waiting post message"),s>this.#Fs)return void i("postMessagePromise: Now waiting message. skip.  command:"+JSON.parse(e).command);await this.#zs(5),++s}this.#Us=t;var r=this.#Ds();r.postMessage(e,r.origin)}.bind(this))}#zs=e=>new Promise(t=>setTimeout(t,e));async callRemoteFunc(e,t){console.log("callRemoteFunc:",e);var i={command:e,parameter:t},s=JSON.stringify(i),r=await this.#Hs(s);return(r=JSON.parse(r)).response==e?r.content:null}#Vs(){var e=this.#Ds();console.log("submitReady:",e),e.postMessage(JSON.stringify({ready:!0}),e.origin)}async getReady(){for(;0==this.#Gs;)await this.#zs(5);console.log("Ready!")}}class l{constructor(e,t){"object"==typeof e&&(this.#js=!0,this.#Ws=e),this.#Ys=t,this.#Xs()}#Zs;#Ys;#Xs(){this.#Zs=new n({getDetailedLayersPropertySet:this.#qs.bind(this),getDetailedOriginalLayersPropertySet:this.#_s.bind(this),setCustomLayerSettingIndex:this.#Ks.bind(this),applyCustomLayers:this.#Js.bind(this),getRootContainerXML:this.#Qs.bind(this),registCustomLayer:this.#$s.bind(this),loadCustomLayerSettings:this.#er.bind(this),storeCustomLayerSettings:this.#tr.bind(this),deleteAllCustomLayerSettings:this.#ir.bind(this),deleteAllCustomViewBoxSettings:this.#sr.bind(this),buildCustomGeoViewboxSettingObject:this.#rr.bind(this),loadCustomGeoViewboxes:this.#ar.bind(this),storeCustomGeoViewboxes:this.#or.bind(this),applyCustomLayersSettingsToCurrentMapView:this.#nr.bind(this),deleteCustomLayerSetting:this.#lr.bind(this),buildCustomLayersSetting:this.#hr.bind(this),mergeSettings:this.#gr.bind(this),getGeoViewBox:this.#Ws.getGeoViewBox.bind(this.#Ws),setGeoViewPort:this.#Ws.setGeoViewPort.bind(this.#Ws),getResume:this.#Ws.getResume.bind(this.#Ws),setResume:this.#Ws.setResume.bind(this.#Ws),refreshScreen:this.#Ws.refreshScreen.bind(this.#Ws)},this.#Ys)}#js=!1;#Ws=null;#dr=null;static#cr="r2";static#pr="svgmap_";static#ur="customLayers";static#mr="customGeoViewboxes";async#yr(){if(0==this.#js)return console.warn("This Object don't have svgMapObject. Exit."),null;var e=new URL(this.#Ws.getSvgImagesProps().root.Path,location.href).href,t=await this.#vr(e,!0);this.#fr(t)}async#_s(){return null==this.#dr&&await this.#yr(),this.#br(this.#dr)}#$s(e,t,i){console.log("registCustomLayer:",e,t,i);var s=this.#er();if(!i||!i.key){var r=new Date;i={key:"L_"+r.getTime(),time:r.getTime(),title:r.toString(),description:""}}s.customLayersSettings[i.key]={data:e,metadata:i},s.currentSettingKey=i.key,this.#tr(s),t&&this.#js&&(this.#Js(s),this.#Ws.refreshScreen())}#Js(e,t){var i,s=!0;if("object"==typeof t&&(s=!1),!this.#js){if("object"!=typeof t)return console.error("No svgMap Object.."),!1;s=!1}if(!s||(i=this.#Ir())){if(e||(e=this.#er()),0==this.#Pr(e))return console.warn("customLayersObject is invalid"),!1;var r=e.currentSettingKey;if(r){console.log(e,r);var a,o,n=e.customLayersSettings[r].data;console.log("applyCustomLayers:customLayersSet:",n),this.#Sr(n),a="object"==typeof t?t.layersProperty:this.#qs(null,null,!0).layersProperty;for(var l=[],h={},g=!1,d={},c={},p=0;p<a.length;p++)c[this.#xr(a[p])]?(g=!0,d[this.#xr(a[p])]=!0):c[this.#xr(a[p])]=!0;g&&console.warn("duplicatedLayerTitles:",d);for(p=a.length-1;p>=0;p--){var u=this.#xr(a[p]);if(n[u]&&!n[u].add)if(n[u].href==a[p].href){if(s){var m=this.#Mr(u);o=this.#wr(i,m.title,m.group,a[p].href).getAttribute("iid"),d[u]&&console.warn("edit duplicatedLayer:",u,a[p].href,this.#Cr(i,o,"iid").getAttribute("xlink:href")),this.#Lr(o,n[u],i)}this.#Ar(p,n[u],a),h[u]=!0,l[p]=!0}else console.error("href is unmatched!!!: title:",u,"  href:",n[u].href," vs ",a[p].href,"  SKIP IT"),l[p]="href is unmatched:"+u;else l[p]=!1}var y={};for(p=a.length-1;p>=0;p--)if(0==l[p])for(var u in n)if(!h[u]&&n[u].href==a[p].href&&!n[u].add&&!y[u]){if(s){m=this.#Mr(this.#xr(a[p]));o=this.#wr(i,m.title,m.group,a[p].href).getAttribute("iid"),this.#Lr(o,n[u],i)}this.#Ar(p,n[u],a),h[u]=!0,l[p]=!0,y[u]=!0}var v=[],f=[];for(var u in n)if(n[u].add){var b=n[u].add;if(b.afterTitle){var I=this.#Er(b.afterTitle,b.afterHref,a);I&&"all"==I.level?v.push(u):f.push(u)}else v.push(u)}!function e(t){for(var i=[],s=0;s<t.length;s++){var r=n[t[s]].add.afterTitle;v.indexOf(r)>=0?v.push(t[s]):i.push(t[s])}if(0!=i.length&&t.length!=i.length)e(i);else for(s=0;s<i.length;s++)v.push(i[s])}(f);for(p=0;p<v.length;p++){if(!h[u=v[p]]){for(var P=!1,S=0;S<a.length;S++)this.#xr(a[S])==u&&(P=!0);P?console.error("Already exists the same title layer : ",u,"  SKIP..."):(s&&this.#Tr(u,n[u],i),h[u]=!0,this.#Or(u,n[u],a))}}return a}console.warn("customLayersObject's currentSettingKey is not assigned. : customLayersObject:",e)}else console.error("Can't get rootContainer")}#Er(e,t,i){for(var s=this.#Mr(e),r=s.title,a=s.group,o=0;o<i.length;o++)if(i[o].title==r&&i[o].href==t){if(!a)return{index:o,level:"all"};if(i[o].detail.group==a)return{index:o,level:"all"}}for(o=0;o<i.length;o++)if(i[o].title==r){if(!a)return{index:o,level:"all"};if(i[o].detail.group==a)return{index:o,level:"title"}}for(o=0;o<i.length;o++)if(i[o].href==t)return{index:o,level:"href"};return null}#Lr(e,t,i){var s=this.#Cr(i,e,"iid"),r=s.getAttribute("xlink:href").trim();if(t.delete)s.parentNode.removeChild(s);else{for(var a in t)"delete"!=a&&("href"==a?r!=t.href&&s.setAttribute("xlink:href",t.href):""==t[a]?s.removeAttribute(a):s.setAttribute(a,t[a]));console.log("layer:",s,s.getAttribute("visibility"))}}#Tr(e,t,i){var s,r=i.createElement("animation"),a=this.#Mr(e).title;for(var o in r.setAttribute("title",a),r.setAttribute("x",-3e4),r.setAttribute("y",-3e4),r.setAttribute("width",6e4),r.setAttribute("height",6e4),t)"add"!=o&&("href"==o?r.setAttribute("xlink:href",t.href):r.setAttribute(o,t[o]));if(""==t.add||1==t.add)s=null;else{var n=this.#Mr(t.add.afterTitle);(s=this.#wr(i,n.title,n.group))||(s=this.#Cr(i,t.add.afterHref,"xlink:href"))&&console.error("Can't find afterLayer element titled:",n,"  but found ",s),s||console.error("Can't find afterLayer element...:",t.add,"   for ",n,"layer.")}s?s.parentElement.insertBefore(r,s):i.documentElement.appendChild(r)}#Ar(e,t,i){if(i.href,t.delete)i.splice(e,1);else{for(var s in t)"delete"!=s&&("href"==s?i[e].href=t.href:"title"==s?i[e].title=t.title:"visibility"==s?"visible"==t[s]||""==t[s]?i[e].visible=!0:i[e].visible=!1:"opacity"==s?i[e].opacity=t.opacity:"class"==s&&(i[e].detail=this.#kr(t.class,{})),"href"!=s?i[e].attributes[s]=t[s]:i[e].attributes["xlink:href"]=t[s]);null==i[e].detail&&delete i[e].detail}}#Or(e,t,i){var s={href:t.href,opacity:t.opacity,title:t.title,visibile:!1,attributes:{},detail:this.#kr(t.class,{})};for(var r in t)"add"!=r&&("href"!=r?s.attributes[r]=t[r]:s.attributes["xlink:href"]=t[r]);var a=-1;if(""==t.add||1==t.add)a=-1;else{var o=this.#Er(t.add.afterTitle,t.add.afterHref,i);o?a=o.index:console.error("Can't find afterLayer ...:",t.add,"  then add top..")}-1==a?i.push(s):i.splice(a,0,s)}#xr(e){var t=e.title;return e.detail&&e.detail.group?t+"\t"+e.detail.group:t}#Mr(e){var t=(e=e.split("\t"))[0],i=null;return 2==e.length&&(i=e[1]),{group:i,title:t}}#hr(e,t){!t&&this.#dr&&(t=this.#br(this.#dr).layersProperty);var i=this.#Rr(e,t,["iid"]),s={};console.log("buildCustomLayersSetting:",e,t,this.#dr),console.log("buildCustomLayersSetting:",i);for(var r=0;r<i.delIndex.length;r++)s[this.#xr(t[i.delIndex[r]])]={delete:!0,href:t[i.delIndex[r]].href};for(r=0;r<i.addIndex.length;r++){var a,o=i.addIndex[r];a=o==e.length-1||{afterTitle:this.#xr(e[o+1]),afterHref:e[o+1].href};var n=this.#xr(e[o]);for(var l in s[n]&&s[n].delete?s[n].originalHref=s[n].href:s[n]={},s[n].add=a,e[o].attributes)s[n][l]=e[o].attributes[l],"xlink:href"==l&&(s[n].href=e[o].attributes[l])}for(r=0;r<i.attrChangedIndex.length;r++){n=this.#xr(e[i.attrChangedIndex[r].edited]);var h=e[i.attrChangedIndex[r].edited].href,g=i.attrChangedIndex[r].attributes,d={};if(g.changedAttributes)for(var l in g.changedAttributes)d[l]=g.changedAttributes[l];if(g.removedAttributes)for(var l in g.removedAttributes)d[l]="";if(g.addedAttributes)for(var l in g.addedAttributes)d[l]=g.addedAttributes[l];s[n]=d,s[n].href=h}return s}async#vr(e,t){var i=await fetch(e),s=new URL(e,location.href).pathname,r=await i.text(),a=(new DOMParser).parseFromString(r,"text/xml");return this.#qs(a,s,t)}#Br(){var e;return this.#js?(console.warn("Get root container document from this window's svgMap"),e=this.#Vr(),{rootContainerDoc:this.#Ir(),rootContainerHref:e}):(console.warn("Can't get root container live document from this windows's svgMap "),{rootContainerDoc:null,rootContainerHref:null})}#qs(e,t,i){if(!e||!t){var s=this.#Br();e=s.rootContainerDoc,t=s.rootContainerHref}if(!e)return console.error("No rootContainerDoc"),null;for(var r=e.getElementsByTagName("animation"),a={},o=[],n=0;n<r.length;n++){o.push({});for(var l=r[n],h={},g=0;g<l.attributes.length;g++)i&&"iid"==l.attributes[g].nodeName||(h[l.attributes[g].nodeName]=l.attributes[g].nodeValue.trim());var d={};h.class&&(d=this.#kr(h.class,a,n)),h.opacity&&(o[n].opacity=Number(h.opacity)),o[n].visibile=!0,"hidden"!=h.visibility&&"none"!=h.display||(o[n].visibile=!1);var c=h["xlink:href"],p=l.getAttribute("title");p||(p=c),o[n].title=p,o[n].href=c,o[n].attributes=h,o[n].detail=d}return{layersProperty:o,groupsProperty:a,rootContainerHref:t}}#kr(e,t,i){var s={};if(!e||""==e)return s;for(var r=e.split(" "),a=0;a<r.length;a++)"clickable"==r[a].trim().toLowerCase()?s.clickable=!0:"editable"==r[a].trim().toLowerCase()?s.editable=!0:"switch"==r[a].trim().toLowerCase()?s.switch=!0:"batch"==r[a].trim().toLowerCase()?s.batch=!0:(s.group=r[a],t[s.group]||(t[s.group]={},t[s.group].members=[]),t[s.group].members.push(i)),s.group&&(s.switch&&(t[s.group].switch=!0),s.batch&&(t[s.group].batch=!0));return s}#fr(e){this.#dr=this.#br(e)}#br(e){return JSON.parse(JSON.stringify(e))}#Gr=[{title:"a",href:"A",attributes:{a:"a",b:"b",c:"c"}},{title:"b",href:"B",attributes:{a:"a",b:"b",c:"c"}},{title:"c",href:"C",attributes:{a:"a",b:"b",c:"c"}},{title:"d",href:"D",attributes:{a:"a",b:"b",c:"c"}},{title:"e",href:"E",attributes:{a:"a",b:"b",c:"c"}},{title:"f",href:"F",attributes:{a:"a",b:"b",c:"c"}},{title:"g",href:"G",attributes:{a:"a",b:"b",c:"c"}},{title:"h",href:"H",attributes:{a:"a",b:"b",c:"c"}},{title:"i",href:"I",attributes:{a:"a",b:"b",c:"c"}}];#Nr=[{title:"a",href:"A",attributes:{a:"A",b:"b",c:"c"}},{title:"c",href:"C",attributes:{a:"a",b:"b",c:"c"}},{title:"a",href:"A",attributes:{a:"a",b:"b",c:"c"}},{title:"d",href:"D",attributes:{a:"a",b:"b",c:"c"}},{title:"e",href:"E",attributes:{a:"a",b:"b",c:"c",d:"d"}},{title:"f",href:"F",attributes:{a:"a",b:"b",c:"c"}},{title:"g",href:"G",attributes:{a:"a",b:"b",c:"c"}},{title:"h",href:"H",attributes:{a:"a",c:"c",k:"K"}},{title:"w",href:"W",attributes:{a:"a",b:"b",c:"c"}}];#Dr=!0;#Rr(e,t,i){e||(e=this.#Nr),t||(t=this.#dr?this.#br(this.#dr).layersProperty:this.#Gr);for(var s=0,r=[],a=[],o=[],n=0;n<t.length;n++){var l=s,h=!1;if(l>=e.length)h=!0,r.push(n);else for(;!this.#Dr&&t[n].title!=e[l].title||t[n].href!=e[l].href;){if(l==e.length-1){h=!0,r.push(n);break}++l}if(!h){if(a.push({original:n,edited:l}),s!=l)for(var g=s;g<l;g++)console.log("added?:",g),o.push(g);s=l+1}}for(g=s;g<e.length;g++)console.log("added?:",g),o.push(g);var d=[];for(n=0;n<a.length;n++){var c=t[a[n].original],p=e[a[n].edited],u=!1,m={},y={},v={};for(var f in c.attributes)i&&-1!=i.indexOf(f)||(p.attributes[f]?c.attributes[f]!=p.attributes[f]&&(u=!0,m[f]=p.attributes[f]):(u=!0,y[f]=""));for(var b in p.attributes)i&&-1!=i.indexOf(b)||c.attributes[b]||(u=!0,v[b]=p.attributes[b]);if(u){var I={};Object.keys(y).length>0&&(I.removedAttributes=y),Object.keys(m).length>0&&(I.changedAttributes=m),Object.keys(v).length>0&&(I.addedAttributes=v),d.push({original:a[n].original,edited:a[n].edited,attributes:I})}}return{attrChangedIndex:d,existIndex:a,delIndex:r,addIndex:o}}#Ur(){if(!this.#js)return console.error("No svgMap Object.."),!1;for(var e=this.#Ws.getRootLayersProps(),t=this.#Ir(),i={},s=0;s<e.length;s++){for(var r=e[s].id,a=this.#Cr(t,r,"iid"),o={},n=0;n<a.attributes.length;n++)o[a.attributes[n].nodeName]=a.attributes[n].nodeValue;var l={};if(o.class){var h=o.class.split(" ");for(n=0;n<h.length;n++)"clickable"==h[n].trim().toLowerCase()?l.clickable=!0:"editable"==h[n].trim().toLowerCase()?l.editable=!0:"switch"==h[n].trim().toLowerCase()?l.switch=!0:"batch"==h[n].trim().toLowerCase()?l.batch=!0:(l.group=h[n],i[l.group]||(i[l.group]={},i[l.group].members=[]),i[l.group].members.push(r)),l.group&&(l.switch&&(i[l.group].switch=!0),l.batch&&(i[l.group].batch=!0))}o.opacity&&(e[s].opacity=Number(o.opacity)),e[s].attributes=o,e[s].detail=l}for(s=0;s<e.length;s++){r=e[s].id;e[s].detail.group&&(i[e[s].detail.group].switch&&(e[s].detail.switch=!0),i[e[s].detail.group].batch&&(e[s].detail.batch=!0)),e[r].attributes=e[s].attributes,e[r].detail=e[s].detail}return{layersProperty:e,groupsProperty:i}}#Ir(){return this.#js?this.#Ws.getSvgImages().root:(console.warn("Can't get root container live document from this windows's svgMap "),null)}#Qs(){var e=this.#Ir();return(new XMLSerializer).serializeToString(e)}#Vr(){return this.#js?new URL(this.#Ws.getSvgImagesProps().root.Path,window.location.href).pathname:(console.warn("Can't get root container live document from this windows's svgMap "),null)}#Fr(e){var t=this.#Vr();return t?l.#pr+t+"#"+e:(console.error("rootContainerHref is not defined... exit"),null)}#tr(e){window.localStorage[this.#Fr(l.#ur)]=JSON.stringify(e)}#er(){var e=null;window.localStorage[this.#Fr(l.#ur)]&&(e=JSON.parse(window.localStorage[this.#Fr(l.#ur)]));var t=this.#Vr();return e&&t==e.rootContainerHref&&e.settingRevision==l.#cr||(e&&(t!=e.rootContainerHref&&console.warn("rootContainerHref mismatch:",t," vs ",e.rootContainerHref),e.settingRevision!=l.#cr&&console.warn("settingRevision mismatch:",l.#cr," vs ",e.settingRevision)),console.warn("create new:",e,t),e={currentSettingKey:null,customLayersSettings:{},rootContainerHref:t,settingRevision:l.#cr}),e}#or(e){window.localStorage[this.#Fr(l.#mr)]=JSON.stringify(e)}#ar(){return window.localStorage[this.#Fr(l.#mr)]?JSON.parse(window.localStorage[this.#Fr(l.#mr)]):{currentSettingKey:null,settings:{}}}#rr(e,t,i,s,r,a){return e||(e="V_"+(new Date).getTime()),t||(t=e),{key:e,title:t,x:i,y:s,width:r,height:a}}#ir(){delete window.localStorage[this.#Fr(l.#ur)]}#sr(){delete window.localStorage[this.#Fr(l.#mr)]}#lr(e){if(null==e)console.error("key is requred");else{var t=this.#er();if(t.customLayersSettings[e])return delete t.customLayersSettings[e],t.currentSettingKey==e&&(t.currentSettingKey=null),this.#tr(t),t;console.error("layer setting key is invalid:",e)}}#Ks(e){var t=this.#er();return e?t.customLayersSettings[e]?(t.currentSettingKey=e,this.#tr(t),t):void console.error("key is invalid:",e):(t.currentSettingKey=null,this.#tr(t),null)}#Cr(e,t,i){return i.indexOf(":")>0&&(i="*|"+i.substring(i.indexOf(":")+1)),e&&e.hasChildNodes()?e.querySelector("["+i+'="'+t+'"]'):null}#Hr(e,t,i,s,r){if(i.indexOf(":")>0&&(i="*|"+i.substring(i.indexOf(":")+1)),!e||!e.hasChildNodes())return null;var a=e.querySelectorAll("["+i+'="'+t+'"]');if(0==a.length)return null;for(var o=0;o<a.length;o++){if(a[o].getAttribute(r)==s)return a[o]}return null}#wr(e,t,i,s,r){if(!e||!e.hasChildNodes())return null;for(var a=[],o=e.querySelectorAll("*"),n=0;n<o.length;n++)o[n].getAttribute("title")&&o[n].getAttribute("title")==t&&a.push(o[n]);if(0==a.length)return null;var l=[];if(i)for(n=0;n<a.length;n++){a[n].getAttribute("class").indexOf(i)>=0&&l.push(a[n])}else l=a;if(0==l.length)return null;var h=[];if(s)for(n=0;n<l.length;n++){l[n].getAttribute("xlink:href").trim()==s&&h.push(l[n])}else h=l;return 0==h.length?null:1==h.length?h[0]:r?h:h[0]}#zr(e){}#nr(e){var t=this.#Ir(),i=this.#Vr(),s=this.#qs(t,i,!0),r=this.#hr(e.layersProperty,s.layersProperty),a={currentSettingKey:"L_0",customLayersSettings:{},settingRevision:l.#cr,rootContainerHref:i};return a.customLayersSettings[a.currentSettingKey]={data:r,metadata:{key:a.currentSettingKey,title:"temp"}},this.#jr(a),a}#jr(e){this.#Js(e),this.#Ws.refreshScreen(),setTimeout(this.#Ws.updateLayerListUI,1e3)}#Pr(e){var t=!0,i="",s=this.#Vr();return e.rootContainerHref!=s&&(t=!1,i="rootContainerHref is invalid "+e.rootContainerHref+" vs "+s),e.settingRevision!=l.#cr&&(t=!1,i="settingRevision is mismatch "+e.settingRevision+" vs "+l.#cr),0==t&&console.warn("customLayersObject is invalid: "+i),t}#gr(e){var t=this.#er(),i=this.#ar();if(e.rootContainerHref!=t.rootContainerHref||location.host!=e.host)return"異なるコンテンツ用の設定ファイルです";if(e.settingRevision!=l.#cr)return"異なるリビジョンの設定ファイルです";for(var s in e.customLayersSettings)t.customLayersSettings[s]?console.warn("カスタムレイヤー：重複しています　スキップします"):t.customLayersSettings[s]=e.customLayersSettings[s];for(var s in e.customGeoViewboxSettings)i.settings[s]?console.warn("ビューボックス：重複しています　スキップします"):i.settings[s]=e.customGeoViewboxSettings[s];return this.#tr(t),this.#or(i),!0}#Sr(e){for(var t in e){var i=e[t];i.iid&&delete i.iid}}applyCustomLayers(...e){return this.#Js(...e)}}class h{constructor(e){this.#Ws=e,this.#Wr()}#Ws=null;#Zs;#Yr;#Xr;#Zr;#qr;#_r;#Kr(e){if(this.#_r||(this.#_r="cesiumWindow2.html"),console.log("openCesium:"),this.#qr)this.#qr.closed&&(this.#qr=null,this.#Kr(e));else{var t=new URL(this.#Ws.getSvgImagesProps().root.Path,window.location).pathname;t=t.substring(0,t.lastIndexOf("/")+1),this.#qr=window.open(this.#_r,"sub","width=800,height=600"),this.#Zs=new n({reldir2imageUrl:function(){return t},getCORSURL:function(e){var t=this.#Ws.getCORSURL(e);return console.log("getCORSURL:",t),t}.bind(this)},this.#qr)}e&&this.#Jr(e)}async#Jr(e){await this.#Zs.getReady(),e()}#_(e){this.#Qr&this.#$r&&this.#ea(),this.#Ws.captureGISgeometriesOption(!0),console.log("getGeoJson  is cesiumWindow?:",this.#qr,"   is complex:",e),"true"==e?this.#Ws.captureGISgeometries(this.#ta):(this.#Kr(),this.#Ws.captureGISgeometries(this.#ia))}#ia=function(e){var t=this.#Ws.getRootLayersProps(),i=this.#Ws.getSvgImagesProps();for(var s in e){var r=i[s].rootLayer;e[s].layerProps=t[r]}this.#sa(e)}.bind(this);#ta=function(e){console.log("called jsonPropComp : json:",e);var t=this.#Ws.getRootLayersProps(),i=this.#Ws.getSvgImagesProps();console.log("svgImagesProps:",i);var s=[];for(var r in e){var a=i[r],o=a.rootLayer;e[r].layerProps=t[o],o&&e[r][0]&&"Point"==e[r][0].type&&(s[o]={title:t[o].title,metaSchema:a.metaSchema.split(",")})}console.log("jLayers:",s);var n=document.getElementById("svg2cesiumProp");this.#ci(n),n.style.display="";var l=document.createElement("span");l.innerHTML="Select property of layers which you want to visualize as bar graphs.<br>Note: If you select string property then value should be the length of string....",n.appendChild(l);var h=document.createElement("table");h.id="extentTable",h.border=1;var g=document.createElement("tr");for(var d in g.innerHTML="<th>LayerName</th><th>targetProp</th><th>min</th><th>max</th>",h.appendChild(g),s){g=document.createElement("tr"),(p=document.createElement("td")).innerHTML=s[d].title,g.appendChild(p),p=document.createElement("td");var c=document.createElement("select");c.addEventListener("change",function(t){this.#ra(t,e)}.bind(this)),c.id="sel_"+d;var p,u=document.createElement("option");u.value="-",u.innerHTML="-",u.selected=!0,c.appendChild(u);for(var m=0;m<s[d].metaSchema.length;m++)(u=document.createElement("option")).value=s[d].metaSchema[m],u.innerHTML=s[d].metaSchema[m],c.appendChild(u);p.appendChild(c),g.appendChild(p),(p=document.createElement("td")).innerHTML="<input type='text' id='min_"+d+"'  readonly>",g.appendChild(p),(p=document.createElement("td")).innerHTML="<input type='text' id='max_"+d+"'  readonly>",g.appendChild(p),h.appendChild(g)}n.appendChild(h);var y=document.createElement("input");y.type="button",y.value="view",y.addEventListener("click",function(t){this.#aa(e)}.bind(this)),n.appendChild(y);var v=document.createElement("input");v.type="button",v.value="cancel",v.addEventListener("click",function(e){document.getElementById("svg2cesiumProp").style.display="none"}.bind(this)),n.appendChild(v)}.bind(this);#aa(e){for(var t=document.getElementById("extentTable"),i=0;i<t.rows.length;i++)for(var s=0;s<t.rows[i].cells.length;s++){var r=t.rows[i].cells[s];console.log(r)}this.#Kr(),console.log("jsonPropCompPh2:",e),this.#sa(e),document.getElementById("svg2cesiumProp").style.display="none"}#ra=function(e,t){var i=e.target.id.substring(4),s=e.target.selectedIndex-1,r=9e99,a=-9e99;for(var o in t)if(t[o].layerProps&&t[o].layerProps.svgImageProps.rootLayer==i)for(var n=0;n<t[o].length;n++)if(s<0)delete t[o][n].mainValue;else if("Point"==t[o][n].type)try{var l="";l=t[o][n].usedParent&&t[o][n].usedParent.getAttribute("content")?t[o][n].usedParent.getAttribute("content").split(",")[s]:t[o][n].src.getAttribute("content").split(",")[s];var h=Number(l);isNaN(h)?(h=l.length,r=Math.min(r,h),a=Math.max(a,h)):(r=Math.min(r,h),a=Math.max(a,h)),t[o][n].mainValue=h}catch(e){}s<0?(document.getElementById("min_"+i).value="",document.getElementById("max_"+i).value="",delete t[i].mainValueMin,delete t[i].mainValueMax):(document.getElementById("min_"+i).value=r,document.getElementById("max_"+i).value=a,t[i].mainValueMin=r,t[i].mainValueMax=a,console.log("min,max,id",r,a,i))}.bind(this);#oa(e){var t={};for(var i in e){if(t[i]={},e[i].length>0){t[i].geometry=[];for(var s=0;s<e[i].length;s++){var r={};for(var a in e[i][s])r[a]="src"==a?{title:e[i][s][a].getAttribute("xlink:title")}:e[i][s][a];t[i].geometry.push(r)}}e[i].layerProps&&(t[i].layerProps={},console.log(i,e[i],e[i].layerProps),t[i].layerProps.id=e[i].layerProps.id,t[i].layerProps.title=e[i].layerProps.title,t[i].layerProps.groupName=e[i].layerProps.groupName,t[i].layerProps.svgImageProps={rootLayer:e[i].layerProps.svgImageProps.rootLayer}),e[i].mainValueMin&&(t[i].mainValueMin=e[i].mainValueMin,t[i].mainValueMax=e[i].mainValueMax)}return console.log("fixJsonObj:",t),t}async#sa(e){var t=this.#Ws.getGeoViewBox();console.log("jsonCapture:",e),this.#qr||console.warn("NO cesiumWindow exit."),await this.#Zs.getReady(),await this.#Zs.callRemoteFunc("viewGeoJson",[this.#oa(e),t])}#ci(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t])}#na=function(){this.#Qr.style.display=""}.bind(this);#ea=function(){this.#Qr.style.display="none"}.bind(this);#Qr;#$r;#Wr(){if(this.#$r=document.getElementById("3DviewButton"),this.#$r){this.#$r.getAttribute("data-app")&&(this.#_r=this.#$r.getAttribute("data-app"),console.log("set cesiumWindowHtmlLocation:",this.#_r)),this.#$r.title||(this.#$r.title="View 3D Map");var e="top:200px";this.#$r.style.top?e=`top:${this.#$r.style.top}`:this.#$r.style.bottom&&(e=`bottom:${this.#$r.style.bottom}`),this.#$r.style.left?e+=`;left:${this.#$r.style.left}`:this.#$r.style.right?e+=`;right:${this.#$r.style.right}`:e+=";left:2px",this.#$r.addEventListener("click",this.#na),this.#Yr="left :0px; top:0px; position: relative",this.#Xr="left :0px; top:0px; position: relative",this.#Zr=e+"; position:absolute;display:none;z-index:1000;background-color : #AAEEDD",this.#Yr||(this.#Yr="right :0px; top: 0px; position: relative"),this.#Xr||(this.#Xr="right :0px; top: 0px; position: relative"),this.#Qr=document.createElement("div"),this.#Qr.id="3dViewBtns",this.#Qr.setAttribute("style",this.#Zr);var t=document.createElement("input");t.id="svg2cesiumBtn1",t.type="button",t.value="Simple 3D view",t.addEventListener("click",function(){this.#_()}.bind(this)),t.setAttribute("style",this.#Yr);var i=document.createElement("input");i.id="svg2cesiumBtn2",i.type="button",i.value="Complex 3D view",i.addEventListener("click",function(){this.#_("true")}.bind(this)),i.setAttribute("style",this.#Xr);var s=document.createElement("input");s.addEventListener("click",this.#ea),s.type="button",s.value="x",this.#Qr.appendChild(t),this.#Qr.appendChild(i),this.#$r&&this.#Qr.appendChild(s);var r=document.createElement("div");r.id="svg2cesiumProp",r.setAttribute("style","left :80px; top: 80px; position: absolute; background-color: white;opacity:0.8;display:none;z-index:1000"),document.body.appendChild(this.#Qr),document.body.appendChild(r)}}}class g{static#la="gMsg_";static#ha=5;static#ga="globalMessage";constructor(){}#da(e,t){var i=document.getElementById(g.#ga);if(!i)return console.log('NO id="'+g.#ga+'" element skip'),!1;var s=i.getElementsByTagName("table")[0];s||(console.log("init globalMesasge area"),(s=document.createElement("table")).style.border="0px",s.style.padding="0px",s.style.margin="0px",i.appendChild(s));var r=i.children,a=document.getElementById(g.#la+t);if(!a){if(r.length>=g.#ha)return console.log("can not append global message due to limit"),!1;a=document.createElement("td");var o=document.createElement("tr");o.id=g.#la+t,o.appendChild(a),i.appendChild(o)}return console.log(a,e),a.innerText=e,!0}putGlobalMessageForLayer(e){return function(t){this.#da(t,e)}.bind(this)}clearGlobalMessage(e){console.log("clearGlobalMessage:",e);var t=document.getElementById(g.#ga);if(console.log("globalMessage:",t),t){var i=document.getElementById(g.#la+e);console.log("globalMessageCell:",i),i&&(console.log("Remove GlobalMessage for layer:",e),i.parentNode.removeChild(i))}else console.log('NO id="globalMesasge" element skip')}}class d{static#ca=20;static#pa="openFrame";static#ua="closeFrame";static#ma="appearFrame";static#ya="hideFrame";#va;#o;#_t;#fa;#ba;#Ia={};#Pa=0;#Sa;#xa;#Ma={};constructor(e,t,i){this.#o=e,this.#fa=t,this.#Ma={},this.#_t=new a(e,window.jsts),this.#Sa=i.bind(this.#o),this.#xa=new g,console.log("construct layerUI: svgMapGIStool:",this.#_t," svgMapAuthoringTool:",this.#fa),window.initSvgMapWebAppLayer=this.initSvgMapWebAppLayer}#wa(){for(var e=this.#o.getRootLayersProps(),t=e.length-1;t>=0;t--)this.#Ca(e[t].id,e[t].visible)}#La(e,t){var i=this.#o.getRootLayersProps();i[e].svgImageProps?i[e].svgImageProps.controller?i[e].svgImageProps.controllerWindow?(console.warn("Already launched"),t&&t(i[e].svgImageProps.controllerWindow)):this.#Aa(i[e].svgImageProps,i[e].id,!0,t):console.error("This layer has NO controller, EXIT."):console.error("This layer is not yet loaded, EXIT.")}setLayerUIobject(e){this.#ba=e}#Aa(e,t,i,s){let r;const a=this.#va.ownerDocument;if(!e.controller&&e.svgScript&&(r=":#exec=hiddenOnLayerLoad"),e.controller&&(r=e.controller.src?e.controller.url?":"+e.controller.url:":":e.controller.url,"function"==typeof this.#ba.setLayerSpecificWebAppLaunchUiEnable&&this.#ba.setLayerSpecificWebAppLaunchUiEnable(t)),r&&!a.getElementById(this.#Ea(t))){var o=this.#Ta(r);if(!e.svgScript||o&&o.exec||(o?o.exec="appearOnLayerLoad":o={exec:"appearOnLayerLoad"}),i&&(o?o.exec="appearOnLayerLoad":o={exec:"appearOnLayerLoad"}),e._execHint&&(o?o.exec=e._execHint:o={exec:e._execHint},delete e._execHint),o&&o.exec&&("appearonlayerload"==o.exec.toLowerCase()||"hiddenonlayerload"==o.exec.toLowerCase())){var n=!1;"hiddenOnLayerLoad"==o.exec&&(n=!0),this.#Oa(t,r,n,s)}}}#ka;#Ra;#Ba(){this.#Va.element?(console.log("Found preDefinedTargetUiElement! : ",this.#Va),this.#va=this.#Va.element,this.#Va.isInline&&(this.#va.style.display="none")):this.#va=document.getElementById("layerSpecificUI"),this.#va?(this.#va.style.zIndex="20",this.#va.style.display="none"):(console.log("can't find id:initLayerSpecificUI elem ... create it"),this.#va=document.createElement("div"),this.#va.setAttribute("id","layerSpecificUI"),this.#va.setAttribute("style","right :10px; top: 40px; width:400px;height:400px; position: absolute; background-color: white;opacity:0.8;display:none;zIndex:20;"),document.body.appendChild(this.#va)),this.#Ia.height=this.#va.style.height,this.#Ia.width=this.#va.style.height,this.#Ia.top=this.#va.style.top,this.#Ia.left=this.#va.style.left,this.#Ia.right=this.#va.style.right,this.#ka=document.createElement("div"),this.#ka.id="layerSpecificUIbody",this.#ka.style.overflow="auto",this.#ka.style.webkitOverflowScrolling="touch",this.#ka.style.width="100%",this.#ka.style.height="100%",this.#va.appendChild(this.#ka),this.#Va.element&&!this.#Va.isInline||(this.#Ra=document.createElement("input"),this.#Ra.type="button",this.#Ra.value="x",this.#Ra.style.webkitTransform="translateZ(10)",this.#Ra.style.zIndex="3",this.#Ra.id="layerSpecificUIclose",this.#Ra.style.position="absolute",this.#Ra.style.right="0px",this.#Ra.style.top="0px",this.#va.appendChild(this.#Ra),this.#Ra.addEventListener("click",function(e){this.#Ga(e)}.bind(this),!1)),this.#Na()}#Va={};#Da(e,t,i){this.#Va={element:e,isInline:t,autoSizing:i}}#Ea(e){return"layerSpecificUIframe_"+e}#Ta(e){if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1);t.indexOf("?")>0&&(t=t.substring(0,t.indexOf("?"))),t=t.split("&");for(var i=0;i<t.length;i++)t[i]=t[i].split("="),t[t[i][0]]=t[i][1];return t}return null}#Ua(){for(var e=this.#ka,t=e.childNodes.length-1;t>=0;t--)if("none"!=e.childNodes[t].style.display)return e.childNodes[t].id;return null}#Oa(e,t,i,s){var r=this.#va.ownerDocument;if(!t){t=svgMap.getRootLayersProps()[e].svgImageProps.controller}var a={height:-1,width:-1},o=this.#Ta(t);o&&(o.requiredHeight&&(a.height=Number(o.requiredHeight)),o.requiredWidth&&(a.width=Number(o.requiredWidth))),i||(!this.#Va.element||this.#Va.isInline?this.#va.style.display="inline":this.#va.style.display="block");var n=this.#Ea(e),l=this.#Ua();!i&&l&&n!=l&&(this.#Fa(d.#ya,l),r.getElementById(l).style.display="none");var h=r.getElementById(n);h?(console.log("alreadyCreated iframe"),"IMG"==h.tagName?this.#Ha(h,r.getElementById("layerSpecificUI"),a):(h.style.display="block",this.#za(h,a)),this.#Fa(d.#ma,n)):this.#ja(e,t,a,i,s)}#Ha(e,t,i){-1!=i.width&&-1!=i.height?(console.log(t.style.width+"/"+t.style.height),e.style.width=i.width+"px",e.style.height=i.height+"px",t.style.width=i.width+"px",t.style.height=i.height+"px",console.log("change designation size.")):e.width&&e.height?(e.style.width=e.width,e.style.height=e.height,t.style.width=e.width+"px",t.style.height=e.height+"px"):(e.style.width="100%",e.style.height="auto",this.#va.style.width=this.#Ia.width,this.#va.style.height=this.#Ia.height),e.style.display="block"}#Fa(e,t){var i=this.#va.ownerDocument;if(i.getElementById(t)&&i.getElementById(t).contentWindow){var s=i.getElementById(t),r=s.contentWindow.document.createEvent("HTMLEvents");r.initEvent(e,!0,!1),s.contentWindow.document.dispatchEvent(r);var a=document.createEvent("HTMLEvents");a.initEvent(e,!0,!1),document.dispatchEvent(a)}}#Wa(e){var t=e.indexOf("#"),i=e.indexOf("?");i>t&&(i=-1);var s,r="disableCacheQuery="+(new Date).getTime();return s=i>0?"&":"?",t>0?e.substring(0,t)+s+r+e.substring(t):e+s+r}initSvgMapWebAppLayer=function(e){var t;for(var i in this.#Ma){var s=this.#Ma[i];if(s.iframe.contentWindow===e){t=s;break}}t&&(console.log("Do initSvgMapWebAppLayer: layerID: ",i),this.#Ya(t.iframe,t.lid,t.reqSize,t.controllerURL,t.cbf),delete this.#Ma[t.lid])}.bind(this);#ja(e,t,i,s,r){var a=this.#ka,o=this.#va.ownerDocument.createElement("iframe");a.appendChild(o);var n=this.#Ea(e);o.id=n,s&&(o.style.display="none"),this.#Ma[e]={iframe:o,lid:e,reqSize:i,controllerURL:t,cbf:r},this.#Xa(o,function(){this.#Ma[e]?(this.#Ya(o,e,i,t,r),delete this.#Ma[e]):console.log("skip")}.bind(this),!1);var l=this.#Za(t);if(":"!=t.charAt(0)&&0==l)if("http://"==t.substr(0,7)||"https://"==t.substr(0,8)){var h=new XMLHttpRequest,g=this;h.onreadystatechange=function(){g.#qa(this,o,e,i)},h.open("GET",t,!0),h.send(null)}else o.src=t,o.src=this.#Wa(t);else{var d;if(l)d=this.#_a('<img src="'+t+'">');else if(this.#o.getSvgImagesProps()[e].controller)d=this.#o.getSvgImagesProps()[e].controller.src;else{var c="<h4>svgScript only  layerUI</h4>LayerID:"+e;d=this.#_a(c)}o.srcdoc=d,o.getAttribute("srcdoc")||(console.log("patch for IE&Edge:"),d=d.replace(/&quot;/g,'"'),o.contentWindow.document.write(d),o.contentWindow.document.close())}return o.setAttribute("frameborder","0"),o.style.width="100%",o.style.height="100%",o.style.border="none",s||(o.style.display="block"),o}#Za(e){return e.indexOf(".png")>0||e.indexOf(".jpg")>0||e.indexOf(".jpeg")>0||e.indexOf(".gif")>0}#_a(e){return"<!doctype html><html><body>"+e+"</body></html>"}#Ya(e,t,i,s,r){var a=e.id;this.#Fa(d.#pa,a),0==this.#Pa&&(this.#Pa=this.#va.offsetHeight),e.contentWindow.layerID=t,e.contentWindow.controllerSrc=s,e.contentWindow.svgMap=this.#o,void 0!==this.#_t&&(e.contentWindow.svgMapGIStool=this.#_t),void 0!==this.#fa&&(e.contentWindow.svgMapAuthoringTool=this.#fa),"undefined"!=typeof svgMapPWA&&(e.contentWindow.svgMapPWA=svgMapPWA),e.contentWindow.svgMapLayerUI=this.#ba,e.contentWindow.putGlobalMessage=this.#xa.putGlobalMessageForLayer(t);var o=this.#o.getSvgImagesProps()[t];e.contentWindow.svgImageProps=o,o.controllerWindow=e.contentWindow,e.contentWindow.svgImage=this.#o.getSvgImages()[t],this.#Ka[t]?(document.removeEventListener("zoomPanMap",this.#Ka[t],!1),document.removeEventListener("screenRefreshed",this.#Ka[t],!1),document.removeEventListener("zoomPanMapCompleted",this.#Ka[t],!1)):this.#Ka[t]=this.#Ja(t),o.svgScript&&this.#Qa(o.svgScript,e.contentWindow),"function"==typeof e.contentWindow.preRenderFunction&&(this.#o.getSvgImagesProps()[t].preRenderControllerFunction=e.contentWindow.preRenderFunction),this.#$a(e.contentWindow),e.contentWindow.setLoadingFlag=function(e){var i=this.#o.getSvgImagesProps();console.log("registLoadingFlag:",i[t]),1==e?this.#eo(t,i):0==e&&this.#to(t,i)},document.addEventListener("zoomPanMap",this.#Ka[t],!1),document.addEventListener("screenRefreshed",this.#Ka[t],!1),document.addEventListener("zoomPanMapCompleted",this.#Ka[t],!1),setTimeout(function(e,t){this.#za(e,t)}.bind(this),1e3,e,i),r&&r(e.contentWindow)}#Xa(e,t,i){var s,r=!1;function a(){r||(r=!0,clearTimeout(s),t.call(this),e.contentWindow.removeEventListener("error",h))}function o(){"complete"===this.readyState&&a.call(this)}function n(e,t,i){return e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,function(){return i.call(e,window.event)})}i&&n(e,"load",function(){a.call(e.contentDocument||e.contentWindow.document)});var l=!1;function h(e){console.warn("iFrame error:",e.message),l=!0}e.contentWindow.addEventListener("error",h),function t(){var i=e.contentDocument||e.contentWindow.document;if(0!==i.URL.indexOf("about:blank"))if("complete"===i.readyState){if(console.warn("Already load completed."),a.call(i),l){console.warn("Retry load process ....");var r=new Event("load");e.contentWindow.dispatchEvent(r)}}else n(i,"DOMContentLoaded",a),n(i,"readystatechange",o);else s=setTimeout(t,1)}()}#Qa(e,t){var i="";console.log("controllerWindow:",t),t.svgImageProps&&t.svgImageProps.CRS&&t.svgImageProps.CRS.unresolved&&t.svgImageProps.CRS.transformFunctionName&&(i="transformFunction: "+t.svgImageProps.CRS.transformFunctionName+",",console.log("transformRetStr set:",i)),t.svgScript=t.Function(`\n\t\t\t${e}\n\t\t\tvar document = svgImage;\n//\t\t\tvar refreshScreen = function(){svgMap.refreshScreen()};\n\t\t\tconsole.log("arrangeHtmlEmbedScript svgScript launched : location.href:",location.href);\n\t\t\tsetTimeout(function(){\n\t\t\t\tconsole.log("arrangeHtmlEmbedScript svgScript Timeout: layerID:",layerID,"  svgImage : ", svgImage);\n\t\t\t\tdocument = svgImage;\n//\t\t\t\ttransform = svgMap.transform.bind(svgMap);\n\t\t\t\tsvgMap.refreshScreen();\n\t\t\t},1);\n\t\t\t\n\t\t\tvar scale,geoViewBox,CRS,docId,actualViewBox;\n\t\t\tvar onload, onzoom, onscroll; \n\t\t\tfunction preRenderFunction(svgDocStatus){\n\t\t\t\t\n\t\t\t\tscale = svgImageProps.scale;\n\t\t\t\tsvgImageProps.script.scale = scale;\n\t\t\t\tgeoViewBox = svgImageProps.geoViewBox;\n\t\t\t\tactualViewBox = svgDocStatus.actualViewBox;\n\t\t\t\tsvgImageProps.script.geoViewBox = geoViewBox;\n\t\t\t\tCRS = svgImageProps.CRS;\n\t\t\t\tsvgImageProps.script.CRS = CRS;\n\t\t\t\tdocId = layerID;\n\t\t\t\tsvgImageProps.script.location=svgDocStatus.location;\n\t\t\t\t\n\t\t\t\t// console.log("svgScript preRenderFunction　this?:",this, geoViewBox);\n\t\t\t\tif ( svgDocStatus && svgDocStatus.viewChanged=="scroll"){\n\t\t\t\t\tif ( typeof(onscroll)=="function" && window.onscroll!=onscroll ){ \n\t\t\t\t\t\tonscroll.call(svgImageProps.script);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif ( typeof(onzoom)=="function" && window.onzoom!=onzoom ){\n\t\t\t\t\t\tonzoom.call(svgImageProps.script);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfunction refreshScreen(...params){\n\t\t\t\treturn ( svgMap.refreshScreen(...params));\n\t\t\t}\n\t\t\tfunction transform(...params){\n\t\t\t\treturn ( svgMap.transform(...params));\n\t\t\t}\n\t\t\tfunction getCanvasSize(){\n\t\t\t\treturn ( svgMap.getCanvasSize());\n\t\t\t}\n\t\t\tfunction getCORSURL(originalURL, alsoCrossoriginParam){\n\t\t\t\treturn ( svgMap.getCORSURL(originalURL, alsoCrossoriginParam));\n\t\t\t}\n\t\t\t\n\t\t\tfunction onloadFunction(svgDocStatus){\n\t\t\t\t// console.log("window.onload:",window.onload,"  this.onload:",this.onload,"  onload:",onload," window.onload==onload?:",window.onload==onload);\n\t\t\t\t\n\t\t\t\tscale = svgImageProps.scale;\n\t\t\t\tsvgImageProps.script.scale = scale;\n\t\t\t\tgeoViewBox = svgImageProps.geoViewBox;\n\t\t\t\tactualViewBox = svgDocStatus.actualViewBox;\n\t\t\t\tsvgImageProps.script.geoViewBox = geoViewBox;\n\t\t\t\tCRS = svgImageProps.CRS;\n\t\t\t\tsvgImageProps.script.CRS = CRS;\n\t\t\t\tdocId = layerID;\n\t\t\t\tsvgImageProps.script.location=svgDocStatus.location;\n\t\t\t\t\n\t\t\t\tif ( typeof(onload)=="function" && window.onload!=onload ){\n//\t\t\t\t\tsvgImageProps.script.location=svgDocStatus.location;\n\t\t\t\t\t// console.log("onloadFunctionZ　this?:",this, "  location:",location,"  svgDocStatus:",svgDocStatus);\n\t\t\t\t\tonload.call(svgImageProps.script); \n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tfunction getTransforrmFunction(fName){\n\t\t\t\t\n\t\t\t\tvar ans= new Function("return " + fName );\n\t\t\t\treturn ( ans );\n\t\t\t}\n\t\t\t\n\t\t\treturn{\n\t\t\t\tonloadFunction : onloadFunction,\n\t\t\t\tpreRenderFunction : preRenderFunction,\n\t\t\t\t${i}\n\t\t\t}\n\t\t`),t.svgImageProps.script=t.svgScript(),t.preRenderFunction||(t.preRenderFunction=t.svgImageProps.script.preRenderFunction),t.svgImageProps.script.onloadFunction(this.#Sa(t.layerID))}#$a(e){var t,i,s=this.#o.getSvgImagesProps(),r=this;e.fetch=function(t){return async function(){r.#eo(e.layerID,s);const i=await t.apply(e,arguments);return r.#to(e.layerID,s),i}}(e.fetch),t=e.XMLHttpRequest.prototype.send,e.XMLHttpRequest.prototype.send=function(){r.#eo(e.layerID,s);var i=this.onreadystatechange;this.onreadystatechange=function(){4==this.readyState&&(this.responseURL,r.#to(e.layerID,s)),i&&i.apply(this,arguments)},t.apply(this,arguments)},i=e.XMLHttpRequest.prototype.open,e.XMLHttpRequest.prototype.open=function(){i.apply(this,arguments)}}#eo(e,t){t[e].xhrLoading?++t[e].xhrLoading:t[e].xhrLoading=1,this.#io=!1}#to(e,t){t[e].xhrLoading?--t[e].xhrLoading:console.error("svgImagesProps["+e+"].xhrLoading flag is inconsistent."),this.#so(t)}#ro(){var e=this.#o.getSvgImagesProps();this.#ao=!0,this.#so(e)}#so(e){var t=0;for(var i in e)e[i].xhrLoading&&(t+=e[i].xhrLoading);0==t&&0==this.#io&&(this.#io=!0,setTimeout(function(){this.#oo()}.bind(this),d.#ca))}#ao=!1;#io=!1;#oo(){if(this.#io){if(this.#ao){this.#ao=!1;var e=document.createEvent("HTMLEvents");e.initEvent("zoomPanMapCompleted",!0,!1),document.dispatchEvent(e)}this.#io=!1}}#qa(e,t,i,s){if(4==e.readyState)if(403!=e.status&&404!=e.status&&500!=e.status&&503!=e.status){var r=e.responseText,a=`<base href='${e.responseURL}'>`;r=r.indexOf("<head>")>-1?r.replace("<head>",`<head>${a}`):r.replace(/<html[^>]*>/,`$&<head>${a}</head>`),t.srcdoc=r,t.getAttribute("srcdoc")||(console.log("patch for IE&Edge"),r=r.replace(/&quot;/g,'"'),t.contentWindow.document.write(r),t.contentWindow.document.close())}else console.log("csvXHR2 : File get failed")}#no(e){return e&&e.indexOf("px")>0?Number(e.substring(0,e.indexOf("px"))):0}#lo=0;#ho(e,t){this.#Ra&&(0==e.offsetWidth?this.#Ra.style.right="0px":this.#va.clientWidth-e.offsetWidth!=this.#lo&&(this.#lo=this.#va.clientWidth-e.offsetWidth,this.#lo>0?this.#Ra.style.right=this.#lo+"px":this.#Ra.style.right="0px"),t||this.#va.clientWidth!=e.offsetWidth||setTimeout(function(e,t){this.#ho(e,t)}.bind(this),1e3,e,!0))}#za(e,t){if("none"!=e.style.display){var i=window.innerHeight-this.#no(this.#Ia.top)-50,s=window.innerWidth-this.#no(this.#Ia.left)-this.#no(this.#Ia.right)-50;!e.contentWindow||this.#Va.element&&!this.#Va.autoSizing||(this.#ho(e.contentWindow.document.documentElement),t.width>0?t.width<s?this.#va.style.width=t.width+"px":this.#va.style.width=s+"px":this.#va.style.width=this.#Ia.width,t.height>0?t.height<i?this.#va.style.height=t.height+"px":this.#va.style.height=i+"px":e.contentWindow.document.body.offsetHeight<this.#Pa?this.#va.style.height=50+e.contentWindow.document.body.offsetHeight+"px":this.#va.style.height=this.#Ia.height)}}#Ka=[];#Ja(e){return function(t){var i=this.#va.ownerDocument.getElementById(this.#Ea(e));if(i){var s=i.contentWindow.document.createEvent("HTMLEvents");s.initEvent(t.type,!0,!1),i.contentWindow.document.dispatchEvent(s)}}.bind(this)}#Ga(){var e=this.#va.ownerDocument,t=this.#Ua();this.#Fa(d.#ya,t),e.getElementById(t).style.display="none",this.#Va.element&&!this.#Va.isInline||(this.#va.style.display="none",this.#va.style.height=this.#Ia.height)}#Ca(e,t){if(this.#va){var i=this.#va.ownerDocument,s=this.#Ua(),r=this.#Ea(e);if(0==t&&i.getElementById(r)){s==r&&this.#Ga();var a=i.getElementById(r);console.log("close layer specific UI for:",e),document.removeEventListener("zoomPanMap",this.#Ka[e],!1),document.removeEventListener("screenRefreshed",this.#Ka[e],!1),document.removeEventListener("zoomPanMapCompleted",this.#Ka[e],!1),delete this.#Ka[e],this.#Fa(d.#ua,r),this.#xa.clearGlobalMessage(e),setTimeout(function(){console.log("remove iframe:",a.id),a.parentNode.removeChild(a)},100)}}}#go=!1;#do(){var e=this.#o.getRootLayersProps();this.#go=!1;for(var t=0;t<e.length;t++)e[t].visible&&(e[t].svgImageProps&&e[t].hasDocument?this.#Aa(e[t].svgImageProps,e[t].id):this.#go=!0)}#co(){this.#go&&this.#do()}#Na(){addEventListener("zoomPanMap",function(e){this.#co(e)}.bind(this),!1),addEventListener("zoomPanMap",function(e){this.#ro(e)}.bind(this),!1),addEventListener("screenRefreshed",function(e){this.#co(e)}.bind(this),!1),this.#do()}assignLayerSpecificUiElement(...e){return this.#Da(...e)}initLayerSpecificUI(...e){return this.#Ba(...e)}showLayerSpecificUI(...e){return this.#Oa(...e)}updateLayerSpecificWebAppHandler(){this.#wa(),this.#do()}}class c{getTransformedBox(e,t){if(t.transform||0!=t.b||0!=t.c){if(t.transform){if(t.transform){for(i=[],s=[],r=4,a=0;a<=r;a++)for(o=0;o<=r;o++){n=t.transform({x:e.x+o*e.width/r,y:e.y+a*e.height/r});i.push(n.x),s.push(n.y)}return{x:l=Math.min.apply(null,i),y:h=Math.min.apply(null,s),width:Math.max.apply(null,i)-l,height:Math.max.apply(null,s)-h}}return null}for(var i=[],s=[],r=1,a=0;a<=r;a++)for(var o=0;o<=r;o++){var n=this.transform(e.x+o*e.width/r,e.y+a*e.height/r,t);i.push(n.x),s.push(n.y)}return{x:l=Math.min.apply(null,i),y:h=Math.min.apply(null,s),width:Math.max.apply(null,i)-l,height:Math.max.apply(null,s)-h}}var l,h,g,d;return t.a>0?(l=t.a*e.x+t.e,g=t.a*e.width):(l=t.a*(e.x+e.width)+t.e,g=-t.a*e.width),t.d>0?(h=t.d*e.y+t.f,d=t.d*e.height):(h=t.d*(e.y+e.height)+t.f,d=-t.d*e.height),{x:l,y:h,width:g,height:d}}matMul(e,t){return e.transform||t.transform?{transform:function(i){var s;return s=e.transform?e.transform(i):this.transform(i.x,i.y,e),t.transform?t.transform(s):this.transform(s.x,s.y,t)}.bind(this)}:{a:t.a*e.a+t.b*e.b,b:t.b*e.a+t.d*e.b,c:t.a*e.c+t.c*e.d,d:t.b*e.c+t.d*e.d,e:t.a*e.e+t.c*e.f+t.e,f:t.b*e.e+t.d*e.f+t.f}}transform(e,t,i,s,r){if(1==s){if(i.transform){var a=i.transform(0,0);return(o=i.transform({x:e,y:t})).x=o.x-a.x,o.y=o.y-a.y,o}return{x:i.a*e+i.c*t,y:i.b*e+i.d*t}}if(r){let s=1;return r.docDPR&&(s=r.docDPR),i?i.transform?((o=i.transform({x:r.x,y:r.y})).x=o.x+e*s,o.y=o.y+t*s,o):{x:i.a*r.x+i.c*r.y+i.e+e*s,y:i.b*r.x+i.d*r.y+i.f+t*s}:{x:r.x+e*s,y:r.y+t*s}}var o;return i?i.transform?o=i.transform({x:e,y:t}):{x:i.a*e+i.c*t+i.e,y:i.b*e+i.d*t+i.f}:{x:e,y:t}}SVG2Geo(e,t,i,s){var r;if(r=s||this.getInverseMatrix(i)){var a=this.transform(e,t,r);return{lng:a.x,lat:a.y}}return null}Geo2SVG(e,t,i){return this.transform(t,e,i)}getConversionMatrixViaGCS(e,t){var i=this.getInverseMatrix(e);if(t.transform||e.transform){var s=this.getInverseMatrix(t);return{transform:function(e){var s=this.transform(e.x,e.y,i);return this.transform(s.x,s.y,t)}.bind(this),inverse:function(t){var i=this.transform(t.x,t.y,s);return this.transform(i.x,i.y,e)}.bind(this),scale:(i.inverse?i.scale:Math.sqrt(Math.abs(i.a*i.d-i.b*i.c)))*(t.inverse?t.scale:Math.sqrt(Math.abs(t.a*t.d-t.b*t.c)))}}var r=t.a*i.a+t.c*i.b,a=t.b*i.a+t.d*i.b,o=t.a*i.c+t.c*i.d,n=t.b*i.c+t.d*i.d;return{a:r,b:a,c:o,d:n,e:t.a*i.e+t.c*i.f+t.e,f:t.b*i.e+t.d*i.f+t.f,scale:Math.sqrt(Math.abs(r*n-a*o))}}matMul(e,t){return e.transform||t.transform?{transform:function(i){var s;return s=e.transform?e.transform(i):this.transform(i.x,i.y,e),t.transform?t.transform(s):this.transform(s.x,s.y,t)}.bind(this)}:{a:t.a*e.a+t.c*e.b,b:t.b*e.a+t.d*e.b,c:t.a*e.c+t.c*e.d,d:t.b*e.c+t.d*e.d,e:t.a*e.e+t.c*e.f+t.e,f:t.b*e.e+t.d*e.f+t.f}}transformRect(e,t){var i;i=e.transform?this.matMul(e.transform,t):t;var s=this.getTransformedBox(e,i);return s.c2rScale=t.scale,s}getInverseMatrix(e){if(e.inverse)return{transform:e.inverse,inverse:e.transform,scale:1/e.scale};var t=e.a*e.d-e.b*e.c;return 0!=t?{a:e.d/t,b:-e.b/t,c:-e.c/t,d:e.a/t,e:(-e.d*e.e+e.c*e.f)/t,f:(e.b*e.e-e.a*e.f)/t}:null}}class p{constructor(){this.scale=1/360,this.mercator=!0}#po(e,t){var i=Math.sin(e*Math.PI/180);return{x:(t+180)/360*1,y:1*(.5-Math.log((1+i)/(1-i))/(4*Math.PI))}}#uo(e,t){var i=e/1-.5,s=.5-t/1;return{lat:90-360*Math.atan(Math.exp(2*-s*Math.PI))/Math.PI,lng:360*i}}transform=function(e){return this.#po(e.y,e.x)}.bind(this);inverse=function(e){var t=this.#uo(e.x,e.y);return{x:t.lng,y:t.lat}}.bind(this);scale;mercator}class u{#mo=!1;#yo;#vo;#fo;#bo;#Io;#Po;#So;#qt;#e;constructor(e,t,i,s,r,a,o){this.#fo=e,this.#bo=t,this.#Io=i,this.#Po=s,this.#So=r,this.#e=o,this.#qt=a}#xo(e){e.touches.length>1&&this.#Mo(e.touches.length+" : "+e.touches[0].pageX+","+e.touches[0].pageY+" : "+e.touches[1].pageX+","+e.touches[1].pageY)}#Mo(e){document.getElementById("posCmt").innerHTML=e}#wo=0;#Co(e){var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;return Math.sqrt(t*t+i*i)}getMouseXY=function(e){var t,i;return this.#qt.uaProps.isIE?(t=event.clientX,i=event.clientY):e.type.indexOf("touch")>=0?e.touches.length>0?(t=e.touches[0].pageX,i=e.touches[0].pageY):e.changedTouches.length>0&&(t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY):(t=e.clientX,i=e.clientY),{x:t,y:i}}.bind(this);startPan=function(e){this.#Lo=0,this.#Ao=0,e&&e.button&&2==e.button?this.#Eo=1:this.#Eo=-1;var t=!1;e&&e.shiftKey&&-1==this.#Eo&&(console.log("SHIFT-ZOOM MODE"),t=!0);var i=this.getMouseXY(e);return this.#yo=i.x,this.#vo=i.y,this.#wo=0,!this.#qt.uaProps.isIE&&e.type.indexOf("touch")>=0&&e.touches.length>1&&(this.#Eo=1,this.#wo=this.#Co(e)),this.#To=0,this.#Oo=0,this.#fo(),this.#mo=!0,1==t?"function"==typeof requestAnimationFrame?this.#ko=requestAnimationFrame(this.#Ro):this.#ko=setTimeout(this.#Ro,this.#Bo):"function"==typeof requestAnimationFrame?this.#ko=requestAnimationFrame(this.#Vo):this.#ko=setTimeout(this.#Vo,this.#Bo),!!this.#qt.uaProps.isIE}.bind(this);#ko;endPan=function(){if(clearTimeout(this.#ko),this.#mo)if(this.#mo=!1,this.#Go&&""==this.#Go.style.display){this.#Go.style.display="none";var e=Math.min(this.#yo+this.#To,this.#yo),t=Math.max(this.#vo+this.#Oo,this.#vo),i=this.#e.screen2Geo(e,t);e=Math.max(this.#yo+this.#To,this.#yo),t=Math.min(this.#vo+this.#Oo,this.#vo);var s=this.#e.screen2Geo(e,t);this.#bo(!0),this.#e.setGeoViewPort(i.lat,i.lng,s.lat-i.lat,s.lng-i.lng)}else if(0!=this.#To||0!=this.#Oo)if(this.#qt.mapCanvas.style.top="0px",this.#qt.mapCanvas.style.left="0px",this.#No(this.#qt.mapCanvas,{a:1,b:0,c:0,d:1,e:0,f:0}),this.#bo(!0),-1!=this.#Eo)this.zoom(1/this.#Eo),this.#Eo=-1;else{this.#Do(1,this.#To,this.#Oo);var r=this.#So(),a=this.#e.getRootViewBox();a.x-=this.#To/r.a,a.y-=this.#Oo/r.d,this.#e.setRootViewBox(a),this.#e.refreshScreen()}else this.#Io(this.#yo,this.#vo)}.bind(this);#To;#Oo;#Lo;#Ao;#Eo=-1;wheelZooming=!1;showPanning=function(e){if(this.#mo){if(this.wheelZooming&&"wheelDummy"!=e.type)return!1;this.#qt.uaProps.isIE?0==event.buttons?this.endPan():(this.#To=event.clientX-this.#yo,this.#Oo=event.clientY-this.#vo):e.type.indexOf("touch")>=0?(this.#To=e.touches[0].pageX-this.#yo,this.#Oo=e.touches[0].pageY-this.#vo,-1!=this.#Eo&&(this.#Eo=this.#Co(e)/this.#wo)):0==e.buttons?this.endPan():(this.#To=e.clientX-this.#yo,this.#Oo=e.clientY-this.#vo),this.#Eo>0&&(0==this.#wo&&(this.#Eo=Math.exp(this.#Oo/(this.#qt.mapCanvasSize.height/2))/Math.exp(0)),this.#Eo<.1&&(this.#Eo=.1)),Math.abs(this.#Lo-this.#To)>200||Math.abs(this.#Ao-this.#Oo)>200?this.endPan():(this.#Lo=this.#To,this.#Ao=this.#Oo)}return!1}.bind(this);#Go;#Ro=function(){if(this.#mo){this.#Go||(this.#Go=document.createElement("span"),this.#Go.id="shiftZoomingBox",this.#Go.style.position="absolute",this.#Go.style.opacity="0.5",this.#Go.style.backgroundColor="gray",document.getElementById("centerSight").insertAdjacentElement("afterend",this.#Go)),this.#Go.style.display="";var e=Math.min(this.#yo+this.#To,this.#yo),t=Math.min(this.#vo+this.#Oo,this.#vo);this.#Go.style.top=t+"px",this.#Go.style.left=e+"px",this.#Go.style.width=Math.abs(this.#To)+"px",this.#Go.style.height=Math.abs(this.#Oo)+"px","function"==typeof requestAnimationFrame?this.#ko=requestAnimationFrame(this.#Ro):this.#ko=setTimeout(this.#Ro,this.#Bo)}}.bind(this);#Vo=function(){return this.#mo&&(this.#Uo(this.#To,this.#Oo,this.#Eo),"function"==typeof requestAnimationFrame?this.#ko=requestAnimationFrame(this.#Vo):this.#ko=setTimeout(this.#Vo,this.#Bo)),!1}.bind(this);#No(e,t){var i;i=(this.#qt.uaProps.verIE,"matrix("+t.a+","+t.b+","+t.c+","+t.d+","+t.e+","+t.f+")"),e.style.transform=i,e.style.webkitTransform=i,e.style.MozTransform=i,e.style.msTransform=i,e.style.OTransform=i}#Uo(e,t,i){var s;this.#qt.uaProps.verIE>8?(s=-1!=i?{a:i,b:0,c:0,d:i,e:0,f:0}:{a:1,b:0,c:0,d:1,e:e,f:t},this.#No(this.#qt.mapCanvas,s)):(this.#qt.mapCanvas.style.top=t+"px",this.#qt.mapCanvas.style.left=e+"px")}zoom=function(e){var t=this.#e.getRootViewBox(),i=t.x+.5*t.width,s=t.y+.5*t.height;t.width=t.width*e,t.height=t.height*e,t.x=i-t.width/2,t.y=s-t.height/2,this.#e.setRootViewBox(t),this.#Do(1/e,0,0),this.#e.refreshScreen()}.bind(this);#Fo=300;#Ho=0;#Bo=20;setSmoothZoomTransitionTime=function(e){Number(e)>0?this.#Fo=Number(e):this.#Fo=300}.bind(this);setSmoothZoomInterval=function(e){Number(e)>0?this.#Bo=Number(e):this.#Bo=20}.bind(this);#zo(e,t,i,s){if(s||(s=1),!t){if(-1!=this.#Eo)return void(this.#Ho=e);t=new Date}var r=new Date-t,a=this;if(i)if(0!=this.#Ho){var o=e*this.#Ho;"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){a.#zo(o,new Date,!1,e)}):setTimeout(function(e,t,i,s){this.#zo(e,t,i,s)}.bind(this),this.#Bo,o,new Date,!1,e),this.#Ho=0}else this.#qt.mapCanvas.style.top="0px",this.#qt.mapCanvas.style.left="0px",this.#No(this.#qt.mapCanvas,{a:1,b:0,c:0,d:1,e:0,f:0}),this.#Eo=-1,this.#bo(!0),this.zoom(e);else r<this.#Fo?(this.#Eo=1/s+(1/e-1/s)*(r/this.#Fo),this.#Uo(0,0,this.#Eo),"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){a.#zo(e,t,!1,s)}.bind(this)):setTimeout(function(e,t,i,s){this.#zo(e,t,i,s)}.bind(this),this.#Bo,e,t,!1,s)):(this.#Uo(0,0,1/e),"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){a.#zo(e,t,!0,s)}.bind(this)):setTimeout(function(e,t,i,s){this.#zo(e,t,i,s)}.bind(this),this.#Bo,e,t,!0,s))}#Do(e,t,i){var s=this.#qt.mapCanvas.querySelectorAll("img, span"),r=this.#qt.mapCanvasSize;if(this.#qt.uaProps.IE)for(var a=s.length-1;a>=0;a--)s.item(a).parentNode.removeChild(s.item(a));else{var o=[],n=[];for(a=s.length-1;a>=0;a--){const c=s.item(a);var l=Number(c.style.left.replace("px","")),h=Number(c.style.top.replace("px","")),g=Number(c.width),d=Number(c.height);o[a]=this.#Po((l-.5*r.width)*e+.5*r.width+t,g*e),n[a]=this.#Po((h-.5*r.height)*e+.5*r.height+i,d*e)}for(a=s.length-1;a>=0;a--){const e=s.item(a);var c=o[a],p=n[a],u=new Object;u.x=c.p0,u.y=p.p0,u.width=c.span,u.height=p.span,e.style.left=c.p0+"px",e.style.top=p.p0+"px","IMG"===e.tagName&&(e.width=c.span,e.height=p.span,e.style.width=c.span+"px",e.style.height=p.span+"px")}}for(a=(s=this.#qt.mapCanvas.getElementsByTagName("canvas")).length-1;a>=0;a--){const o=s.item(a);l=0,h=0,g=Number(o.width),d=Number(o.height),c=this.#Po((l-.5*r.width)*e+.5*r.width+t,g*e),p=this.#Po((h-.5*r.height)*e+.5*r.height+i,d*e);o.style.left=c.p0+"px",o.style.top=p.p0+"px",o.width=c.span,o.height=p.span}}#jo=1.7320508;setZoomRatio(e){this.#jo=e}zoomup=function(){this.#zo(1/this.#jo)}.bind(this);zoomdown=function(){this.#zo(this.#jo)}.bind(this)}class m{verIE=100;isIE=!1;isSP;uaProp;name;MS;IE;Edge;Blink;smartPhone;old;constructor(){this.isSP=this.#Wo(),this.uaProp=this.#Yo(),this.#Xo()}#Wo(){return navigator.userAgent.indexOf("iPhone")>0||navigator.userAgent.indexOf("iPad")>0||navigator.userAgent.indexOf("iPod")>0||navigator.userAgent.indexOf("Android")>0||navigator.userAgent.indexOf("Mobile")>0&&navigator.userAgent.indexOf("Gecko")>0}#Yo(){var e,t=!1,i=!1,s=!1,r=!1,a=!1,o=this.#Wo();return navigator.userAgent.indexOf("Trident")>=0?(e="IE",t=!0,i=!0):navigator.userAgent.indexOf("MSIE")>=0?(e="IE",t=!0,i=!0,a=!0):navigator.userAgent.indexOf("Edge")>=0?(e="Edge",t=!0,r=!0):navigator.userAgent.indexOf("Firefox")>=0?e="Firefox":navigator.userAgent.indexOf("Opera")>=0?(e="Opera",s=!0):navigator.userAgent.indexOf("Safari")>=0&&navigator.userAgent.indexOf("Chrome")<0?e="Safari":navigator.userAgent.indexOf("Chrome")>=0&&(e="Chrome",s=!0),this.name=e,this.MS=t,this.IE=i,this.Edge=r,this.Blink=s,this.smartPhone=o,this.old=a,{name:e,MS:t,IE:i,Edge:r,Blink:s,smartPhone:o,old:a}}#Xo(){if("Microsoft Internet Explorer"==navigator.appName||navigator.userAgent.indexOf("Trident")>=0){this.isIE=!0;var e=navigator.appVersion.toLowerCase();console.log("checkIE:",e),e.indexOf("msie")>-1?this.verIE=parseInt(e.replace(/.*msie[ ]/,"").match(/^[0-9]+/)):this.verIE=parseInt(e.match(/(msie\s|rv:)([\d\.]+)/)[2])}}}class y{#e;#Zo;#rt;#qo;constructor(e,t){this.#e=e,this.#Zo=new c,this.#rt=t,this.#_o=new Object}GISgeometriesCaptureFlag=!1;GISgeometriesCaptureOptions={BitImageGeometriesCaptureFlag:!1,TreatRectAsPolygonFlag:!1,SkipVectorRendering:!1,captureAlsoAsBitImage:!1};#_o;#Ko;#Jo(){console.log("CGET:",(new Date).getTime()-this.#Ko)}captureGISgeometries(e,t,i,s,r,a,o,n){if(this.GISgeometriesCaptureFlag)return console.log("Now processing another captureGISgeometries. Try later."),e(!1),!1;this.#Ko=(new Date).getTime(),this.GISgeometriesCaptureFlag=!0,this.#_o=new Object;var l=function(){document.removeEventListener("screenRefreshed",l,!1),console.log("screenRefreshed start prepare Geom"),this.#Jo(),this.#Qo(e,t,i,s,r,a,o,n)}.bind(this);document.addEventListener("screenRefreshed",l,!1),console.log("Start capture geom"),this.#e.refreshScreen()}#Qo(e,t,i,s,r,a,o,n){var l=this.#e.getSvgImagesProps();for(var h in this.#_o){var g=this.#_o[h];if(g.length>0)for(var d,c,p=l[h].CRS,u=this.#Zo.getInverseMatrix(p),m=0;m<g.length;m++){var y=g[m];if("Point"===y.type)d=this.#Zo.SVG2Geo(y.svgXY[0],y.svgXY[1],null,u),y.coordinates=[d.lng,d.lat];else if("Coverage"===y.type)if(y.coordinates=new Array,!y.transform||y.transform&&0==y.transform.b&&0==y.transform.c){if(y.transform){var v=this.#Zo.transform(y.svgXY[0][0],y.svgXY[0][1],y.transform),f=this.#Zo.transform(y.svgXY[1][0],y.svgXY[1][1],y.transform);d=this.#Zo.SVG2Geo(v.x,v.y,null,u),c=this.#Zo.SVG2Geo(f.x,f.y,null,u)}else d=this.#Zo.SVG2Geo(y.svgXY[0][0],y.svgXY[0][1],null,u),c=this.#Zo.SVG2Geo(y.svgXY[1][0],y.svgXY[1][1],null,u);y.coordinates.push({lat:Math.min(d.lat,c.lat),lng:Math.min(d.lng,c.lng)}),y.coordinates.push({lat:Math.max(d.lat,c.lat),lng:Math.max(d.lng,c.lng)}),delete y.transform}else{y.coordinates.push({x:y.svgXY[0][0],y:y.svgXY[0][1]}),y.coordinates.push({x:y.svgXY[1][0],y:y.svgXY[1][1]});var b=this.#Zo.matMul(y.transform,u);y.transform=b}else if(y.coordinates=new Array,1==y.svgXY.length&&1==y.svgXY[0].length)d=this.#Zo.SVG2Geo(y.svgXY[0][0][0],y.svgXY[0][0][1],null,u),y.coordinates=[d.lng,d.lat],y.type="Point";else for(var I=0;I<y.svgXY.length;I++){var P=y.svgXY[I],S=new Array;if("Polygon"===y.type&&P.length>2||"MultiLineString"===y.type&&P.length>1){for(var x=0;x<P.length;x++){var M=P[x];if(d=this.#Zo.SVG2Geo(M[0],M[1],null,u),0==x)var w=d;S.push([d.lng,d.lat])}"Polygon"!==y.type||w.lat==d.lat&&w.lng==d.lng||S.push([w.lng,w.lat]),y.coordinates.push(S)}}delete y.svgXY}}this.GISgeometriesCaptureFlag=!1,this.GISgeometriesCaptureOptions.captureAlsoAsBitImage&&this.#$o(this.#_o),e(this.#_o,t,i,s,r,a,o,n)}prepareDocGeometries(e){this.#_o[e]||(this.#_o[e]=new Array)}removeDocGeometries(e){delete this.#_o[e]}addGeometry(e,t,i,s){t.href?(t.href=this.#rt(t.href,s),(i&&i.naturalHeight>0||0==t.href.indexOf("data:")||0==t.href.indexOf("blob:"))&&this.#_o[e].push(t)):this.#_o[e].push(t)}dummy2DContextBuilder(){var e={};for(var t of["clearRect","fillRect","strokeRect","fillText","strokeText","measureText","getLineDash","setLineDash","createLinearGradient","createRadialGradient","createPattern","beginPath","closePath","moveTo","lineTo","bezierCurveTo","quadraticCurveTo","arc","arcTo","ellipse","rect","fill","stroke","drawFocusIfNeeded","scrollPathIntoView","clip","isPointInPath","isPointInStroke","rotate","scale","translate","transform","setTransform","resetTransform","drawImage","createImageData","getImageData","putImageData","save","restore","addHitRegion","removeHitRegion","clearHitRegions"])e[t]=function(){};return e}#$o(e){var t=this.getLayerCanvases(e),i=this.#e.getSvgImagesProps().root,s=svgMap.getGeoViewBox();for(var r in console.log("layerCanvases:",t," root SvgImagesProps:",i),t){var a=t[r].toDataURL("image/png");console.log("imgUri:",r," url:",a);var o=this.#en(a,s,i.CRS);e[r]=e[r].concat(o)}}#en(e,t,i){i.transform;var s=document.createElement("span");return s.setAttribute("iid","layerCanvasImage"),[{type:"Coverage",coordinates:[{lat:t.y,lng:t.x},{lat:t.y+t.height,lng:t.x+t.width}],href:e,layerCanvasImage:!0,src:s}]}splitImage=async function(e){var t=await this.getImage(e),i=Math.ceil(t.naturalWidth/4),s=Math.ceil(t.naturalHeight/4),r=document.createElement("canvas");r.width=i,r.height=s;for(var a=r.getContext("2d"),o=[],n=0;n<4;++n){for(var l=[],h=0;h<4;++h)a.clearRect(0,0,i,s),a.drawImage(t,h*i,n*s,i,s,0,0,i,s),l.push(r.toDataURL());o.push(l)}return o};getImage(e){return new Promise(function(t){var i=new Image;i.src=e,i.onload=function(){t(i)}})}getLayerCanvases(e){var t={};for(var i in e){var s=document.getElementById(i+"_canvas");s&&(t[i]=s)}return t}}class v{type;svgXY;src;static createSVGMapGISgeometry(e,i,s,r){return e==t.EMBEDSVG?(console.log("return null for GISGeometry"),null):e!=t.BITIMAGE||r.BitImageGeometriesCaptureFlag?new v(e,i,s,r):(console.log("return null for GISGeometry"),null)}constructor(e,i,s,r){switch(e){case t.EMBEDSVG:break;case t.BITIMAGE:r.BitImageGeometriesCaptureFlag&&(this.type="Coverage");break;case t.POI:this.type="Point";break;case t.VECTOR2D:switch(i){case t.PATH:this.type="TBD";break;case t.POLYLINE:this.type="MultiLineString";break;case t.POLYGON:this.type="Polygon";break;case t.RECT:r.TreatRectAsPolygonFlag?this.type="Polygon":this.type="Point";break;case t.CIRCLE:case t.ELLIPSE:this.type="Point"}}this.type&&(this.src=s)}determineType(e){"TBD"===this.type&&(e.fill&&"none"!=e.fill?this.type="Polygon":this.type="MultiLineString"),e.usedParent&&(this.usedParent=e.usedParent,this.type="Point")}setCoverage(e,t,i,s,r,a){this.svgXY=[],this.svgXY[0]=[e,t],this.svgXY[1]=[e+i,t+s],this.transform=r,this.href=a}setPoint(e,t){this.svgXY=[e,t]}makePath(){this.svgXY=new Array}startSubPath(e,t){var i=[[e,t]];this.svgXY.push(i)}addSubPathPoint(e,t){var i=[e,t];this.svgXY[this.svgXY.length-1].push(i)}}class f{static getLinearTransformMatrix(e,t,i,s,r,a,o,n,l,h,g,d){var c=f.getTernarySimultaneousEquationsSolution(e,t,1,i,s,1,r,a,1,o,l,g),p=f.getTernarySimultaneousEquationsSolution(e,t,1,i,s,1,r,a,1,n,h,d);return c&&p?{a:c.x1,c:c.x2,e:c.x3,b:p.x1,d:p.x2,f:p.x3}:null}static getTernarySimultaneousEquationsSolution(e,t,i,s,r,a,o,n,l,h,g,d){var c=e*r*l+t*a*o+i*s*n-e*a*n-t*s*l-i*r*o;return 0==c?null:{x1:(h*r*l+t*a*d+i*g*n-h*a*n-t*g*l-i*r*d)/c,x2:(e*g*l+h*a*o+i*s*d-e*a*d-h*s*l-i*g*o)/c,x3:(e*r*d+t*g*o+h*s*n-e*g*n-t*s*d-h*r*o)/c}}}class b{#Ws;#si;#tn;#Zo;constructor(e,t,i){this.#Ws=e,this.#si=this.#Ws.getSvgImagesProps(),this.#tn=t,this.#Zo=i}vectorDataWrapperForShowPoiProperty(e,t,i){var s=this.getVectorMetadata(e,i,t),r=this.getMetadataObject(s.metadata,s.metaSchema,s.title),a=this.#Ws.screen2Geo(t.x,t.y+t.height),o=this.#Ws.screen2Geo(t.x+t.width,t.y),n=e.getAttribute("content");i&&i.getAttribute("content")&&e.setAttribute("content",i.getAttribute("content")),console.log("targetElement:",e),e.setAttribute("lat",a.lat+","+o.lat),e.setAttribute("lng",a.lng+","+o.lng),e.setAttribute("data-title",r.title),this.showPoiPropertyWrapper(e),n?e.setAttribute("content",n):e.setAttribute("content",""),e.removeAttribute("data-title"),e.removeAttribute("lat"),e.removeAttribute("lng")}getVectorMetadata(e,t,i){console.log("called getVectorMetadata: ",e,t,i);var s=this.#Ws.screen2Geo(i.x,i.y+i.height),r=this.#Ws.screen2Geo(i.x+i.width,i.y),a="",o="";t&&t.getAttribute("content")?a=t.getAttribute("content"):e.getAttribute("content")&&(a=e.getAttribute("content")),t&&t.getAttribute("xlink:title")?o=t.getAttribute("xlink:title"):e.getAttribute("xlink:title")&&(o=e.getAttribute("xlink:title"));var n="",l=this.#tn(this.#Ws.getLayer(this.#si[e.ownerDocument.firstChild.getAttribute("about")].rootLayer));return e.ownerDocument.firstChild.getAttribute("property")&&(n=e.ownerDocument.firstChild.getAttribute("property")),{geolocMin:s,geolocMax:r,metadata:a,metaSchema:n,layerName:l,title:o}}getMetadataObject(e,t,i){var s,r=this.parseEscapedCsvLine(e);if(t){var a=this.parseEscapedCsvLine(t);if(r.length==a.length){s=new Object;for(var o=0;o<r.length;o++)s[a[o]]=r[o];i||(s.name?i=s.name:s.title?i=s.title:s["名前"]?i=s["名前"]:s["名称"]?i=s["名称"]:s["タイトル"]&&(i=s["タイトル"]))}}return i||(i=r[0]),{object:s,title:i,array:r}}#in(e){var t=this.#si[i.getDocumentId(e)].CRS,s=i.getImageProps(e,SvgMapElementType.POI),r=this.#Zo.SVG2Geo(s.x,s.y,t),a=document.getElementById(e.getAttribute("iid")).title;e.setAttribute("lat",r.lat),e.setAttribute("lng",r.lng),e.setAttribute("data-title",a),this.showPoiPropertyWrapper(e),e.removeAttribute("data-title"),e.removeAttribute("lat"),e.removeAttribute("lng")}#sn={};showPoiPropertyWrapper(e){var t=!1;if(e.nodeType===Node.ELEMENT_NODE){t=!0;var s=i.getDocumentId(e),r=this.#si[s].rootLayer,a=this.#tn(this.#Ws.getLayer(r));e.setAttribute("data-layername",a)}var o=!0;this.#sn[s]?o=this.#sn[s](e):this.#sn[r]?o=this.#sn[r](e):t?this.#rn(e):console.warn(" Skip. The result of the hit test is not an Element, so it is necessary to setShowPoiProperty. :",e),0==o&&this.#rn(e),t&&e.removeAttribute("data-layername")}setShowPoiProperty(e,t){e?t?this.#sn[t]=e:this.#an=e:t?delete this.#sn[t]:this.#an=null}#an;#rn(e){this.#an?this.#an(e):this.#on(e)}#on(e){var t=null;e.ownerDocument.firstChild.getAttribute("property")&&(t=e.ownerDocument.firstChild.getAttribute("property").split(","));var s="<table border='1' style='word-break: break-all;table-layout:fixed;width:100%;border:solid orange;border-collapse: collapse'>",r="";if(e.getAttribute("data-title")&&(r=e.getAttribute("data-title")+"/"+e.getAttribute("data-layername")+"\n"),e.getAttribute("content")){var a=this.parseEscapedCsvLine(e.getAttribute("content"));if(s+="<tr><th style='width=25%'>name</th><th>value</th></tr>",""!=r&&(s+="<tr><td>title/Layer</td><td> "+r+"</td></tr>"),t&&t.length==a.length)for(var o=0;o<t.length;o++){var n="--";""!=a[o]&&(n=a[o]),s+="<tr><td>"+t[o]+" </td><td> "+n+"</td></tr>"}else for(o=0;o<a.length;o++){n="--";""!=a[o]&&(n=a[o]),s+="<tr><td>"+o+" </td><td> "+n+"</td></tr>"}}else{var l=e.attributes;for(o=0;o<l.length;o++)s+="<tr><td>"+l.item(o).nodeName+" </td><td> "+domElement.getAttribute(l.item(o).nodeName)+"</td></tr>"}i.getHyperLink(e)&&(s+="<tr><td>link</td> <td><a href='"+i.getHyperLink(e).href+"' target=`_blank'>"+i.getHyperLink(e).href+"</a></td></tr>"),e.getAttribute("lat")&&(s+="<tr><td>latitude</td> <td>"+this.#nn(e.getAttribute("lat"))+"</td></tr>",s+="<tr><td>longitude</td> <td>"+this.#nn(e.getAttribute("lng"))+"</td></tr>"),s+="</table>",this.showModal(s,400,600)}#nn(e){for(var t=e.split(","),s="",r=0;r<t.length;r++)s+=i.numberFormat(Number(t[r]),6),r<t.length-1&&(s+=",");return s}showModal(e,t,s){var r,a=!1;t&&s||(a=!0),document.getElementById("modalDiv")?((r=document.getElementById("modalDiv")).parentNode.removeChild(r),r=document.createElement("div")):r=document.createElement("div"),window.innerWidth-100<t&&(t=window.innerWidth-100),window.innerHeight-140<s&&(s=window.innerHeight-100),a?(r.style.maxHeight=s+36+"px",r.style.maxWidth=t+10+"px"):(r.style.height=s+36+"px",r.style.width=t+10+"px"),r.style.backgroundColor="rgba(180, 180, 180, 0.4)",r.style.zIndex="1000",r.style.position="absolute",r.style.top="40px",r.style.left="40px",r.style.overflowY="hidden",r.style.overflowX="hidden",r.id="modalDiv";const o=r.attachShadow({mode:"closed"}),n=document.createElement("div");a?(n.style.overflow="hidden",n.style.margin="5px",n.style.marginBottom="30px"):(n.style.height=s+"px",n.style.width=t+"px",n.style.position="absolute",n.style.top="5px",n.style.left="5px",n.style.overflowY="scroll",n.style.overflowX="hidden"),n.style.backgroundColor="rgba(255,240,220,0.7)",n.id="infoDiv","string"==typeof e?n.innerHTML=e:e instanceof Element&&n.appendChild(e);const l=document.createElement("button"),h=document.createTextNode("CLOSE");return l.appendChild(h),l.onclick=function(){r.parentNode.removeChild(r)},l.style.position="absolute",l.style.width="30%",l.style.bottom="5px",l.style.right="40px",o.appendChild(n),o.appendChild(l),r.addEventListener("wheel",function(e){i.MouseWheelListenerFunc(e)},!1),r.addEventListener("mousewheel",function(e){i.MouseWheelListenerFunc(e)},!1),r.addEventListener("DOMMouseScroll",function(e){i.MouseWheelListenerFunc(e)},!1),document.getElementsByTagName("body")[0].appendChild(r),n}parseEscapedCsvLine(e){for(var t=e.split(","),s=0;s<t.length;s++)if(t[s]=i.trim(t[s]),0==t[s].indexOf("'")||0==t[s].indexOf('"')){for(var r=0;"'"!=t[s].substr(t[s].length-1,1)&&'"'!=t[s].substr(t[s].length-1,1)&&(t[s]=t[s]+","+t[s+1],t.splice(s+1,1),!(++r>5)););t[s]=t[s].replace(/['"]/g,"")}return t}}class I{constructor(e,t,i){this.#Ws=e,this.#fa=t,this.#ln=i}#fa;#Ws;#ln;enable;centralGetter;hittedElements;hittedElementsBbox;hittedElementsUsedParent;x;y;setCentralVectorObjectsGetter(){if(this.enable)return!1;this.enable=!1,this.centralGetter=!0;var e=this.#Ws.getMapCanvasSize();return this.x=e.width/2,this.y=e.height/2,this.hittedElements=new Array,this.hittedElementsBbox=new Array,this.hittedElementsUsedParent=new Array,"object"!=typeof this.#fa||!this.#fa.isEditingGraphicsElement()||(console.log("now object editing.."),this.enable=!1,!1)}getHittedObjects=function(){return this.enable=!1,this.centralGetter=!1,{elements:this.hittedElements,bboxes:this.hittedElementsBbox,parents:this.hittedElementsUsedParent}}.bind(this);setHittedObjects(e,t,i){this.hittedElements.push(e),this.hittedElementsBbox.push(t),this.hittedElementsUsedParent.push(i)}getVectorObjectsAtPoint(e,t){return this.enable=!0,this.centralGetter=!1,this.x=e,this.y=t,this.hittedElements=new Array,this.hittedElementsBbox=new Array,this.hittedElementsUsedParent=new Array,"object"==typeof this.#fa&&this.#fa.isEditingGraphicsElement()?(console.log("now object editing.."),this.enable=!1,null):(this.#Ws.refreshScreen(!1,null,!1,!0),this.#ln(!0),this.getHittedObjects())}}class P{constructor(){this.visiblePOIs=new Array}visiblePOIs;getPoiObjectsAtPoint(e,t){var i=new Array;for(var s in this.visiblePOIs)e<this.visiblePOIs[s].x||e>this.visiblePOIs[s].x+this.visiblePOIs[s].width||t<this.visiblePOIs[s].y||t>this.visiblePOIs[s].y+this.visiblePOIs[s].height||(this.visiblePOIs[s].id=s,i.push(this.visiblePOIs[s]));return i}clear(){this.visiblePOIs=new Array}setPoiBBox(e,t,i,s,r){this.visiblePOIs[e]={x:t,y:i,width:s,height:r}}}class S{constructor(e,t){this.#e=e,this.#si=e.getSvgImagesProps(),this.#ii=e.getSvgImages(),this.#tn=t}#e;#si;#ii;#tn;getLayerHitTestAtPoint(e,t,i){var s=this.#e.screen2Geo(e,t),r={clientX:e,clientY:t,lat:s.lat,lng:s.lng};i&&(r.isMapCenterHitTest=!0);var a=[];for(var o in this.#si){var n=this.#si[o];if(n.controllerWindow){var l=n.controllerWindow.customHitTester;if("function"==typeof l){var h=l(r);if(h){Array.isArray(h)||(h=[h]);var g=this.#tn(this.#e.getLayer(o)),d=0;for(var c of h){var p={};p.layerName=g,p.metaSchema=n.metaSchema,p.geoBbox={x:s.lng,y:s.lng,width:0,height:0},p.hitTestIndex=d,!0===c?(p.element=this.#ii[o].documentElement,p.title=g,p.metadata=d):"string"==typeof c?(p.element=this.#ii[o].documentElement,p.title=c,p.metadata=c):c.nodeType===Node.ELEMENT_NODE&&(p.element=c,p.title=c.getAttribute("xlink:title"),p.metadata=c.getAttribute("content")),a.push(p),++d}}}}}return a}}class x{#Ws;#hn;#gn;#dn;#si;showPoiProperty;pathHitTester;poiHitTester;#cn;#pn;#un;#tn;#Zo;#fa;constructor(e,t,s,r,a,o){if(this.#Ws=e,this.#dn=document.getElementById("centerSight"),!this.#hn){var n=this.#dn.parentNode;this.#hn=document.createElement("span"),n.insertBefore(this.#hn,this.#dn),this.#hn.style.position="absolute",this.#hn.style.backgroundColor="yellow",this.#hn.style.color="black",this.#hn.style.display="none",this.#hn.style.opacity="0.5",this.#hn.id="ticker",this.#hn.style.cursor="pointer",this.#hn.style.overflowX="hidden",this.#hn.style.overflowY="auto",this.#hn.addEventListener("wheel",i.MouseWheelListenerFunc,!1),this.#hn.addEventListener("mousewheel",i.MouseWheelListenerFunc,!1),this.#hn.addEventListener("DOMMouseScroll",i.MouseWheelListenerFunc,!1),this.#gn=document.createElement("table"),this.#gn.style.borderCollapse="collapse",this.#gn.style.border="solid 1px black",this.#gn.setAttribute("border","1"),this.#hn.appendChild(this.#gn),this.#si=this.#Ws.getSvgImagesProps(),this.#Zo=t,this.#un=s,this.#tn=r,this.#fa=o}this.updateTicker(),this.pathHitTester=new I(e,o,a),this.poiHitTester=new P,this.#cn=new S(e,r),this.showPoiProperty=new b(e,r,t)}updateTicker(){this.#mn(),this.#hn.style.fontSize="110%",this.#hn.style.fontWeight="bolder"}isEnabled(){if(this.#hn)return!0}showTicker(){this.#hn&&(this.#hn.style.display="")}hideTicker=function(){this.#hn&&(this.#hn.style.display="none")}.bind(this);#mn(e,t){if(this.#hn){if(!e&&!t){var i=this.#Ws.getMapCanvasSize();e=i.width/2,t=i.height/2}this.#hn.style.left=e+2+"px",this.#hn.style.top=t+this.#dn.height/2+"px"}}#yn(){var e=this.#Ws.getMapCanvasSize(),t=Number(this.#hn.style.top.replace("px",""));this.#hn.style.height="";var i=this.#hn.offsetHeight;this.#hn.offsetWidth,e.height-t<i&&(this.#hn.style.height=e.height-t-8+"px")}#vn;getTickerMetadata=function(){for(var e=0;e<this.#vn.length;e++){var s=this.#vn[e];if(s.img){var r=this.#Ws.getSvgTarget(s.img).element,a=this.#si[i.getDocumentId(r)].CRS,o=i.getImageProps(r,t.POI),n=this.#Zo.SVG2Geo(o.x,o.y,a);s.geoBbox={x:n.lng,y:n.lat,width:0,height:0},s.metadata=r.getAttribute("content"),s.element=r,s.metaSchema=r.ownerDocument.firstChild.getAttribute("property")}}return console.log("getTickerMetadata:",this.#vn),this.#vn}.bind(this);checkTicker(e,t){var i,s,r;if(e&&t)i=this.pathHitTester.getVectorObjectsAtPoint(e,t),s=this.poiHitTester.getPoiObjectsAtPoint(e,t),r=this.#cn.getLayerHitTestAtPoint(e,t);else{i=this.pathHitTester.getHittedObjects();var a=this.#Ws.getMapCanvasSize();s=this.poiHitTester.getPoiObjectsAtPoint(a.width/2,a.height/2),r=this.#cn.getLayerHitTestAtPoint(a.width/2,a.height/2,!0)}if(!(0==s.length&&e&&t&&this.#fn(i,e,t)))if(this.#ci(this.#gn),this.#vn=new Array,i&&i.elements.length>0||s.length>0||r.length>0){var o,n=this;setTimeout(function(){n.#yn()}.bind(this),300);for(var l=0;l<s.length;l++){var h=this.#bn(s[l].id),g=h.imgElement;o=u=function(e){return function(){n.#In(e)}}(g),this.#Pn(g.title,u,this.#gn,h.layerName),this.#vn.push({title:g.title,layerName:h.layerName,img:g})}if(i)for(l=0;l<i.elements.length;l++){var d=this.showPoiProperty.getVectorMetadata(i.elements[l],i.parents[l],i.bboxes[l]),c=this.showPoiProperty.getMetadataObject(d.metadata,d.metaSchema,d.title);console.log(d.geolocMin,d.geolocMax,c,c.title,d.layerName);var p=function(e,t,i,s){return function(){s.vectorDataWrapperForShowPoiProperty(e,i,t)}}(i.elements[l],i.parents[l],i.bboxes[l],this.showPoiProperty);o=p,this.#Pn(c.title,p,this.#gn,d.layerName),this.#vn.push({title:c.title,layerName:d.layerName,element:i.elements[l],parent:i.parents[l],bbox:i.bboxes[l],metadata:d.metadata,geoBbox:{x:d.geolocMin.lng,y:d.geolocMin.lat,width:d.geolocMax.lng-d.geolocMin.lng,height:d.geolocMax.lat-d.geolocMin.lat},metaSchema:d.metaSchema})}for(l=0;l<r.length;l++){var u,m=r[l];o=u=function(e,t){return function(){e.setAttribute("data-hitTestIndex",t),this.showPoiProperty.showPoiPropertyWrapper(e),e.removeAttribute("data-hitTestIndex")}.bind(this)}.bind(this)(m.element,m.hitTestIndex),this.#Pn(m.title,u,this.#gn,m.layerName),this.#vn.push(m)}e&&t&&1==this.#vn.length?(this.hideTicker(),o()):(this.#mn(e,t),this.showTicker())}else this.hideTicker()}#In(e){var t=e.target||e.srcElement||e,i=this.#un(),s=this.#Ws.getSvgTarget(t);s.element,"object"==typeof this.#fa&&i&&i.getAttribute("iid")==this.#si[t.parentNode.getAttribute("id")].rootLayer?this.#fa.setTargetObject(s):this.#Sn(s)}#Pn(e,t,i,s){var r=document.createElement("tr"),a=document.createElement("td"),o=document.createElement("span");o.innerHTML=s?e+"<font size='-2'>/"+s+"</font>":e,a.appendChild(o),r.appendChild(a),i.appendChild(r),o.addEventListener("mousedown",t,!1)}getObjectAtPoint=function(e,t){this.checkTicker(e,t)}.bind(this);#fn(e,t,s){var r=this.#un(),a=!1;if("object"==typeof this.#fa&&r)if(e&&e.elements.length>0){var o=this.#xn(e,r);o&&(this.#fa.setTargetObject({element:o,docId:i.getDocumentId(o)}),a=!0)}else this.#fa.editPoint(t,s),a=!0;return a}#xn(e,t){var s=-1;if("object"==typeof this.#fa&&t)for(var r=0;r<e.elements.length;r++)if(t.getAttribute("iid")==i.getDocumentId(e.elements[r])){s=r;break}return s>=0?e.elements[s]:null}#ci(e){for(var t=e.childNodes.length-1;t>=0;t--)e.removeChild(e.childNodes[t])}#bn(e){var t,i=document.getElementById(e);if(i&&i.parentNode&&i.parentNode.getAttribute("class")){var s=i.parentNode.getAttribute("class").substring(10),r=this.#Ws.getLayer(s);t=this.#tn(r)}else t="/";return{layerId:s,layerName:t,imgElement:i}}#Sn(e){var t=e.element;i.getHyperLink(t)&&!t.getAttribute("content")?this.showPage(i.getHyperLink(t)):i.getHyperLink(t)&&t.getAttribute("content")?this.POIviewSelection(t):this.showUseProperty(t)}showPage(e){var t=i.trim(e.href);if(0!=t.indexOf("#"))e.target?window.open(t):window.open(t,"_self","");else{var s=i.getFragmentView(t);s&&this.#Ws.setGeoViewPort(s.y,s.x,s.height,s.width)}}POIviewSelection(e){var t=this.initModal("POIviewSelection"),s=function(r){switch(r.target.id){case"pvsView":this.showUseProperty(e),this.initModal(),t.removeEventListener("click",s,!1);break;case"pvsLink":this.showPage(i.getHyperLink(e)),this.initModal(),t.removeEventListener("click",s,!1)}}.bind(this);t.addEventListener("click",s,!1)}initModal(e){var t;if(document.getElementById("modalUI"))t=document.getElementById("modalUI");else{var i=document.getElementsByTagName("body")[0];(t=document.createElement("div")).style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.width="100%",t.style.height="100%",t.style.display="none",t.id="modalUI",t.style.zIndex="32767",i.appendChild(t);var s=document.createElement("div");s.style.position="absolute",s.id="modalMask",s.style.left="0px",s.style.top="0px",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="#505050",s.style.color="yellow",s.style.opacity="0.5",t.appendChild(s);var r=document.createElement("div");r.style.opacity="1",r.style.position="absolute",r.style.backgroundColor="white",r.id="POIviewSelection",r.innerHTML='<input type="button" id="pvsView" value="view Property"/><br><input type="button" id="pvsLink" value="open Link"/>',r.style.display="none",t.appendChild(r);var a=document.createElement("div");a.style.opacity="1",a.style.position="absolute",a.style.backgroundColor="white",a.id="customModal",a.style.display="none",t.appendChild(a)}var o=null;e?(t.style.display="",o=document.getElementById(e)):t.style.display="none";for(var n=t.getElementsByTagName("div"),l=0;l<n.length;l++)n[l].id==e||"modalMask"==n[l].id?n[l].style.display="":n[l].style.display="none";return o}showUseProperty(e){var s=this.#si[i.getDocumentId(e)].CRS,r=i.getImageProps(e,t.POI),a=this.#Zo.SVG2Geo(r.x,r.y,s),o=document.getElementById(e.getAttribute("iid")).title;e.setAttribute("lat",a.lat),e.setAttribute("lng",a.lng),e.setAttribute("data-title",o),this.showPoiProperty.showPoiPropertyWrapper(e),e.removeAttribute("data-title"),e.removeAttribute("lat"),e.removeAttribute("lng")}}class M{constructor(e){this.mapTicker=e,console.log("const:CustomModal: this.mapTicker",this.mapTicker)}mapTicker;setCustomModal(e,t,i,s,r){console.log("setCustomModal :","btmMsgs:",t,Array.isArray(t),"options:",r);let a={top:0,left:0};r&&r.position&&(r.position?.tagName?(a=this.#Mn(r.position),console.log(a)):0==isNaN(r.position?.top)&&0==isNaN(r.position?.left)&&(a={top:r.position?.top,left:r.position?.left}));var o=this.mapTicker.initModal("customModal");o.style.top=a.top+"px",o.style.left=a.left+"px";for(var n=o.childNodes.length-1;n>=0;n--)o.removeChild(o.childNodes[n]);if(t)if(Array.isArray(t));else{var l=t;(t=new Array)[0]=l}else t=["OK"];console.log("setCustomModal :",t);var h=document.createElement("div");"object"==typeof e&&1==e.nodeType?h.appendChild(e):h.innerHTML=e,o.appendChild(h);for(n=0;n<t.length;n++){var g=document.createElement("input");g.setAttribute("type","button"),g.id="customModalBtn_"+n,g.setAttribute("value",t[n]),o.appendChild(g)}var d=function(e){return function(e){e.target.id.indexOf("customModalBtn_")>=0&&(this.mapTicker.initModal(),i&&i(Number(e.target.id.substring(15)),s),o.removeEventListener("click",d,!1))}.bind(this)}.bind(this)();o.addEventListener("click",d,!1),window.setTimeout(function(){console.log("cm pos:",o.offsetWidth,o.offsetHeight),a.top+o.offsetHeight>window.innerHeight&&(o.style.top=Math.max(window.innerHeight-o.offsetHeight,0)),a.left+o.offsetWidth>window.innerWidth&&(o.style.left=Math.max(window.innerWidth-o.offsetWidth,0))},100)}#Mn(e){let t,i=e.getBoundingClientRect(),s=i.top+(e.ownerDocument.defaultView.scrollY||0),r=i.left+(e.ownerDocument.defaultView.scrollX||0),a=e.ownerDocument.defaultView;for(;a!==window.top&&(t=a.parent,t);){let e=a.frameElement;if(e){let t=e.getBoundingClientRect();s+=t.top,r+=t.left}a=t}return{top:s,left:r}}}class w{constructor(e,t,i){this.#Ws=e,this.#si=e.getSvgImagesProps(),this.#ii=e.getSvgImages(),this.#wn=t,this.#Cn=i}#Ln=!1;#An=3;#En;static localStorageSvgMapSuffix="svgmap_";#Ws;#si;#ii;#wn;#Tn=null;#Cn;#On(e,t,i){var s=new URL(this.#si.root.Path,location.href).pathname;window.localStorage[w.localStorageSvgMapSuffix+s+"#"+e]=t}#kn(){for(var e={},t=new URL(this.#si.root.Path,location.href).pathname,i=w.localStorageSvgMapSuffix+t+"#",s=0;s<window.localStorage.length;s++)0==window.localStorage.key(s).indexOf(i)&&(e[window.localStorage.key(s).substring(i.length)]=window.localStorage[window.localStorage.key(s)]);return e}#Rn(e){for(var t=new URL(this.#si.root.Path,location.href).pathname,i=w.localStorageSvgMapSuffix+t+"#",s=window.localStorage.length-1;s>=0;s--)0==window.localStorage.key(s).indexOf(i)&&(e?window.localStorage.key(s).indexOf(e)>0&&delete window.localStorage[window.localStorage.key(s)]:delete window.localStorage[window.localStorage.key(s)])}setInitialCustomLayers(e,t){if(e&&"object"==typeof e){if(e.customLayersSettings){if(console.warn("setInitialCustomLayers: initialCustomLayersObj is cookie CustomLayersObj, use default setting"),!e.currentSettingKey)if(e.currentSettingKeys?.customLayer)e.currentSettingKey=e.currentSettingKeys.customLayer;else{var i=Object.keys(e.customLayersSettings);i.length>0&&(e.currentSettingKey=i[0])}this.#Tn=e}else if(function(e){if(!e.data||!e.metadata)return!1;var t=e.data;for(var i in t){var s=t[i];if("object"!=typeof s)return!1;if(!s.href)return!1}return console.log("setInitialCustomLayers Check OK!"),!0}(e)){var s=new URL(t,window.location.href);this.#Tn={currentSettingKey:"startup",customLayersSettings:{startup:e},settingRevision:"r2",rootContainerHref:s.pathname,host:s.host},e.metadata&&(e.metadata.viewBox&&(this.#Tn.viewBox=e.metadata.viewBox),e.metadata.settingRevision&&(this.#Tn.settingRevision=e.metadata.settingRevision),e.metadata.rootContainerHref&&(this.#Tn.rootContainerHref=e.metadata.rootContainerHref)),this.#Tn.customLayersSettings.startup.metadata.key="startup"}}else console.warn("setInitialCustomLayers: initialCustomLayersObj is not object exit.")}resumeFirstTime=!0;checkResume(e,t){var s,r,a=null;if(location.href.indexOf("#")>=0&&(s=location.href.substring(location.href.indexOf("#")),r=i.getUrlHash(s)),this.resumeFirstTime){var o=this.#kn();(r&&(r.visibleLayer||r.hiddenLayer)||o.resume||o.customLayers||this.#Tn)&&this.#Cn(e,t);var n,l=this.#Ws.getRootLayersProps();if(this.#En=l,this.#Tn&&this.#wn)try{console.log("applyCustomLayers using initialCustomLayers information : ",this.#Tn),this.#wn.applyCustomLayers(this.#Tn),this.#Cn(e,t),l=this.#Ws.getRootLayersProps(),this.#Tn.viewBox&&(n=this.#Tn.viewBox)}catch(e){console.error("svgMapCustomLayersManager.applyCustomLayers by initialCustomLayers step error:",e)}else if(o.customLayers&&this.#wn)try{var h=JSON.parse(o.customLayers);this.#wn.applyCustomLayers(h),this.#Cn(e,t),l=this.#Ws.getRootLayersProps()}catch(e){console.error("svgMapCustomLayersManager.applyCustomLayers step by cookie error:",e)}if(n)this.#Ws.setGeoViewPort(n.y,n.x,n.height,n.width,!0);else if(o.customGeoViewboxes){var g=JSON.parse(o.customGeoViewboxes);if(console.log("customGeoViewboxes:",g),g.currentSettingKey){var d=g.settings[g.currentSettingKey];d&&this.#Ws.setGeoViewPort(d.y,d.x,d.height,d.width,!0)}}if(o.resume&&(a=JSON.parse(o.resume),this.#Ln=a.resume),this.#Rn("resume"),this.#Ln&&a){if(r&&(r.hiddenLayer||r.visibleLayer))console.log("hiddenLayer or visibleLayer hash is. Skip layer visibility resume.");else{for(var c=a.layersProperties,p=[],u=0;u<l.length;u++){var m=l[u].title;if(p.push(!1),c[m])if(c[m].href==l[u].href){var y=c[m].visible;this.#Ws.setRootLayersProps(l[u].id,y,!1),p[u]=!0,delete c[m]}else console.warn("href is unmatched!!!: title:",m,"  href:",c[m].href," : ",l[u].href,"  SKIP IT")}for(u=0;u<l.length;u++)if(0==p[u])for(var m in c)if(c[m].href==l[u].href){y=c[m].visible;this.#Ws.setRootLayersProps(l[u].id,y,!1),p[u]=!0,console.log("layer title may be changed, but set visibility")}}var v=Number(a.vbLat),f=Number(a.vbLng),b=Number(a.vbLatSpan),I=Number(a.vbLngSpan);this.#Ws.setGeoViewPort(v,f,b,I,!0)}}if(this.#Ln&&this.#Bn(),this.resumeFirstTime&&r){var P;if(r.svgView)P=i.getFragmentView(s);else if(r.xywh&&0==r.xywh.indexOf("global:")){var S=r.xywh.substring(7).split(",");P={x:Number(S[0]),y:Number(S[1]),width:Number(S[2]),height:Number(S[3]),global:!0},console.log(" global view by Media Fragments: ",P)}if(r.visibleLayer&&r.visibleLayer.indexOf("*")>=0){var x=this.#Ws.getLayers();for(u=0;u<x.length;u++){var M=x[u].getAttribute("iid");this.#Ws.setRootLayersProps(M,!0,!1)}}if(r.hiddenLayer)if(r.hiddenLayer.indexOf("*")>=0)for(x=getLayers(),u=0;u<x.length;u++){M=x[u].getAttribute("iid");this.#Ws.setRootLayersProps(M,!1,!1)}else{var w=decodeURIComponent(r.hiddenLayer).split(",");for(u=0;u<w.length;u++){w[u]=this.#Vn(w[u]),(M=this.#Ws.getLayerId(w[u].name))&&this.#Ws.setRootLayersProps(M,!1,!1,w[u].hash)}}if(r.visibleLayer){var C=decodeURIComponent(r.visibleLayer).split(",");for(u=0;u<C.length;u++){C[u]=this.#Vn(C[u]),(M=this.#Ws.getLayerId(C[u].name))&&this.#Ws.setRootLayersProps(M,!0,!1,C[u].hash)}}P&&P.global&&this.#Ws.setGeoViewPort(P.y,P.x,P.height,P.width,!0)}this.resumeFirstTime=!1}#Vn(e){var t=e.indexOf("#"),i=e.indexOf("?");i>t&&(i=-1);var s="",r="",a=e;return t>0&&(s=a.substring(t),a=a.substring(0,t)),i>0&&(r=a.substring(i),a=a.substring(0,i),console.log("queryStr:",r)),{name:a,query:r,hash:s}}#Bn(){var e=new Date;e.setTime(e.getTime()+864e5*this.#An);var t={};1==this.#Ln&&(t=this.#Gn()),t.resume=this.#Ln,this.#On("resume",JSON.stringify(t),e)}#Gn(){var e={},t=this.#Ws.getGeoViewBox();e.vbLng=t.x,e.vbLat=t.y,e.vbLngSpan=t.width,e.vbLatSpan=t.height;var i=this.#Ws.getRootLayersProps(),s=this.#Nn(i);return e.layersProperties=s,e}#Dn(e){var t=e.svgImageProps?.hash,i=e.href;if(t){var s=i.indexOf("#");s<0?i+=t:i=i.substring(0,s)+t}return i}#Nn(e){for(var t={},i=0;i<e.length;i++){var s=e[i],r=this.#Dn(s),a=s.title,o={visible:s.visible,editing:s.editing,groupName:s.groupName,groupFeature:s.groupFeature,href:r,title:s.title};t[a]=o}return t}getBasicPermanentLink(e){var t=this.#Gn(),s=[],r=[],a=this.#Nn(this.#En);for(var o in a){var n=a[o],l=t.layersProperties[o];if(l){var h=i.getSvgLocation(n.href).hash,g=i.getSvgLocation(l.href).hash;h!=g&&l.visible?r.push(o+g):n.visible!=l.visible&&(1==n.visible?s.push(o):h!=g?r.push(o+g):r.push(o))}}var d="";r.length>0&&(d=`&visibleLayer=${r.join(",")}`);var c="";s.length>0&&(c=`&hiddenLayer=${s.join(",")}`);var p=`xywh=global:${t.vbLng.toFixed(6)},${t.vbLat.toFixed(6)},${t.vbLngSpan.toFixed(6)},${t.vbLatSpan.toFixed(6)}`,u=new URL(location.pathname,location.origin),m=p+d+c;if(u.hash=m,1==e)try{navigator.clipboard.writeText(u.href)}catch(e){console.warn("Cant access clipboard, may be http page"),this.#Ws.showModal(`<textarea style="font-size:11px;width:390px;height:130px;">Link URL : \n${u.href}</textarea>`,400,150)}return u}resumeToggle(e){e.target.checked?this.#Ws.setResume(!0):this.#Ws.setResume(!1)}setResume(e){this.#Ln=e,(!this.#Ln||Object.keys(this.#ii).length>0)&&this.#Bn()}getResume(){return this.#Ln}}class C{#Un={getUrlViaProxy:null,getUrlViaImageProxy:null,crossOriginAnonymous:!1,getNonlinearTransformationProxyUrl:null,crossOriginAnonymousNonlinearTF:!1};getAccessInfo(e){return"function"==typeof this.#Un.getUrlViaProxy?this.#Un.getUrlViaProxy(e):e}getImageAccessInfo(e,t,i){var s=!1,r=!1;return null!=i&&(s=!0),"function"==typeof this.#Un.getUrlViaImageProxy?(e=this.#Un.getUrlViaImageProxy(e),this.#Un.crossOriginAnonymous&&(s=!0)):"function"==typeof this.#Un.getNonlinearTransformationProxyUrl&&t&&(e=this.#Un.getNonlinearTransformationProxyUrl(e),r=!0,this.#Un.crossOriginAnonymousNonlinearTF&&(s=!0)),{href:e,crossOriginFlag:s,hasNonLinearImageTransformation:r}}setProxyURLFactory(e,t,i,s,r){"function"==typeof e?this.#Un.getUrlViaProxy=e:null===e&&(this.#Un.getUrlViaProxy=null),"function"==typeof t?this.#Un.getUrlViaImageProxy=t:null===t&&(this.#Un.getUrlViaImageProxy=null),1==i?this.#Un.crossOriginAnonymous=!0:0==i&&(this.#Un.crossOriginAnonymous=!1),"function"==typeof s?this.#Un.getNonlinearTransformationProxyUrl=s:null===s&&(this.#Un.getNonlinearTransformationProxyUrl=null),1==r?this.#Un.crossOriginAnonymousNonlinearTF=!0:0==r&&(this.#Un.crossOriginAnonymousNonlinearTF=!1),console.log("called setProxyURLFactory: contentProxyParams:",this.#Un,"    input params:",e,t,i,s,r)}getCORSURL(e,t){return t?"function"==typeof this.#Un.getNonlinearTransformationProxyUrl?{url:this.#Un.getNonlinearTransformationProxyUrl(e),crossorigin:this.#Un.crossOriginAnonymousNonlinearTF}:{url:e,crossorigin:!1}:"function"==typeof this.#Un.getNonlinearTransformationProxyUrl?this.#Un.getNonlinearTransformationProxyUrl(e):e}}class L{#Ws;#si;#ii;constructor(e){this.#Ws=e,this.#si=e.getSvgImagesProps(),this.#ii=e.getSvgImages()}linkedDocOp(e,i,s,r,a,o,n){var l=this.#ii[i],h=this.#si[i];if(l){e(l,h,s,r,a,o,n);var g=h.childImages;for(var d in g)g[d]!=t.CLICKABLE&&g[d]!=t.EXIST||this.linkedDocOp(e,d,s,r,a,o,n)}}childDocOp(e,i,s,r,a,o,n){var l=this.#ii[i],h=this.#si[i];if(l){var g=h.childImages;for(var d in g){if(g[d]==t.CLICKABLE||g[d]==t.EXIST)e(this.#ii[d],this.#si[d],s,r,a,o,n)}}}contColorSet(){var e=Number(document.getElementById("contValue").value);e&&this.contColorSetContinuous(e)}contColorSetOnce(e){var t=this.#Ws.getHashByDocPath("vectorContainer.svg");this.linkedDocOp(this.contourMarker,t,e),this.#Ws.refreshScreen()}contColorSetContinuous(e){var t;"contourSearch[m]"==document.getElementById("contButton").innerHTML?(document.getElementById("contButton").innerHTML="disableSearch",document.getElementById("contValue").disabled="true",t=!1):(document.getElementById("contButton").innerHTML="contourSearch[m]",document.getElementById("contValue").disabled="",t=!0),t?(document.removeEventListener("zoomPanMap",this.eDom,!1),t=!1,this.eDom=this.editDOM(e,!0),this.eDom()):(this.eDom=this.editDOM(Number(e),!1),this.eDom(),document.addEventListener("zoomPanMap",this.eDom,!1),t=!0)}eDom;editDOM(e,t){return function(){var i=this.#Ws.getHashByDocPath("vectorContainer.svg");this.linkedDocOp(contourMarker,i,e,t),this.#Ws.refreshScreen()}}contourMarker(e,t,i,s){for(var r=e.getElementsByTagName("path"),a=0;a<r.length;a++){var o=r[a],n=Number(o.getAttribute("lm:標高"));n&&n%i==0&&(s?(o.removeAttribute("stroke"),o.removeAttribute("stroke-width")):(o.setAttribute("stroke","red"),o.setAttribute("stroke-width","2")))}}}class A{styleCatalog=new Array("stroke","stroke-width","stroke-linejoin","stroke-linecap","fill","fill-rule","fill-opacity","filter","opacity","vector-effect","display","font-size","stroke-dasharray","marker-end","visibility","image-rendering");constructor(){}getStyle(e,t,i,s){var r;s&&(r=s.get(e)),null==r&&(r=this.getNodeStyle(e,i),s&&s.set(e,r));var a={};for(var o of this.styleCatalog)r[o]?a[o]=r[o]:t&&t[o]&&(a[o]=t[o]);return r.minZoom?a.minZoom=r.minZoom:t&&t.minZoom&&(a.minZoom=t.minZoom),r.maxZoom?a.maxZoom=r.maxZoom:t&&t.maxZoom&&(a.maxZoom=t.maxZoom),r.nonScalingOffset?a.nonScalingOffset=r.nonScalingOffset:t&&t.nonScalingOffset&&(a.nonScalingOffset=t.nonScalingOffset),t&&t.usedParent&&(a.usedParent=t.usedParent),a}getNodeStyle(e,t){for(var s=!1,r={fill:null},a=this.getStyleAttribute(e),o=0;o<this.styleCatalog.length;o++){var n=this.getStyleOf(this.styleCatalog[o],e,a);n&&(r[this.styleCatalog[o]]=n,s=!0)}if(e.getAttribute("visibleMinZoom")&&(r.minZoom=Number(e.getAttribute("visibleMinZoom"))/100,s=!0),e.getAttribute("visibleMaxZoom")&&(r.maxZoom=Number(e.getAttribute("visibleMaxZoom"))/100,s=!0),r.hasUpdate=s,t){var l=e.getAttribute("xlink:href"),h=e.getAttribute("target");l&&(r.hyperLink=l,r.target=h)}const g=e.getAttribute("transform");return g&&g.indexOf("ref")>=0&&(r.nonScalingOffset=i.parseNonScalingOffset(g)),r}getStyleAttribute(e){var t=null;if(e.getAttribute("style")){t={};var s=e.getAttribute("style").split(";");if(s)for(var r=0;r<s.length;r++){var a=s[r].split(":");if(a&&a.length>1){var o=i.trim(a[0]),n=i.trim(a[1]);"fill"!=o&&"stroke"!=o||6==n.length&&n.match(/^[0-9A-F]/)&&(n="#"+n),t[o]=n}}}return t}getStyleOf(e,t,i){var s;return t.getAttribute(e)?s=t.getAttribute(e):i&&i[e]&&(s=i[e]),s}static setCanvasStyle(e,t){var i={fillStyle:null,strokeStyle:null};if(e){if(e.stroke?"none"==e.stroke?t.strokeStyle="rgba(0, 0, 0, 0)":(t.strokeStyle=e.stroke,i.strokeStyle=e.stroke):t.strokeStyle="rgba(0, 0, 0, 0)",e.fill&&("none"==e.fill?t.fillStyle="rgba(0, 0, 0, 0)":(t.fillStyle=e.fill,i.fillStyle=e.fill)),e["stroke-width"]?e["vector-effect"]?e["stroke-width"]?t.lineWidth=e["stroke-width"]:t.lineWidth=0:t.lineWidth=1:t.lineWidth=0,e["stroke-dasharray"]){var s=e["stroke-dasharray"].split(/\s*[\s,]\s*/);t.setLineDash(s)}e["stroke-linejoin"]&&(t.lineJoin=e["stroke-linejoin"]),e["stroke-linecap"]&&(t.lineCap=e["stroke-linecap"]),e.opacity&&(t.globalAlpha=e.opacity),e["fill-opacity"]&&(t.globalAlpha=e["fill-opacity"])}return i}}class E{#Fn;#Zo;#Hn;#qt;constructor(e,t,i,s){console.log("new PathRenderer"),this.#Fn=e,this.#Zo=t,this.#Hn=i,this.#qt=s}defaultHilightStyle={stroke:{color:"rgba(255,0,0,1)",widthIncrement:6},fill:{color:"rgba(255,0,0,1)",lineWidth:6,lineColor:null}};setDefaultHilightStyle(e){"object"==typeof e&&(e.stroke&&("string"==typeof e.stroke.color&&(this.defaultHilightStyle.stroke.color=e.stroke.color),"number"==typeof e.stroke.widthIncrement&&(this.defaultHilightStyle.stroke.widthIncrement=e.stroke.widthIncrement)),e.fill&&("string"==typeof e.fill.color&&(this.defaultHilightStyle.fill.color=e.fill.color),"number"==typeof e.fill.lineWidth&&(this.defaultHilightStyle.fill.lineWidth=e.fill.lineWidth),"string"==typeof e.fill.lineColor&&(this.defaultHilightStyle.fill.lineColor=e.fill.lineColor)))}setSVGcirclePoints(e,i,s,r,a,o,n){var l,h,g=Number(e.getAttribute("cx")),d=Number(e.getAttribute("cy"));a==t.CIRCLE?h=l=Number(e.getAttribute("r")):(l=Number(e.getAttribute("rx")),h=Number(e.getAttribute("ry"))),n&&n.setPoint(g,d);var c="M"+(g-l)+","+d+"A"+l+","+h+" 0 0 1 "+(g+l)+","+d+"A"+l+","+h+" 0 0 1 "+(g-l)+","+d+"z",p=this.setSVGpathPoints(e,i,s,r,c,o,n);if(o.nonScalingOffset)p.y-=h,p.height=2*h;else{var u=this.#Zo.transform(l,h,s,!0);p.y-=u.y,p.height=2*u.y}return p}setSVGrectPoints(e,t,i,s,r,a){var o=Number(e.getAttribute("x")),n=Number(e.getAttribute("y")),l=Number(e.getAttribute("width")),h=Number(e.getAttribute("height"));a&&!this.#Fn.GISgeometriesCaptureOptions.TreatRectAsPolygonFlag&&a.setPoint(o+l/2,n+h/2);var g="M"+o+","+n+"L"+(o+l)+","+n+" "+(o+l)+","+(n+h)+" "+o+","+(n+h)+"z";return this.setSVGpathPoints(e,t,i,s,g,r,a)}setSVGpolyPoints(e,i,s,r,a,o,n){var l=e.getAttribute("points");if(l){var h=l.replace(/,/g," ").split(" ");if(h.length>3){for(var g="M",d=0;d<h.length/2;d++)g+=h[2*d]+","+h[2*d+1],g+=0==d?"L":" ";return a==t.POLYGON&&(g+="Z"),this.setSVGpathPoints(e,i,s,r,g,o,n)}}}ssppRe0=new RegExp(/,/gm);ssppRe1=new RegExp(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm);ssppRe2=new RegExp(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm);ssppRe3=new RegExp(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm);ssppRe4=new RegExp(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm);ssppRe5=new RegExp(/([0-9])([+\-])/gm);ssppRe6=new RegExp(/(\.[0-9]*)(\.)/gm);ssppRe7=new RegExp(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm);setSVGpathPoints(e,t,s,r,a,o,n){var l=o.nonScalingOffset;l&&(o.docDPR?l.docDPR=o.docDPR:l.docDPR=1);var h=t.context;if(n)if(l){if(n.setPoint(l.x,l.y),this.#Fn.GISgeometriesCaptureOptions.SkipVectorRendering)return{}}else n.svgXY||n.makePath();var g=A.setCanvasStyle(o,h),d=!1;g.fillStyle||(d=!0);var c=!1;g.strokeStyle||(c=!0);var p,u=6e4,m=-6e4,y=6e4,v=-6e4,f=t.altdMap.get(e);f?p=f:((p=a||e.getAttribute("d"))||(p=""),p=(p=(p=(p=(p=(p=(p=(p=p.replace(this.ssppRe0," ")).replace(this.ssppRe1,"$1 $2")).replace(this.ssppRe2,"$1 $2")).replace(this.ssppRe3,"$1 $2")).replace(this.ssppRe4,"$1 $2")).replace(this.ssppRe5,"$1 $2")).replace(this.ssppRe6,"$1 $2")).replace(this.ssppRe7,"$1 $3 $4 "),p=(p=i.trim(i.compressSpaces(p))).split(" "),t.altdMap.set(e,p));var b="M",I=!1,P=0,S=0,x=0,M=0,w=0,C=0,L=0,E=0;h.beginPath();for(var T,O=0,k=p[O],R=!1;O<p.length;){switch(T&&(L=T.x,E=T.y),k){case"M":++O,P=Number(p[O]),++O,w=P,C=S=Number(p[O]),x=(T=this.#Zo.transform(P,S,s,!1,l)).x,M=T.y,h.moveTo(T.x,T.y),n&&!l&&n.startSubPath(P,S),k="L";break;case"m":++O,P+=Number(p[O]),++O,w=P,C=S+=Number(p[O]),x=(T=this.#Zo.transform(P,S,s,!1,l)).x,M=T.y,h.moveTo(T.x,T.y),n&&!l&&n.startSubPath(P,S),k="l";break;case"L":++O,P=Number(p[O]),++O,S=Number(p[O]),T=this.#Zo.transform(P,S,s,!1,l),h.lineTo(T.x,T.y),n&&!l&&n.addSubPathPoint(P,S);break;case"l":++O,P+=Number(p[O]),++O,S+=Number(p[O]),T=this.#Zo.transform(P,S,s,!1,l),h.lineTo(T.x,T.y),n&&!l&&n.addSubPathPoint(P,S);break;case"A":var B={x:P,y:S};++O;var V=Number(p[O]);++O;var G=Number(p[O]);++O;var N=Number(p[O]);++O;var D=Number(p[O]);++O;var U,F=Number(p[O]);++O,P=Number(p[O]),++O,T={x:P,y:S=Number(p[O])},U=0==N?{x:(B.x-T.x)/2,y:(B.y-T.y)/2}:{x:Math.cos(N)*(B.x-T.x)/2+Math.sin(N)*(B.y-T.y)/2,y:-Math.sin(N)*(B.x-T.x)/2+Math.cos(N)*(B.y-T.y)/2};var H=Math.pow(U.x,2)/Math.pow(V,2)+Math.pow(U.y,2)/Math.pow(G,2);H>1&&(V*=Math.sqrt(H),G*=Math.sqrt(H));var z=(D==F?-1:1)*Math.sqrt((Math.pow(V,2)*Math.pow(G,2)-Math.pow(V,2)*Math.pow(U.y,2)-Math.pow(G,2)*Math.pow(U.x,2))/(Math.pow(V,2)*Math.pow(U.y,2)+Math.pow(G,2)*Math.pow(U.x,2)));isNaN(z)&&(z=0);var j,W={x:z*V*U.y/G,y:z*-G*U.x/V};j=0==N?{x:(B.x+T.x)/2+W.x,y:(B.y+T.y)/2+W.y}:{x:(B.x+T.x)/2+Math.cos(N)*W.x-Math.sin(N)*W.y,y:(B.y+T.y)/2+Math.sin(N)*W.x+Math.cos(N)*W.y};var Y=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2))},X=function(e,t){return(e[0]*t[0]+e[1]*t[1])/(Y(e)*Y(t))},Z=function(e,t){return(e[0]*t[1]<e[1]*t[0]?-1:1)*Math.acos(X(e,t))},q=Z([1,0],[(U.x-W.x)/V,(U.y-W.y)/G]),_=[(U.x-W.x)/V,(U.y-W.y)/G],K=[(-U.x-W.x)/V,(-U.y-W.y)/G],J=Z(_,K);X(_,K)<=-1&&(J=Math.PI),X(_,K)>=1&&(J=0);X=V>G?V:G;var Q,$=V>G?1:V/G,ee=V>G?G/V:1,te=this.#Zo.transform(j.x,j.y,s,!1,l);Q=l?{x:$*l.docDPR,y:ee*l.docDPR}:this.#Zo.transform($,ee,s,!0),h.translate(te.x,te.y),0==N&&1==Q.x&&1==Q.y?h.arc(0,0,X,q,q+J,1-F):(h.rotate(N),h.scale(Q.x,Q.y),h.arc(0,0,X,q,q+J,1-F),h.scale(1/Q.x,1/Q.y),h.rotate(-N)),h.translate(-te.x,-te.y),T=this.#Zo.transform(P,S,s,!1,l);break;case"Z":case"z":h.closePath(),R=!0,P=w,S=C,n&&!l&&n.addSubPathPoint(P,S);break;default:I=!0}T&&(T.x<u&&(u=T.x),T.x>m&&(m=T.x),T.y<y&&(y=T.y),T.y>v&&(v=T.y)),I?(k=b,I=!1,--O):(b=k,k=p[++O])}d||h.fill(),c||h.stroke();var ie,se=!1;if(r&&!d&&(this.#Hn.pathHitTester.enable||this.#Hn.pathHitTester.centralGetter)&&((h.isPointInPath(this.#Hn.pathHitTester.x,this.#Hn.pathHitTester.y)||h.isPointInStroke(this.#Hn.pathHitTester.x,this.#Hn.pathHitTester.y))&&(se=!0,r.hilightFillStyle?r.hilightFillStyle.color&&r.hilightFillStyle.lineWidth&&(ie=r.hilightFillStyle):ie=this.defaultHilightStyle.fill,ie))){var re=h.lineWidth;h.lineWidth=ie.lineWidth;var ae=h.fillStyle;h.fillStyle=ie.color,h.fill();var oe=h.strokeStyle;ie.lineColor&&(h.strokeStyle=ie.lineColor),h.stroke(),h.fillStyle=ae,h.lineWidth=re,h.strokeStyle=oe}if(r&&d){var ne,le=h.lineWidth,he=h.strokeStyle;if(h.lineWidth<6&&(h.lineWidth=6,h.strokeStyle="rgba(0,0,0,0)",h.stroke()),this.#Hn.pathHitTester.enable||this.#Hn.pathHitTester.centralGetter)if(h.isPointInStroke(this.#Hn.pathHitTester.x,this.#Hn.pathHitTester.y))se=!0,r.hilightStrokeStyle?r.hilightStrokeStyle.color&&r.hilightStrokeStyle.widthIncrement&&(ne=r.hilightStrokeStyle):ne=this.defaultHilightStyle.stroke,ne&&(h.lineWidth=le+ne.widthIncrement,h.strokeStyle=ne.color,h.stroke());h.lineWidth=le,h.strokeStyle=he}var ge,de,ce=0,pe=0;R?(ge=x,de=M):(ge=T.x,de=T.y);var ue=Math.sqrt((ge-L)*(ge-L)+(de-E)*(de-E));return ue&&(ce=(ge-L)/ue,pe=(de-E)/ue),{hitted:se,x:u,y:y,width:m-u,height:v-y,endX:ge,endY:de,endCos:ce,endSin:pe}}}class T{constructor(e,t,i,s){this.#si=e,this.#ii=t,this.#zn=i,this.#jn=s,this.setRootLayersPropsPostprocessed={processed:!1,execHint:{}}}setRootLayersPropsPostprocessed;#si;#ii;#zn;#jn;getLayer(e){var t=null,s=this.#si.root.isSVG2;if(isNaN(e)){if(!(t=i.getElementByImgIdNoNS(this.#ii.root,e)))for(var r=this.getLayers(),a=0;a<r.length;a++){if(r[a].getAttribute("title")==e){t=r[a];break}if(s&&r[a].getAttribute("src")==e){t=r[a];break}if(r[a].getAttribute("xlink:href")==e){t=r[a];break}}}else t=s?this.#ii.root.getElementsByTagName("iframe")[e]:this.#ii.root.getElementsByTagName("animation")[e];return t}getLayerId(e){var t=null;if(e.getAttribute)t=e.getAttribute("iid");else{var i=this.getLayer(e);i&&(t=i.getAttribute("iid"))}return t}isEditingLayer=function(e){if(e){var t=e.getAttribute("iid");return!(!this.#si[t]||!this.#si[t].editing)}for(var s in this.#si)if(1==this.#si[s].editing)return this.#ii.root.documentElement,i.getElementByImgIdNoNS(this.#ii.root,s);return null}.bind(this);isEditableLayer(e){if("string"==typeof e){for(var t=this.#Wn(),i=0;i<t.length;i++)if(t[i].getAttribute("iid")==e)return!0;return!1}return!!(e.getAttribute("class")&&e.getAttribute("class").indexOf("editable")>=0)}#Wn(){for(var e=new Array,t=this.getLayers(),i=0;i<t.length;i++)this.isEditableLayer(t[i])&&e.push(t[i]);return e}#Yn(e,t,i,s,r,a){return t&&-1!=e.indexOf(t)&&e.splice(e.indexOf(t),1),i&&-1!=e.indexOf(i)&&e.splice(e.indexOf(i),1),s&&-1!=e.indexOf(s)&&e.splice(e.indexOf(s),1),r&&-1!=e.indexOf(r)&&e.splice(e.indexOf(r),1),a&&-1!=e.indexOf(a)&&e.splice(e.indexOf(a),1),e}getSwLayers(e){for(var t=new Array,i=new Array,s=this.getLayers(),r=0;r<s.length;r++)if(s[r].getAttribute("class")){var a,o=s[r].getAttribute("class").split(" ");a=!e||-1!=o.indexOf(e),o=this.#Yn(o,"switch","batch","editable","clickable");for(var n=0;n<o.length;n++)t[o[n]]||(t[o[n]]=new Array),a&&(i[o[n]]=!0),t[o[n]].push(s[r])}if(e)for(var r in t)i[r]||delete t[r];return t}#Xn(e){var t;if(!e.getAttribute("class"))return!0;t=e.getAttribute("class").split(" "),t=this.#Yn(t,"batch","editable","clickable","switch");var i=this.getSwLayers("switch"),s=!1;for(var r in i)if(-1!=t.indexOf(r)){s=!0;break}if(s){if("hidden"==e.getAttribute("visibility")||"none"==e.getAttribute("display")){i=this.getSwLayers();var a=new Array;for(r=0;r<t.length;r++)for(var o=i[t[r]],n=0;n<o.length;n++)o[n]!=e&&a.push(o[n]);return i=null,a}return!1}return!0}getLayers(e){return e||(e="root"),this.#si[e].isSVG2?this.#ii[e].getElementsByTagName("iframe"):this.#ii[e].getElementsByTagName("animation")}getRootLayersProps(){for(var e=this.getSwLayers("switch"),t=this.getSwLayers("batch"),i=this.getLayers(),s=new Array,r=0;r<i.length;r++){s[r]=new Object,s[r].id=i[r].getAttribute("iid"),s[r].number=r,this.#si[s[r].id]&&this.#ii[s[r].id]&&!this.#zn[s[r].id]?s[r].hasDocument=!0:s[r].hasDocument=!1,s[r].href=i[r].getAttribute("xlink:href"),s[r].svgImageProps=this.#si[s[r].id],s[r].title=this.getLayerName(i[r]);var a=!0;"hidden"!=i[r].getAttribute("visibility")&&"none"!=i[r].getAttribute("display")||(a=!1),s[r].visible=a,s[r].editable=this.isEditableLayer(i[r]),s[r].editing=!1,s[r].editable&&(s[r].editing=this.isEditingLayer(i[r]));var o="";if(i[r].getAttribute("class")){var n=this.#Yn(i[r].getAttribute("class").split(" "),"switch","batch","editable","clickable");n.length>0&&(o=n[0])}s[r].groupName=o,s[r].groupFeature="",o&&(e[o]?s[r].groupFeature="switch":t[o]&&(s[r].groupFeature="batch"))}for(r=0;r<s.length;r++)s[s[r].id]=s[r];return s}setRootLayersProps(e,t,i,s,r,a){this.setRootLayersPropsPostprocessed.processed=!1;var o=this.getLayer(e);if(!o)return!1;r&&o.parentElement.removeChild(o);var n=o.getAttribute("iid"),l=this.getRootLayersProps(),h=l[n];if(null==t&&(t=h.visible),null==i&&(i=h.editing),!s&&h.visible==t&&h.editing==i)return!1;if(!h.editable&&i)return!1;if(!t&&i)return!1;if("switch"==h.groupFeature&&t&&!h.visible){var g=this.#Xn(o);if(g instanceof Boolean&&0==g);else if(g instanceof Array)for(var d=0;d<g.length;d++)g[d].setAttribute("visibility","hidden")}if(i&&h.editing!=i)for(d=0;d<l.length;d++)this.#si[l[d].id]&&1==this.#si[l[d].id].editing&&this.#si[l[d].id].editing;if(h.visible!=t&&(t?o.setAttribute("visibility","visible"):o.setAttribute("visibility","hidden")),s){var c=!1,p=o.getAttribute("xlink:href");p||(c=!0,p=o.getAttribute("src")),p.indexOf("#")>0?p=p.substring(0,p.indexOf("#"))+s:p+=s,console.log("add hashOption to url:",p," : ",s),c?o.setAttribute("src",p):o.setAttribute("xlink:href",p)}return h.editing!=i&&(this.#si[n].editing=i),!a||"appearOnLayerLoad"!=a&&"hiddenOnLayerLoad"!=a&&"onClick"!=a?delete this.setRootLayersPropsPostprocessed.execHint[n]:this.setRootLayersPropsPostprocessed.execHint[n]=a,!0}setLayerVisibility(e,t,i){let s=null,r=null;i&&(i.exec&&(s=i.exec),i.hash&&(r=i.hash)),this.setRootLayersProps(e,t,!1,r,null,s),this.#jn()}getLayerName(e){var t="";return e.getAttribute("title")?t=e.getAttribute("title"):(t=e.getAttribute("xlink:href"),optText||(t=e.getAttribute("src"))),t}getLayerHash(e){var t=null,i=this.getLayer(e);return i&&(t=i.getAttribute("iid")),t}getHashByDocPath(e){var t=null;for(var i in this.#si)if(null==this.#si[i].Path);else if(this.#si[i].Path.indexOf(e)>=0){t=i;break}return t}}class O{#Zn=null;#e;constructor(e){this.#e=e;var t=this.#e.getUaProp(),i=document.getElementById("gpsButton");if(i)if(navigator.geolocation){if(t.isSP&&navigator.userAgent.indexOf("Safari")>0&&navigator.userAgent.indexOf("Chrome")<0){this.#Zn=document.createElement("iframe"),document.documentElement.appendChild(this.#Zn),console.log("contentWindow:",this.#Zn.contentWindow.document);var s=this.#Zn.contentWindow.document.documentElement,r=this.#Zn.contentWindow.document.createElement("script");this.#Zn.style.display="none",r.innerHTML='function gps(){navigator.geolocation.getCurrentPosition( gpsSuccess );}function gpsSuccess(position){console.log("gps",position);window.parent.svgMap.gpsCallback(position)}',s.appendChild(r)}}else i.style.display="none"}gps(){this.#Zn?this.#Zn.contentWindow.gps():navigator.geolocation.getCurrentPosition(this.gpsSuccess)}gpsSuccess=function(e){console.log("gpsSuccess:",e),this.#e.setGeoCenter(e.coords.latitude,e.coords.longitude,10*e.coords.accuracy/1e5)}.bind(this)}class k{#e;#zn;#qn;#_n;#si;#Zo;#bo;#Kn;#qt;constructor(e,t,i,s,r,a,o,n){this.#e=e,this.#zn=t,this.#qn=i,this.#_n=s,this.#qt=r,this.#Zo=a,this.#bo=o,this.#Kn=n,this.#si=this.#e.getSvgImagesProps()}getImgElement(e,s,r,a,o,n,l,h,g,d,c,p,u,m,y,v,f,b){var I=document.createElement("img");u&&(I.style.imageRendering="pixelated",I.style.imageRendering="-moz-crisp-edges",I.style.msInterpolationMode="nearest-neighbor",I.style.imageRendering="optimize-contrast",I.dataset.pixelated="true"),p&&I.setAttribute("href_fragment",p),y&&(o=i.getNoCacheRequest(o)),b&&(o=i.addCommonQueryAtQueryString(o,b));var P=this.#qn.getImageAccessInfo(o,this.#Jn(this.#si[f.docId].CRS,f.svgNode),v);return this.#Qn(I,P.href,n,!1,f,P.crossOriginFlag,P.hasNonLinearImageTransformation),l&&(I.style.opacity=l),m&&(I.style.filter+=m),I.style.left=e+"px",I.style.top=s+"px",I.style.display="none",I.style.position="absolute",I.style.maxWidth="initial",I.style.height=a+"px",I.style.width=r+"px",I.width=r,I.height=a,I.id=n,c&&(I.style.transform="matrix("+c.a+","+c.b+","+c.c+","+c.d+","+c.e+","+c.f+")",I.style.transformOrigin="0 0",I.style.webkitTransform="matrix("+c.a+","+c.b+","+c.c+","+c.d+","+c.e+","+c.f+")",I.style.webkitTransformOrigin="0 0"),h==t.POI?(I.style.zIndex="10",I.style.cursor="pointer",I.setAttribute("content",g),d?I.setAttribute("title",d):I.setAttribute("title",P.href)):I.setAttribute("title",""),I}setImgElement(e,t,i,s,r,a,o,n,l,h,g,d,c,p,u,m,y,v){if(n||(n=0),l||(l=0),e.style.left=n+t+"px",h){g||(e.style.fontSize=r+"px");var f=parseInt(e.style.fontSize);const t=this.#$n(v.svgNode.textContent,f);e.style.top=i+l-t+"px"}else e.style.top=l+i+"px";h||(e.width=s,e.height=r,e.style.width=s+"px",e.style.height=r+"px"),c?(e.style.imageRendering="pixelated",e.style.imageRendering="-moz-crisp-edges",e.style.msInterpolationMode="nearest-neighbor",e.style.imageRendering="optimize-contrast",e.dataset.pixelated="true"):(e.style.imageRendering="",e.style.imageRendering="",e.style.msInterpolationMode="",e.style.imageRendering="",e.dataset.pixelated="true"),e.style.opacity=m||"",e.style.filter=p||"";var b=this.#qn.getImageAccessInfo(a,this.#Jn(this.#si[v.docId].CRS,v.svgNode),y),I=e.getAttribute("data-preTransformedHref");I||(I=e.getAttribute("src")),!h&&e.src&&b.href&&this.#el(I,b.href)&&(e.removeAttribute("data-preTransformedHref"),this.#Qn(e,b.href,u,!0,v,b.crossOriginFlag,b.hasNonLinearImageTransformation)),o&&(e.style.transform="matrix("+o.a+","+o.b+","+o.c+","+o.d+","+o.e+","+o.f+")",e.style.transformOrigin="0 0",e.style.webkitTransform="matrix("+o.a+","+o.b+","+o.c+","+o.d+","+o.e+","+o.f+")",e.style.webkitTransformOrigin="0 0"),e.style.visibility="",d&&this.#tl(e,d)}#Qn(e,t,i,s,r,a,o){var n=this.#_n;1==o&&(n=3*this.#_n),this.#qt.uaProps.verIE>8?(e.addEventListener("load",this.#il),e.addEventListener("error",this.#sl),e.src=t,e.crossOrigin=a?"anonymous":null):(e.attachEvent("onload",this.#il),e.crossOrigin=a?"anonymous":null,s?e.src=t:e.setAttribute("href",t),e.style.filter="inherit"),setTimeout(this.#sl,n,e),this.#zn[i]=r}#il=function(e){var t=e.target||e.srcElement;if(t.removeEventListener("load",this.#il),t.src,t.getAttribute("href_fragment")){var i=t.getAttribute("href_fragment");this.#tl(t,i),t.removeAttribute("href_fragment")}t.style.display="",t.style.visibility="";var s=this.#zn[t.id];delete this.#zn[t.id],this.#rl(t,s),this.#bo()}.bind(this);#Jn(e,t){if(e.transform||this.#qt.rootCrs.transform){if("true"==t.getAttribute("data-mercator-tile")&&!e.transform&&this.#qt.rootCrs.mercator)return!1;var i=t.getAttribute("transform");return!i||0!=i.indexOf("ref")}return!1}#sl=function(e){var t,i=!1;e.id?(t=e,i=!0):(t=e.target||e.srcElement,++this.#Kn.otherBitImagesCount),this.#zn[t.id]&&(console.warn("LoadImg TimeOut!!!!!"),i&&++this.#Kn.timeoutBitImagesCount,delete this.#zn[t.id],this.#bo())}.bind(this);#rl(e,t){if(t){var s=t.svgNode,r=s.getAttribute("transform");if(!r||0!=r.indexOf("ref")){var a=i.parseTransformMatrix(r),o=this.#si[t.docId].CRS;if(0!=this.#Jn(o,s)){var n=document.getElementById("imageTransformCanvas");n||((n=document.createElement("canvas")).id="imageTransformCanvas");var l=e.naturalWidth,h=e.naturalHeight,g=n.getContext("2d");n.width=l,n.height=h,g.drawImage(e,0,0);var d=g.getImageData(0,0,l,h),c=g.createImageData(l,h),p=Number(s.getAttribute("x")),u=Number(s.getAttribute("y")),m={a:Number(s.getAttribute("width"))/l,b:0,c:0,d:Number(s.getAttribute("height"))/h,e:p,f:u};a&&(m=this.#Zo.matMul(m,a));var y=this.#Zo.getInverseMatrix(m),v=this.#Zo.getConversionMatrixViaGCS(this.#qt.rootCrs,o),f=this.#Zo.getConversionMatrixViaGCS(o,this.#qt.rootCrs),b=this.#Zo.transformRect({x:0,y:0,width:l,height:h},m);if(e.getAttribute("data-preTransformedHref"))console.log("Already Transformed image");else{for(var I=this.#Zo.transformRect(b,f),P={a:I.width/l,b:0,c:0,d:I.height/h,e:I.x,f:I.y},S=[],x=4*l,M=0;M<h;M++)for(var w=!1,C=0;C<l;C++){var L,A=4*(C+M*l),E=this.#Zo.transform(C,M,P),T=this.#Zo.transform(E.x,E.y,v);if(T&&(L=this.#Zo.transform(T.x,T.y,y)),L&&L.x>=0&&L.x<l&&L.y>=0&&L.y<h){var O=4*(Math.floor(L.x)+Math.floor(L.y)*l);c.data[A]=d.data[O],c.data[A+1]=d.data[O+1],c.data[A+2]=d.data[O+2],c.data[A+3]=d.data[O+3],w=!0,S[C]=!0}else w?(c.data[A]=c.data[A-4],c.data[A+1]=c.data[A-4+1],c.data[A+2]=c.data[A-4+2],c.data[A+3]=c.data[A-4+3]):S[C]&&(c.data[A]=c.data[A-x],c.data[A+1]=c.data[A-x+1],c.data[A+2]=c.data[A-x+2],c.data[A+3]=c.data[A-x+3]),w=!1,S[C]=!1}g.putImageData(c,0,0);var k=n.toDataURL("image/png");e.setAttribute("data-preTransformedHref",e.getAttribute("src")),e.setAttribute("src",k)}}}}}#tl(e,t){var i=t.split(/\s*,\s*|\s/),s=e.width/Number(i[2]),r=e.height/Number(i[3]),a=parseFloat(e.style.left)-s*Number(i[0]),o=parseFloat(e.style.top)-r*Number(i[1]),n=e.naturalWidth*s,l=e.naturalHeight*r;e.style.left=a+"px",e.style.top=o+"px",e.width=n,e.height=l,e.style.width=n+"px",e.style.height=l+"px",e.style.clip="rect("+Number(i[1])*r+"px,"+(Number(i[0])+Number(i[2]))*s+"px,"+(Number(i[1])+Number(i[3]))*r+"px,"+Number(i[0])*s+"px)"}#el(e,t){var i=!0;if(e==t)return!1;if(0==e.indexOf(t)){var s=e.substring(t.length);s.indexOf("unixTime=")>0&&s.length<24&&(i=!1)}return i}buildPixelatedImages4Edge(e){var t=e.getElementsByTagName("img");if(t.length>0)for(var i=0;i<t.length;i++)if(t[i].dataset.pixelated){var s=t[i].parentNode;console.log("should be pixelated img : ",t[i].id,"  style:",t[i].style.top,t[i].style.left),t[i].style.visibility="hidden";var r=document.createElement("canvas");r.dataset.pixelate4Edge="true",r.width=t[i].width,r.height=t[i].height,r.style.position="absolute",r.style.top=t[i].style.top,r.style.left=t[i].style.left,s.insertBefore(r,t[i]);var a=r.getContext("2d");a.imageSmoothingEnabled=!1,a.msImageSmoothingEnabled=!1;var o=new Image;o.src=t[i].src,a.drawImage(o,0,0,r.width,r.height)}}getSpanTextElement(e,t,i,s,r,a,o,n,l,h,g){var d=document.createElement("span");o&&(d.style.opacity=o),l.fill&&(d.style.color=l.fill);var c=0;c=l["font-size"]&&g?Number(l["font-size"]):g?16:h;const p=this.#$n(r,c);return d.style.fontSize=c+"px",d.innerHTML=r,d.style.left=e+i+"px",d.style.top=t+s-p+"px",d.style.position="absolute",d.id=a,d.setAttribute("title",""),d}#al={height:{0:0}};#ol=64;#$n(e,t){return this.#nl(t)*(this.#ll(e)+1)}#nl(e){const t=String(e);let i=this.#al.height[t];if(null==i){if(Object.keys(this.#al.height).length<this.#ol){i=this.#hl("TEXT",e+"px").height,this.#al.height[t]=i}else i=this.#gl(e)}return i}#gl(e){this.#al.fsArray&&this.#al.fsArray.length===Object.keys(this.#al.height).length||(this.#al.fsArray=Object.keys(this.#al.height).map(e=>parseFloat(e)).filter(e=>0!==e).sort((e,t)=>e-t));const t=this.#al.fsArray;if(t.length<2){const i=t[0]||1;return(this.#al.height[String(i)]||1)*(e/i)}let i,s,r,a,o=null,n=null;for(let i=0;i<t.length;i++){const s=t[i];if(s<e)o=s;else if(s>e){n=s;break}}if(null!==o&&null!==n)i=o,r=n;else if(null===o&&null!==n)i=t[0],r=t[1];else{if(null===o||null!==n)return 0;{const e=t.length;i=t[e-2],r=t[e-1]}}s=this.#al.height[String(i)],a=this.#al.height[String(r)];return s+(e-i)/(r-i)*(a-s)}#hl(e,t,i="sans-serif"){const s=document.createElement("span");s.style.visibility="hidden",s.style.position="absolute",s.style.whiteSpace="pre-wrap",s.style.fontSize=t,s.style.fontFamily=i,s.innerHTML=e,document.body.appendChild(s);const r=s.getBoundingClientRect(),a=r.width,o=r.height;return document.body.removeChild(s),{width:a,height:o}}#ll(e){const t=e.match(/<br>/gi);return t?t.length:0}}class R{#e;#dl;#Hn;#Zo;#cl;#So;#qt;#pl=null;initialCustomLayers=null;rootSVGpath=null;geoViewBox={x:0,y:0,width:1,height:1};ignoreMapAspect=!1;constructor(e,t,i,s,r,a,o){this.#e=e,this.#qt=t,this.#dl=i,this.#Hn=s,this.#Zo=r,this.#cl=a,this.#So=o,this.#ul=0}#ml;#yl;#vl=50;initMapCanvas(){var e=document.getElementById("mapcanvas");if(!e)return console.warn("NO id:mapcanvas div exit.."),null;var t,s=document.createElement("div");for(var r of(e.setAttribute("id","mapCanvasWrapper"),e.attributes))"id"==r.name?s.setAttribute("id","mapcanvas"):"title"==r.name||s.setAttribute(r.name,r.value);if(e.appendChild(s),e.setAttribute("style","position: absolute; overflow: hidden; top: 0px; left: 0px; width: 100%; height: 100%;"),this.#qt.mapCanvas=s,this.#qt.mapCanvasWrapper=e,e.dataset.src)t=e.dataset.src;else{if(!e.title)return console.warn("NO id:mapcanvas data-src for root svg container exit.."),null;t=e.title}if(e.dataset.customLayersRoot){var a,o=e.dataset.customLayersRoot,n=location.href.substring(location.href.indexOf("#")),l=i.getUrlHash(n);if(l&&o)l.customLayers?a=l.customLayers:l.customlayers&&(a=l.customlayers),a&&(this.#pl=new URL(a,new URL(o,location)).href);else o&&o.endsWith(".json")&&(this.#pl=new URL(o,location).href)}return t}prepareInitialCustomLayers=async function(){if(this.#pl)try{this.initialCustomLayers=await(await fetch(this.#pl)).json(),console.log("customLayersPath:",this.#pl," initialCustomLayers:",this.initialCustomLayers)}catch(e){console.warn("can't load customLayers json",e)}return this.initialCustomLayers};setLayerListSize(){var e=document.getElementById("layerList"),t=e.style.width;if((!t||t.indexOf("px")<0)&&(e.style.width=.5*this.#qt.mapCanvasSize.width-this.#vl-5+"px",t=e.style.width),t=Number(t.substring(0,t.indexOf("px"))),e.dataset.originalSize||(e.dataset.originalSize=t),this.#vl+5+Number(e.dataset.originalSize)>this.#qt.mapCanvasSize.width){var i=this.#qt.mapCanvasSize.width-(this.#vl+7);e.style.width=i+"px"}else e.style.width=e.dataset.originalSize+"px"}initNavigationUIs(e){var t=document.createElement("style");t.innerHTML="::-webkit-scrollbar{-webkit-appearance:none;width:7px;}::-webkit-scrollbar-thumb{border-radius:4px;background-color:rgba(0,0,0,.5);-webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);}",document.documentElement.appendChild(t);var i=document.documentElement.style;i.position="fixed",i.width="100%",i.height="100%",i.overflow="hidden";var s=document.getElementById("zoomupButton"),r=document.getElementById("zoomdownButton"),a=document.getElementById("gpsButton"),o=document.getElementById("layerList"),n=document.getElementsByClassName("customButton");if(e){var l=0;if(s&&(s.width=this.#vl,s.height=this.#vl,s.style.top=l+"px",l+=this.#vl+5),r&&(r.width=this.#vl,r.height=this.#vl,r.style.top=l+"px",l+=this.#vl+5),a&&(a.width=this.#vl,a.height=this.#vl,a.style.top=l+"px",l+=this.#vl+5),n)for(var h=0;h<n.length;h++)n[h].width=this.#vl,n[h].height=this.#vl,n[h].style.top=l+"px",l+=this.#vl+5;l>0&&o&&(o.style.left=this.#vl+5+"px")}if(o&&this.setLayerListSize(),s&&(s.style.cursor="pointer"),r&&(r.style.cursor="pointer"),a&&(a.style.cursor="pointer"),n)for(h=0;h<n.length;h++)n[h].style.cursor="pointer"}setPointerEvents(){this.#qt.uaProps.verIE>8&&(i.addEvent(document,"contextmenu",function(e){e.preventDefault()}),i.addEvent(this.#qt.mapCanvas,"click",function(e){e.preventDefault()},!1),i.addEvent(this.#qt.mapCanvas,"mousedown",function(e){e.preventDefault()},!1));var e=this;if(this.#qt.uaProps.verIE>8){var t=this.#qt.mapCanvasWrapper;i.addEvent(t,"touchstart",function(e){e.preventDefault()}),i.addEvent(t,"touchend",function(e){e.preventDefault()}),i.addEvent(t,"touchmove",function(e){e.preventDefault()}),i.addEvent(t,"touchstart",function(t){e.#dl.startPan(t)}),i.addEvent(t,"touchend",function(t){e.#dl.endPan(t)}),i.addEvent(t,"touchmove",function(t){e.#dl.showPanning(t)}),i.addEvent(window,"resize",function(t){e.#fl(t)}),i.addEvent(t,"mousedown",function(t){e.#dl.startPan(t)}),i.addEvent(t,"mouseup",function(t){e.#dl.endPan(t)}),i.addEvent(t,"mousemove",function(t){e.#dl.showPanning(t)}),i.addEvent(window,"resize",function(t){e.#fl(t)})}e=this;window.addEventListener("wheel",function(t){e.#bl(t)},{passive:!1})}#fl(){var e=i.getCanvasSize();if(!e||e.width<1||e.height<1)setTimeout(function(){this.#fl()}.bind(this),50);else{var t=this.#So(this.#qt.rootViewBox,this.#qt.mapCanvasSize),s=this.#qt.rootViewBox.x+.5*this.#qt.rootViewBox.width,r=this.#qt.rootViewBox.y+.5*this.#qt.rootViewBox.height;this.#qt.setMapCanvasSize(e),this.#qt.rootViewBox.width=this.#qt.mapCanvasSize.width/t.a,this.#qt.rootViewBox.height=this.#qt.mapCanvasSize.height/t.d,this.#qt.rootViewBox.x=s-.5*this.#qt.rootViewBox.width,this.#qt.rootViewBox.y=r-.5*this.#qt.rootViewBox.height,this.setMapCanvasCSS(this.#qt.mapCanvas),this.#e.refreshScreen(),this.setLayerListSize(),this.setCenterUI()}}#Il;#ul;#bl(e){0==this.#ul&&(this.#dl.startPan({type:"wheelDummy",button:2,clientX:0,clientY:0}),this.#dl.wheelZooming=!0);var t=1;e.ctrlKey&&(t=3),this.#ul-=(e.deltaX+e.deltaY+e.deltaZ)*t,this.#dl.showPanning({type:"wheelDummy",buttons:1,clientX:0,clientY:this.#ul}),clearTimeout(this.#Il),this.#Il=setTimeout(function(){this.#dl.endPan(),this.#dl.wheelZooming=!1,this.#ul=0}.bind(this),200),e.preventDefault()}setCenterUI(){var e;document.getElementById("centerSight")?e=document.getElementById("centerSight"):((e=document.createElement("img")).setAttribute("id","centerSight"),e.setAttribute("src",BuiltinIcons.xcursor),e.setAttribute("width",15),e.setAttribute("height",15),e.style.opacity="0.5",document.documentElement.appendChild(e)),e.style.position="absolute",e.style.top=this.#qt.mapCanvasSize.height/2-document.getElementById("centerSight").height/2+"px",e.style.left=this.#qt.mapCanvasSize.width/2-document.getElementById("centerSight").width/2+"px",this.#Hn.updateTicker(),document.getElementById("centerPos")?this.#ml=document.getElementById("centerPos"):this.#ml=null,document.getElementById("vScale")?this.#yl=document.getElementById("vScale"):this.#yl=null}updateCenterPos(){if(this.#ml){var e=this.getCentralGeoCoorinates();this.#ml.innerHTML=i.round(e.lat,6)+" , "+i.round(e.lng,6)}this.#yl&&(this.#yl.innerHTML=i.round(this.getVerticalScreenScale(50),3)+"Km")}setUpdateCenterPos(e){e&&(this.updateCenterPos=e)}getVerticalScreenScale(e){var t=this.screen2Geo(1,1),i=this.screen2Geo(1,1+e);return 111.111111*(t.lat-i.lat)}getCentralGeoCoorinates(){var e=this.#qt.rootViewBox.x+this.#qt.rootViewBox.width/2,t=this.#qt.rootViewBox.y+this.#qt.rootViewBox.height/2;return this.#Zo.SVG2Geo(e,t,this.#qt.rootCrs)}screen2Geo(e,t){var i,s;t?(i=e,s=t):(i=e.x,s=e.y);var r=this.#qt.rootViewBox.width*i/this.#qt.mapCanvasSize.width,a=this.#qt.rootViewBox.height*s/this.#qt.mapCanvasSize.height,o=this.#qt.rootViewBox.x+r,n=this.#qt.rootViewBox.y+a;return this.#Zo.SVG2Geo(o,n,this.#qt.rootCrs)}geo2Screen(e,t){var i,s;t?(i=e,s=t):(i=e.lat,s=e.lng);var r=this.#Zo.Geo2SVG(i,s,this.#qt.rootCrs);return{x:(r.x-this.#qt.rootViewBox.x)*this.#qt.mapCanvasSize.width/this.#qt.rootViewBox.width,y:(r.y-this.#qt.rootViewBox.y)*this.#qt.mapCanvasSize.height/this.#qt.rootViewBox.height}}setGeoCenter(e,t,i){if(console.log("setGeoCenter:",e,t,i),e&&t){var s,r;if(this.#cl(),i){if(this.#qt.rootCrs.d)r=Math.abs(this.#qt.rootCrs.d*i);else{var a=this.#Zo.transform(t,e-i/2,this.#qt.rootCrs),o=this.#Zo.transform(t,e+i/2,this.#qt.rootCrs);r=Math.abs(a.y-o.y)}s=r*this.#qt.rootViewBox.width/this.#qt.rootViewBox.height}else r=this.#qt.rootViewBox.height,s=this.#qt.rootViewBox.width;var n=this.#Zo.Geo2SVG(e,t,this.#qt.rootCrs),l=n.x-s/2,h=n.y-r/2;this.#qt.rootViewBox.x=l,this.#qt.rootViewBox.y=h,this.#qt.rootViewBox.width=s,this.#qt.rootViewBox.height=r,this.#e.refreshScreen()}}setGeoViewPort(e,t,i,s,r){return!(!i||!s)&&(this.#cl(),this.#qt.setRootViewBox(this.#Pl(e,t,i,s,this.ignoreMapAspect)),r?this.setGeoViewBox(this.#Zo.getTransformedBox(this.#qt.rootViewBox,this.#qt.root2Geo)):this.#e.refreshScreen(),!0)}#Pl(e,t,s,r,a){var o=this.#Zo.Geo2SVG(e,t,this.#qt.rootCrs),n=this.#Zo.Geo2SVG(e+s,t+r,this.#qt.rootCrs),l=new Object;return l.x=o.x,l.y=n.y,l.width=Math.abs(n.x-o.x),l.height=Math.abs(o.y-n.y),a?l:i.getrootViewBoxFromRootSVG(l,this.#qt.mapCanvasSize)}setGeoViewBox(e){this.geoViewBox.x=e.x,this.geoViewBox.y=e.y,this.geoViewBox.width=e.width,this.geoViewBox.height=e.height}getGeoViewBox(){var e=this.getCentralGeoCoorinates();return{x:this.geoViewBox.x,y:this.geoViewBox.y,width:this.geoViewBox.width,height:this.geoViewBox.height,cx:e.lng,cy:e.lat}}setMapCanvasCSS(e){e.style.position="absolute",e.style.overflow="hidden",e.style.top="0px",e.style.left="0px",e.style.width=this.#qt.mapCanvasSize.width+"px",e.style.height=this.#qt.mapCanvasSize.height+"px"}}class B{root2Geo;mapCanvas;rootCrs;uaProps;mapCanvas;mapCanvasWrapper;constructor(){Object.defineProperty(this,"rootViewBox",{value:{}}),Object.defineProperty(this,"mapCanvasSize",{value:{}})}hasUaProps(){var e=!1;return this.uaProps&&this.uaProps.verIE&&(e=!0),e}hasMapCanvasSize(){return!!this.mapCanvasSize.width}setRootViewBox(e){this.rootViewBox.x=e.x,this.rootViewBox.y=e.y,this.rootViewBox.width=e.width,this.rootViewBox.height=e.height}setMapCanvasSize(e){this.mapCanvasSize.x=e.x,this.mapCanvasSize.y=e.y,this.mapCanvasSize.width=e.width,this.mapCanvasSize.height=e.height}}class V{#qt;#Sl;#Hn;#Fn;#si;#ii;#jn;#xl;usedImages={};constructor(e,t,i,s,r){Object.defineProperty(this,"loadingImgs",{value:{}}),this.#qt=e,this.#si=t,this.#ii=i,this.#jn=s,this.#xl=r}init(e,t,i){this.#Sl=e,this.#Hn=t,this.#Fn=i}#Ml=!0;setLoadCompleted=function(e){this.#Ml=e}.bind(this);getLoadCompleted=function(){return this.#Ml}.bind(this);checkLoadCompleted=function(e){var t=this.#wl(this.loadingImgs);if(0==t||e){for(var i=0;i<this.#Cl;i++){var s=document.getElementById("toBeDel"+i);s&&s.parentNode.removeChild(s)}if(this.#Cl=0,this.#Ll(this.#qt.mapCanvas),this.#qt.uaProps.Edge&&this.#Sl.buildPixelatedImages4Edge(this.#qt.mapCanvas),!this.#Ml&&!this.#Hn.pathHitTester.enable)if(this.#Al(),this.#xl()){var r=document.createEvent("HTMLEvents");r.initEvent("zoomPanMap",!0,!1),document.dispatchEvent(r)}else{var a=document.createEvent("HTMLEvents");a.initEvent("screenRefreshed",!0,!1),document.dispatchEvent(a)}return this.#Ml=!0,this.#El(),!0}return this.#Ml=0==t,!1}.bind(this);#Cl=0;requestRemoveTransition(e,t){var i=e.parentNode,s=null;if(i.childNodes)for(var r=0;r<i.childNodes.length;r++)if(1==i.childNodes[r].nodeType&&0==i.childNodes[r].id.indexOf("toBeDel")){s=i.childNodes[r];break}s||((s=document.createElement("div")).id="toBeDel"+this.#Cl,i.insertBefore(s,i.firstChild),++this.#Cl),i.removeChild(e),s.appendChild(e)}#Ll(e){for(var t=e.getElementsByTagName("canvas"),i=t.length-1;i>=0;i--)"true"!=t[i].getAttribute("hasdrawing")&&t[i].parentNode.removeChild(t[i]);this.#Tl(e)}#Tl(e){for(var t=!0,i=e.childNodes.length-1;i>=0;i--){var s=e.childNodes.item(i);if(1==s.nodeType)if("DIV"!=s.nodeName)t=!1;else if(s.hasChildNodes()){this.#Tl(s)&&!s.getAttribute("data-layerNode")?s.parentNode.removeChild(s):t=!1}else s.getAttribute("data-layerNode")||s.parentNode.removeChild(s)}return t}#Al(){var e=[];for(var t in this.#ii)this.usedImages[t]||(this.#si[t].domMutationObserver&&this.#si[t].domMutationObserver.disconnect(),delete this.#ii[t],delete this.#si[t],this.#Fn.removeDocGeometries(t),e.push(t));e.length>0&&console.log("removeUnusedDocs : docId:",e," are no longer used. Delete it.")}#El(){for(var e in this.#si)this.#si[e].refresh&&this.#si[e].refresh.timeout>0&&0==this.#si[e].refresh.start&&(this.#si[e].refresh.start=!0,this.#si[e].refresh.loadScript=!0,setTimeout(function(e){this.#Ol(e)}.bind(this),1e3*this.#si[e].refresh.timeout,e))}#Ol(e){this.#si[e]&&(this.#si[e].refresh.start=!1,this.#jn())}#wl(e){return Object.keys(e).length}}class G{#kl=!1;clearHashChangedFlag(){const e=this.#kl;return this.#kl=!1,e}get hash(){return new URL(this.Path,location).hash}set hash(e){if(e&&""!=e){if(!e.startsWith("#"))return void console.warn("hash should be startd with #");if("#"==e)return void console.warn("At least one string of characters in addition to the # is required.");this.#kl=e,this.Path=this.#Rl(this.Path)+e}else this.#kl=!0,this.Path=this.#Rl(this.Path)}#Rl(e){let t;const i=e.indexOf("#");return t=i>-1?e.substring(0,i):e,t}}class N{#Bl=1;#Vl=[];#Gl=!0;#_n=7e3;#Nl=138;#Dl=37;#qt;#ii={};#si={};#hn;#gn;#ba;#n;#fa;#wn;#Ul;#Zo;#dl;#Fn;#Hn;#Fl;#Hl;#qn;#zl;#jl;#Wl;#Yl;#Xl;#Sl;#Zl;#ql;constructor(){this.#qt=new B;var e=this;console.log("init"),i.addEvent(window,"load",function(){e.#_l()}.bind(this)),i.addEvent(window,"hashchange",function(){e.#jn(),"function"==typeof this.#Kl&&setTimeout(function(){this.#Kl()}.bind(this),300)}.bind(this)),this.#Zo=new c,this.#qn=new C,this.#fa=new o(this,this.#qt),this.#n=new d(this,this.#fa,this.#Sa),this.#ba=new r(this,this.#n),this.#n.setLayerUIobject(this.#ba),this.#wn=new l(this,this.#ba.getLayersCustomizer),this.#ql=new V(this.#qt,this.#si,this.#ii,this.#jn,this.#xl),this.#Yl=new T(this.#si,this.#ii,this.#ql.loadingImgs,this.#jn),this.#Hn=new x(this,this.#Zo,this.#Yl.isEditingLayer,this.#Yl.getLayerName,this.#ql.setLoadCompleted,this.#fa),this.#Fl=new M(this.#Hn),this.#Ul=new h(this),this.#Fn=new y(this,i.getImageURL),this.#jl=new E(this.#Fn,this.#Zo,this.#Hn,this.#qt),this.#Sl=new k(this,this.#ql.loadingImgs,this.#qn,this.#_n,this.#qt,this.#Zo,this.#ql.checkLoadCompleted,this.#Kn),this.#ql.init(this.#Sl,this.#Hn,this.#Fn),this.#Hl=new w(this,this.#wn,function(e,t){this.#Jl(e,"root",this.#qt.mapCanvas,!1,t,null,null,!0)}.bind(this)),this.#zl=new L(this),this.#Wl=new A(i.getNonScalingOffset)}async#_l(){this.#qt.hasUaProps()&&console.log("Already initialized. Exit..."),this.#dl=new u(this.#Hn.hideTicker,this.#ql.checkLoadCompleted,this.#Hn.getObjectAtPoint,this.#Po,this.#So,this.#qt,this),this.#Zl=new R(this,this.#qt,this.#dl,this.#Hn,this.#Zo,this.#cl,this.#So);var e=this.#Zl.initMapCanvas();if(e){if(this.#qt.uaProps=new m,this.#qt.setMapCanvasSize(i.getCanvasSize()),!this.#qt.hasMapCanvasSize())return console.log("retry init....",this.#qt.mapCanvasSize),this.#qt.uaProps=null,void setTimeout(function(){this.#_l()}.bind(this),50);this.#Xl=new O(this),this.#qt.setRootViewBox(i.getBBox(0,0,this.#qt.mapCanvasSize.width,this.#qt.mapCanvasSize.height)),this.#Zl.setMapCanvasCSS(this.#qt.mapCanvas),this.#Zl.setPointerEvents(),this.#Zl.setCenterUI(),this.#Zl.initNavigationUIs(this.#qt.uaProps.isSP),this.#Hl.setInitialCustomLayers(await this.#Zl.prepareInitialCustomLayers(),e),this.#Ql(e,"root",this.#qt.mapCanvas)}}#$l(e,t,i){i&&("root"==i?(this.#si[e].rootLayer=e,t.setAttribute("class","rootLayer:"+e),t.getAttribute("data-nocache")&&(this.#si[e].noCache=!0)):(this.#si[e].rootLayer=this.#si[i].rootLayer,t.setAttribute("class","rootLayer:"+this.#si[i].rootLayer)))}#Ql(e,t,s,r){if(this.#ii[t])delete this.#ql.loadingImgs[t],this.#$l(t,s,r),this.#eh(t,s);else{this.#si[t]=new G,this.#$l(t,s,r);var a=this,o=this.#th(function(){a.#ih(t,e,s,this,r)},function(){a.#sh(t,e,this,!0)});if(o){this.#ql.loadingImgs[t]=!0;var n=e;this.#si[t].rootLayer&&this.#si[this.#si[t].rootLayer].noCache&&(n=i.getNoCacheRequest(n));const s=this.#si[t].commonQuery||this.#si[this.#si[t].rootLayer]?.commonQuery;null!=s&&(n=i.addCommonQueryAtQueryString(n,s),this.#si[t].commonQuery=s),n=this.#qn.getAccessInfo(n),o.open("GET",i.getSvgReq(n),!0),this.#qt.uaProps.MS&&o.ontimeout&&(o.timeout=this.#_n),o.send(null)}}}#sh(e,t,i,s){delete this.#ql.loadingImgs[e],console.log("File get failed: Err:",i.status," Path:",t," id:",e),this.#si[e]&&(this.#si[e].loadError=!0),s?++this.#Kn.timeoutSvgDocCount:++this.#Kn.otherSvgDocCount,this.#ql.checkLoadCompleted()}#ih(e,s,r,a,o){if(4==a.readyState){if(!this.#si[e])return console.log("NO svgImagesProps[docId] : docId:",e,"  skip processing"),delete this.#ql.loadingImgs[e],void this.#ql.checkLoadCompleted();if(403==a.status||404==a.status||500==a.status||503==a.status)return void this.#sh(e,s,a);if(a.responseText.indexOf("http://www.w3.org/2000/svg")>=0){var n=a.responseText.replace('xmlns="http://www.w3.org/2000/svg"','xmlns="http://www.w3.org/"');n.match(/data-controller-src([\s\S]*)"/)&&(n=i.getControllerSrc(n,this.#si[e])),n.match(/<script>([\s\S]*)<\/script>/)&&(n=i.getSvgScript(n,this.#si[e])),this.#ii[e]=(new DOMParser).parseFromString(n,"application/xml")}else this.#ii[e]=(new DOMParser).parseFromString(a.responseText,"application/xml");if(this.#ii[e].getElementsByTagName("svg").length<1)return console.warn("DOCUMENT ERROR.. skip"),delete this.#ii[e],void this.#sh(e,s,a);this.#ii[e].getElementById=i.getElementByIdUsingQuerySelector,this.#si[e].Path=s,this.#si[e].CRS=this.#rh(this.#ii[e],e),this.#si[e].refresh=i.getRefresh(this.#ii[e]),this.#si[e].styleMap=new WeakMap,this.#si[e].altdMap=new WeakMap;var l=new MutationObserver(function(t){t.forEach(function(t){"attributes"==t.type&&(this.#si[e].styleMap.delete(t.target),this.#si[e].altdMap.delete(t.target))}.bind(this))}.bind(this));if(l.observe(this.#ii[e].documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),this.#si[e].domMutationObserver=l,this.#ah(e),this.#si[e].isSVG2=this.#si[e].CRS.isSVG2,this.#si[e].parentDocId=o,this.#si[o]&&this.#si[o].childImages[e]==t.CLICKABLE&&(this.#si[e].isClickable={value:!0}),this.#oh(this.#ii[e],s,this.#si[e]),"root"==e){this.#qt.rootCrs=this.#si[e].CRS,this.#qt.root2Geo=this.#Zo.getInverseMatrix(this.#qt.rootCrs);var h=this.#nh(this.#ii.root);this.#qt.setRootViewBox(i.getrootViewBoxFromRootSVG(h,this.#qt.mapCanvasSize,this.#Zl.ignoreMapAspect))}else this.#Yl.isEditableLayer(e)&&(this.#si[e].editable=!0);this.#eh(e,r)}}#lh=new Object;#eh(e,t){e||t||(e="root",t=this.#qt.mapCanvas);var s=this.#ii[e];s.documentElement.setAttribute("about",e),t.setAttribute("property",this.#si[e].metaSchema);var r=i.getSymbols(s);"root"==e&&(this.#ql.usedImages={},this.#Hn.pathHitTester.setCentralVectorObjectsGetter(),this.#Yl.setRootLayersPropsPostprocessed.processed||("function"==typeof this.#Kl&&this.#Kl(),this.#Yl.setRootLayersPropsPostprocessed.processed=!0),this.#Gl&&this.#hh(),this.#Hn.hideTicker(),this.#Zl.updateCenterPos(),this.#Zl.setGeoViewBox(this.#Zo.getTransformedBox(this.#qt.rootViewBox,this.#qt.root2Geo)),this.#Hn.pathHitTester.enable||(this.#lh=new Object,this.#Hn.poiHitTester.clear()),this.#Hl.checkResume(s.documentElement,r),this.#gh()),this.#Yl.setRootLayersPropsPostprocessed.execHint[e]&&(this.#si[e]._execHint=this.#Yl.setRootLayersPropsPostprocessed.execHint[e],delete this.#Yl.setRootLayersPropsPostprocessed.execHint[e]),this.#Jl(s.documentElement,e,t,!1,r,null,null),delete this.#ql.loadingImgs[e],"root"==e&&("function"==typeof this.#dh&&(this.#dh({}),this.#n.initLayerSpecificUI(),this.#dh=null),this.#ch(this.#qt.mapCanvas),!this.#Hn.isEnabled()||this.#Hn.pathHitTester.enable||this.#Fn.GISgeometriesCaptureFlag||this.#Hn.checkTicker()),this.#Hn.pathHitTester.enable||this.#ql.checkLoadCompleted()}#ph(e,t,s){this.#si[e].script.location=i.getSvgLocation(this.#si[e].Path),this.#si[e].script.scale=t*s.scale,this.#si[e].script.actualViewBox=this.#Zo.getTransformedBox(this.#qt.rootViewBox,this.#Zo.getInverseMatrix(s)),this.#si[e].script.geoViewBox=this.#Zl.geoViewBox,this.#si[e].script.viewport=this.#si[e].script.actualViewBox,this.#si[e].script.geoViewport=this.#Zl.geoViewBox;var r=this.#xl(e);this.#si[e].script.handleScriptCf(),"zoom"==r||this.#si[e].script.initialLoad?(this.#si[e].script.initialLoad=!1,this.#si[e].script.onzoom&&this.#si[e].script.onzoom()):"scroll"==r&&this.#si[e].script.onscroll&&this.#si[e].script.onscroll(),this.#si[e].refresh.timeout>0&&1==this.#si[e].refresh.loadScript&&(this.#si[e].refresh.loadScript=!1,this.#si[e].script.onload())}#uh=null;#mh(e,t,i,s){var r=this.#Sa(e,t,i);if(s)this.#uh(r);else try{this.#si[e].preRenderControllerFunction(r)}catch(t){console.error("Error in handlePreRenderControllerScript: docId:",e,"  Exception:",t)}}#Sa(e,t,s){if(!t||!s){var r=this.#si[e].CRS;s=this.#Zo.getConversionMatrixViaGCS(r,this.#qt.rootCrs);var a=this.#So(this.#qt.rootViewBox,this.#qt.mapCanvasSize);t=this.#yh(a,e)[0]}var o=this.#xl("prc_"+e);return{docId:e,location:i.getSvgLocation(this.#si[e].Path),scale:t*s.scale,rootScale:t,c2rScale:s.scale,actualViewBox:this.#Zo.getTransformedBox(this.#qt.rootViewBox,this.#Zo.getInverseMatrix(s)),geoViewBox:this.#Zl.geoViewBox,viewChanged:o}}#vh={};#xl=function(e){var t;return e||(e="allMaps"),t=this.#vh[e]&&this.#vh[e].width==this.#qt.rootViewBox.width&&this.#vh[e].height==this.#qt.rootViewBox.height?(this.#vh[e].x!=this.#qt.rootViewBox.x||this.#vh[e].y!=this.#qt.rootViewBox.y)&&"scroll":"zoom",this.#vh[e],this.#vh[e]={x:this.#qt.rootViewBox.x,y:this.#qt.rootViewBox.y,width:this.#qt.rootViewBox.width,height:this.#qt.rootViewBox.height},t}.bind(this);#ah(e){var t=i.getMetaSchema(this.#ii[e]);this.#si[e].metaSchema=t||""}#Jl(e,s,r,a,o,n,l,h){var g=this.#si[s].Path,d=this.#si[s].isClickable;"svg"==e.nodeName&&(this.#ah(s),this.#ql.usedImages[s]=!0,n={});var c=null,p=this.#So(this.#qt.rootViewBox,this.#qt.mapCanvasSize);const[u,m]=this.#yh(p,s);var y=e.childNodes,b=this.#si[s].CRS;if(!this.#si[s].CRS.unresolved||(this.#si[s].CRS=this.#rh(this.#ii[s],s),!this.#si[s].CRS.unresolved)){this.#si[s].isSVG2=this.#si[s].CRS.isSVG2;var I=this.#si[s].isSVG2,P=this.#Zo.getConversionMatrixViaGCS(b,this.#qt.rootCrs);this.#si[s].scale=u*P.scale,this.#si[s].geoViewBox=this.#Zl.geoViewBox;var S=this.#Zo.matMul(P,p);"svg"==e.nodeName&&("function"==typeof this.#si[s].preRenderControllerFunction&&this.#mh(s,u,P),"function"==typeof this.#uh&&this.#mh(s,u,P,!0)),this.#Fn.GISgeometriesCaptureFlag&&this.#Fn.prepareDocGeometries(s);for(var x=i.getDocDir(g),M=0;M<y.length;M++){var w=y[M],C=!1;if(1==w.nodeType){var L="",A=t.NONE,E=t.NONE;switch(w.nodeName){case"animation":I||(A=t.EMBEDSVG);break;case"iframe":I&&(A=t.EMBEDSVG,E=t.SVG2EMBED);break;case"image":i.getNonScalingOffset(w).nonScaling?(A=t.POI,E=t.DIRECTPOI):A=t.BITIMAGE;break;case"use":(L=w.getAttribute("xlink:href"))||(L=w.getAttribute("href")),o[L]&&("group"==o[L].type?(A=t.GROUP,E=t.SYMBOL):(A=t.POI,E=t.USEDPOI));break;case"path":E=t.PATH,A=t.VECTOR2D;break;case"polyline":E=t.POLYLINE,A=t.VECTOR2D;break;case"polygon":E=t.POLYGON,A=t.VECTOR2D;break;case"rect":E=t.RECT,A=t.VECTOR2D;break;case"circle":E=t.CIRCLE,A=t.VECTOR2D;break;case"ellipse":E=t.ELLIPSE,A=t.VECTOR2D;break;case"g":A=t.GROUP;break;case"a":A=t.GROUP,E=t.HYPERLINK;break;case"text":A=t.TEXT}var T=null;if(!this.#Hn.pathHitTester.enable&&this.#Fn.GISgeometriesCaptureFlag&&(T=v.createSVGMapGISgeometry(A,E,w,this.#Fn.GISgeometriesCaptureOptions)),!this.#Hn.pathHitTester.enable&&(A==t.POI||A==t.BITIMAGE||A==t.EMBEDSVG||A==t.TEXT)||this.#Hn.pathHitTester.enable&&A==t.EMBEDSVG){var O,k=w.getAttribute("iid");k&&0==k.indexOf("i")||(k="i"+this.#fh,w.setAttribute("iid",k),++this.#fh),this.#lh[k]=!0,O=this.#bh(k);var R=i.getImageProps(w,A,l,E,T),B=this.#Zo.transformRect(R,P);if(R.nonScaling&&(B.nonScaling=!0),0!=B.width||0!=B.height||A!=t.EMBEDSVG&&A!=t.BITIMAGE||console.warn("This embedding element don't have width/height property. Never renders... imageId:",k,w),R.commonQuery&&"root"!=s&&(this.#si[this.#si[s].rootLayer].commonQuery=R.commonQuery),h)continue;if(!a&&i.isIntersect(B,this.#qt.rootViewBox)&&i.inZoomRange(R,u,B.c2rScale)&&i.isVisible(R)){var V,G,N=null;if(R.transform){var D=this.#Zo.matMul(R.transform,S),U=this.#Zo.transform(R.x,R.y,D);if(!D.a){var F=this.#Zo.transform(R.x+R.width,R.y,D),H=this.#Zo.transform(R.x+R.width,R.y+R.height,D);D=f.getLinearTransformMatrix(R.x,R.y,R.x+R.width,R.y,R.x+R.width,R.y+R.height,U.x,U.y,F.x,F.y,H.x,H.y)}var z=Math.sqrt(Math.abs(D.a*D.d-D.b*D.c));V={p0:0,span:R.width*z},G={p0:0,span:R.height*z},V.p0=U.x,G.p0=U.y,N={a:D.a/z,b:D.b/z,c:D.c/z,d:D.d/z,e:0,f:0}}else{var j=this.#Zo.getTransformedBox(B,p);if(A==t.POI&&E==t.USEDPOI){var W=o[R.href];W.d||(R.href=W.path,j.x+=m*W.offsetX,j.y+=m*W.offsetY,j.width=m*W.width,j.height=m*W.height)}else R.nonScaling&&(j.width=m*R.width,j.height=m*R.height,(R.cdx||R.cdy)&&(j.x+=m*R.cdx,j.y+=m*R.cdy));V=this.#Po(j.x,j.width),G=this.#Po(j.y,j.height)}if(O)A==t.POI||A==t.BITIMAGE?this.#Sl.setImgElement(O,V.p0,G.p0,V.span,G.span,i.getImageURL(R.href,x),N,0,0,!1,R.nonScaling,R.href_fragment,R.pixelated,R.imageFilter,k,R.opacity,R.crossorigin,{docId:s,svgNode:w}):A==t.TEXT?this.#Sl.setImgElement(O,V.p0,G.p0,0,G.span,"",N,R.cdx,R.cdy,!0,R.nonScaling,null,R.pixelated,R.imageFilter,k,R.opacity,null,{docId:s,svgNode:w}):(this.#Ih(R,x,k,w),this.#Ph(this.#ii,k,O,0)),c=O;else{var Y;if(A==t.POI||A==t.BITIMAGE){var X=i.getImageURL(R.href,x),Z=A==t.BITIMAGE&&this.#si[s].rootLayer&&this.#si[this.#si[s].rootLayer].noCache;Y=this.#Sl.getImgElement(V.p0,G.p0,V.span,G.span,X,k,R.opacity,A,R.metadata,R.title,N,R.href_fragment,R.pixelated,R.imageFilter,Z,R.crossorigin,{docId:s,svgNode:w},R.commonQuery||this.#si[this.#si[s].rootLayer]?.commonQuery)}else if(A==t.TEXT){var q=this.#Wl.getStyle(w,l,null,this.#si[s].styleMap);Y=this.#Sl.getSpanTextElement(V.p0,G.p0,R.cdx,R.cdy,R.text,k,R.opacity,N,q,G.span,R.nonScaling)}else Y=document.createElement("div"),"root"==s&&(w.getAttribute("data-nocache")&&Y.setAttribute("data-nocache","true"),Y.setAttribute("data-layerNode","true")),Y.id=k,R.opacity&&(this.#qt.uaProps.MS?(this.#qt.uaProps.verIE>8&&Y.setAttribute("style","Filter: Alpha(Opacity="+100*R.opacity+");opacity:"+R.opacity+";"),Y.style.filter="alpha(opacity="+100*R.opacity+")",Y.style.position="absolute",Y.style.top=0,Y.style.left=0):Y.style.opacity=R.opacity),R.imageFilter&&(Y.style.filter=R.imageFilter),this.#si[s].childImages||(this.#si[s].childImages=new Array),this.#si[s].isClickable||R.elemClass&&R.elemClass.indexOf("clickable")>=0?this.#si[s].childImages[k]=t.CLICKABLE:this.#si[s].childImages[k]=t.EXIST;if(A==t.POI&&this.#Fn.GISgeometriesCaptureOptions.SkipVectorRendering);else{if(c)r.insertBefore(Y,c.nextSibling);else if(r.hasChildNodes()){var _=r.getElementsByTagName("div");_?r.insertBefore(Y,_.item(0)):r.insertBefore(Y,r.lastChild)}else r.appendChild(Y);c=Y}if(A!=t.POI&&A!=t.BITIMAGE&&A!=t.TEXT){var K=i.getImageURL(R.href,x);this.#Ql(K,k,Y,s)}this.#qt.uaProps.isIE&&(this.#qt.uaProps.verIE<9&&(A==t.POI||A==t.BITIMAGE)&&(Y.src=Y.getAttribute("href")),Y.width=V.span,Y.height=G.span,Y.style.width=V.span+"px",Y.style.height=G.span+"px")}A==t.POI&&this.#Hn.poiHitTester.setPoiBBox(k,V.p0,G.p0,V.span,G.span),C=!0}else O&&(this.#ql.requestRemoveTransition(O,r),A==t.EMBEDSVG&&(this.#Ih(R,x,k,w),this.#Sh(k)))}else if(A==t.GROUP){if(w.hasChildNodes()||E==t.SYMBOL){var J=!1;E==t.HYPERLINK&&(J=!0);q=this.#Wl.getStyle(w,l,J,this.#si[s].styleMap);E==t.SYMBOL&&(q.usedParent=w,w=o[L].node),c=this.#Jl(w,s,r,!1,o,n,q,h)}}else if(A==t.VECTOR2D){if(h)continue;if(!n.context)if(this.#Gl){var Q=document.getElementById(this.#si[s].rootLayer+"_canvas");Q||((Q=document.createElement("canvas")).style.position="absolute",Q.style.left="0px",Q.style.top="0px",Q.width=this.#qt.mapCanvasSize.width,Q.height=this.#qt.mapCanvasSize.height,Q.id=this.#si[s].rootLayer+"_canvas",document.getElementById(this.#si[s].rootLayer).appendChild(Q),Q.setAttribute("hasdrawing","false")),n.element=Q,n.context2d=Q.getContext("2d")}else;if((q=this.#Wl.getStyle(w,l,null,this.#si[s].styleMap)).docDPR=m,T&&T.determineType(q),this.#Fn.GISgeometriesCaptureOptions.SkipVectorRendering?n.context=this.#Fn.dummy2DContextBuilder():n.context=n.context2d,n.altdMap=this.#si[s].altdMap,i.inZoomRange(q,u,P.scale)&&(!q.display||"none"!=q.display)&&(!q.visibility||"hidden"!=q.visibility)){var $=null;if(E==t.PATH?$=this.#jl.setSVGpathPoints(w,n,S,d,null,q,T):E==t.RECT?$=this.#jl.setSVGrectPoints(w,n,S,d,q,T):E==t.CIRCLE||E==t.ELLIPSE?$=this.#jl.setSVGcirclePoints(w,n,S,d,E,q,T):E!=t.POLYLINE&&E!=t.POLYGON||($=this.#jl.setSVGpolyPoints(w,n,S,d,E,q,T)),$){if(q["marker-end"]){var ee="M-20,-5 L0,0 L-20,5",te=/\s*url\((#.*)\)/.exec(q["marker-end"]);te&&o[te[1]]&&o[te[1]].d&&(ee=o[te[1]].d);var ie={a:$.endCos,b:$.endSin,c:-$.endSin,d:$.endCos,e:$.endX,f:$.endY};n.context.setLineDash([]),this.#jl.setSVGpathPoints(w,n,ie,d,ee,q)}(this.#Hn.pathHitTester.enable||this.#Hn.pathHitTester.centralGetter)&&$.hitted&&this.#Hn.pathHitTester.setHittedObjects(w,$,q.usedParent),i.isIntersect($,this.#qt.mapCanvasSize)&&(n.element.setAttribute("hasdrawing","true"),C=!0)}}}T&&C&&this.#Fn.addGeometry(s,T,O,x)}}return c}console.warn("docId:",s,"'s CRS is not resolved skip.")}#Ih(e,t,s,r){var a=i.getImageURL(e.href,t);if(this.#si[s]&&this.#si[s].Path&&this.#si[s].Path!=a){const t=i.urlChanged(this.#si[s].Path,a),o=this.#si[s].clearHashChangedFlag();console.log("change SVG's path:",t,o),t.hash&&o?!0===o?r.setAttribute("xlink:href",i.getPathWithoutHash(e.href)):r.setAttribute("xlink:href",i.getPathWithoutHash(e.href)+o):this.#si[s].Path=a}}#Ph(e,t,s,r){if(!this.#si[t]||!this.#si[t].loadError)if(this.#ii[t]&&this.#si[t]){this.#ql.loadingImgs[t]=!0;var a=i.getSymbols(this.#ii[t]);this.#Jl(this.#ii[t].documentElement,t,s,!1,a,null,null),delete this.#ql.loadingImgs[t]}else r<20?(++r,setTimeout(function(e,t,i,s){this.#Ph(e,t,i,s)}.bind(this),50,e,t,s,r)):console.log("FAIL: document load : imageId:",t)}#ch(e){for(var t=new Array,i=e.childNodes.length-1;i>=0;i--){var s=e.childNodes.item(i);1==s.nodeType&&("IMG"!=s.nodeName&&"SPAN"!=s.nodeName||!s.id||-1!=s.id.indexOf("toBeDel")||this.#lh[s.id]||t.push(s),s.id&&-1==s.id.indexOf("toBeDel")&&s.hasChildNodes()&&this.#ch(s))}for(i=0;i<t.length;i++)this.#ql.requestRemoveTransition(t[i],e)}#hh(){for(var e=this.#qt.mapCanvas.getElementsByTagName("canvas"),t=e.length-1;t>=0;t--){var i=e.item(t);i.dataset.pixelate4Edge||(i.setAttribute("hasdrawing","false"),i.style.left="0px",i.style.top="0px",i.width=this.#qt.mapCanvasSize.width,i.height=this.#qt.mapCanvasSize.height,i.getContext("2d").clearRect(0,0,i.width,i.height))}}#So=function(e,t){var i,s;return e||(e=this.#qt.rootViewBox,t=this.#qt.mapCanvasSize),{a:i=t.width/e.width,b:0,c:0,d:s=t.height/e.height,e:-i*e.x,f:-s*e.y}}.bind(this);#fh=0;#bh(e){var t=document.getElementById(e);return t||!1}#Po(e,t){var i=Math.floor(e);return{p0:i,span:Math.floor(e+t)-i+.02}}#cl=function(){for(var e=this.#qt.mapCanvas.getElementsByTagName("img"),t=e.length-1;t>=0;t--)e[t].style.visibility="hidden"}.bind(this);#rh(e,t){var s=!1,r=null,a=i.getElementByIdNoNS(e,"globe");try{var o={unresolved:!0,isSVG2:!1};if(a&&"view"==a.nodeName){var n=a.getAttribute("viewBox").split(/\s*,\s*|\s/);(r=new Array(6))[0]=n[2]/360,r[1]=0,r[2]=0,r[3]=-n[3]/180,r[4]=Number(n[0])+180*r[0],r[5]=Number(n[1])-90*r[3],s=!0,o={a:r[0],b:r[1],c:r[2],d:r[3],e:r[4],f:r[5],isSVG2:s}}else{var l=e.getElementsByTagName("globalCoordinateSystem")[0];if(l){var h=l.getAttribute("transform");if(h)if(o.transformFunctionName=h,h.indexOf("matrix")>=0)(o=i.parseTransformMatrix(h))&&(o.isSVG2=s);else if("mercator"==h.toLowerCase())console.log("isMercator"),(o=new p).isSVG2=!1;else if(0==h.indexOf("controller.")){var g=this.#si[this.#si[t].rootLayer].controllerWindow;if(g){var d=h.substring(11);g[d]&&((o=g[d]).isSVG2||(o.isSVG2=!1))}}else if(this.#si[t].script&&this.#si[t].script.transformFunction){var c=this.#si[t].script.transformFunction;console.log("set transformFunction:",c),c&&((o=c()).isSVG2||(o.isSVG2=!1))}}}return o.unresolved&&console.warn("This document don't have CRS. Never renders. docId:",t),o}catch(e){return{a:1,b:0,c:0,d:1,e:0,f:0,isSVG2:!1}}}#oh(e,t,s){var r=e.documentElement.getAttribute("data-controller");if(s.controller&&s.controller.src){if(r){var a=s.controller.src;s.controller=new String(r),s.controller.url=r,s.controller.src=a}}else if(r){var o=i.getImageURL(r,i.getDocDir(t));s.controller=new String(o),s.controller.url=o}else if("root"==s.parentDocId&&null!=(r=this.#Yl.getLayer(s.rootLayer).getAttribute("data-controller"))&&""!==r){o=i.getImageURL(r,i.getDocDir(t));s.controller=new String(o),s.controller.url=o}}#nh(e){var t=e.documentElement.getAttribute("viewBox");if(t){if(0==t.indexOf("#"))return t.substring(1);if(0==t.trim().indexOf("global")){var s=i.trim(t).split(/[\s,]+/),r={x:Number(s[1]),y:Number(s[2]),width:Number(s[3]),height:Number(s[4])},a=this.#Zo.getTransformedBox(r,this.#qt.rootCrs);return console.log("getViewBox:global,root:",r,a,s),a}s=i.trim(t).split(/[\s,]+/);return{x:Number(s[0]),y:Number(s[1]),width:Number(s[2]),height:Number(s[3])}}return null}#yh(e,t){var i=this.#si[t].rootLayer;let s;s=null!=this.#Vl[i]?this.#Vl[i]:this.#Bl;return[(Math.abs(e.a)+Math.abs(e.d))/(2*s),s]}#xh(e,t){t?e>0?this.#Vl[t]=e:e||delete this.#Vl[t]:e>0?this.#Bl=e:e||(this.#Bl=1,this.#Vl=[])}#Mh(e){if(e){var t=this.#si[e].rootLayer;return null!=this.#Vl[t]?this.#Vl[t]:this.#Bl}return{commonDevicePixelRatio:this.#Bl,layerDevicePixelRatio:this.#Vl}}#th(e,t){var i=null;try{i=new XMLHttpRequest}catch(e){alert("Too old browsers: not supported")}return i&&(i.onreadystatechange=e),t&&(this.#qt.uaProps.MS||(i.timeout=this.#_n),i.ontimeout=t),i}#Sh(e){if(this.#ii[e]){for(var t=this.#Yl.getLayers(e),i=0;i<t.length;i++)this.#Sh(t[i].getAttribute("iid"));this.#si[e].domMutationObserver&&this.#si[e].domMutationObserver.disconnect(),delete this.#ii[e],delete this.#si[e]}else this.#si[e]&&this.#si[e].loadError&&(this.#si[e].domMutationObserver&&this.#si[e].domMutationObserver.disconnect(),delete this.#si[e])}#Kn={};#gh(){this.#Kn={timeoutBitImagesCount:0,timeoutSvgDocCount:0,otherBitImagesCount:0,otherSvgDocCount:0}}#wh(){return this.#Kn}#Ch(e){var t=e.parentNode.getAttribute("id");return"mapcanvas"==t&&(t="root"),{element:i.getElementByImgIdNoNS(this.#ii[t],e.getAttribute("id")),docId:t}}#Lh=!1;#jn=function(e,t,i,s){if(s)return this.#Ah(e,t,i,s);queueMicrotask(function(){this.#Ah(e,t,i)}.bind(this))}.bind(this);#Ah=function(e,t,i){if(!this.#Lh||i){if(0!=this.#ql.getLoadCompleted())this.#Lh=!1,this.#ql.setLoadCompleted(!1),this.#eh("root",this.#qt.mapCanvas);else if(!e){var s=this;setTimeout(function(){s.#jn(e,undefined,!0)}.bind(this),10),this.#Lh=!0}}else console.log("Is refreshScreen retry queue:: SKIP this Call")}.bind(this);#dh;#Kl;#Eh(e){console.log("called reLoadLayer : ",e),this.#Yl.setRootLayersProps(e,!1,!1),this.#jn(),this.#Yl.setRootLayersProps(e,!0,!1),this.#jn()}Geo2SVG(...e){return this.#Zo.Geo2SVG(...e)}POIviewSelection(...e){return this.#Hn.POIviewSelection(...e)}SVG2Geo(...e){return this.#Zo.SVG2Geo(...e)}addEvent(){return i.addEvent}captureGISgeometries(...e){return this.#Fn.captureGISgeometries(...e)}captureGISgeometriesOption=function(e,t,i,s){if("object"==typeof e)for(var r in e)"boolean"==typeof e[r]&&"boolean"==typeof this.#Fn.GISgeometriesCaptureOptions[r]&&(this.#Fn.GISgeometriesCaptureOptions[r]=e[r]);else!0!==e&&!1!==e||(this.#Fn.GISgeometriesCaptureOptions.BitImageGeometriesCaptureFlag=e),!0!==t&&!1!==t||(this.#Fn.GISgeometriesCaptureOptions.TreatRectAsPolygonFlag=t),!0!==i&&!1!==i||(this.#Fn.GISgeometriesCaptureOptions.SkipVectorRendering=i),"boolean"==typeof s&&(this.#Fn.GISgeometriesCaptureOptions.captureAlsoAsBitImage=s)}.bind(this);checkSmartphone(...e){return this.#qt.uaProps.isSP}childDocOp(...e){return this.#zl.childDocOp(...e)}dynamicLoad(...e){return this.#eh(...e)}escape(...e){return i.escape(...e)}geo2Screen(...e){return this.#Zl.geo2Screen(...e)}getBasicPermanentLink(...e){return this.#Hl.getBasicPermanentLink(...e)}getBBox(...e){return i.getBBox(...e)}getCanvasSize(...e){return i.getCanvasSize(...e)}getCentralGeoCoorinates(...e){return this.#Zl.getCentralGeoCoorinates(...e)}getConversionMatrixViaGCS(...e){return this.#Zo.getConversionMatrixViaGCS(...e)}getCORSURL(...e){return this.#qn.getCORSURL(...e)}getElementByImageId(...e){return i.getElementByImgIdNoNS(...e)}getGeoViewBox(){return this.#Zl.getGeoViewBox()}getHashByDocPath(...e){return this.#Yl.getHashByDocPath(...e)}getHyperLink(...e){return i.getHyperLink(...e)}getInverseMatrix(...e){return this.#Zo.getInverseMatrix(...e)}getLayer(...e){return this.#Yl.getLayer(...e)}getLayerId(...e){return this.#Yl.getLayerId(...e)}getLayers(...e){return this.#Yl.getLayers(...e)}getLinearTransformMatrix(...e){return f.getLinearTransformMatrix(...e)}getLoadErrorStatistics(...e){return this.#wh(...e)}getMapCanvas(){return this.#qt.mapCanvas}getMapCanvasSize(){return this.#qt.mapCanvasSize}getMouseXY(...e){return this.#dl.getMouseXY(...e)}getNonScalingOffset(...e){return i.getNonScalingOffset(...e)}getPoiPos(...e){return i.getNonScalingOffset(...e)}getResume(){return this.#Hl.getResume()}getRoot2Geo(){return this.#qt.root2Geo}getRootCrs(){return this.#qt.rootCrs}getRootLayersProps(...e){return this.#Yl.getRootLayersProps(...e)}getRootViewBox(){return this.#qt.rootViewBox}getSvgImages(){return this.#ii}getSvgImagesProps(){return this.#si}getSvgMapLayerUI(){return this.#ba}getSvgTarget(...e){return this.#Ch(...e)}getSwLayers(...e){return this.#Yl.getSwLayers(...e)}getSymbols(...e){return i.getSymbols(...e)}getTickerMetadata(...e){return this.#Hn.getTickerMetadata(...e)}getTransformedBox(...e){return this.#Zo.getTransformedBox(...e)}getUaProp(){return{isIE:this.#qt.uaProps.isIE,isSP:this.#qt.uaProps.isSP,uaProp:this.#qt.uaProps}}getVerticalScreenScale(...e){return this.#Zl.getVerticalScreenScale(...e)}getViewBox(...e){return this.#nh(...e)}gps(...e){return this.#Xl.gps(...e)}gpsCallback(...e){return this.#Xl.gpsSuccess(...e)}handleResult(...e){return this.#ih(...e)}ignoreMapAspect(){this.#Zl.ignoreMapAspect=!0}initLoad(...e){return this.#_l(...e)}isIntersect(...e){return i.isIntersect(...e)}linkedDocOp(...e){return this.#zl.linkedDocOp(...e)}loadSVG(...e){return this.#Ql(...e)}matMul(...e){return this.#Zo.matMul(...e)}numberFormat(...e){return i.numberFormat(...e)}parseEscapedCsvLine(...e){return this.#Hn.showPoiProperty.parseEscapedCsvLine(...e)}refreshScreen(...e){return this.#jn(...e)}registLayerUiSetter(e,t){console.log("registLayerUiSetter:",e,t),this.#dh=e,this.#Kl=t}reLoadLayer(...e){return this.#Eh(...e)}resumeToggle(...e){return this.#Hl.resumeToggle(...e)}screen2Geo(...e){return this.#Zl.screen2Geo(...e)}setCustomModal(...e){return this.#Fl.setCustomModal(...e)}setDefaultHilightStyle(...e){this.#jl.setDefaultHilightStyle(...e)}setDevicePixelRatio(...e){return this.#xh(...e)}getDevicePixelRatio(...e){return this.#Mh(...e)}setGeoCenter(...e){return this.#Zl.setGeoCenter(...e)}setGeoViewPort(...e){return this.#Zl.setGeoViewPort(...e)}setLayerVisibility(...e){return this.#Yl.setLayerVisibility(...e)}setMapCanvas(e){this.#qt.mapCanvas=e}setMapCanvasCSS(...e){return this.#Zl.setMapCanvasCSS(...e)}setMapCanvasSize(e){this.#qt.setMapCanvasSize(e)}setPreRenderController(e,t){"function"==typeof t?e?this.#si[e].preRenderControllerFunction=t:this.#uh=t:e?delete this.#si[e].preRenderControllerFunction:this.#uh=null}setProxyURLFactory(...e){return this.#qn.setProxyURLFactory(...e)}setResume(e){this.#Hl.setResume(e)}setRootLayersProps(...e){return this.#Yl.setRootLayersProps(...e)}setRootViewBox(e){this.#qt.setRootViewBox(e)}setShowPoiProperty(...e){return this.#Hn.showPoiProperty.setShowPoiProperty(...e)}setSmoothZoomInterval(...e){return this.#dl.setSmoothZoomInterval(...e)}setSmoothZoomTransitionTime(...e){return this.#dl.setSmoothZoomTransitionTime(...e)}setSummarizeCanvas(e){this.#Gl=e}setUpdateCenterPos(...e){return this.#Zl.setUpdateCenterPos(...e)}setZoomRatio(e){this.#dl.setZoomRatio(e)}showModal(...e){return this.#Hn.showPoiProperty.showModal(...e)}showPage(...e){return this.#Hn.showPage(...e)}showUseProperty(...e){return this.#Hn.showUseProperty(...e)}transform(...e){return this.#Zo.transform(...e)}updateLayerListUI=function(){console.log("updateLayerListUI called  this:",this),"function"==typeof this.#Kl&&this.#Kl()}.bind(this);zoomdown(...e){return this.#dl.zoomdown(...e)}zoomup(...e){return this.#dl.zoomup(...e)}}export{N as SvgMap};
